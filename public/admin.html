<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Velocity Lab</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Header Navigation -->
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <h1>üöÄ Velocity Lab</h1>
                <span class="nav-subtitle">Administration Panel</span>
            </div>
            <div class="nav-user">
                <span id="userInfo" class="user-info">Loading...</span>
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="profile.html" class="nav-link">Profile</a>
                <button id="logout" class="btn btn-outline">Logout</button>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="main admin-main">
        <div class="admin-container">
            <!-- Admin Header -->
            <section class="admin-header">
                <h2>üõ°Ô∏è Administration Panel</h2>
                <p>Manage users, monitor progress, and configure system settings</p>
            </section>

            <!-- Admin Navigation -->
            <nav class="admin-nav" role="tablist">
                <button class="admin-nav-item active" data-tab="overview" role="tab" aria-selected="true">
                    üìä Overview
                </button>
                <button class="admin-nav-item" data-tab="users" role="tab" aria-selected="false">
                    üë• Users
                </button>
                <button class="admin-nav-item" data-tab="progress" role="tab" aria-selected="false">
                    üìà Progress
                </button>
                <button class="admin-nav-item" data-tab="settings" role="tab" aria-selected="false">
                    ‚öôÔ∏è Settings
                </button>
                <button class="admin-nav-item" data-tab="logs" role="tab" aria-selected="false">
                    üìù Logs
                </button>
            </nav>

            <!-- Admin Content -->
            <div class="admin-content">
                <!-- Overview Tab -->
                <section id="overview" class="admin-tab active" role="tabpanel">
                    <h3>System Overview</h3>
                    
                    <!-- System Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üë•</div>
                            <div class="stat-content">
                                <h4>Total Users</h4>
                                <div class="stat-value" id="totalUsers">0</div>
                                <div class="stat-detail" id="newUsersToday">0 new today</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üèÉ</div>
                            <div class="stat-content">
                                <h4>Active Users</h4>
                                <div class="stat-value" id="activeUsers">0</div>
                                <div class="stat-detail">Last 7 days</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">‚úÖ</div>
                            <div class="stat-content">
                                <h4>Completion Rate</h4>
                                <div class="stat-value" id="completionRate">0%</div>
                                <div class="stat-detail">Average across all users</div>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">üèÜ</div>
                            <div class="stat-content">
                                <h4>Labs Completed</h4>
                                <div class="stat-value" id="labsCompleted">0</div>
                                <div class="stat-detail">Total completed labs</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h4>Recent Activity</h4>
                        <div class="activity-list" id="recentActivity">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading recent activity...</p>
                            </div>
                        </div>
                    </div>

                    <!-- System Health -->
                    <div class="system-health">
                        <h4>System Health</h4>
                        <div class="health-grid">
                            <div class="health-item">
                                <div class="health-icon status-good">‚úÖ</div>
                                <div class="health-content">
                                    <h5>Database</h5>
                                    <p>Operational</p>
                                </div>
                            </div>
                            
                            <div class="health-item">
                                <div class="health-icon status-good">‚úÖ</div>
                                <div class="health-content">
                                    <h5>API Services</h5>
                                    <p>Operational</p>
                                </div>
                            </div>
                            
                            <div class="health-item">
                                <div class="health-icon status-good">‚úÖ</div>
                                <div class="health-content">
                                    <h5>File Storage</h5>
                                    <p>Operational</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Users Tab -->
                <section id="users" class="admin-tab" role="tabpanel" hidden>
                    <div class="tab-header">
                        <h3>User Management</h3>
                        <div class="tab-actions">
                            <button class="btn btn-primary" id="addUserBtn">
                                ‚ûï Add User
                            </button>
                            <button class="btn btn-outline" id="exportUsersBtn">
                                üì• Export Users
                            </button>
                        </div>
                    </div>
                    
                    <!-- User Filters -->
                    <div class="filters">
                        <div class="filter-group">
                            <input type="text" id="userSearch" class="form-input" placeholder="Search users...">
                        </div>
                        <div class="filter-group">
                            <select id="roleFilter" class="form-select">
                                <option value="">All Roles</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="table-container">
                        <table class="data-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Company</th>
                                    <th>Role</th>
                                    <th>Progress</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="7" class="loading-cell">
                                        <div class="loading-spinner"></div>
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="usersPagination">
                        <button class="btn btn-outline btn-sm" id="prevUsers">Previous</button>
                        <span class="pagination-info">Page 1 of 1</span>
                        <button class="btn btn-outline btn-sm" id="nextUsers">Next</button>
                    </div>
                </section>

                <!-- Progress Tab -->
                <section id="progress" class="admin-tab" role="tabpanel" hidden>
                    <div class="tab-header">
                        <h3>Progress Analytics</h3>
                        <div class="tab-actions">
                            <button class="btn btn-outline" id="refreshProgressBtn">
                                üîÑ Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <!-- Progress Charts -->
                    <div class="analytics-grid">
                        <div class="chart-card">
                            <h4>Overall Progress Distribution</h4>
                            <div class="chart-container" id="progressChart">
                                <div class="chart-placeholder">
                                    üìä Progress chart will be displayed here
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-card">
                            <h4>Weekly Task Completion</h4>
                            <div class="chart-container" id="weeklyChart">
                                <div class="chart-placeholder">
                                    üìà Weekly completion chart will be displayed here
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task Statistics -->
                    <div class="task-stats">
                        <h4>Task Completion Statistics</h4>
                        <div class="task-stats-grid">
                            <div class="week-stats" data-week="week1">
                                <h5>üìö Week 1: Foundation Setup</h5>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: 0%"></div>
                                </div>
                                <p>0% average completion (0/12 tasks)</p>
                            </div>
                            
                            <div class="week-stats" data-week="week2">
                                <h5>üèóÔ∏è Week 2: Infrastructure Expansion</h5>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: 0%"></div>
                                </div>
                                <p>0% average completion (0/8 tasks)</p>
                            </div>
                            
                            <div class="week-stats" data-week="week3">
                                <h5>üìß Week 3: Email & Messaging</h5>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: 0%"></div>
                                </div>
                                <p>0% average completion (0/12 tasks)</p>
                            </div>
                            
                            <div class="week-stats" data-week="week4">
                                <h5>‚òÅÔ∏è Week 4: Cloud Integration</h5>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: 0%"></div>
                                </div>
                                <p>0% average completion (0/10 tasks)</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Tab -->
                <section id="settings" class="admin-tab" role="tabpanel" hidden>
                    <h3>System Settings</h3>
                    
                    <!-- General Settings -->
                    <div class="settings-section">
                        <h4>General Settings</h4>
                        <form class="settings-form" id="generalSettingsForm">
                            <input type="hidden" id="csrfToken" name="csrf_token" value="">
                            
                            <div class="form-group">
                                <label for="siteName" class="form-label">Site Name</label>
                                <input 
                                    type="text" 
                                    id="siteName" 
                                    name="siteName" 
                                    class="form-input" 
                                    value="Velocity Lab"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="adminEmail" class="form-label">Admin Email</label>
                                <input 
                                    type="email" 
                                    id="adminEmail" 
                                    name="adminEmail" 
                                    class="form-input" 
                                    placeholder="admin@velocitylab.com"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="maxUsers" class="form-label">Maximum Users</label>
                                <input 
                                    type="number" 
                                    id="maxUsers" 
                                    name="maxUsers" 
                                    class="form-input" 
                                    value="100"
                                    min="1"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" name="allowRegistration" class="checkbox-input" checked>
                                    <span class="checkbox-custom"></span>
                                    <span class="checkbox-label">Allow user registration</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" name="emailVerification" class="checkbox-input">
                                    <span class="checkbox-custom"></span>
                                    <span class="checkbox-label">Require email verification</span>
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    üíæ Save General Settings
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Security Settings -->
                    <div class="settings-section">
                        <h4>Security Settings</h4>
                        <form class="settings-form" id="securitySettingsForm">
                            <div class="form-group">
                                <label for="sessionTimeout" class="form-label">Session Timeout (minutes)</label>
                                <input 
                                    type="number" 
                                    id="sessionTimeout" 
                                    name="sessionTimeout" 
                                    class="form-input" 
                                    value="60"
                                    min="5"
                                    max="1440"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="passwordMinLength" class="form-label">Minimum Password Length</label>
                                <input 
                                    type="number" 
                                    id="passwordMinLength" 
                                    name="passwordMinLength" 
                                    class="form-input" 
                                    value="8"
                                    min="6"
                                    max="20"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="maxLoginAttempts" class="form-label">Maximum Login Attempts</label>
                                <input 
                                    type="number" 
                                    id="maxLoginAttempts" 
                                    name="maxLoginAttempts" 
                                    class="form-input" 
                                    value="5"
                                    min="3"
                                    max="10"
                                >
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" name="requireStrongPassword" class="checkbox-input" checked>
                                    <span class="checkbox-custom"></span>
                                    <span class="checkbox-label">Require strong passwords</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" name="enableTwoFactor" class="checkbox-input">
                                    <span class="checkbox-custom"></span>
                                    <span class="checkbox-label">Enable two-factor authentication</span>
                                </label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    üîí Save Security Settings
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Backup Settings -->
                    <div class="settings-section">
                        <h4>Backup & Maintenance</h4>
                        <div class="backup-controls">
                            <div class="backup-item">
                                <div class="backup-content">
                                    <h5>Database Backup</h5>
                                    <p>Last backup: <span id="lastBackup">Never</span></p>
                                </div>
                                <button class="btn btn-outline" id="createBackupBtn">
                                    üíæ Create Backup
                                </button>
                            </div>
                            
                            <div class="backup-item">
                                <div class="backup-content">
                                    <h5>Export All Data</h5>
                                    <p>Export all user data and progress</p>
                                </div>
                                <button class="btn btn-outline" id="exportAllDataBtn">
                                    üì• Export Data
                                </button>
                            </div>
                            
                            <div class="backup-item">
                                <div class="backup-content">
                                    <h5>System Maintenance</h5>
                                    <p>Clear temporary files and optimize database</p>
                                </div>
                                <button class="btn btn-warning" id="maintenanceBtn">
                                    üîß Run Maintenance
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Logs Tab -->
                <section id="logs" class="admin-tab" role="tabpanel" hidden>
                    <div class="tab-header">
                        <h3>System Logs</h3>
                        <div class="tab-actions">
                            <select id="logLevel" class="form-select">
                                <option value="">All Levels</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                                <option value="debug">Debug</option>
                            </select>
                            <button class="btn btn-outline" id="refreshLogsBtn">
                                üîÑ Refresh
                            </button>
                            <button class="btn btn-outline" id="clearLogsBtn">
                                üóëÔ∏è Clear Logs
                            </button>
                        </div>
                    </div>
                    
                    <!-- Logs Container -->
                    <div class="logs-container">
                        <div class="logs-list" id="logsList">
                            <div class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading system logs...</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- User Modal -->
    <div id="userModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">User Details</h2>
                <button id="closeUserModal" class="modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" class="user-form">
                    <input type="hidden" id="userId" name="userId" value="">
                    <input type="hidden" id="csrfTokenUser" name="csrf_token" value="">
                    
                    <div class="form-group">
                        <label for="userName" class="form-label">Full Name</label>
                        <input 
                            type="text" 
                            id="userName" 
                            name="name" 
                            class="form-input" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="userEmail" class="form-label">Email Address</label>
                        <input 
                            type="email" 
                            id="userEmail" 
                            name="email" 
                            class="form-input" 
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="userCompany" class="form-label">Company</label>
                        <input 
                            type="text" 
                            id="userCompany" 
                            name="company" 
                            class="form-input"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="userRole" class="form-label">Role</label>
                        <select id="userRole" name="role" class="form-select" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="userActive" name="active" class="checkbox-input">
                            <span class="checkbox-custom"></span>
                            <span class="checkbox-label">Account Active</span>
                        </label>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            üíæ Save User
                        </button>
                        <button type="button" class="btn btn-outline" id="cancelUser">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-danger" id="deleteUser" style="margin-left: auto;">
                            üóëÔ∏è Delete User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification" role="alert" aria-live="polite"></div>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script>
        // Admin-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize admin interface
            initAdminTabs();
            loadAdminData();
            setupAdminHandlers();
        });

        function initAdminTabs() {
            const navItems = document.querySelectorAll('.admin-nav-item');
            const tabPanels = document.querySelectorAll('.admin-tab');
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const targetTab = e.target.dataset.tab;
                    
                    // Update nav items
                    navItems.forEach(nav => {
                        nav.classList.remove('active');
                        nav.setAttribute('aria-selected', 'false');
                    });
                    e.target.classList.add('active');
                    e.target.setAttribute('aria-selected', 'true');
                    
                    // Update tab panels
                    tabPanels.forEach(panel => {
                        panel.classList.remove('active');
                        panel.hidden = true;
                    });
                    const targetPanel = document.getElementById(targetTab);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                        targetPanel.hidden = false;
                    }
                    
                    // Load tab-specific data
                    loadTabData(targetTab);
                });
            });
        }

        async function loadAdminData() {
            try {
                // Load overview data
                const response = await fetch('/api/admin/overview', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateOverviewStats(data);
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
                showNotification('Failed to load admin data', 'error');
            }
        }

        function updateOverviewStats(data) {
            // Update stat cards
            document.getElementById('totalUsers').textContent = data.totalUsers || 0;
            document.getElementById('newUsersToday').textContent = `${data.newUsersToday || 0} new today`;
            document.getElementById('activeUsers').textContent = data.activeUsers || 0;
            document.getElementById('completionRate').textContent = `${data.averageCompletion || 0}%`;
            document.getElementById('labsCompleted').textContent = data.labsCompleted || 0;
        }

        function loadTabData(tabName) {
            switch (tabName) {
                case 'users':
                    loadUsersData();
                    break;
                case 'progress':
                    loadProgressData();
                    break;
                case 'logs':
                    loadLogsData();
                    break;
            }
        }

        async function loadUsersData() {
            try {
                const response = await fetch('/api/admin/users', {
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const users = await response.json();
                    populateUsersTable(users);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                showNotification('Failed to load users data', 'error');
            }
        }

        function populateUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">No users found</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.company || '-'}</td>
                    <td><span class="role-badge ${user.role}">${user.role}</span></td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar-mini">
                                <div class="progress-fill-mini" style="width: ${user.progress || 0}%"></div>
                            </div>
                            <span>${user.progress || 0}%</span>
                        </div>
                    </td>
                    <td>${formatDate(user.lastActive)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline" onclick="editUser('${user.id}')">Edit</button>
                            <button class="btn btn-sm btn-outline" onclick="exportUserData('${user.id}')">Export</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function setupAdminHandlers() {
            // Add user button
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => openUserModal());
            }
            
            // Export buttons
            const exportUsersBtn = document.getElementById('exportUsersBtn');
            if (exportUsersBtn) {
                exportUsersBtn.addEventListener('click', exportAllUsers);
            }
            
            // Modal handlers
            const closeUserModal = document.getElementById('closeUserModal');
            if (closeUserModal) {
                closeUserModal.addEventListener('click', () => {
                    document.getElementById('userModal').style.display = 'none';
                });
            }
            
            // Settings forms
            const generalForm = document.getElementById('generalSettingsForm');
            if (generalForm) {
                generalForm.addEventListener('submit', saveGeneralSettings);
            }
            
            const securityForm = document.getElementById('securitySettingsForm');
            if (securityForm) {
                securityForm.addEventListener('submit', saveSecuritySettings);
            }
        }

        function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            
            if (userId) {
                title.textContent = 'Edit User';
                // Load user data
                loadUserForEdit(userId);
            } else {
                title.textContent = 'Add New User';
                // Reset form
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
            }
            
            modal.style.display = 'flex';
        }

        async function exportAllUsers() {
            try {
                const response = await fetch('/api/admin/export-users', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `velocity-lab-users-${new Date().toISOString().split('T')[0]}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    showNotification('Users exported successfully', 'success');
                }
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Failed to export users', 'error');
            }
        }

        // Helper functions
        function editUser(userId) {
            openUserModal(userId);
        }

        async function saveGeneralSettings(e) {
            e.preventDefault();
            // Implement settings save
            showNotification('General settings saved', 'success');
        }

        async function saveSecuritySettings(e) {
            e.preventDefault();
            // Implement security settings save
            showNotification('Security settings saved', 'success');
        }

        function loadProgressData() {
            // Implement progress analytics loading
            console.log('Loading progress analytics...');
        }

        function loadLogsData() {
            // Implement logs loading
            console.log('Loading system logs...');
        }
    </script>
</body>
</html>