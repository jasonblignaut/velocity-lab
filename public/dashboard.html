<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Velocity Lab Exchange Hybrid Migration</title>
    <meta name="description" content="Track your progress through 42 hands-on tasks in Exchange hybrid migration training">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/css/styles.css" as="style">
    <link rel="preload" href="/js/constants.js" as="script">
    <link rel="preload" href="/js/utils.js" as="script">
    <link rel="preload" href="/app.js" as="script">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/styles.css">
    
    <!-- Meta tags for sharing -->
    <meta property="og:title" content="Exchange Hybrid Migration Lab - Velocity Lab">
    <meta property="og:description" content="Professional MSP training for Exchange hybrid deployments">
    <meta property="og:type" content="website">
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <!-- Additional CSS for dashboard-specific styles -->
    <style>
        /* Dashboard-specific enhancements */
        .dashboard-hero {
            background: linear-gradient(135deg, 
                rgba(0, 122, 255, 0.05) 0%, 
                rgba(52, 199, 89, 0.05) 50%, 
                rgba(255, 149, 0, 0.05) 100%);
            border-bottom: 1px solid var(--border);
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            position: relative;
        }
        
        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            r: 52;
            cx: 60;
            cy: 60;
        }
        
        .progress-ring .bg {
            stroke: var(--gray-200);
        }
        
        .progress-ring .progress {
            stroke: url(#progressGradient);
            stroke-linecap: round;
            stroke-dasharray: 327;
            stroke-dashoffset: 327;
            transition: stroke-dashoffset 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--primary);
        }
        
        .week-expand-icon {
            transition: transform var(--transition-base);
        }
        
        .week-expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Task completion animations */
        @keyframes taskComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .task-card.just-completed {
            animation: taskComplete 0.6s ease-out;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .hero-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-4);
            }
            
            .progress-ring {
                width: 100px;
                height: 100px;
            }
            
            .progress-ring circle {
                r: 42;
                cx: 50;
                cy: 50;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- Navigation -->
    <nav class="nav-glass">
        <div class="container">
            <div class="nav-content">
                <a href="/dashboard.html" class="nav-brand">
                    <img src="/assets/velocity-logo.png" alt="Velocity Logo" class="nav-logo">
                    <span class="font-semibold text-xl">Velocity Lab</span>
                </a>
                
                <div class="nav-links">
                    <a href="/dashboard.html" class="nav-link">Dashboard</a>
                    <a href="/profile.html" class="nav-link">Profile</a>
                    <a href="/admin.html" class="nav-link" id="adminLink" style="display: none;">Admin</a>
                    <span class="text-sm text-secondary" id="userInfo">Loading...</span>
                    <button class="btn btn-secondary btn-sm" id="logout">Sign Out</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
        <!-- Dashboard Hero Section -->
        <section class="dashboard-hero">
            <div class="container">
                <div class="hero">
                    <div class="hero-badge">
                        üöÄ Exchange Hybrid Migration Lab
                    </div>
                    
                    <h1 class="hero-title">
                        Master Hybrid Deployments
                    </h1>
                    
                    <p class="hero-subtitle">
                        Complete 42 hands-on tasks to become proficient in Exchange hybrid migrations. 
                        From Active Directory setup to Microsoft 365 integration.
                    </p>
                    
                    <!-- Progress Overview -->
                    <div class="hero-stats">
                        <div class="stat-item">
                            <div class="progress-ring">
                                <svg>
                                    <defs>
                                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#007aff"/>
                                            <stop offset="50%" style="stop-color:#5ac8fa"/>
                                            <stop offset="100%" style="stop-color:#34c759"/>
                                        </linearGradient>
                                    </defs>
                                    <circle class="bg" />
                                    <circle class="progress" id="progressRing" />
                                </svg>
                                <div class="progress-percentage" id="progressPercentage">0%</div>
                            </div>
                            <div class="stat-label">Overall Progress</div>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-number" id="completedTasks">0</span>
                            <div class="stat-label">Tasks Completed</div>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-number">42</span>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                        
                        <div class="stat-item">
                            <span class="stat-number" id="currentWeek">Week 1</span>
                            <div class="stat-label">Current Focus</div>
                        </div>
                    </div>
                    
                    <div class="hero-actions">
                        <button class="btn btn-primary btn-lg" id="continueBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="5,3 19,12 5,21"></polygon>
                            </svg>
                            <span>Continue Learning</span>
                        </button>
                        
                        <button class="btn btn-secondary btn-lg" id="restartLabBtn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="1,4 1,10 7,10"></polyline>
                                <path d="M3.51,15a9,9 0,0,0,2.13,3.09l1.67,-1.67"></path>
                                <path d="M13,5h8"></path>
                                <path d="M17,1l4,4-4,4"></path>
                            </svg>
                            <span>Start New Lab</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section class="progress-section container">
            <div class="progress-header">
                <h3>Lab Progress</h3>
                <div class="text-sm text-secondary" id="progressText">
                    0% Completed (0/42 tasks)
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- Week Grid -->
        <section class="container">
            <div class="weeks-grid-container">
                
                <!-- Week 1: Foundation Setup -->
                <div class="week-card" data-week="week1">
                    <div class="week-header">
                        <div class="week-badge">
                            <div class="week-number">1</div>
                            <div class="week-icon">üèóÔ∏è</div>
                            <div>
                                <h4 class="week-title">Foundation Setup</h4>
                                <p class="week-description">Windows Server 2012 DC, domain joining, and network shares</p>
                            </div>
                        </div>
                        <div class="week-progress">
                            <span class="week-count" data-week="week1">0/12 tasks</span>
                            <div class="progress-bar">
                                <div class="progress-fill" data-week="week1" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="week-expand" data-week="week1">
                        <span class="expand-text">View Tasks</span>
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    
                    <div class="tasks-container" data-week="week1">
                        <div class="tasks-grid">
                            <!-- Week 1 Tasks will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Week 2: Infrastructure Expansion -->
                <div class="week-card" data-week="week2">
                    <div class="week-header">
                        <div class="week-badge">
                            <div class="week-number">2</div>
                            <div class="week-icon">üè¢</div>
                            <div>
                                <h4 class="week-title">Infrastructure Expansion</h4>
                                <p class="week-description">Second DC, WSUS, and time synchronization</p>
                            </div>
                        </div>
                        <div class="week-progress">
                            <span class="week-count" data-week="week2">0/8 tasks</span>
                            <div class="progress-bar">
                                <div class="progress-fill" data-week="week2" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="week-expand" data-week="week2">
                        <span class="expand-text">View Tasks</span>
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    
                    <div class="tasks-container" data-week="week2">
                        <div class="tasks-grid">
                            <!-- Week 2 Tasks will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Week 3: Email & Messaging -->
                <div class="week-card" data-week="week3">
                    <div class="week-header">
                        <div class="week-badge">
                            <div class="week-number">3</div>
                            <div class="week-icon">üìß</div>
                            <div>
                                <h4 class="week-title">Email & Messaging</h4>
                                <p class="week-description">Server 2016 upgrade and Exchange 2019 deployment</p>
                            </div>
                        </div>
                        <div class="week-progress">
                            <span class="week-count" data-week="week3">0/12 tasks</span>
                            <div class="progress-bar">
                                <div class="progress-fill" data-week="week3" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="week-expand" data-week="week3">
                        <span class="expand-text">View Tasks</span>
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    
                    <div class="tasks-container" data-week="week3">
                        <div class="tasks-grid">
                            <!-- Week 3 Tasks will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Week 4: Cloud Integration -->
                <div class="week-card" data-week="week4">
                    <div class="week-header">
                        <div class="week-badge">
                            <div class="week-number">4</div>
                            <div class="week-icon">‚òÅÔ∏è</div>
                            <div>
                                <h4 class="week-title">Cloud Integration</h4>
                                <p class="week-description">External mail publishing and Microsoft 365 hybrid setup</p>
                            </div>
                        </div>
                        <div class="week-progress">
                            <span class="week-count" data-week="week4">0/10 tasks</span>
                            <div class="progress-bar">
                                <div class="progress-fill" data-week="week4" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="week-expand" data-week="week4">
                        <span class="expand-text">View Tasks</span>
                        <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    </div>
                    
                    <div class="tasks-container" data-week="week4">
                        <div class="tasks-grid">
                            <!-- Week 4 Tasks will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Task Modal -->
    <div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Task Title</h2>
                <button class="modal-close" id="closeModal" aria-label="Close modal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalDescription">
                    <!-- Task description content will be dynamically populated -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div class="notification" id="notification" role="alert" aria-live="assertive">
        <!-- Dynamic notification content -->
    </div>

    <!-- Scripts -->
    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/app.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            window.redirectIfNotAuthenticated();
            
            // Initialize dashboard with task structure from constants
            initDashboard();
            
            // Load user progress and populate tasks
            loadUserProgress();
            
            // Setup event handlers
            setupDashboardHandlers();
        });
        
        function initDashboard() {
            console.log('üéØ Dashboard initializing...');
            
            // Populate tasks for each week
            Object.keys(window.TASK_STRUCTURE).forEach(weekKey => {
                populateWeekTasks(weekKey);
            });
        }
        
        function populateWeekTasks(weekKey) {
            const week = window.TASK_STRUCTURE[weekKey];
            const tasksGrid = document.querySelector(`.tasks-container[data-week="${weekKey}"] .tasks-grid`);
            
            if (!tasksGrid || !week) return;
            
            tasksGrid.innerHTML = week.tasks.map(taskId => {
                const taskDefinition = window.TASK_DEFINITIONS[`${weekKey}-${taskId}`];
                const displayTaskId = taskId.replace(/-/g, '-');
                
                return `
                    <div class="task-card task" data-week="${weekKey}" data-task="${taskId}">
                        <div class="task-header">
                            <input type="checkbox" class="task-checkbox" data-week="${weekKey}" data-task="${taskId}">
                            <div>
                                <h5 class="task-title">${taskDefinition ? taskDefinition.title : taskId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h5>
                                <p class="task-description">${taskDefinition ? taskDefinition.description : 'Task description'}</p>
                            </div>
                        </div>
                        <div class="task-meta">
                            <span>‚è±Ô∏è ${getEstimatedTime(taskId)}</span>
                            <span>üìã ${taskDefinition ? taskDefinition.subtasks.length : 5} steps</span>
                            <span>${getTaskCategory(taskId)}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getEstimatedTime(taskId) {
            const timeMap = {
                'install-server2012': '30 min',
                'configure-static-ip': '15 min',
                'install-adds-role': '20 min',
                'promote-to-dc': '45 min',
                'configure-dns-server': '25 min',
                'create-domain-users': '30 min',
                'setup-vm-dns': '15 min',
                'join-vm-domain': '20 min',
                'create-hidden-share': '25 min',
                'map-drive-gpo': '35 min',
                'map-drive-script': '30 min',
                'create-security-group': '25 min'
            };
            return timeMap[taskId] || '20 min';
        }
        
        function getTaskCategory(taskId) {
            const categoryMap = {
                'install-server2012': 'üéØ Foundation',
                'configure-static-ip': 'üåê Network',
                'install-adds-role': 'üîê Identity',
                'promote-to-dc': 'üè∞ Domain',
                'configure-dns-server': 'üåê DNS',
                'create-domain-users': 'üë• Users',
                'setup-vm-dns': 'üñ•Ô∏è Client',
                'join-vm-domain': 'üîó Domain Join',
                'create-hidden-share': 'üìÅ Shares',
                'map-drive-gpo': 'üìÑ GPO',
                'map-drive-script': 'üíª Script',
                'create-security-group': 'üîí Security'
            };
            return categoryMap[taskId] || '‚öôÔ∏è Config';
        }
        
        async function loadUserProgress() {
            try {
                const response = await window.apiCall('/api/progress');
                if (response.success) {
                    updateProgressDisplay(response.progress);
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                window.showNotification('Failed to load progress', 'error');
            }
        }
        
        function updateProgressDisplay(progress) {
            // Calculate overall progress using the utility function
            const overallProgress = window.VelocityUtils.calculateProgress(progress);
            
            // Update progress ring
            updateProgressRing(overallProgress);
            
            // Update week progress
            updateWeekProgress(progress);
            
            // Update stats
            const totalCompleted = calculateCompletedTasks(progress);
            document.getElementById('completedTasks').textContent = totalCompleted;
            document.getElementById('progressText').textContent = `${overallProgress}% Completed (${totalCompleted}/42 tasks)`;
            
            // Update current week
            updateCurrentWeek(totalCompleted);
            
            // Update checkboxes
            updateTaskCheckboxes(progress);
        }
        
        function updateProgressRing(percentage) {
            const progressRing = document.getElementById('progressRing');
            const progressPercentage = document.getElementById('progressPercentage');
            
            if (progressRing && progressPercentage) {
                const circumference = 2 * Math.PI * 52;
                const offset = circumference - (percentage / 100) * circumference;
                
                progressRing.style.strokeDashoffset = offset;
                progressPercentage.textContent = Math.round(percentage) + '%';
            }
        }
        
        function updateWeekProgress(progress) {
            Object.keys(window.TASK_STRUCTURE).forEach(weekKey => {
                const weekData = window.VelocityUtils.getWeekProgress(progress, weekKey);
                
                const weekProgressBar = document.querySelector(`.progress-fill[data-week="${weekKey}"]`);
                const weekCount = document.querySelector(`.week-count[data-week="${weekKey}"]`);
                
                if (weekProgressBar) {
                    weekProgressBar.style.width = weekData.percentage + '%';
                }
                
                if (weekCount) {
                    weekCount.textContent = `${weekData.completed}/${weekData.total} tasks`;
                }
            });
        }
        
        function calculateCompletedTasks(progress) {
            let completed = 0;
            Object.keys(window.TASK_STRUCTURE).forEach(weekKey => {
                const week = window.TASK_STRUCTURE[weekKey];
                const weekProgress = progress[weekKey] || {};
                
                week.tasks.forEach(taskId => {
                    if (weekProgress[taskId] && weekProgress[taskId].completed) {
                        completed++;
                    }
                });
            });
            return completed;
        }
        
        function updateCurrentWeek(totalCompleted) {
            const currentWeekEl = document.getElementById('currentWeek');
            if (!currentWeekEl) return;
            
            if (totalCompleted < 12) currentWeekEl.textContent = 'Week 1';
            else if (totalCompleted < 20) currentWeekEl.textContent = 'Week 2';
            else if (totalCompleted < 32) currentWeekEl.textContent = 'Week 3';
            else if (totalCompleted < 42) currentWeekEl.textContent = 'Week 4';
            else currentWeekEl.textContent = 'Complete!';
        }
        
        function updateTaskCheckboxes(progress) {
            Object.keys(window.TASK_STRUCTURE).forEach(weekKey => {
                const week = window.TASK_STRUCTURE[weekKey];
                const weekProgress = progress[weekKey] || {};
                
                week.tasks.forEach(taskId => {
                    const checkbox = document.querySelector(`input[data-week="${weekKey}"][data-task="${taskId}"]`);
                    if (checkbox && weekProgress[taskId] && weekProgress[taskId].completed) {
                        checkbox.checked = true;
                    }
                });
            });
        }
        
        function setupDashboardHandlers() {
            // Week expansion functionality
            const weekExpanders = document.querySelectorAll('.week-expand');
            weekExpanders.forEach(expander => {
                expander.addEventListener('click', function() {
                    const week = this.getAttribute('data-week');
                    const tasksContainer = document.querySelector(`.tasks-container[data-week="${week}"]`);
                    const expandIcon = this.querySelector('.expand-icon');
                    const expandText = this.querySelector('.expand-text');
                    
                    if (tasksContainer.classList.contains('show')) {
                        tasksContainer.classList.remove('show');
                        expandIcon.classList.remove('expanded');
                        expandText.textContent = 'View Tasks';
                        tasksContainer.style.maxHeight = '0px';
                    } else {
                        tasksContainer.classList.add('show');
                        expandIcon.classList.add('expanded');
                        expandText.textContent = 'Hide Tasks';
                        const scrollHeight = tasksContainer.scrollHeight;
                        tasksContainer.style.maxHeight = scrollHeight + 'px';
                    }
                });
            });
            
            // Continue button functionality
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    const incompleteTasks = document.querySelectorAll('.task-checkbox:not(:checked)');
                    if (incompleteTasks.length > 0) {
                        const firstIncompleteTask = incompleteTasks[0];
                        const week = firstIncompleteTask.getAttribute('data-week');
                        
                        const tasksContainer = document.querySelector(`.tasks-container[data-week="${week}"]`);
                        if (!tasksContainer.classList.contains('show')) {
                            const expander = document.querySelector(`.week-expand[data-week="${week}"]`);
                            if (expander) expander.click();
                        }
                        
                        setTimeout(() => {
                            firstIncompleteTask.closest('.task-card').scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }, 300);
                    } else {
                        window.showNotification('üéâ All tasks completed! You\'re ready for production hybrid deployments!', 'success', 6000);
                    }
                });
            }
            
            // Restart lab button
            const restartBtn = document.getElementById('restartLabBtn');
            if (restartBtn) {
                restartBtn.addEventListener('click', async function() {
                    if (confirm('Are you sure you want to start a new lab? This will reset all your current progress.')) {
                        try {
                            const response = await window.apiCall('/api/lab/start-new', { method: 'POST' });
                            if (response.success) {
                                window.showNotification('New lab started successfully!', 'success');
                                loadUserProgress();
                            }
                        } catch (error) {
                            console.error('Error starting new lab:', error);
                            window.showNotification('Failed to start new lab', 'error');
                        }
                    }
                });
            }
            
            // Task completion handling
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('task-checkbox')) {
                    handleTaskToggle(e.target);
                }
            });
        }
        
        async function handleTaskToggle(checkbox) {
            const week = checkbox.getAttribute('data-week');
            const task = checkbox.getAttribute('data-task');
            const completed = checkbox.checked;
            
            try {
                const response = await window.apiCall('/api/progress', {
                    method: 'POST',
                    body: JSON.stringify({
                        week,
                        task,
                        completed,
                        completedAt: completed ? new Date().toISOString() : null
                    })
                });
                
                if (response.success) {
                    // Update progress display
                    loadUserProgress();
                    
                    if (completed) {
                        window.showNotification(`‚úÖ Task completed: ${task.replace(/-/g, ' ')}`, 'success');
                    }
                } else {
                    // Revert checkbox if failed
                    checkbox.checked = !completed;
                    window.showNotification('Failed to update progress', 'error');
                }
            } catch (error) {
                console.error('Error updating progress:', error);
                checkbox.checked = !completed;
                window.showNotification('Failed to update progress', 'error');
            }
        }
        
        console.log('üéØ Dashboard enhanced features loaded successfully!');
    </script>
</body>
</html>