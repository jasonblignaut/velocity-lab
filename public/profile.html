<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="My Profile - Velocity Lab">
  <title>My Profile | Velocity Lab</title>
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <a href="#main" class="skip-link">Skip to content</a>
  
  <nav class="nav-glass" role="navigation" aria-label="Main navigation">
    <div class="brand">
      <a href="/">
        <img src="/assets/Velocity-Logo.png" alt="Velocity Lab" class="brand-logo" width="180" height="45">
      </a>
    </div>
    <div class="auth">
      <span id="userInfo" class="user-info"></span>
      <a href="/dashboard.html">Dashboard</a>
      <a href="#" id="logout">Logout</a>
    </div>
  </nav>

  <main id="main" class="container">
    <header class="header">
      <h1>My Profile</h1>
      <h2>Manage your account settings</h2>
    </header>

    <div id="notification" class="notification" role="alert" aria-live="polite"></div>

    <div class="profile-container">
      <!-- Profile Information Section -->
      <div class="profile-section">
        <h3>Profile Information</h3>
        <div class="profile-info">
          <div class="avatar-container">
            <img id="avatarPreview" 
                 src="/assets/default-avatar.png" 
                 alt="User Avatar" 
                 class="avatar"
                 width="120"
                 height="120">
            <form id="avatarForm" style="margin-top: 1rem;">
              <input type="file" 
                     id="avatarInput" 
                     name="avatar" 
                     accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" 
                     style="display: none;"
                     aria-label="Choose avatar image">
              <button type="button" 
                      id="uploadAvatarBtn" 
                      class="btn btn-secondary"
                      style="width: 100%;">
                Upload Avatar
              </button>
              <p style="font-size: 0.875rem; color: var(--primary-gray); margin-top: 0.5rem;">
                Max size: 5MB
              </p>
            </form>
          </div>
          <div class="profile-details">
            <p><strong>Name:</strong> <span id="profileName"></span></p>
            <p><strong>Email:</strong> <span id="profileEmail"></span></p>
            <p><strong>Role:</strong> <span id="profileRole" style="text-transform: capitalize;"></span></p>
            <p><strong>Member Since:</strong> <span id="profileJoined"></span></p>
          </div>
        </div>
      </div>

      <!-- Progress Statistics Section -->
      <div class="profile-section">
        <h3>Your Progress</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalProgress">0%</div>
            <div class="stat-label">Overall Progress</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completedTasks">0/14</div>
            <div class="stat-label">Tasks Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="currentWeek">Week 1</div>
            <div class="stat-label">Current Focus</div>
          </div>
        </div>
      </div>

      <!-- Change Password Section -->
      <div class="profile-section">
        <h3>Change Password</h3>
        <form id="passwordForm" novalidate>
          <input type="hidden" id="csrfToken" name="csrf_token">
          
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" 
                   id="currentPassword" 
                   name="currentPassword" 
                   required
                   autocomplete="current-password"
                   aria-describedby="current-password-error">
            <span id="current-password-error" class="error-text" role="alert"></span>
          </div>
          
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" 
                   id="newPassword" 
                   name="newPassword" 
                   required
                   autocomplete="new-password"
                   minlength="8"
                   aria-describedby="new-password-error new-password-requirements">
            <span id="new-password-error" class="error-text" role="alert"></span>
            <div id="new-password-requirements" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--primary-gray);">
              Password must contain at least 8 characters
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" 
                   id="confirmPassword" 
                   name="confirmPassword" 
                   required
                   autocomplete="new-password"
                   aria-describedby="confirm-password-error">
            <span id="confirm-password-error" class="error-text" role="alert"></span>
          </div>
          
          <div class="form-group">
            <button type="submit" class="btn btn-primary">
              <span>Update Password</span>
              <span class="spinner" aria-hidden="true"></span>
            </button>
          </div>
        </form>
      </div>

      <!-- Account Actions Section -->
      <div class="profile-section" style="background: var(--surface-light); padding: 1.5rem; border-radius: var(--radius-md);">
        <h3 style="color: var(--primary-gray); font-size: 1.2rem;">Account Actions</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button class="btn btn-secondary" onclick="exportMyData()">
            Export My Data
          </button>
          <button class="btn btn-secondary" style="background: #dc3545; border-color: #dc3545; color: white;" onclick="confirmDeleteAccount()">
            Delete Account
          </button>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/main.js" defer></script>
  <script>
    // Additional profile-specific functions
    async function exportMyData() {
      try {
        const response = await fetch('/api/user/export', {
          credentials: 'same-origin'
        });
        
        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `velocity-lab-data-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          
          window.VelocityLab.showNotification('Your data has been exported', 'success');
        }
      } catch (error) {
        console.error('Export error:', error);
        window.VelocityLab.showNotification('Failed to export data', 'error');
      }
    }

    function confirmDeleteAccount() {
      if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        if (confirm('This will permanently delete all your data. Are you absolutely sure?')) {
          // Handle account deletion
          window.VelocityLab.showNotification('Please contact support to delete your account', 'info');
        }
      }
    }
  </script>
</body>
</html>