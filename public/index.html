<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Velocity Lab</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <script src="/assets/task-definitions.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #007AFF; --primary-hover: #0056CC; --success: #34C759; --warning: #FF9500; --error: #FF3B30;
            --text-primary: #1D1D1F; --text-secondary: #6B7280; --text-tertiary: #9CA3AF;
            --background: #F2F2F7; --surface: #FFF; --surface-secondary: #F9F9F9;
            --border: #D1D1D6; --border-light: #E5E5EA; --shadow-color: rgba(0,0,0,.05);
            --shadow-light: 0 1px 3px var(--shadow-color); --shadow-medium: 0 4px 12px var(--shadow-color);
            --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px;
            --transition: background-color .3s ease, transform .3s ease;
            --dark-primary: #0A84FF; --dark-text-primary: #FFF; --dark-text-secondary: #9CA3AF;
            --dark-background: #000; --dark-surface: #1C1C1E; --dark-surface-secondary: #2C2C2E;
            --dark-border: #38383A; --dark-border-light: #48484A; --dark-shadow-color: rgba(0,0,0,.3);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background); color: var(--text-primary); line-height: 1.5;
            font-size: 16px; -webkit-font-smoothing: antialiased; overflow-x: hidden;
        }
        body.dark {
            background: var(--dark-background); color: var(--dark-text-primary);
            --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary);
            --surface: var(--dark-surface); --surface-secondary: var(--dark-surface-secondary);
            --border: var(--dark-border); --border-light: var(--dark-border-light);
            --primary: var(--dark-primary); --shadow-color: var(--dark-shadow-color);
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        header {
            position: fixed; top: 0; width: 100%; background: rgba(255,255,255,.85);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-light);
            z-index: 1000; transition: var(--transition);
        }
        body.dark header { background: rgba(28,28,30,.85); }
        nav { height: 56px; display: flex; justify-content: space-between; align-items: center; }
        .logo img { height: 32px; transition: var(--transition); }
        .logo img:hover { transform: scale(1.05); }
        .nav-right { display: flex; align-items: center; gap: 8px; }
        .btn {
            padding: 8px 16px; border-radius: var(--radius-lg); border: none;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition);
            min-height: 36px; white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .btn-secondary { background: var(--surface); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--surface-secondary); transform: translateY(-1px); }
        .btn-admin { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
        .btn-admin:hover { transform: translateY(-1px); box-shadow: var(--shadow-medium); }
        .lab-button-container { position: relative; display: inline-block; }
        .lab-dropdown {
            position: absolute; top: 100%; right: 0; background: var(--surface);
            border: 1px solid var(--border); border-radius: var(--radius-md);
            box-shadow: var(--shadow-medium); min-width: 200px; z-index: 1001; display: none;
        }
        .lab-dropdown.show { display: block; }
        .lab-dropdown-item {
            padding: 12px 16px; cursor: pointer; transition: var(--transition);
            border-bottom: 1px solid var(--border-light);
        }
        .lab-dropdown-item:last-child { border-bottom: none; }
        .lab-dropdown-item:hover { background: var(--surface-secondary); }
        .theme-selector {
            padding: 8px; border: 1px solid var(--border); border-radius: var(--radius-md);
            background: var(--surface); color: var(--text-primary); font-size: 14px;
            font-weight: 600; cursor: pointer; min-width: 100px;
        }
        .theme-selector:focus { outline: 2px solid var(--primary); }
        .hidden { display: none !important; }
        #landing {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            text-align: center; padding-top: 56px; background: var(--background);
            color: var(--text-primary);
        }
        #landing h1 { font-size: clamp(36px, 8vw, 64px); font-weight: 700; margin-bottom: 24px; }
        #landing p { font-size: 18px; opacity: .9; max-width: 600px; margin: 0 auto 32px; }
        .landing-actions { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
        #dashboard { padding: 80px 0 40px; min-height: 100vh; }
        .progress-card {
            background: var(--surface); border-radius: var(--radius-xl); padding: 24px;
            margin-bottom: 24px; box-shadow: var(--shadow-light); text-align: center;
            border: 1px solid var(--border-light);
        }
        .progress-ring { width: 140px; height: 140px; margin: 0 auto 24px; position: relative; }
        .progress-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .progress-ring .background { stroke: var(--border); }
        .progress-ring .foreground { stroke: var(--primary); stroke-dasharray: calc(2 * 3.14159 * 65); }
        .progress-percentage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 28px; font-weight: 700; color: var(--primary);
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin: 24px 0; }
        .stat { text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); margin-bottom: 4px; }
        .stat-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; }
        .weeks-container { display: flex; flex-direction: column; gap: 16px; }
        .week-card {
            background: var(--surface); border-radius: var(--radius-xl); overflow: hidden;
            border: 1px solid var(--border-light); box-shadow: var(--shadow-light);
        }
        .week-card[aria-expanded="true"] .expand-icon { transform: rotate(90deg); }
        .week-header {
            padding: 16px; cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: var(--transition);
        }
        .week-header:hover { background: var(--surface-secondary); }
        .week-info h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .week-info p { color: var(--text-secondary); font-size: 13px; }
        .week-progress { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .progress-text { font-size: 13px; font-weight: 600; }
        .progress-bar { width: 80px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); transition: width .3s ease; }
        .expand-icon { width: 18px; height: 18px; color: var(--text-secondary); transition: var(--transition); }
        .tasks-container { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
        .week-card[aria-expanded="true"] .tasks-container { max-height: 2000px; }
        .tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; padding: 16px; }
        .task-item {
            background: var(--surface-secondary); border-radius: var(--radius-md); padding: 12px;
            cursor: pointer; transition: var(--transition); border: 1px solid var(--border-light);
            display: flex; align-items: center; gap: 12px;
        }
        .task-item:hover { background: var(--surface); transform: translateY(-1px); }
        .task-item.completed { background: rgba(52,199,89,.1); border-color: var(--success); }
        .task-checkbox {
            width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px;
            cursor: pointer; appearance: none; transition: var(--transition);
        }
        .task-checkbox:checked { background: var(--success); border-color: var(--success); }
        .task-checkbox:checked::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 11px; }
        .task-content { flex: 1; }
        .task-title { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .task-description { font-size: 12px; color: var(--text-secondary); }
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5);
            backdrop-filter: blur(10px); z-index: 2000; padding: 16px; justify-content: center; align-items: center;
        }
        .modal[aria-hidden="false"] { display: flex; }
        .modal-content {
            background: var(--surface); border-radius: var(--radius-xl); padding: 24px;
            max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 25px var(--shadow-color);
        }
        .modal-branded {
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            background-color: rgba(255,255,255,.92); position: relative;
        }
        body.dark .modal-branded { background-color: rgba(28,28,30,.92); }
        .modal-logo { display: block; margin: 0 auto 16px; max-height: 40px; max-width: 100%; }
        .task-notes-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light); }
        #task-notes {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);
            font-size: 14px; resize: vertical; transition: var(--transition);
        }
        #task-notes:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .modal-title { font-size: 20px; font-weight: 700; }
        .modal-close {
            width: 28px; height: 28px; border-radius: 50%; background: var(--surface-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition);
        }
        .modal-close:hover { background: var(--border); }
        .modal-close svg { width: 16px; height: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: var(--radius-md);
            font-size: 15px; transition: var(--transition); background: var(--surface);
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,122,255,.1); }
        .form-label { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer; }
        .notification {
            position: fixed; top: 80px; right: 16px; padding: 12px 20px; border-radius: var(--radius-md);
            color: #fff; font-weight: 600; transform: translateX(300px); transition: var(--transition);
            box-shadow: 0 4px 12px var(--shadow-color); z-index: 3000; aria-live: "assertive";
        }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }
        .admin-content { max-width: 1000px; width: 100%; }
        .admin-tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--surface-secondary); padding: 4px; border-radius: var(--radius-md); }
        .admin-tab {
            flex: 1; padding: 12px; text-align: center; border-radius: var(--radius-md);
            cursor: pointer; transition: var(--transition); font-weight: 600; color: var(--text-secondary);
        }
        .admin-tab.active { background: var(--surface); color: var(--primary); }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        .admin-table {
            width: 100%; border-collapse: collapse; background: var(--surface);
            border-radius: var(--radius-md); overflow: hidden; box-shadow: var(--shadow-light);
        }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-light); }
        .admin-table th { background: var(--surface-secondary); font-weight: 700; color: var(--text-secondary); font-size: 12px; }
        .leaderboard-table th { scope: col; }
        .rank-cell { text-align: center; font-weight: bold; }
        .medal-icon { font-size: 18px; margin-right: 4px; }
        .progress-container { display: flex; align-items: center; gap: 8px; }
        .progress-bar-mini { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .progress-fill-mini { height: 100%; background: var(--primary); transition: width .3s ease; }
        .progress-text-mini { font-size: 12px; font-weight: 600; min-width: 30px; }
        .notes-badge { background: var(--primary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 11px; }
        .user-card {
            background: var(--surface); border-radius: var(--radius-md); padding: 12px;
            margin-bottom: 12px; border: 1px solid var(--border-light); display: flex; justify-content: space-between;
        }
        .user-card:hover { box-shadow: var(--shadow-light); transform: translateY(-1px); }
        .user-info h4 { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .user-info p { font-size: 13px; color: var(--text-secondary); }
        .user-actions { display: flex; gap: 8px; }
        .user-progress-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin: 8px 0; width: 80px; }
        .user-progress-fill { height: 100%; background: var(--primary); transition: width .3s ease; }
        .loading { width: 14px; height: 14px; border: 2px solid var(--border); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .container { padding: 0 12px; }
            .tasks-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 16px; margin: 8px; }
            .modal-logo { max-height: 32px; }
            .admin-tabs { flex-direction: column; }
            .user-card { flex-direction: column; align-items: flex-start; gap: 12px; }
            .user-actions { width: 100%; justify-content: flex-end; }
            .leaderboard-table th, .leaderboard-table td { padding: 8px 4px; font-size: 12px; }
        }
        @media (max-width: 480px) {
            #landing h1 { font-size: 32px; }
            #landing p { font-size: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo">
                <img src="/assets/Velocity-Logo.png" alt="Velocity Lab Logo" aria-label="Velocity Lab">
            </div>
            <div class="nav-right">
                <span id="auth-buttons">
                    <button onclick="showLogin()" class="btn btn-secondary" aria-label="Sign In">Sign In</button>
                    <button onclick="showRegister()" class="btn btn-primary" aria-label="Register">Register</button>
                </span>
                <span id="user-menu" class="hidden">
                    <span id="user-name" style="margin-right:8px;font-weight:600"></span>
                    <button id="admin-button" class="btn btn-admin hidden" onclick="showAdmin()" aria-label="Admin Portal">Admin</button>
                    <button onclick="authSystem.logout()" class="btn btn-secondary" aria-label="Sign Out">Sign Out</button>
                    <select id="theme-selector" class="theme-selector" onchange="uiSystem.changeTheme(this.value)" aria-label="Select Theme">
                        <option value="auto">Auto</option>
                        <option value="light">Light Jedi</option>
                        <option value="dark">Dark Sith</option>
                    </select>
                </span>
            </div>
        </nav>
    </header>
    <main>
        <section id="landing" aria-labelledby="landing-title">
            <div class="container">
                <h1 id="landing-title">Master Exchange Hybrid</h1>
                <p>42 tasks over 4 weeks. Build a lab with DCs, Exchange Server, and VMs.</p>
                <div class="landing-actions">
                    <button class="btn btn-primary" onclick="showRegister()" aria-label="Get Started">Get Started</button>
                    <button class="btn btn-secondary" onclick="showLogin()" aria-label="Sign In">Sign In</button>
                </div>
            </div>
        </section>
        <section id="dashboard" class="hidden" aria-labelledby="dashboard-title">
            <div class="container">
                <div class="progress-card">
                    <h2 id="dashboard-title">Training Progress</h2>
                    <div class="progress-ring">
                        <svg viewBox="0 0 140 140" aria-label="Overall Progress">
                            <circle cx="70" cy="70" r="65" class="background" />
                            <circle cx="70" cy="70" r="65" class="foreground" id="progress-ring" />
                        </svg>
                        <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat"><div class="stat-value" id="completed-tasks">0</div><div class="stat-label">Tasks Done</div></div>
                        <div class="stat"><div class="stat-value">42</div><div class="stat-label">Total Tasks</div></div>
                        <div class="stat"><div class="stat-value" id="current-week">Week 1</div><div class="stat-label">Current</div></div>
                        <div class="stat"><div class="stat-value">3</div><div class="stat-label">VMs</div></div>
                    </div>
                    <div class="lab-button-container">
                        <button class="btn btn-primary" onclick="uiSystem.toggleLabDropdown()" aria-haspopup="true" aria-expanded="false">Start New Lab ▼</button>
                        <div class="lab-dropdown" id="lab-dropdown" role="menu">
                            <div class="lab-dropdown-item" onclick="labSystem.startNew();uiSystem.closeLabDropdown()" role="menuitem">🚀 Start Fresh Lab</div>
                            <div class="lab-dropdown-item" onclick="uiSystem.showLabHistory();uiSystem.closeLabDropdown()" role="menuitem">📅 Lab History</div>
                        </div>
                    </div>
                </div>
                <div class="weeks-container" id="weeks-container">
                    <div class="week-card" id="week1-card" role="region" aria-expanded="false" aria-labelledby="week1-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week1')" role="button" tabindex="0">
                            <div class="week-info"><h3 id="week1-title">Week 1: Foundation</h3><p>DC setup, domain join, file shares</p></div>
                            <div class="week-progress"><div class="progress-text"><span id="week1-completed">0</span>/13 tasks</div><div class="progress-bar"><div class="progress-fill" id="week1-progress"></div></div></div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"></polyline></svg>
                        </div>
                        <div class="tasks-container"><div class="tasks-grid" id="week1-tasks-grid"></div></div>
                    </div>
                    <div class="week-card" id="week2-card" role="region" aria-expanded="false" aria-labelledby="week2-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week2')" role="button" tabindex="0">
                            <div class="week-info"><h3 id="week2-title">Week 2: Infrastructure</h3><p>Second DC, WSUS, time sync</p></div>
                            <div class="week-progress"><div class="progress-text"><span id="week2-completed">0</span>/8 tasks</div><div class="progress-bar"><div class="progress-fill" id="week2-progress"></div></div></div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"></polyline></svg>
                        </div>
                        <div class="tasks-container"><div class="tasks-grid" id="week2-tasks-grid"></div></div>
                    </div>
                    <div class="week-card" id="week3-card" role="region" aria-expanded="false" aria-labelledby="week3-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week3')" role="button" tabindex="0">
                            <div class="week-info"><h3 id="week3-title">Week 3: Exchange</h3><p>DC upgrades, Exchange 2019 setup</p></div>
                            <div class="week-progress"><div class="progress-text"><span id="week3-completed">0</span>/12 tasks</div><div class="progress-bar"><div class="progress-fill" id="week3-progress"></div></div></div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"></polyline></svg>
                        </div>
                        <div class="tasks-container"><div class="tasks-grid" id="week3-tasks-grid"></div></div>
                    </div>
                    <div class="week-card" id="week4-card" role="region" aria-expanded="false" aria-labelledby="week4-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week4')" role="button" tabindex="0">
                            <div class="week-info"><h3 id="week4-title">Week 4: Hybrid</h3><p>M365 integration, hybrid mail</p></div>
                            <div class="week-progress"><div class="progress-text"><span id="week4-completed">0</span>/10 tasks</div><div class="progress-bar"><div class="progress-fill" id="week4-progress"></div></div></div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"></polyline></svg>
                        </div>
                        <div class="tasks-container"><div class="tasks-grid" id="week4-tasks-grid"></div></div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <div id="login-modal" class="modal" role="dialog" aria-labelledby="login-title" aria-hidden="true">
        <div class="modal-content modal-branded">
            <img src="/assets/Velocity-Logo.png" alt="Velocity Logo" class="modal-logo">
            <div class="modal-header">
                <h2 class="modal-title" id="login-title">Sign In</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
            </div>
            <form id="login-form">
                <div class="form-group"><input type="email" name="email" placeholder="Email" required class="form-input" aria-label="Email"></div>
                <div class="form-group"><input type="password" name="password" placeholder="Password" required class="form-input" aria-label="Password"></div>
                <div class="form-group"><label class="form-label"><input type="checkbox" name="remember" class="form-checkbox" aria-label="Remember me">Remember me</label></div>
                <button type="submit" class="btn btn-primary" style="width:100%" aria-label="Sign In">Sign In</button>
                <p style="text-align:center;color:var(--text-secondary)">New? <a href="#" onclick="showRegister()" style="color:var(--primary)">Create account</a></p>
            </form>
        </div>
    </div>
    <div id="register-modal" class="modal" role="dialog" aria-labelledby="register-title" aria-hidden="true">
        <div class="modal-content modal-branded">
            <img src="/assets/Velocity-Logo.png" alt="Velocity Logo" class="modal-logo">
            <div class="modal-header">
                <h2 class="modal-title" id="register-title">Create Account</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
            </div>
            <form id="register-form">
                <div class="form-group"><input type="text" name="name" placeholder="Full name" required class="form-input" aria-label="Full name"></div>
                <div class="form-group"><input type="email" name="email" placeholder="Email" required class="form-input" aria-label="Email"></div>
                <div class="form-group"><input type="password" name="password" placeholder="Password (8+ chars)" required minlength="8" class="form-input" aria-label="Password"></div>
                <button type="submit" class="btn btn-primary" style="width:100%;" aria-label="Create Account">Create Account</button>
                <p style="text-align:center;color:var(--text-secondary)">Have account? <a href="#" onclick="showLogin()" style="color:var(--primary)">Sign in</a></p>
            </form>
        </div>
    </div>
    <div id="task-modal" class="modal" role="dialog" aria-labelledby="task-title" aria-hidden="true">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header">
                <h2 class="modal-title" id="task-title"></h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
            </div>
            <div id="task-content"></div>
            <div class="task-notes-section">
                <h3 style="font-size: 15px; margin-bottom: 8px;">📝 Notes</h3>
                <textarea id="task-notes" placeholder="Add notes..." maxlength="500" rows="4" aria-label="Task Notes"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                    <small id="notes-counter" style="color: var(--text-secondary);">0/500</small>
                    <button id="save-notes-btn" class="btn btn-secondary" onclick="taskSystem.saveNotes()">💾 Save</button>
                </div>
            </div>
        </div>
    </div>
    <div id="lab-history-modal" class="modal" role="dialog" aria-labelledby="lab-history-title" aria-hidden="true">
        <div class="modal-content" style="max-width:600px">
            <div class="modal-header">
                <h2 class="modal-title" id="lab-history-title">Lab History</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
            </div>
            <div id="lab-history-content"></div>
        </div>
    </div>
    <div id="admin-modal" class="modal" role="dialog" aria-labelledby="admin-title" aria-hidden="true">
        <div class="admin-content modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="admin-title">Admin Portal</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12" /></svg></button>
            </div>
            <div class="admin-tabs" role="tablist">
                <div class="admin-tab active" onclick="adminSystem.switchTab('leaderboard')" role="tab" aria-selected="true" id="tab-leaderboard">Leaderboard</div>
                <div class="admin-tab" onclick="adminSystem.switchTab('users')" role="tab" aria-selected="false" id="tab-users">Users</div>
                <div class="admin-tab" onclick="adminSystem.switchTab('data')" role="tab" aria-selected="false" id="tab-data">Data Tools</div>
            </div>
            <div id="admin-leaderboard" class="admin-section active" role="tabpanel" aria-labelledby="tab-leaderboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">🏆 Leaderboard</h3>
                    <button class="btn btn-secondary" onclick="adminSystem.refreshLeaderboard()" style="padding: 6px 12px; font-size: 13px;" aria-label="Refresh">🔄 Refresh</button>
                </div>
                <table class="admin-table">
                    <thead><tr><th>Rank</th><th>Student</th><th>Progress</th><th>Tasks</th><th>Notes</th><th>Last Active</th></tr></thead>
                    <tbody id="leaderboard-body"></tbody>
                </table>
            </div>
            <div id="admin-users" class="admin-section" role="tabpanel" aria-labelledby="tab-users">
                <div id="users-list"></div>
            </div>
            <div id="admin-data" class="admin-section" role="tabpanel" aria-labelledby="tab-data">
                <div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="adminSystem.exportProgress()">Export CSV</button><input type="file" accept=".csv" id="import-file" style="display:none;" onchange="adminSystem.importProgress(this.files[0])"><button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Import</button></div>
            </div>
        </div>
    </div>
    <div id="notification" class="notification" role="alert"></div>
    <script>
        const tasksByWeek = {
            1: ["install-server2012", "configure-static-ip", "install-adds-role", "promote-toad", "configure-dns-server", "create-domain-users", "join-vm-domain", "create-hidden-task", "map-drive-gpo", "map-drive-script", "map-drive-powershell", "create-security-group", "restrict-share-task"],
            2: ["install-second-task", "promote-additional-dc", "install-wsus-role", "configure-wsus-task", "setup-wsus-gpo", "configure-primary-task", "configure-time-task", "test-infrastructure-task"],
            3: ["backup-tasks", "upgrade-task", "upgrade-second-task", "raise-functional-task", "install-exchange", "install-exchange-prereqs", "extend-ad-task", "install-exchange-task", "configure-exchange-task", "create-mailboxes", "test-mailbox-task", "configure-internal-mailflow"],
            4: ["configure-external-dns", "setup-firewall-rules", "install-ssl-certificate", "configure-external-task", "setup-modern-task", "prepare-m365-task", "install-aad-connect", "run-hybrid-task", "configure-hybrid-mailflow", "verify-hybrid-task"]
        };
        let appState = { user: null, progress: {}, authenticated: false, sessionToken: null };
        const utils = {
            getId: id => document.getElementById(id),
            show: el => el?.classList.remove("hidden"),
            hide: el => el?.classList.add("hidden"),
            cookies: {
                get: name => document.cookie.match(`(?:^|;)${name}=([^;]*)`)?.[1],
                set: (name, value, days=8) => document.cookie = `${name}=${value};path=/;Max-Age=${days*86400};SameSite=Strict;${location.protocol.toLowerCase() === "https:" ? "Secure" : ""}`,
                delete: name => document.cookie = `${name}=;path=/;Max-Age=0;SameSite=Strict`
            }
        };
        function showNotification(msg, type = "success") {
            const n = utils.getId("notification");
            n.textContent = msg;
            n.className = `notification ${type} show`;
            setTimeout(() => n.classList.remove("show"), 3000);
        }
        async function apiCall(endpoint, options = {}) {
            const headers = new Headers(options.headers || {});
            if (appState.sessionToken) headers.set("Authorization", `Bearer ${appState.sessionToken}`);
            const isGet = !options.method || options.method.toUpperCase() === "GET";
            let body = options.body;
            if (!isGet) {
                body = options.body instanceof FormData ? options.body : new FormData();
                if (!(options.body instanceof FormData)) Object.entries(options.body || {}).forEach(([k, v]) => body.append(k, v));
                body.append("csrf_token", "static-csrf-token-12345");
            }
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    const response = await fetch(endpoint, {
                        credentials: "same-origin", headers, method: options.method || "GET", body,
                        signal: AbortSignal.timeout(30000)
                    });
                    if (!response.ok) throw new Error(`Server error (${response.status})`);
                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || "Request failed");
                    return data;
                } catch (error) {
                    if (attempt === 3) {
                        showNotification(error.message || "Request failed", "error");
                        throw error;
                    }
                }
            }
        }
        function showLogin() {
            closeModal();
            const m = utils.getId("login-modal");
            m.style.display = "flex";
            m.setAttribute("aria-hidden", "false");
            m.querySelector("input[name='email']").focus();
        }
        function showRegister() {
            closeModal();
            const m = utils.getId("register-modal");
            m.style.display = "flex";
            m.setAttribute("aria-hidden", "false");
            m.querySelector("input[name='name']").focus();
        }
        function closeModal() {
            document.querySelectorAll(".modal").forEach(m => {
                m.style.display = "none";
                m.setAttribute("aria-hidden", "true");
            });
        }
        const authSystem = {
            async checkSession() {
                const user = utils.cookies.get("user");
                const session = utils.cookies.get("session");
                if (!user || !session) return;
                try {
                    appState.user = JSON.parse(decodeURIComponent(user));
                    appState.sessionToken = session;
                    appState.authenticated = true;
                    if (appState.user.role === "admin") utils.show(utils.getId("admin-button"));
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                } catch (e) {
                    this.logout();
                }
            },
            async login(formData) {
                try {
                    const { name, role, email, sessionToken } = await apiCall("/api/login", { method: "POST", body: formData });
                    utils.cookies.set("user", encodeURIComponent(JSON.stringify({ name, role, email })));
                    utils.cookies.set("session", sessionToken);
                    appState.user = { name, role, email };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    if (role === "admin") utils.show(utils.getId("admin-button"));
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                    closeModal();
                    showNotification("Welcome back, " + name + "!");
                } catch (e) {
                    showNotification(e.message || "Login failed", "error");
                }
            },
            async register(formData) {
                try {
                    const { name, role, sessionToken, email } = await apiCall("/api/register", { method: "POST", body: formData });
                    utils.cookies.set("user", encodeURIComponent(JSON.stringify({ name, role, email })));
                    utils.cookies.set("session", sessionToken);
                    appState.user = { name, role, email };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                    closeModal();
                    showNotification("Welcome, " + name + "!");
                } catch (e) {
                    showNotification(e.message || "Registration failed", "error");
                }
            },
            logout() {
                apiCall("/api/logout", { method: "POST" }).catch(e => console.error("Logout failed:", e));
                utils.cookies.delete("user");
                utils.cookies.delete("session");
                appState = { user: null, progress: {}, authenticated: false, sessionToken: null };
                utils.hide(utils.getId("admin-button"));
                uiSystem.showLanding();
                showNotification("Signed out");
            }
        };
        const uiSystem = {
            showLanding() {
                utils.hide(utils.getId("dashboard"));
                utils.show(utils.getId("landing"));
                utils.hide(utils.getId("user-menu"));
                utils.show(utils.getId("auth-buttons"));
            },
            showDashboard() {
                utils.show(utils.getId("dashboard"));
                utils.hide(utils.getId("landing"));
                utils.show(utils.getId("user-menu"));
                utils.hide(utils.getId("auth-buttons"));
                utils.getId("user-name").textContent = appState.user?.name || "";
            },
            toggleLabDropdown() {
                const d = utils.getId("lab-dropdown");
                const b = document.querySelector(".lab-button-container .btn");
                const is = d.classList.toggle("show");
                b.setAttribute("aria-expanded", is.toString());
                if (is) document.addEventListener("click", e => !d.contains(e.target) && !b.contains(e.target) && this.closeLabDropdown(), { once: true });
            },
            closeLabDropdown() {
                const d = utils.getId("lab-dropdown");
                const b = document.querySelector(".lab-button-container .btn");
                d.classList.remove("show");
                b.setAttribute("aria-expanded", "false");
            },
            showLabHistory() {
                closeModal();
                const m = labHistoryModal();
                m.style.display = "flex";
                m.setAttribute("aria-hidden", "false");
                labSystem.loadHistory();
            },
            changeTheme(theme) {
                if (theme === "auto") {
                    document.body.classList.remove("dark", "light");
                    localStorage.removeItem("theme");
                } else {
                    document.body.classList.remove("dark", "light");
                    document.body.classList.add(theme);
                    localStorage.setItem("theme", theme);
                }
            },
            initTheme() {
                const saved = localStorage.getItem("theme");
                const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                if (saved) this.changeTheme(saved);
                else if (prefersDark) this.changeTheme("dark");
                utils.getId("theme-selector").value = saved || "auto";
            }
        };
        const progressSystem = {
            observer: null,
            initObserver() {
                this.observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const id = entry.target.id.replace("-card", "");
                            this.loadWeekTasks(id);
                            this.observer.unobserve(entry.target);
                        }
                    });
                }, { rootMargin: "100px" });
                document.querySelectorAll(".week-card").forEach(card => this.observer.observe(card));
            },
            async loadProgress() {
                try {
                    const { data } = await apiCall("/api/progress");
                    appState.progress = data;
                    this.updateProgressUI();
                    this.initObserver();
                } catch (e) {
                    showNotification("Failed to load progress", "error");
                }
            },
            updateProgressUI() {
                const totalTasks = Object.values(tasksByWeek).flat().length;
                const completed = Object.values(appState.progress).filter(t => t.completed).length;
                const percentage = Math.round((completed / totalTasks) * 100);
                const ring = utils.getId("progress-ring");
                const offset = (1 - percentage / 100) * (2 * Math.PI * 65);
                ring.style.strokeDashoffset = offset;
                utils.getId("progress-percentage").textContent = `${percentage}%`;
                utils.getId("completed-tasks").textContent = completed;
                utils.getId("current-week").textContent = `Week ${Math.min(Math.floor(completed / 10) + 1, 4)}`;
                Object.keys(tasksByWeek).forEach(week => this.updateWeekProgress(`week${week}`));
            },
            updateWeekProgress(weekId) {
                const week = weekId.replace("week", "");
                const tasks = tasksByWeek[week] || [];
                const completed = tasks.filter(id => appState.progress[`${week}-${id}`]?.completed).length;
                const progress = tasks.length ? (completed / tasks.length) * 100 : 0;
                utils.getId(`${weekId}-completed`).textContent = completed;
                utils.getId(`${weekId}-progress`).style.width = `${progress}%`;
            },
            async loadWeekTasks(weekId) {
                const week = weekId.replace("week", "");
                const grid = utils.getId(`${weekId}-tasks-grid`);
                if (grid.dataset.loaded) return;
                grid.dataset.loaded = "true";
                const fragment = document.createDocumentFragment();
                tasksByWeek[week].forEach(taskId => {
                    const task = appState.progress[`${week}-${taskId}`] || {};
                    const div = document.createElement("div");
                    div.className = `task-item ${task.completed ? "completed" : ""}`;
                    div.innerHTML = `
                        <input type="checkbox" class="task-checkbox" ${task.completed ? "checked" : ""} 
                            onchange="progressSystem.toggleTask('${week}', '${taskId}', this.checked)" aria-label="${taskId.replace(/-/g, " ")}">
                        <div class="task-content">
                            <div class="task-title">${taskId.replace(/-/g, " ").replace(/\b\w/g, l => l.toUpperCase())}</div>
                            <div class="task-description">${task.description || "Click for details"}</div>
                        </div>
                    `;
                    div.onclick = e => {
                        if (e.target.type !== "checkbox") taskSystem.openModal(week, taskId);
                    };
                    fragment.appendChild(div);
                });
                grid.appendChild(fragment);
            },
            toggleWeek(weekId) {
                const card = utils.getId(`${weekId}-card`);
                const isExpanded = card.getAttribute("aria-expanded") === "true";
                card.setAttribute("aria-expanded", (!isExpanded).toString());
                if (!isExpanded && !card.querySelector(".tasks-grid").dataset.loaded) {
                    this.loadWeekTasks(weekId);
                }
            },
            async toggleTask(week, taskId, completed) {
                try {
                    await apiCall("/api/progress", {
                        method: "POST",
                        body: { week, task: taskId, completed }
                    });
                    appState.progress[`${week}-${taskId}`] = { ...appState.progress[`${week}-${taskId}`], completed };
                    this.updateProgressUI();
                    showNotification(`Task ${completed ? "completed" : "marked incomplete"}!`);
                } catch (e) {
                    showNotification("Failed to update task", "error");
                }
            }
        };
        const labSystem = {
            async startNew() {
                try {
                    await apiCall("/api/lab/start", { method: "POST" });
                    showNotification("New lab started!");
                } catch (e) {
                    showNotification("Failed to start lab", "error");
                }
            },
            async loadHistory() {
                const content = utils.getId("lab-history-content");
                try {
                    const { data } = await apiCall("/api/lab/history");
                    content.innerHTML = data.length ? data.map(lab => `
                        <div class="user-card">
                            <div class="user-info">
                                <h4>Lab ${lab.id}</h4>
                                <p>Started: ${new Date(lab.startTime).toLocaleString()}</p>
                                <p>Status: ${lab.status}</p>
                            </div>
                        </div>
                    `).join("") : "<p>No lab history available.</p>";
                } catch (e) {
                    content.innerHTML = "<p>Failed to load history.</p>";
                }
            }
        };
        const taskSystem = {
            currentTask: { week: null, taskId: null },
            openModal(week, taskId) {
                if (!appState.authenticated) {
                    showNotification("Please sign in to view task details", "error");
                    showLogin();
                    return;
                }
                this.currentTask = { week, taskId };
                const taskKey = `${week}-${taskId}`;
                const taskDef = TASK_DEFINITIONS?.[taskKey] || {
                    title: taskId.replace(/-/g, " ").replace(/\b\w/g, l => l.toUpperCase()),
                    description: "No details available."
                };
                utils.getId("task-title").textContent = taskDef.title;
                utils.getId("task-content").innerHTML = taskDef.description;
                this.loadNotes();
                utils.getId("task-modal").style.display = "flex";
                utils.getId("task-modal").setAttribute("aria-hidden", "false");
            },
            async loadNotes() {
                const { week, taskId } = this.currentTask;
                const notesInput = utils.getId("task-notes");
                const counter = utils.getId("notes-counter");
                try {
                    const { data } = await apiCall(`/api/notes?week=${week}&task=${taskId}`);
                    notesInput.value = data.notes || "";
                    counter.textContent = `${notesInput.value.length}/500`;
                } catch (e) {
                    console.error("Failed to load notes:", e);
                }
                notesInput.oninput = () => counter.textContent = `${notesInput.value.length}/500`;
            },
            async saveNotes() {
                const { week, taskId } = this.currentTask;
                const notes = utils.getId("task-notes").value;
                const btn = utils.getId("save-notes-btn");
                try {
                    btn.disabled = true;
                    btn.textContent = "Saving...";
                    await apiCall("/api/notes", { method: "POST", body: { week, task: taskId, notes } });
                    showNotification("Notes saved!");
                } catch (e) {
                    showNotification("Failed to save notes", "error");
                } finally {
                    btn.disabled = false;
                    btn.textContent = "💾 Save";
                }
            }
        };
        const adminSystem = {
            switchTab(tab) {
                document.querySelectorAll(".admin-tab").forEach(t => {
                    t.classList.remove("active");
                    t.setAttribute("aria-selected", "false");
                });
                document.querySelectorAll(".admin-section").forEach(s => s.classList.remove("active"));
                utils.getId(`tab-${tab}`).classList.add("active");
                utils.getId(`tab-${tab}`).setAttribute("aria-selected", "true");
                utils.getId(`admin-${tab}`).classList.add("active");
                if (tab === "leaderboard") this.refreshLeaderboard();
                else if (tab === "users") this.loadUsers();
            },
            async refreshLeaderboard(force = false) {
                const tbody = utils.getId("leaderboard-body");
                const cacheKey = "leaderboard-cache";
                const cache = JSON.parse(sessionStorage.getItem(cacheKey) || "{}");
                if (!force && cache.data && Date.now() - cache.time < 5 * 60 * 1000) {
                    tbody.innerHTML = cache.html;
                    return;
                }
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;"><div class="loading"></div></td></tr>';
                try {
                    const { data } = await apiCall("/api/admin/users-progress");
                    const users = data.map((user, i) => ({
                        ...user,
                        rank: i + 1,
                        medal: i === 0 ? "🥇" : i === 1 ? "🥈" : i === 2 ? "🥉" : ""
                    }));
                    const fragment = document.createDocumentFragment();
                    users.forEach(user => {
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
                            <td class="rank-cell">${user.medal ? `<span class="medal-icon">${user.medal}</span>` : ""}#${user.rank}</td>
                            <td><strong>${user.name}</strong><br><small>${user.email}</small></td>
                            <td><div class="progress-container"><div class="progress-bar-mini"><div class="progress-fill-mini" style="width: ${user.progress}%"></div></div><span class="progress-text-mini">${user.progress}%</span></div></td>
                            <td style="text-align: center;"><strong>${user.completedTasks}</strong>/42</td>
                            <td>${user.notesCount ? `<span class="notes-badge">${user.notesCount}</span>` : "No notes"}</td>
                            <td><small>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : "Never"}</small></td>
                        `;
                        fragment.appendChild(tr);
                    });
                    tbody.innerHTML = "";
                    tbody.appendChild(fragment);
                    sessionStorage.setItem(cacheKey, JSON.stringify({ time: Date.now(), html: tbody.innerHTML, data: users }));
                } catch (e) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--error);">Failed to load</td></tr>';
                }
            },
            async loadUsers() {
                const list = utils.getId("users-list");
                try {
                    const { data } = await apiCall("/api/admin/users");
                    list.innerHTML = data.map(user => `
                        <div class="user-card">
                            <div class="user-info">
                                <h4>${user.name}</h4>
                                <p>${user.email} • ${user.role}</p>
                                <div class="user-progress-bar"><div class="user-progress-fill" style="width:${user.progress}%"></div></div>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-secondary" style="padding:6px 12px" onclick="adminSystem.editUser('${user.id}')">Edit</button>
                                <button class="btn btn-secondary" style="padding:6px 12px;background:var(--error)" onclick="adminSystem.deleteUser('${user.id}')">Delete</button>
                            </div>
                        </div>
                    `).join("");
                } catch (e) {
                    list.innerHTML = "<p>Failed to load users.</p>";
                }
            },
            async editUser(userId) {
                showNotification("Edit user functionality not implemented", "error");
            },
            async deleteUser(userId) {
                if (!confirm("Delete user?")) return;
                try {
                    await apiCall(`/api/admin/users/${userId}`, { method: "DELETE" });
                    this.loadUsers();
                    showNotification("User deleted");
                } catch (e) {
                    showNotification("Failed to delete user", "error");
                }
            },
            async exportProgress() {
                try {
                    const { data } = await apiCall("/api/admin/export-progress");
                    const blob = new Blob([data.csv], { type: "text/csv" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "progress_export.csv";
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification("Progress exported");
                } catch (e) {
                    showNotification("Export failed", "error");
                }
            },
            async importProgress(file) {
                try {
                    const formData = new FormData();
                    formData.append("file", file);
                    await apiCall("/api/admin/import-progress", { method: "POST", body: formData });
                    showNotification("Progress imported");
                    this.refreshLeaderboard(true);
                } catch (e) {
                    showNotification("Import failed", "error");
                }
            }
        };
        function showAdmin() {
            closeModal();
            const m = utils.getId("admin-modal");
            m.style.display = "flex";
            m.setAttribute("aria-hidden", "false");
            adminSystem.refreshLeaderboard();
        }
        function labHistoryModal() {
            return utils.getId("lab-history-modal");
        }
        document.addEventListener("DOMContentLoaded", () => {
            uiSystem.initTheme();
            authSystem.checkSession();
            utils.getId("login-form").onsubmit = async e => {
                e.preventDefault();
                await authSystem.login(new FormData(e.target));
            };
            utils.getId("register-form").onsubmit = async e => {
                e.preventDefault();
                await authSystem.register(new FormData(e.target));
            };
            document.querySelectorAll(".week-header").forEach(h => {
                h.addEventListener("keydown", e => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        progressSystem.toggleWeek(h.parentElement.id);
                    }
                });
            });
        });
    </script>
</body>
</html>