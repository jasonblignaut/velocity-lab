<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocity Lab - Comprehensive MSP Training Platform</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Velocity Lab">
    <meta name="apple-mobile-web-app-title" content="Velocity Lab">
    <meta name="description" content="Comprehensive MSP training platform covering Exchange Hybrid LAB plus tutorials for Networking, Azure, Firewalls, Linux, and more">
    <meta name="theme-color" content="#00a8ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/Appleios.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icon-512.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Open Graph for sharing -->
    <meta property="og:title" content="Velocity Lab - MSP Training Platform">
    <meta property="og:description" content="Exchange Hybrid LAB plus comprehensive tutorials covering Networking, Microsoft Azure, Firewalls, Linux, and more">
    <meta property="og:image" content="/assets/Android_512.png">
    <meta property="og:url" content="https://labverse.co.za">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Velocity Lab - MSP Training Platform">
    <meta name="twitter:description" content="Exchange Hybrid LAB plus comprehensive tutorials covering Networking, Microsoft Azure, Firewalls, Linux, and more">
    <meta name="twitter:image" content="/assets/Android_512.png">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/assets/Velocity-Logo.png" as="image">
    <link rel="preload" href="/assets/VelocityBackground.jpg" as="image">
    
    <style>
        /* Apple White + Unifi Cloud Color Scheme with Dark Mode */
        :root {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #f8f9fa;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-hover: #e9ecef;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: #d2d2d7;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --jedi-glow: #00ff88;
            --sith-glow: #ff0066;
            --bg-secondary: #f0f0f5;
        }

        [data-theme="dark"] {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #1e1e1e;
            --background: #000000;
            --surface: #1e1e1e;
            --surface-hover: #2e2e2e;
            --text: #ffffff;
            --text-secondary: #a1a1a6;
            --border: #2e2e2e;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --shadow: rgba(255, 255, 255, 0.1);
            --shadow-heavy: rgba(255, 255, 255, 0.2);
            --bg-secondary: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s ease;
            scroll-behavior: smooth;
        }

        /* Landing page scroll prevention */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        /* Background Image - Fixed to show in both themes */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.08;
            z-index: -1;
        }

        [data-theme="dark"] body::before {
            opacity: 0.05;
        }

        /* Header - Modern layered approach */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            transition: all 0.3s ease;
        }

        /* Solid background layer */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--background);
            z-index: -2;
        }

        /* Blur overlay layer */
        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border);
            z-index: -1;
        }

        [data-theme="dark"] .header::after {
            background: rgba(0, 0, 0, 0.8);
        }

        /* Logo */
        .logo {
            width: 80px;
            height: 80px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            cursor: pointer;
            position: relative;
            z-index: 10001;
            transition: transform 0.2s ease;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        [data-theme="dark"] .logo {
            filter: invert(1) brightness(1.2);
        }

        /* Desktop Navigation - Only Request Access in header */
        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Mobile Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10001;
        }

        .hamburger:hover {
            background: var(--surface-hover);
            transform: scale(1.05);
        }

        .hamburger span {
            width: 24px;
            height: 2px;
            background: var(--text);
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 9998;
            padding: 1rem;
            max-height: calc(100vh - 70px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        [data-theme="dark"] .mobile-menu {
            background: rgba(0, 0, 0, 0.98);
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
        }

        .mobile-menu-item:hover, .mobile-menu-item.primary {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .mobile-menu-item.secondary {
            border: 1px solid var(--border);
        }

        /* Theme Menu */
        .theme-menu-item {
            position: relative;
        }

        .theme-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            color: var(--text);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
        }

        .theme-menu-toggle:hover {
            background: var(--surface-hover);
            transform: translateY(-1px);
        }

        .theme-submenu {
            position: absolute;
            right: 100%;
            top: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 150px;
            z-index: 9996;
            display: none;
        }

        .theme-menu-item:hover .theme-submenu {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .theme-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .theme-option:hover {
            background: var(--surface-hover);
            transform: translateX(-2px);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
        }

        .theme-option.jedi:hover {
            background: linear-gradient(45deg, var(--jedi-glow), #00ff88);
            color: white;
        }

        .theme-option.sith:hover {
            background: linear-gradient(45deg, var(--sith-glow), #ff0066);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 168, 255, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Welcome Screen - Only Sign In button in center */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative;
        }

        .welcome-notification {
            position: absolute;
            top: 120px;
            left: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            max-width: 300px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--text), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            padding: 0.2rem 0;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            from { filter: brightness(1); }
            to { filter: brightness(1.1); }
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem;
            animation: fadeInUp 0.8s ease 0.3s both;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            animation: fadeInUp 0.8s ease 0.6s both;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* Modern Apple-style Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            padding: 2rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Apple-style Modal Content */
        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 0;
            width: 100%;
            max-width: 400px;
            height: auto;
            min-height: 320px;
            max-height: 90vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-content.large {
            max-width: 600px;
            background: var(--background);
            height: auto;
            min-height: unset;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Apple-style signin has dark background */
        .apple-modal {
            background: #1a1a1a;
            color: white;
        }

        @keyframes modalSlideIn {
            from { 
                transform: scale(0.8) translateY(60px); 
                opacity: 0; 
            }
            to { 
                transform: scale(1) translateY(0); 
                opacity: 1; 
            }
        }

        /* Clean header with logo */
        .modal-header-clean {
            position: relative;
            height: 100px;
            background: #1a1a1a;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Velocity logo in the center - properly sized and colored */
        .modal-logo {
            width: 120px;
            height: 35px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            filter: invert(1) brightness(1.2);
        }

        /* Modal content area with better centering */
        .modal-body {
            padding: 20px 35px 35px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 220px;
            overflow-y: auto;
        }

        .modal-body.initial-state {
            justify-content: center;
        }

        .apple-modal .modal-body {
            color: white;
        }

        .modal-title {
            font-size: clamp(22px, 5vw, 28px);
            font-weight: 600;
            margin-bottom: 32px;
            color: white;
            line-height: 1.2;
        }

        .modal-subtitle {
            color: #a1a1a6;
            margin-bottom: 32px;
            font-size: clamp(15px, 4vw, 17px);
            line-height: 1.3;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 20;
            font-size: 18px;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .modal-close:active {
            transform: scale(0.9);
        }

        /* Form Styles for Apple Modal */
        .apple-form-group {
            margin-bottom: 16px;
            text-align: left;
            position: relative;
        }

        .apple-form-group.hidden {
            display: none;
        }

        .apple-form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid #3a3a3c;
            border-radius: 12px;
            font-size: 17px;
            background: #2c2c2e;
            color: white;
            transition: all 0.3s ease;
        }

        .apple-form-input:focus {
            outline: none;
            border-color: #0a84ff;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
            transform: scale(1.02);
        }

        .apple-form-input::placeholder {
            color: #6d6d70;
        }

        .password-field .apple-form-input {
            padding-right: 56px;
        }

        /* Enhanced loading spinner for email field */
        .apple-form-input.loading {
            background: #2c2c2e;
            position: relative;
            pointer-events: none;
        }

        .apple-form-input.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 16px;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            border: 2px solid #0a84ff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: emailSpinnerMove 2s linear infinite;
        }

        @keyframes emailSpinnerMove {
            0% {
                left: 16px;
                transform: rotate(0deg);
            }
            50% {
                left: calc(100% - 32px);
                transform: rotate(180deg);
            }
            100% {
                left: 16px;
                transform: rotate(360deg);
            }
        }

        /* Password field with styled arrow button */
        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: #6d6d70;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .password-toggle:hover {
            background: #8e8e93;
            transform: translateY(-50%) scale(1.05);
        }

        .password-toggle:active {
            background: #34c759;
            transform: translateY(-50%) scale(0.95);
        }

        .password-toggle.loading {
            background: #6d6d70;
            color: transparent;
            pointer-events: none;
            font-size: 0;
            border: none;
            background-color: transparent !important;
        }

        .password-toggle.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #0a84ff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            background: transparent;
        }

        .apple-checkbox-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .apple-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: #0a84ff;
        }

        .apple-checkbox-label {
            color: #a1a1a6;
            font-size: 15px;
        }

        /* Request Access Form Styles - Fixed for desktop */
        .request-form {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            margin: 0 auto 2rem;
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .request-form h3 {
            margin-bottom: 1rem;
            color: var(--text);
            text-align: center;
        }

        .request-form p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            text-align: center;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
            transform: scale(1.02);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-submit {
            width: 100%;
            margin-top: 1rem;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-submit:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 168, 255, 0.3);
        }

        .form-submit:active {
            transform: scale(0.98);
        }

        .hidden {
            display: none !important;
        }

        /* Non-Apple modals keep original styling */
        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem 1rem 0;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Task Detail Modal */
        .task-detail-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .task-detail-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: var(--surface-hover);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 20;
            font-size: 18px;
            font-weight: bold;
        }

        .task-detail-close:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
        }

        .task-detail-close:active {
            transform: scale(0.9);
        }

        .notes-container {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .notes-title {
            margin: 0;
            color: var(--text);
        }

        .save-note-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            opacity: 0.7;
        }

        .save-note-btn:hover {
            opacity: 1;
            transform: translateY(-1px);
        }

        .save-note-btn:active {
            transform: scale(0.95);
        }

        .save-note-btn.saved {
            background: var(--success);
        }

        .notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--background);
            color: var(--text);
            font-family: inherit;
            resize: vertical;
            transition: all 0.2s ease;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .notes-textarea.has-content {
            cursor: pointer;
            background: linear-gradient(135deg, var(--surface), var(--background));
        }

        .notes-textarea.has-content:hover {
            border-color: var(--primary);
        }

        .notes-tip {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .subtask-container {
            margin: 1rem 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .subtask-item:hover {
            background: var(--surface-hover);
            transform: translateX(2px);
        }

        .subtask-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }

        .subtask-item label {
            cursor: pointer;
            line-height: 1.4;
            flex: 1;
        }

        .subtask-item.completed {
            opacity: 0.7;
        }

        .subtask-item.completed label {
            text-decoration: line-through;
        }

        /* Lab History Modal Specific Fixes */
        .lab-history-modal-content {
            max-height: 80vh;
            height: 80vh;
            overflow-y: auto;
            padding: 1rem;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        /* Main Dashboard */
        .main-content {
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
            animation: fadeInUp 0.6s ease;
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            animation: fadeInUp 0.6s ease 0.2s both;
        }

        /* Progress Ring */
        .progress-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
            animation: fadeInUp 0.6s ease 0.4s both;
        }

        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Category Cards - Enhanced Design with Lab and Tutorial sections */
        .lab-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .lab-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
        }

        .lab-card-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .tutorials-section {
            margin-top: 3rem;
        }

        .tutorials-section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .tutorials-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .categories-container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeInUp 0.6s ease 0.6s both;
        }

        .category-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .category-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 30px var(--shadow-heavy);
        }

        .category-card:active {
            transform: translateY(-2px) scale(1.01);
        }

        .category-card.lab-card {
            border: 2px solid var(--primary);
            background: linear-gradient(135deg, rgba(0, 168, 255, 0.05), var(--background));
            max-width: 400px;
        }

        .category-card.tutorial-card {
            /* Standard tutorial card styling */
        }

        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .category-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }

        .category-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text);
        }

        .category-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .category-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .category-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .category-progress {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--success);
        }

        /* Tutorial View Styles */
        .tutorial-view {
            padding: 2rem 0;
        }

        .tutorial-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .tutorial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .tutorial-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .tutorial-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px var(--shadow-heavy);
        }

        .tutorial-header h3 {
            margin: 0 0 1rem 0;
            color: var(--text);
            font-size: 1.1rem;
        }

        .tutorial-preview {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .tutorial-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .tutorial-type {
            font-size: 0.8rem;
            color: var(--primary);
            font-weight: 500;
        }

        .tutorial-arrow {
            color: var(--text-secondary);
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .tutorial-card:hover .tutorial-arrow {
            transform: translateX(5px);
        }

        /* Tutorial Content Styles */
        .tutorial-content {
            line-height: 1.6;
        }

        .tutorial-content h2 {
            color: var(--text);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 0.5rem;
        }

        .tutorial-content h3 {
            color: var(--text);
            margin: 1.5rem 0 1rem 0;
        }

        .tutorial-content h4 {
            color: var(--text);
            margin: 1rem 0 0.5rem 0;
        }

        .tutorial-content p {
            margin-bottom: 1rem;
            color: var(--text);
        }

        .tutorial-content ul, .tutorial-content ol {
            margin: 1rem 0 1rem 1.5rem;
            color: var(--text);
        }

        .tutorial-content li {
            margin-bottom: 0.5rem;
        }

        .code-block {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            overflow-x: auto;
        }

        .code-block code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--text);
            white-space: pre;
        }

        .tutorial-tips {
            background: rgba(0, 168, 255, 0.1);
            border: 1px solid rgba(0, 168, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .tutorial-tips h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .tutorial-warning {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
        }

        .tutorial-warning h4 {
            color: var(--warning);
            margin-bottom: 0.5rem;
        }

        /* Week Cards */
        .weeks-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .week-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .week-card.expanded {
            cursor: default;
        }

        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .week-tasks {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .week-progress {
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .week-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .week-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .week-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Task List */
        .task-list {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .week-card.expanded .task-list {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .task-item:hover {
            background: var(--surface-hover);
            transform: translateX(2px);
        }

        .task-checkbox {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .task-content:hover {
            background: var(--surface-hover);
        }

        .task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-detail-btn {
            margin-left: 1rem;
            padding: 4px 8px;
            font-size: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .task-item:hover .task-detail-btn {
            opacity: 1;
            transform: scale(1.05);
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s ease;
        }

        .user-menu-toggle:hover {
            background: var(--surface-hover);
            transform: scale(1.05);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 200px;
            z-index: 9997;
            display: none;
        }

        .user-menu-dropdown.active {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .user-menu-item:hover {
            background: var(--surface-hover);
            transform: translateX(2px);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                display: flex;
                align-items: center;
                justify-content: space-between;
                z-index: 9999;
            }
            
            .header-buttons,
            #headerButtons,
            .user-menu,
            #userMenu,
            .user-menu-toggle,
            .user-menu-dropdown,
            #userMenuDropdown,
            .theme-menu-item,
            .theme-submenu,
            .theme-option {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: fixed !important;
                left: -99999px !important;
                top: -99999px !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                pointer-events: none !important;
                z-index: -9999 !important;
            }

            .logo {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 100px;
                height: 100px;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .hamburger {
                display: flex !important;
                position: absolute;
                right: 1rem;
                visibility: visible !important;
                opacity: 1 !important;
                flex-direction: column;
            }
            
            .hamburger span {
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .welcome-notification {
                position: static;
                margin-bottom: 2rem;
                max-width: none;
                margin-top: 1rem;
            }

            .welcome-screen {
                padding: 1rem;
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }

            .btn-large {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
                margin-top: 70px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .progress-ring {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 1.5rem;
            }

            .categories-container {
                flex-direction: column;
                gap: 1rem;
            }

            .lab-card-container .category-card {
                max-width: 100%;
            }

            .tutorials-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .lab-card-container {
                margin-bottom: 1rem;
            }

            .tutorials-section {
                margin-top: 2rem;
            }

            .tutorial-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .tutorial-view {
                padding: 1rem 0;
            }

            .weeks-container {
                flex-direction: column;
                gap: 1rem;
            }

            .week-card {
                padding: 1rem;
            }

            .week-title {
                font-size: 1.1rem;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 0;
                margin: auto;
                max-width: 90vw;
                min-height: 300px;
            }

            .modal-content.large {
                max-width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-body {
                padding: 15px 20px 25px;
                min-height: 200px;
            }

            .modal-body.initial-state {
                justify-content: center;
            }

            .modal-logo {
                width: 100px;
                height: 29px;
            }

            .modal-header-clean {
                height: 80px;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px 16px;
                justify-content: center;
            }

            .form-input {
                font-size: 16px;
            }

            #mobileThemeOptions {
                display: none;
                flex-direction: column;
                background: var(--bg-secondary);
                border-radius: 8px;
                margin-top: 0.5rem;
            }

            #mobileThemeOptions .mobile-menu-item {
                margin: 0;
                border-radius: 0;
                font-size: 0.9rem;
            }

            #mobileThemeOptions .mobile-menu-item:first-child {
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
            }

            #mobileThemeOptions .mobile-menu-item:last-child {
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
            }

            .mobile-menu {
                position: fixed;
                max-height: calc(100vh - 70px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            .mobile-menu.active {
                overflow-y: auto;
            }

            .landing-page .hamburger {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }

            .tutorials-section {
                margin-top: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
                padding: 0 0.75rem;
            }

            .main-content {
                margin-top: 60px;
                padding: 0.75rem;
            }

            .mobile-menu {
                top: 60px;
                max-height: calc(100vh - 60px);
                z-index: 9998;
            }

            .logo {
                width: 90px;
                height: 90px;
            }

            .header-buttons,
            #headerButtons,
            .user-menu,
            #userMenu,
            .user-menu-toggle,
            .user-menu-dropdown,
            #userMenuDropdown {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: fixed !important;
                left: -9999px !important;
                top: -9999px !important;
                width: 0 !important;
                height: 0 !important;
                overflow: hidden !important;
                pointer-events: none !important;
                z-index: -1 !important;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                border-radius: 16px;
                max-width: 95vw;
                min-height: 280px;
            }

            .modal-content.large {
                max-width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
            }

            .task-detail-close {
                top: 10px;
                right: 15px;
                width: 28px;
                height: 28px;
                font-size: 16px;
            }

            .modal-body {
                padding: 10px 18px 20px;
                min-height: 180px;
            }

            .modal-body.initial-state {
                justify-content: center;
            }

            .modal-header-clean {
                height: 70px;
            }

            .modal-title {
                font-size: 20px;
                margin-bottom: 24px;
            }

            .modal-subtitle {
                font-size: 14px;
                display: block;
            }

            .landing-page .hamburger {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
            }

            .tutorials-section {
                margin-top: 1.5rem;
            }

            .lab-card-container {
                margin-bottom: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 9995;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--primary);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .landing-page {
            /* Additional styling if needed */
        }

        .task-item-wrapper {
            /* Wrapper to prevent event bubbling */
        }

        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 9999;
            display: none;
        }

        /* Performance optimizations */
        .category-card,
        .tutorial-card,
        .week-card,
        .task-item {
            will-change: transform;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus improvements */
        .btn:focus,
        .form-input:focus,
        .apple-form-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Enhanced loading state for buttons */
        .btn.loading {
            cursor: not-allowed;
        }

        /* Better mobile touch targets */
        @media (max-width: 768px) {
            .btn,
            .mobile-menu-item,
            .task-checkbox,
            .subtask-checkbox {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body data-theme="dark" class="no-scroll landing-page">
    <!-- Header -->
    <div class="header" id="header">
        <!-- Logo only (no text) -->
        <div class="logo" onclick="goHome()"></div>
        
        <!-- Desktop Navigation - Only Request Access in header -->
        <div class="header-buttons" id="headerButtons">
            <button class="btn btn-secondary" onclick="showRequestAccessModal()">Request Access</button>
        </div>
        
        <!-- Mobile Hamburger Menu -->
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <!-- Desktop User Menu -->
        <div class="user-menu hidden" id="userMenu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()">
                <span id="userName">User</span>
                <span>▼</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <button class="user-menu-item" onclick="startLabEnvironment()">Start New Lab</button>
                <button class="user-menu-item" onclick="showLabHistoryModal()" id="labHistoryButton">Lab History</button>
                <button class="user-menu-item" onclick="showAdminPanel()" id="adminButton" style="display: none;">Admin Panel</button>
                <div class="theme-menu-item">
                    <button class="theme-menu-toggle">
                        <span>Theme</span>
                        <span>▶</span>
                    </button>
                    <div class="theme-submenu">
                        <button class="theme-option jedi" onclick="setTheme('light')">
                            Light Jedi
                        </button>
                        <button class="theme-option sith active" onclick="setTheme('dark')">
                            Dark Sith
                        </button>
                    </div>
                </div>
                <button class="user-menu-item" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-items" id="mobileMenuItems">
            <!-- Items populated by JavaScript based on auth state -->
        </div>
    </div>

    <!-- Welcome Screen - Only Sign In button in center -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-notification">
            Welcome to Velocity Lab! Request access to begin your MSP training journey with our Exchange Hybrid LAB and comprehensive tutorials.
        </div>
        
        <h1 class="welcome-title">MSP Training Platform</h1>
        <p class="welcome-subtitle">
            Exchange Hybrid LAB + Comprehensive Tutorials<br>
            Professional development for managed service providers
        </p>
        
        <div class="welcome-buttons">
            <button class="btn btn-primary btn-large" onclick="showSignInModal()">
                Sign In
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="main-content hidden" id="mainContent">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Training Journey</h1>
            <p class="dashboard-subtitle">Exchange Hybrid LAB with progress tracking + comprehensive MSP tutorials</p>
        </div>

        <!-- Categories Grid (shows by default) -->
        <div class="categories-container" id="categoriesContainer">
            <!-- Category cards will be populated by JavaScript -->
        </div>

        <!-- Course View (shows when Exchange LAB is selected) -->
        <div class="course-view hidden" id="courseView">
            <!-- Progress Ring -->
            <div class="progress-section">
                <div class="progress-ring">
                    <svg viewBox="0 0 120 120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="54"/>
                        <circle class="progress-ring-fill" cx="60" cy="60" r="54" 
                                stroke-dasharray="0 339.292" id="progressRing"/>
                    </svg>
                    <div class="progress-text">
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
            </div>

            <!-- Week Cards -->
            <div class="weeks-container" id="weeksContainer">
                <!-- Week cards will be populated by JavaScript -->
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="showCategoriesView()">← Back to Categories</button>
            </div>
        </div>

        <!-- Tutorial View (shows when tutorial category is selected) -->
        <div class="tutorial-view hidden" id="tutorialView">
            <!-- Tutorial content will be populated by JavaScript -->
        </div>
    </div>

    <!-- Apple-style Sign In Modal -->
    <div class="modal" id="signInModal">
        <div class="modal-content apple-modal">
            <button class="modal-close" onclick="closeModal('signInModal')">&times;</button>
            
            <!-- Clean header with logo -->
            <div class="modal-header-clean">
                <div class="modal-logo"></div>
            </div>
            
            <div class="modal-body">
                <h2 class="modal-title">Sign in to Velocity Lab</h2>
                <p class="modal-subtitle">Welcome back to your training journey</p>
                
                <form id="signInForm">
                    <div class="apple-form-group">
                        <input type="email" class="apple-form-input" id="signInEmail" name="email" 
                               placeholder="Email" required>
                    </div>
                    
                    <div class="apple-form-group hidden" id="passwordGroup">
                        <div class="password-field">
                            <input type="password" class="apple-form-input" id="signInPassword" name="password" 
                                   placeholder="Password" required>
                            <button type="submit" class="password-toggle" title="Sign In">
                                →
                            </button>
                        </div>
                    </div>
                    
                    <div class="apple-checkbox-container hidden" id="rememberGroup">
                        <input type="checkbox" class="apple-checkbox" name="remember" id="rememberMe">
                        <label class="apple-checkbox-label" for="rememberMe">Remember me for 30 days</label>
                    </div>
                    
                    <div id="signInMessage"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Request Access Modal -->
    <div class="modal" id="requestAccessModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('requestAccessModal')">&times;</button>
            
            <div class="modal-header">
                <h2>🚀 Request Training Access</h2>
                <p style="color: var(--text-secondary);">Join our comprehensive MSP training platform</p>
            </div>
            
            <div class="modal-body">
                <div class="request-form">
                    <h3>Access Request Form</h3>
                    <p>Please fill out the form below to request access to our training platform. Our team will review your request and create your account manually.</p>
                    
                    <form action="https://api.web3forms.com/submit" method="POST" id="requestAccessForm">
                        <!-- Replace with your Access Key -->
                        <input type="hidden" name="access_key" value="fe37519c-2a4b-48ee-a090-1746e3ad0010">
                        
                        <!-- Form Inputs -->
                        <div class="form-group">
                            <label class="form-label" for="requestName">Full Name *</label>
                            <input type="text" class="form-input" id="requestName" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="requestEmail">Email Address *</label>
                            <input type="email" class="form-input" id="requestEmail" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="requestCompany">Company/Organization</label>
                            <input type="text" class="form-input" id="requestCompany" name="company">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="requestMessage">Tell us about your training goals *</label>
                            <textarea class="form-input form-textarea" id="requestMessage" name="message" required 
                                      placeholder="What specific areas are you interested in? (Exchange LAB, Networking, Azure, Firewalls, etc.)"></textarea>
                        </div>
                        
                        <!-- Honeypot Spam Protection -->
                        <input type="checkbox" name="botcheck" class="hidden" style="display: none;">
                        
                        <!-- Custom Confirmation / Success Page -->
                        <input type="hidden" name="redirect" value="https://labverse.co.za/thanks.html">
                        
                        <button type="submit" class="form-submit">Submit Access Request</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content large">
            <button class="task-detail-close" onclick="closeModal('taskDetailModal')">&times;</button>
            <div class="modal-header">
                <h2 id="taskDetailTitle">Task Details</h2>
            </div>
            <div class="task-detail-content" id="taskDetailContent">
                <!-- Task details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Tutorial Detail Modal -->
    <div class="modal" id="tutorialDetailModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('tutorialDetailModal')">&times;</button>
            <div class="modal-header">
                <h2 id="tutorialDetailTitle">Tutorial Guide</h2>
            </div>
            <div class="task-detail-content" id="tutorialDetailContent">
                <!-- Tutorial details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Lab History Modal -->
    <div class="modal" id="labHistoryModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('labHistoryModal')">&times;</button>
            <div class="modal-header">
                <h2>📊 Lab History</h2>
                <p style="color: var(--text-secondary);">Your Exchange Hybrid LAB progress timeline</p>
            </div>
            <div class="lab-history-modal-content" id="labHistoryModalContent">
                <!-- Lab history content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
            <div class="modal-header">
                <h2>👑 Admin Panel</h2>
                <p style="color: var(--text-secondary);">Exchange LAB progress leaderboard</p>
            </div>
            <div class="lab-history-modal-content" id="adminContent">
                <!-- Admin content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        📡 You're offline - some features may be limited
    </div>

    <!-- Load Task Definitions (Exchange LAB only) -->
    <script src="/assets/task-definitions.js"></script>
    
    <!-- Load Tutorial Content -->
    <script src="/assets/tutorials/networking.js"></script>
    <script src="/assets/tutorials/azure.js"></script>
    <script src="/assets/tutorials/microsoft365.js"></script>
    <script src="/assets/tutorials/firewalls.js"></script>
    <script src="/assets/tutorials/backup.js"></script>
    <script src="/assets/tutorials/linux.js"></script>
    <script src="/assets/tutorials/tools.js"></script>

    <script>
        // Global application state
        const appState = {
            user: null,
            sessionToken: null,
            progress: {},
            authenticated: false,
            labHistory: [],
            tasks: [],
            categories: [],
            currentCategory: null,
            currentView: 'categories', // 'categories', 'lab', 'tutorial'
            isWelcomeShown: false,
            shownNotifications: new Set()
        };

        // API configuration
        const API_BASE = '/api';

        // Training categories configuration - HYBRID APPROACH
        const TRAINING_CATEGORIES = {
            'exchange-lab': {
                id: 'exchange-lab',
                title: 'Exchange Hybrid LAB',
                icon: '🧪',
                type: 'lab', // Trackable progress
                description: 'Complete 4-week hands-on lab building Exchange Hybrid environment. Full progress tracking with sessions, completion rates, and detailed task management.',
                courses: [
                    'Week 1: Foundation & Domain Setup',
                    'Week 2: Infrastructure & Updates', 
                    'Week 3: Exchange & Mail Flow',
                    'Week 4: Hybrid & External Access'
                ]
            },
            'networking': {
                id: 'networking',
                title: 'Networking',
                icon: '🌐',
                type: 'tutorial', // Informational only
                description: 'Comprehensive step-by-step tutorials for network infrastructure, monitoring tools, and configurations. Reference materials for daily operations.',
                courses: [
                    'Setting up Zabbix monitoring server',
                    'Monitoring with Zabbix advanced features',
                    'Adding new hosts to Zabbix',
                    'Cisco ISR voice router configuration',
                    'Cisco monitored interfaces setup',
                    'PRTG 100 sensors free setup',
                    'DNS server configuration and management',
                    'Creating network diagrams in Visio/draw.io',
                    'Cisco backup automation via SSH/Telnet',
                    'Grandstream PBX setup and configuration',
                    'Grandstream RADIUS authentication for corporate WiFi',
                    'PuTTY configuration backup with syntax highlighting'
                ]
            },
            'azure': {
                id: 'azure',
                title: 'Microsoft Azure',
                icon: '☁️',
                type: 'tutorial',
                description: 'Complete step-by-step guides for Azure cloud services, security solutions, analytics, and infrastructure management.',
                courses: [
                    'Microsoft Defender for Servers deployment',
                    'Microsoft Defender for Cloud configuration',
                    'Microsoft Intune device management setup',
                    'Microsoft Sentinel SIEM configuration',
                    'Azure Firewall Standard vs Premium comparison',
                    'Log Analytics workspace setup and queries',
                    'Azure VM backup and restore procedures',
                    'Azure Site Recovery disaster recovery',
                    'Azure VPN setup: site-to-site vs point-to-site'
                ]
            },
            'microsoft365': {
                id: 'microsoft365',
                title: 'Microsoft 365',
                icon: '🏢',
                type: 'tutorial',
                description: 'Comprehensive guides for Microsoft 365 administration, tenant management, and automation workflows.',
                courses: [
                    'Creating new M365 tenant for customers',
                    'Tenant migration and merger procedures',
                    'Send-as permissions configuration in 365',
                    'SharePoint Online landing page creation',
                    'Power Automate: shared mailbox to SharePoint flow',
                    'Exchange Online administration best practices'
                ]
            },
            'firewalls': {
                id: 'firewalls',
                title: 'Firewall Configuration',
                icon: '🔥',
                type: 'tutorial',
                description: 'Detailed configuration guides for enterprise firewalls, security policies, and advanced network protection.',
                courses: [
                    'Sophos firewall initial setup and configuration',
                    'FortiGate firewall policy creation and management',
                    'FortiGate SD-WAN zone and member configuration',
                    'Custom IPsec VPN tunnel setup on FortiGate',
                    'SSL VPN integration with Azure Enterprise apps',
                    'FortiGate LDAP authentication configuration',
                    'Static routing configuration and troubleshooting',
                    'FortiGate setup from scratch - complete guide',
                    'DDNS configuration for LTE WAN sites',
                    'CLI debugging and diagnostics on FortiGate',
                    'Advanced CLI commands: set source and exec options'
                ]
            },
            'backup': {
                id: 'backup',
                title: 'Backup & Recovery',
                icon: '💾',
                type: 'tutorial',
                description: 'Comprehensive backup solution guides, monitoring tools, and disaster recovery strategies.',
                courses: [
                    'Veeam Backup & Replication setup and configuration',
                    'Backup monitoring with Backup Radar platform',
                    'Block64 reporting setup and automation'
                ]
            },
            'linux': {
                id: 'linux',
                title: 'Linux Administration',
                icon: '🐧',
                type: 'tutorial',
                description: 'Linux system administration tutorials, server management, automation scripts, and security hardening.',
                courses: [
                    'Linux basics and system administration',
                    'Server configuration and service management',
                    'Shell scripting and task automation',
                    'System monitoring and log analysis',
                    'Package management across distributions',
                    'Security hardening and best practices'
                ]
            },
            'tools': {
                id: 'tools',
                title: 'MSP Tools',
                icon: '🛠️',
                type: 'tutorial',
                description: 'Professional MSP tool usage guides, remote access solutions, and automation techniques.',
                courses: [
                    'Atera: remote access via Splashtop integration',
                    'Atera: script management and automation',
                    'Atera: multi-customer environment management',
                    'Atera: alerting system and reporting setup'
                ]
            }
        };

        // Utility functions for cookies and DOM manipulation
        const utils = {
            cookies: {
                set(name, value) {
                    const expires = new Date();
                    expires.setTime(expires.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
                    document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/; SameSite=Strict`;
                },
                get(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                },
                delete(name) {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict`;
                }
            },
            getId(id) {
                return document.getElementById(id);
            }
        };

        // API call function (enhanced with offline detection)
        const api = {
            async call(url, options = {}) {
                try {
                    console.log('API Call:', options.method || 'GET', url);
                    
                    if (options.body instanceof FormData) {
                        console.log('FormData contents:');
                        for (let [key, value] of options.body.entries()) {
                            if (key === 'password') {
                                console.log(`  ${key}: [${value.length} characters]`);
                            } else {
                                console.log(`  ${key}:`, value);
                            }
                        }
                    }
                    
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        body: options.body,
                        headers: {
                            ...options.headers
                        }
                    });

                    console.log('Response status:', response.status, response.statusText);

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        if (contentType && contentType.includes('text/html')) {
                            console.warn('Backend API not deployed');
                            throw new Error('BACKEND_NOT_AVAILABLE');
                        }
                        
                        console.error('Expected JSON response but got:', contentType);
                        const responseText = await response.text();
                        console.error('Response body:', responseText);
                        throw new Error(`API returned ${response.status}: Expected JSON response but got ${contentType}`);
                    }

                    const result = await response.json();
                    console.log('Response data:', result);
                    
                    if (!result.success) {
                        throw new Error(result.message || 'API call failed');
                    }
                    
                    return result;
                } catch (error) {
                    console.error('API call failed:', error);
                    
                    // Handle offline state
                    if (!navigator.onLine) {
                        throw new Error('OFFLINE');
                    }
                    
                    throw error;
                }
            }
        };

        // Enhanced notification system with deduplication
        const notificationSystem = {
            notifications: [],
            
            success(message) {
                console.log('Success:', message);
                this.show(message, 'success');
            },
            
            error(message) {
                console.log('Error:', message);
                this.show(message, 'error');
            },
            
            info(message) {
                console.log('Info:', message);
                this.show(message, 'info');
            },
            
            show(message, type) {
                const notificationId = `${type}:${message}`;
                
                if (appState.shownNotifications.has(notificationId)) {
                    console.log('Duplicate notification prevented:', message);
                    return;
                }
                
                if (message.includes('Welcome back') || message.includes('Welcome to Velocity Lab')) {
                    if (appState.isWelcomeShown) {
                        console.log('Duplicate welcome notification prevented:', message);
                        return;
                    }
                    appState.isWelcomeShown = true;
                }
                
                appState.shownNotifications.add(notificationId);
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                const offset = this.notifications.length * 80;
                notification.style.top = `${90 + offset}px`;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                setTimeout(() => {
                    notification.remove();
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                        this.notifications.forEach((notif, i) => {
                            notif.style.top = `${90 + (i * 80)}px`;
                        });
                    }
                    
                    setTimeout(() => {
                        appState.shownNotifications.delete(notificationId);
                    }, 1000);
                }, 5000);
            },
            
            clearShownNotifications() {
                appState.shownNotifications.clear();
                appState.isWelcomeShown = false;
            }
        };

        // Authentication system (enhanced with offline handling)
        const authSystem = {
            async login(formData) {
                const submitBtn = document.querySelector('#signInForm .password-toggle');
                
                try {
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                    }
                    
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        throw new Error('Please fill in all required fields.');
                    }

                    console.log('Attempting login with backend APIs...');
                    
                    const { data } = await api.call('/api/users/login', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log('Login successful with backend APIs');
                    
                    const { name, role, email: userEmail, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, role, email: userEmail }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, role, email: userEmail };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        const adminBtn = document.getElementById('adminButton');
                        if (adminBtn) adminBtn.style.display = 'block';
                    }
                    
                    showDashboard();
                    await loadUserProgress();
                    await loadLabHistory();
                    closeModal('signInModal');
                    
                    closeMobileMenu();
                    
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    
                    if (!appState.isWelcomeShown) {
                        notificationSystem.success(`Welcome back, ${name}! 🎉`);
                    }
                    
                } catch (err) {
                    console.error('Login failed:', err);
                    if (err.message === 'BACKEND_NOT_AVAILABLE') {
                        notificationSystem.error('Backend service not available. Please ensure the API functions are deployed.');
                    } else if (err.message === 'OFFLINE') {
                        notificationSystem.error('You are offline. Please check your internet connection.');
                    } else {
                        notificationSystem.error(err.message || 'Login failed. Please check your credentials.');
                    }
                } finally {
                    if (submitBtn) {
                        submitBtn.classList.remove('loading');
                    }
                }
            },
            
            async logout() {
                try {
                    if (appState.sessionToken) {
                        await api.call('/api/users/logout', { 
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`
                            }
                        });
                    }
                } catch (err) {
                    console.log('Logout API call failed (expected if no backend logout endpoint):', err);
                }
                
                utils.cookies.delete('user');
                utils.cookies.delete('session');
                
                appState.user = null;
                appState.progress = {};
                appState.authenticated = false;
                appState.sessionToken = null;
                appState.labHistory = [];
                appState.currentCategory = null;
                appState.currentView = 'categories';
                
                localStorage.removeItem('velocity_progress');
                localStorage.removeItem('velocity_lab_history');
                
                notificationSystem.clearShownNotifications();
                
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.style.display = 'none';
                
                closeMobileMenu();
                showWelcomeScreen();
                notificationSystem.info('Signed out successfully');
            }
        };

        // Theme management (same as before)
        const themeSystem = {
            async setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                
                try {
                    if (appState.sessionToken) {
                        await api.call('/api/user/preferences', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ theme: theme })
                        });
                        console.log('Theme preference saved to backend APIs');
                    } else {
                        throw new Error('BACKEND_NOT_AVAILABLE');
                    }
                } catch (error) {
                    if (error.message === 'BACKEND_NOT_AVAILABLE' || error.message === 'OFFLINE') {
                        console.warn('Saving theme to localStorage fallback');
                        utils.cookies.set('theme', theme);
                    } else {
                        console.warn('Failed to save theme to backend, using client-side only:', error);
                        utils.cookies.set('theme', theme);
                    }
                }
                
                const themeOptions = document.querySelectorAll('.theme-option');
                themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if ((theme === 'light' && option.classList.contains('jedi')) || 
                        (theme === 'dark' && option.classList.contains('sith'))) {
                        option.classList.add('active');
                    }
                });
                
                if (theme === 'light') {
                    notificationSystem.success('🌟 Light Jedi theme activated!');
                } else {
                    notificationSystem.success('⚡ Dark Sith theme activated!');
                }
            },

            async loadTheme() {
                try {
                    if (appState.sessionToken) {
                        const response = await api.call('/api/user/preferences', {
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`
                            }
                        });
                        
                        if (response.success && response.data.theme) {
                            document.body.setAttribute('data-theme', response.data.theme);
                            console.log('Theme loaded from backend APIs:', response.data.theme);
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load theme from backend, using default:', error);
                }
                
                const savedTheme = utils.cookies.get('theme') || 'dark';
                document.body.setAttribute('data-theme', savedTheme);
                console.log('Theme loaded from cookie:', savedTheme);
            }
        };

        // Offline detection system
        const offlineSystem = {
            init() {
                window.addEventListener('online', this.handleOnline.bind(this));
                window.addEventListener('offline', this.handleOffline.bind(this));
                this.updateStatus();
            },

            handleOnline() {
                this.updateStatus();
                notificationSystem.success('🌐 Connection restored!');
            },

            handleOffline() {
                this.updateStatus();
                notificationSystem.error('📡 You are offline - some features may be limited');
            },

            updateStatus() {
                const indicator = document.getElementById('offlineIndicator');
                if (indicator) {
                    if (navigator.onLine) {
                        indicator.style.display = 'none';
                    } else {
                        indicator.style.display = 'block';
                    }
                }
            }
        };

        // Load task definitions and categorize them
        function loadTaskDefinitions() {
            if (typeof window !== 'undefined' && window.TASK_DEFINITIONS) {
                appState.tasks = [];
                Object.keys(window.TASK_DEFINITIONS).forEach(taskId => {
                    const task = window.TASK_DEFINITIONS[taskId];
                    appState.tasks.push({
                        id: taskId,
                        title: task.title,
                        description: task.description || 'No description available',
                        week: parseInt(taskId.split('-')[0].replace('week', '')) || 1,
                        category: 'exchange-lab' // All task-definitions.js tasks belong to Exchange LAB
                    });
                });
                console.log('Exchange LAB task definitions loaded:', appState.tasks.length, 'tasks');
            } else {
                console.warn('Task definitions not loaded from task-definitions.js - Exchange LAB will have fallback content');
                appState.tasks = generateFallbackTasks();
            }
            
            // Initialize categories
            appState.categories = Object.values(TRAINING_CATEGORIES);
        }

        function generateFallbackTasks() {
            // Generate basic Exchange lab tasks as fallback
            const weeks = [
                {
                    title: 'Foundation & Domain Setup',
                    description: '2012 Server promoted to DC, VM joined to domain, network shares with security groups',
                    tasks: [
                        'Install Windows Server 2012 R2',
                        'Configure Domain Controller',
                        'Create Organizational Units',
                        'Add Domain Users'
                    ]
                },
                {
                    title: 'Infrastructure & Updates',
                    description: 'Install 2nd server, setup WSUS, configure time servers',
                    tasks: [
                        'Install Exchange Server 2016',
                        'Configure Exchange Organization',
                        'Create Mailboxes',
                        'Setup Distribution Groups'
                    ]
                },
                {
                    title: 'Exchange & Mail Flow',
                    description: 'Upgrade to Server 2016, install Exchange, create mailboxes, internal mail flow',
                    tasks: [
                        'Create M365 Tenant',
                        'Configure Domain',
                        'Setup Exchange Online',
                        'Create Cloud Users'
                    ]
                },
                {
                    title: 'Hybrid & External Access',
                    description: 'Publish mail externally, setup Office 365 hybrid environment',
                    tasks: [
                        'Install Azure AD Connect',
                        'Configure Directory Sync',
                        'Setup Hybrid Exchange',
                        'Configure Mail Flow'
                    ]
                }
            ];

            const tasks = [];
            weeks.forEach((week, weekIndex) => {
                week.tasks.forEach((task, taskIndex) => {
                    tasks.push({
                        id: `week${weekIndex + 1}-task${taskIndex + 1}`,
                        week: weekIndex + 1,
                        title: task,
                        description: `Complete ${task} as part of Week ${weekIndex + 1}`,
                        category: 'exchange-lab'
                    });
                });
            });

            return tasks;
        }

        // Progress management (enhanced with offline handling)
        async function loadUserProgress() {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token available');
                    appState.progress = JSON.parse(localStorage.getItem('velocity_progress') || '{}');
                    updateProgressDisplay();
                    return;
                }

                console.log('Loading progress from backend APIs...');
                const response = await api.call(`${API_BASE}/user/progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                if (response.success) {
                    appState.progress = response.data || {};
                    console.log('Progress loaded from backend APIs');
                } else {
                    console.warn('API returned error:', response.message);
                    appState.progress = {};
                }
            } catch (error) {
                if (error.message === 'BACKEND_NOT_AVAILABLE' || error.message === 'OFFLINE') {
                    console.warn('Using localStorage fallback for progress');
                    appState.progress = JSON.parse(localStorage.getItem('velocity_progress') || '{}');
                } else {
                    console.warn('Progress API unavailable:', error);
                    appState.progress = JSON.parse(localStorage.getItem('velocity_progress') || '{}');
                }
            }
            
            updateProgressDisplay();
            checkLabCompletion();
        }

        async function saveUserProgress(taskId, taskProgress) {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token, saving to localStorage');
                    localStorage.setItem('velocity_progress', JSON.stringify(appState.progress));
                    return;
                }

                console.log(`Saving progress for task ${taskId} to backend APIs...`);
                const response = await api.call(`${API_BASE}/user/progress`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        progress: taskProgress
                    })
                });
                
                if (response.success) {
                    console.log('Progress saved to backend APIs');
                } else {
                    console.warn('Failed to save progress:', response.message);
                }
            } catch (error) {
                if (error.message === 'BACKEND_NOT_AVAILABLE' || error.message === 'OFFLINE') {
                    console.warn('Saving progress to localStorage fallback');
                    localStorage.setItem('velocity_progress', JSON.stringify(appState.progress));
                } else {
                    console.warn('Progress save failed, using localStorage:', error);
                    localStorage.setItem('velocity_progress', JSON.stringify(appState.progress));
                }
            }
        }

        // Lab history management (enhanced with offline handling)
        async function loadLabHistory() {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token available');
                    appState.labHistory = JSON.parse(localStorage.getItem('velocity_lab_history') || '[]');
                    
                    if (appState.labHistory.length === 0) {
                        const today = new Date().toISOString().split('T')[0];
                        const defaultLab = {
                            session: 1,
                            date: today,
                            status: 'started',
                            labId: 'LAB001',
                            startedAt: new Date().toISOString(),
                            completedAt: null,
                            tasksCompleted: 0,
                            totalTasks: 43
                        };
                        appState.labHistory = [defaultLab];
                        localStorage.setItem('velocity_lab_history', JSON.stringify(appState.labHistory));
                    }
                    return;
                }

                console.log('Loading lab history from backend APIs...');
                const response = await api.call(`${API_BASE}/user/lab-history`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                if (response.success) {
                    appState.labHistory = response.data || [];
                    console.log('Lab history loaded from backend APIs:', appState.labHistory.length, 'sessions');
                    
                    if (appState.labHistory.length === 0) {
                        const today = new Date().toISOString().split('T')[0];
                        const defaultLab = {
                            session: 1,
                            date: today,
                            status: 'started',
                            labId: 'LAB001',
                            startedAt: new Date().toISOString(),
                            completedAt: null,
                            tasksCompleted: 0,
                            totalTasks: 43
                        };
                        appState.labHistory = [defaultLab];
                        await saveLabHistory(appState.labHistory);
                    }
                } else {
                    console.warn('API returned error:', response.message);
                    appState.labHistory = [];
                }
            } catch (error) {
                if (error.message === 'BACKEND_NOT_AVAILABLE' || error.message === 'OFFLINE') {
                    console.warn('Using localStorage fallback for lab history');
                    appState.labHistory = JSON.parse(localStorage.getItem('velocity_lab_history') || '[]');
                    
                    if (appState.labHistory.length === 0) {
                        const today = new Date().toISOString().split('T')[0];
                        const defaultLab = {
                            session: 1,
                            date: today,
                            status: 'started',
                            labId: 'LAB001',
                            startedAt: new Date().toISOString(),
                            completedAt: null,
                            tasksCompleted: 0,
                            totalTasks: 43
                        };
                        appState.labHistory = [defaultLab];
                        localStorage.setItem('velocity_lab_history', JSON.stringify(appState.labHistory));
                    }
                } else {
                    console.warn('Lab history API unavailable:', error);
                    appState.labHistory = JSON.parse(localStorage.getItem('velocity_lab_history') || '[]');
                }
            }
        }

        async function saveLabHistory(newSession) {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token, saving to localStorage');
                    localStorage.setItem('velocity_lab_history', JSON.stringify(appState.labHistory));
                    return;
                }

                console.log('Saving lab history to backend APIs...');
                const response = await api.call(`${API_BASE}/user/lab-history`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(Array.isArray(newSession) ? newSession : appState.labHistory)
                });
                
                if (response.success) {
                    console.log('Lab history saved to backend APIs');
                    await loadLabHistory();
                } else {
                    console.warn('Failed to save lab history:', response.message);
                }
            } catch (error) {
                if (error.message === 'BACKEND_NOT_AVAILABLE' || error.message === 'OFFLINE') {
                    console.warn('Saving lab history to localStorage fallback');
                    localStorage.setItem('velocity_lab_history', JSON.stringify(appState.labHistory));
                } else {
                    console.warn('Lab history save failed, using localStorage:', error);
                    localStorage.setItem('velocity_lab_history', JSON.stringify(appState.labHistory));
                }
            }
        }

        function checkLabCompletion() {
            if (appState.currentCategory !== 'exchange-lab') return;
            
            const categoryTasks = appState.tasks.filter(task => task.category === 'exchange-lab');
            const totalTasks = categoryTasks.length;
            const completedTasks = categoryTasks.filter(task => 
                appState.progress[task.id] && appState.progress[task.id].completed
            ).length;
            
            if (completedTasks === totalTasks && totalTasks > 0 && appState.labHistory.length > 0) {
                const currentLab = appState.labHistory.find(lab => lab.status === 'started');
                
                if (currentLab && currentLab.status === 'started') {
                    const completionEntry = {
                        ...currentLab,
                        status: 'completed',
                        completedAt: new Date().toISOString(),
                        tasksCompleted: completedTasks,
                        totalTasks: totalTasks
                    };
                    
                    const labIndex = appState.labHistory.findIndex(lab => lab.labId === currentLab.labId);
                    if (labIndex >= 0) {
                        appState.labHistory[labIndex] = completionEntry;
                        saveLabHistory(completionEntry);
                        notificationSystem.success('🎉 Exchange Hybrid LAB completed successfully!');
                    }
                }
            }
        }

        // Check for existing session
        function checkExistingSession() {
            const userCookie = utils.cookies.get('user');
            const sessionCookie = utils.cookies.get('session');
            
            if (userCookie && sessionCookie) {
                try {
                    appState.user = JSON.parse(userCookie);
                    appState.sessionToken = sessionCookie;
                    appState.authenticated = true;
                    
                    appState.isWelcomeShown = true;
                    
                    console.log('Found existing session for:', appState.user.name);
                    showDashboard();
                    loadUserProgress();
                    loadLabHistory();
                    themeSystem.loadTheme();
                    
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    
                    updateMobileMenuItems();
                } catch (error) {
                    console.error('Session validation failed:', error);
                    utils.cookies.delete('user');
                    utils.cookies.delete('session');
                    notificationSystem.clearShownNotifications();
                    showWelcomeScreen();
                    themeSystem.loadTheme();
                }
            } else {
                console.log('No existing session found');
                notificationSystem.clearShownNotifications();
                showWelcomeScreen();
                themeSystem.loadTheme();
            }
        }

        // Form handlers
        function setupFormHandlers() {
            const loginForm = utils.getId('signInForm');
            if (loginForm) {
                const emailInput = document.getElementById('signInEmail');
                const passwordGroup = document.getElementById('passwordGroup');
                const rememberGroup = document.getElementById('rememberGroup');
                
                if (emailInput) {
                    emailInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && this.value.length > 0) {
                            e.preventDefault();
                            showPasswordField();
                        }
                    });
                    
                    emailInput.addEventListener('blur', function() {
                        if (this.value.length > 0 && (this.value.includes('@') || this.value.length > 3)) {
                            setTimeout(() => showPasswordField(), 100);
                        }
                    });
                }
                
                function showPasswordField() {
                    if (passwordGroup.classList.contains('hidden')) {
                        const modalBody = document.querySelector('#signInModal .modal-body');
                        
                        emailInput.classList.add('loading');
                        
                        setTimeout(() => {
                            emailInput.classList.remove('loading');
                            passwordGroup.classList.remove('hidden');
                            rememberGroup.classList.remove('hidden');
                            if (modalBody) modalBody.classList.remove('initial-state');
                            document.getElementById('signInPassword').focus();
                        }, 600);
                    }
                }

                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(loginForm);
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    console.log('Login attempt for:', email);
                    await authSystem.login(formData);
                });
            }

            // Request access form handler
            const requestForm = utils.getId('requestAccessForm');
            if (requestForm) {
                requestForm.addEventListener('submit', function(event) {
                    const submitBtn = event.target.querySelector('.form-submit');
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                        submitBtn.textContent = 'Submitting...';
                    }
                    
                    // Form will submit to web3forms naturally
                    // Success is handled by redirect to thanks.html
                });
            }
        }

        // Global functions for HTML event handlers
        window.setTheme = function(theme) {
            themeSystem.setTheme(theme);
        };

        window.logout = async function() {
            await authSystem.logout();
        };

        window.goHome = function() {
            if (appState.authenticated) {
                showCategoriesView();
            } else {
                showWelcomeScreen();
            }
        };

        window.toggleMobileMenu = function() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            
            updateMobileMenuItems();
        };

        window.startLabEnvironment = async function() {
            try {
                console.log('Starting new Exchange Hybrid lab environment...');
                
                const response = await api.call('/api/lab/start', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                
                if (response.success) {
                    console.log('Lab started successfully with backend');
                    
                    appState.progress = {};
                    updateProgressDisplay();
                    await loadLabHistory();
                    
                    if (response.data.previousLabCompleted) {
                        notificationSystem.success(`🎉 Previous lab completed! New ${response.data.labId} started!`);
                    } else {
                        notificationSystem.success(`🚀 New Exchange LAB ${response.data.labId} started!`);
                    }
                }
                
            } catch (error) {
                console.error('Failed to start lab:', error);
                
                if (error.message === 'BACKEND_NOT_AVAILABLE') {
                    notificationSystem.error('Backend API not available. Please deploy the functions first.');
                } else if (error.message === 'OFFLINE') {
                    notificationSystem.error('You are offline. Please check your internet connection.');
                } else {
                    notificationSystem.error('Failed to start lab environment. Please try again.');
                }
            }
        };

        window.showLabHistoryModal = function() {
            const content = document.getElementById('labHistoryModalContent');
            
            if (appState.labHistory.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🧪</div>
                        <p>No Exchange LAB sessions yet!</p>
                        <p style="margin-top: 0.5rem;">Click "Start New Lab" to begin your first Exchange Hybrid training session.</p>
                    </div>
                `;
            } else {
                const filterButtons = `
                    <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button onclick="filterLabHistory('week')" class="lab-filter-btn" data-filter="week" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Week</button>
                        <button onclick="filterLabHistory('month')" class="lab-filter-btn" data-filter="month" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 30 Days</button>
                        <button onclick="filterLabHistory('quarter')" class="lab-filter-btn" data-filter="quarter" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 3 Months</button>
                        <button onclick="filterLabHistory('halfyear')" class="lab-filter-btn" data-filter="halfyear" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 6 Months</button>
                        <button onclick="filterLabHistory('year')" class="lab-filter-btn" data-filter="year" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Year</button>
                        <button onclick="filterLabHistory('lifetime')" class="lab-filter-btn active" data-filter="lifetime" style="padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 0.8rem;">Lifetime</button>
                    </div>
                `;
                
                content.innerHTML = filterButtons + `
                    <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                        <strong>Total Exchange LAB Sessions: <span id="filteredCount">${appState.labHistory.length}</span></strong>
                    </div>
                    <div id="labHistoryContent">
                        ${generateLabHistoryHTML(appState.labHistory)}
                    </div>
                `;
            }
            
            showModal('labHistoryModal');
        };

        window.showAdminPanel = async function() {
            const adminBtn = document.getElementById('adminButton');
            const mobileAdminBtn = document.getElementById('mobileAdminButton');
            
            try {
                // Show loading state
                if (adminBtn) {
                    adminBtn.classList.add('loading');
                    adminBtn.textContent = '';
                }
                if (mobileAdminBtn) {
                    mobileAdminBtn.classList.add('loading');
                    mobileAdminBtn.textContent = '';
                }

                if (!appState.user || appState.user.role !== 'admin') {
                    notificationSystem.error('Admin access required');
                    return;
                }

                console.log('Loading admin data from backend APIs...');
                const response = await api.call(`${API_BASE}/admin/users-progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.success) {
                    console.log('Admin data loaded from backend APIs');
                    displayAdminPanel(response.data);
                } else {
                    notificationSystem.error(`Failed to load admin data: ${response.message}`);
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
                
                if (error.message === 'BACKEND_NOT_AVAILABLE') {
                    console.log('Backend APIs not deployed, showing fallback');
                    showAdminPanelFallback('Backend APIs not deployed yet. Please deploy the Functions to enable admin features.');
                } else if (error.message === 'OFFLINE') {
                    console.log('Offline mode, showing fallback');
                    showAdminPanelFallback('Admin panel requires internet connection. Please check your connection and try again.');
                } else {
                    console.log('Admin panel API unavailable, showing fallback');
                    showAdminPanelFallback('Admin panel temporarily unavailable. Please try again later.');
                }
            } finally {
                // Remove loading state
                if (adminBtn) {
                    adminBtn.classList.remove('loading');
                    adminBtn.textContent = 'Admin Panel';
                }
                if (mobileAdminBtn) {
                    mobileAdminBtn.classList.remove('loading');
                    mobileAdminBtn.textContent = 'Admin Panel';
                }
            }
        };

        window.filterLabHistory = function(period) {
            const now = new Date();
            let filteredHistory = appState.labHistory;
            
            if (period !== 'lifetime') {
                const cutoffDate = new Date();
                switch(period) {
                    case 'week':
                        cutoffDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        cutoffDate.setDate(now.getDate() - 30);
                        break;
                    case 'quarter':
                        cutoffDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'halfyear':
                        cutoffDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredHistory = appState.labHistory.filter(session => 
                    new Date(session.date) >= cutoffDate
                );
            }
            
            document.querySelectorAll('.lab-filter-btn').forEach(btn => {
                btn.style.background = 'var(--surface)';
                btn.style.color = 'var(--text)';
                btn.style.border = '1px solid var(--border)';
            });
            
            const activeBtn = document.querySelector(`[data-filter="${period}"]`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary)';
                activeBtn.style.color = 'white';
                activeBtn.style.border = '1px solid var(--primary)';
            }
            
            document.getElementById('filteredCount').textContent = filteredHistory.length;
            document.getElementById('labHistoryContent').innerHTML = generateLabHistoryHTML(filteredHistory);
        };

        window.showTaskDetail = function(taskId) {
            const taskDefinition = window.TASK_DEFINITIONS && window.TASK_DEFINITIONS[taskId];
            
            if (taskDefinition) {
                document.getElementById('taskDetailTitle').textContent = taskDefinition.title;
                
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const taskProgress = appState.progress[taskId];
                const hasNotes = taskProgress.notes && taskProgress.notes.trim().length > 0;
                
                const notesSection = `
                    <div class="notes-container">
                        <div class="notes-header">
                            <h4 class="notes-title">📝 Your Notes</h4>
                            <button class="save-note-btn" id="saveNoteBtn_${taskId}" onclick="saveTaskNotes('${taskId}')">
                                💾 Save Note
                            </button>
                        </div>
                        <textarea 
                            id="taskNotes_${taskId}" 
                            class="notes-textarea ${hasNotes ? 'has-content' : ''}"
                            placeholder="Add your notes, observations, or troubleshooting steps here..."
                            ${hasNotes ? 'title="Click to edit your notes"' : ''}
                        >${taskProgress.notes || ''}</textarea>
                        <div class="notes-tip">
                            💡 Tip: Document any issues, solutions, or key learnings for future reference
                            ${hasNotes ? ' • Click the textarea to edit your saved notes' : ''}
                        </div>
                    </div>
                `;
                
                document.getElementById('taskDetailContent').innerHTML = taskDefinition.description + notesSection;
                
                setTimeout(() => {
                    const subtaskItems = document.querySelectorAll('.subtask-item');
                    subtaskItems.forEach(item => {
                        const checkbox = item.querySelector('.subtask-checkbox');
                        const label = item.querySelector('label');
                        const step = checkbox ? checkbox.getAttribute('data-step') : null;
                        
                        if (step && checkbox && label) {
                            if (taskProgress.subtasks && taskProgress.subtasks[step]) {
                                checkbox.checked = taskProgress.subtasks[step].completed;
                                if (checkbox.checked) {
                                    item.classList.add('completed');
                                }
                            }
                            
                            const clickHandler = function(e) {
                                if (e.target === checkbox) return;
                                
                                e.preventDefault();
                                e.stopPropagation();
                                
                                checkbox.checked = !checkbox.checked;
                                handleSubtaskChange(taskId, step, checkbox.checked);
                            };
                            
                            item.addEventListener('click', clickHandler);
                            label.addEventListener('click', clickHandler);
                            
                            checkbox.addEventListener('change', function(e) {
                                e.stopPropagation();
                                handleSubtaskChange(taskId, step, this.checked);
                            });
                        }
                    });

                    const notesTextarea = document.getElementById(`taskNotes_${taskId}`);
                    const saveBtn = document.getElementById(`saveNoteBtn_${taskId}`);
                    
                    if (notesTextarea && saveBtn) {
                        let saveTimeout;
                        notesTextarea.addEventListener('input', function() {
                            clearTimeout(saveTimeout);
                            saveBtn.textContent = 'Save Note';
                            saveBtn.classList.remove('saved');
                            
                            saveTimeout = setTimeout(() => {
                                saveTaskNotes(taskId);
                            }, 2000);
                        });

                        if (hasNotes) {
                            notesTextarea.addEventListener('click', function() {
                                this.focus();
                                this.setSelectionRange(this.value.length, this.value.length);
                            });
                        }
                    }
                }, 100);
                
                showModal('taskDetailModal');
            } else {
                notificationSystem.error('Task details not available');
            }
        };

        window.saveTaskNotes = function(taskId) {
            const notesTextarea = document.getElementById(`taskNotes_${taskId}`);
            const saveBtn = document.getElementById(`saveNoteBtn_${taskId}`);
            
            if (notesTextarea && appState.progress[taskId]) {
                appState.progress[taskId].notes = notesTextarea.value;
                appState.progress[taskId].lastUpdated = new Date().toISOString();
                saveUserProgress(taskId, appState.progress[taskId]);
                
                if (saveBtn) {
                    saveBtn.textContent = '✅ Saved!';
                    saveBtn.classList.add('saved');
                    
                    setTimeout(() => {
                        saveBtn.textContent = '💾 Save Note';
                        saveBtn.classList.remove('saved');
                    }, 2000);
                }
                
                const hasContent = notesTextarea.value.trim().length > 0;
                if (hasContent) {
                    notesTextarea.classList.add('has-content');
                    notesTextarea.title = 'Click to edit your notes';
                } else {
                    notesTextarea.classList.remove('has-content');
                    notesTextarea.title = '';
                }
                
                console.log('Notes saved for task:', taskId);
                
                if (hasContent) {
                    notificationSystem.success('📝 Notes saved successfully!');
                } else {
                    notificationSystem.info('📝 Notes cleared');
                }
            }
        };

        window.toggleTaskCompletion = async function(taskId) {
            try {
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const isCompleted = appState.progress[taskId].completed;
                
                appState.progress[taskId].completed = !isCompleted;
                appState.progress[taskId].completedAt = !isCompleted ? new Date().toISOString() : null;
                appState.progress[taskId].lastUpdated = new Date().toISOString();
                
                const taskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                const taskItem = taskCheckbox?.closest('.task-item');
                
                if (taskCheckbox && taskItem) {
                    taskCheckbox.checked = !isCompleted;
                    if (!isCompleted) {
                        taskItem.classList.add('completed');
                    } else {
                        taskItem.classList.remove('completed');
                    }
                }
                
                await saveUserProgress(taskId, appState.progress[taskId]);
                
                updateProgressDisplay();
                
                checkLabCompletion();
                
            } catch (error) {
                console.error('Failed to toggle task completion:', error);
                notificationSystem.error('Failed to save progress. Please try again.');
            }
        };

        window.toggleWeekExpansion = function(weekNum, event) {
            if (event && event.target) {
                const taskItem = event.target.closest('.task-item');
                const taskList = event.target.closest('.task-list');
                
                if (taskItem || taskList) {
                    return;
                }
            }
            
            const weekCards = document.querySelectorAll('.week-card');
            const targetCard = weekCards[weekNum - 1];
            
            if (targetCard) {
                targetCard.classList.toggle('expanded');
            }
        };

        window.toggleMobileThemeMenu = function(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const themeOptions = document.getElementById('mobileThemeOptions');
            const themeToggle = document.getElementById('mobileThemeToggle');
            
            if (themeOptions && themeToggle) {
                if (themeOptions.style.display === 'none' || !themeOptions.style.display) {
                    themeOptions.style.display = 'flex';
                    themeToggle.innerHTML = 'Theme ▼';
                } else {
                    themeOptions.style.display = 'none';
                    themeToggle.innerHTML = 'Theme ▶';
                }
            }
        };

        window.showUserLabHistory = function(userName, userEmail) {
            notificationSystem.info('User lab history requires backend implementation');
        };

        // Category management functions
        window.showCategoryView = function(categoryId) {
            const category = TRAINING_CATEGORIES[categoryId];
            
            if (!category) {
                notificationSystem.error('Category not found');
                return;
            }
            
            if (category.type === 'lab') {
                // Show Exchange LAB interface with progress tracking
                appState.currentCategory = categoryId;
                appState.currentView = 'lab';
                
                // Update dashboard title
                const dashboardTitle = document.querySelector('.dashboard-title');
                const dashboardSubtitle = document.querySelector('.dashboard-subtitle');
                
                if (dashboardTitle) {
                    dashboardTitle.textContent = category.title;
                }
                if (dashboardSubtitle) {
                    dashboardSubtitle.textContent = category.description;
                }
                
                // Show course view with progress tracking
                document.getElementById('categoriesContainer').classList.add('hidden');
                document.getElementById('courseView').classList.remove('hidden');
                document.getElementById('tutorialView').classList.add('hidden');
                
                // Generate week cards for Exchange LAB
                generateWeekCards();
                updateProgressDisplay();
                
            } else if (category.type === 'tutorial') {
                // Navigate to the appropriate HTML file
                window.location.href = `/assets/${categoryId}.html`;
            }
        };

        window.showTutorialView = function(categoryId) {
            // This function is kept for compatibility but redirects to HTML files
            window.location.href = `/assets/${categoryId}.html`;
        };

        window.showCategoriesView = function() {
            appState.currentCategory = null;
            appState.currentView = 'categories';
            
            // Reset dashboard title
            const dashboardTitle = document.querySelector('.dashboard-title');
            const dashboardSubtitle = document.querySelector('.dashboard-subtitle');
            
            if (dashboardTitle) {
                dashboardTitle.textContent = 'Your Training Journey';
            }
            if (dashboardSubtitle) {
                dashboardSubtitle.textContent = 'Exchange Hybrid LAB with progress tracking + comprehensive MSP tutorials';
            }
            
            // Show categories, hide other views
            document.getElementById('categoriesContainer').classList.remove('hidden');
            document.getElementById('courseView').classList.add('hidden');
            document.getElementById('tutorialView').classList.add('hidden');
            
            // Generate category cards
            generateCategoryCards();
        };

        window.showRequestAccessModal = function() {
            showModal('requestAccessModal');
        };

        window.showTutorialDetail = function(categoryId, courseIndex) {
            const category = TRAINING_CATEGORIES[categoryId];
            const courseName = category.courses[courseIndex];
            
            // Get tutorial content from loaded tutorial files
            let tutorialContent = null;
            
            // Try to get content from tutorial modules
            switch(categoryId) {
                case 'networking':
                    tutorialContent = window.NETWORKING_TUTORIALS && window.NETWORKING_TUTORIALS[Object.keys(window.NETWORKING_TUTORIALS)[courseIndex]];
                    break;
                case 'azure':
                    tutorialContent = window.AZURE_TUTORIALS && window.AZURE_TUTORIALS[Object.keys(window.AZURE_TUTORIALS)[courseIndex]];
                    break;
                case 'microsoft365':
                    tutorialContent = window.MICROSOFT365_TUTORIALS && window.MICROSOFT365_TUTORIALS[Object.keys(window.MICROSOFT365_TUTORIALS)[courseIndex]];
                    break;
                case 'firewalls':
                    tutorialContent = window.FIREWALL_TUTORIALS && window.FIREWALL_TUTORIALS[Object.keys(window.FIREWALL_TUTORIALS)[courseIndex]];
                    break;
                case 'backup':
                    tutorialContent = window.BACKUP_TUTORIALS && window.BACKUP_TUTORIALS[Object.keys(window.BACKUP_TUTORIALS)[courseIndex]];
                    break;
                case 'linux':
                    tutorialContent = window.LINUX_TUTORIALS && window.LINUX_TUTORIALS[Object.keys(window.LINUX_TUTORIALS)[courseIndex]];
                    break;
                case 'tools':
                    tutorialContent = window.TOOLS_TUTORIALS && window.TOOLS_TUTORIALS[Object.keys(window.TOOLS_TUTORIALS)[courseIndex]];
                    break;
            }
            
            // Set modal content
            document.getElementById('tutorialDetailTitle').textContent = courseName;
            
            if (tutorialContent && tutorialContent.content) {
                document.getElementById('tutorialDetailContent').innerHTML = tutorialContent.content;
            } else {
                document.getElementById('tutorialDetailContent').innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📚</div>
                        <h3>Tutorial Available</h3>
                        <p>This tutorial contains step-by-step instructions for:</p>
                        <p><strong>${courseName}</strong></p>
                        <p style="margin-top: 2rem; font-size: 0.9rem;">
                            Tutorial content loaded from <code>/assets/tutorials/${categoryId}.js</code>
                        </p>
                    </div>
                `;
            }
            
            showModal('tutorialDetailModal');
        };

        // Mobile menu functionality
        function setupMobileMenuHandlers() {
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const hamburger = document.getElementById('hamburger');
                
                if (mobileMenu && hamburger && !mobileMenu.contains(event.target) && !hamburger.contains(event.target)) {
                    closeMobileMenu();
                }
            });
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (hamburger) hamburger.classList.remove('active');
            if (mobileMenu) mobileMenu.classList.remove('active');
            
            closeMobileThemeMenu();
            
            setTimeout(() => {
                updateMobileMenuItems();
            }, 100);
        }

        function updateMobileMenuItems() {
            const mobileMenuItems = document.getElementById('mobileMenuItems');
            
            if (appState.authenticated && appState.user) {
                let adminItem = '';
                if (appState.user.role === 'admin') {
                    adminItem = '<button class="mobile-menu-item" onclick="showAdminPanel(); closeMobileMenu();" id="mobileAdminButton">Admin Panel</button>';
                }
                
                mobileMenuItems.innerHTML = `
                    <div style="padding: 0.5rem 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
                        Welcome, ${appState.user.name}
                    </div>
                    <button class="mobile-menu-item" onclick="startLabEnvironment(); closeMobileMenu();">Start New Lab</button>
                    <button class="mobile-menu-item" onclick="showLabHistoryModal(); closeMobileMenu();">Lab History</button>
                    ${adminItem}
                    <button class="mobile-menu-item" onclick="toggleMobileThemeMenu(event)" id="mobileThemeToggle">
                        Theme ▶
                    </button>
                    <div id="mobileThemeOptions" style="display: none;">
                        <button class="mobile-menu-item" onclick="setTheme('light'); closeMobileMenu();">
                            Light Jedi
                        </button>
                        <button class="mobile-menu-item" onclick="setTheme('dark'); closeMobileMenu();">
                            Dark Sith
                        </button>
                    </div>
                    <button class="mobile-menu-item" onclick="logout(); closeMobileMenu();">Sign Out</button>
                `;
            } else {
                mobileMenuItems.innerHTML = '';
            }
        }

        function closeMobileThemeMenu() {
            const themeOptions = document.getElementById('mobileThemeOptions');
            if (themeOptions) {
                themeOptions.style.display = 'none';
            }
        }

        function generateLabHistoryHTML(history) {
            if (history.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No Exchange LAB sessions found for this period.</div>';
            }
            
            const sortedHistory = [...history].sort((a, b) => {
                if (a.status === 'started' && b.status !== 'started') return -1;
                if (b.status === 'started' && a.status !== 'started') return 1;
                
                return b.session - a.session;
            });
            
            return sortedHistory.map(session => {
                const isInProgress = session.status === 'started';
                const statusIcon = session.status === 'completed' ? '✅' : '🧪';
                const statusText = session.status === 'completed' ? 'Completed' : 'In Progress';
                const statusColor = session.status === 'completed' ? 'var(--success)' : 'var(--primary)';
                
                const currentProgress = getCurrentLabProgress();
                const completedTasks = isInProgress ? currentProgress.completedTasks : (session.tasksCompleted || 0);
                
                let labTitle;
                if (isInProgress) {
                    labTitle = `${statusIcon} Current Exchange LAB (${session.labId})`;
                } else {
                    const labNumber = session.labId ? session.labId.replace('LAB', '').replace(/^0+/, '') : session.session;
                    labTitle = `${statusIcon} Exchange LAB ${labNumber} (${session.labId})`;
                }
                
                const progressPercentage = Math.round((completedTasks / (session.totalTasks || 43)) * 100);
                
                return `
                    <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; ${isInProgress ? 'border-color: var(--primary); background: linear-gradient(135deg, rgba(0, 168, 255, 0.05), transparent);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; ${isInProgress ? 'color: var(--primary);' : ''}">${labTitle}</span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                            Session #${session.session} • ${new Date(session.date).toLocaleDateString()}
                        </div>
                        
                        <div style="background: var(--surface); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                            <div style="height: 100%; background: ${statusColor}; width: ${progressPercentage}%; transition: width 0.5s ease;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="color: ${isInProgress ? 'var(--primary)' : 'var(--success)'}; font-size: 0.9rem; font-weight: 600;">
                                Tasks: ${completedTasks}/${session.totalTasks || 43} (${progressPercentage}%)
                            </span>
                            ${isInProgress ? 
                                '<span style="color: var(--primary); font-size: 0.8rem; font-weight: 600;">⚡ ACTIVE</span>' : 
                                `<span style="color: var(--success); font-size: 0.8rem; font-weight: 600;">🏆 DONE</span>`
                            }
                        </div>
                        
                        <div style="color: var(--text-secondary); font-size: 0.75rem;">
                            ${session.completedAt ? 
                                `✅ Completed: ${new Date(session.completedAt).toLocaleDateString()} at ${new Date(session.completedAt).toLocaleTimeString()}` : 
                                session.startedAt ? 
                                `🧪 Started: ${new Date(session.startedAt).toLocaleDateString()} at ${new Date(session.startedAt).toLocaleTimeString()}` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCurrentLabProgress() {
            let totalTasks = 43;
            let completedTasks = 0;
            
            if (appState.currentCategory === 'exchange-lab') {
                const categoryTasks = appState.tasks.filter(task => task.category === 'exchange-lab');
                totalTasks = categoryTasks.length || 43;
                completedTasks = categoryTasks.filter(task => 
                    appState.progress[task.id] && appState.progress[task.id].completed
                ).length;
            } else {
                completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            }
            
            return { completedTasks, totalTasks };
        }

        function handleSubtaskChange(taskId, step, isCompleted) {
            if (!appState.progress[taskId].subtasks) {
                appState.progress[taskId].subtasks = {};
            }
            
            appState.progress[taskId].subtasks[step] = {
                completed: isCompleted,
                completedAt: isCompleted ? new Date().toISOString() : null
            };
            
            const checkbox = document.querySelector(`[data-step="${step}"]`);
            const subtaskItem = checkbox?.closest('.subtask-item');
            
            if (subtaskItem) {
                if (isCompleted) {
                    subtaskItem.classList.add('completed');
                } else {
                    subtaskItem.classList.remove('completed');
                }
            }
            
            const allSubtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
            const completedSubtasks = Array.from(allSubtaskCheckboxes).filter(cb => cb.checked);
            
            if (completedSubtasks.length === allSubtaskCheckboxes.length && allSubtaskCheckboxes.length > 0) {
                appState.progress[taskId].completed = true;
                appState.progress[taskId].completedAt = new Date().toISOString();
                
                notificationSystem.success(`🎉 Task completed: ${window.TASK_DEFINITIONS[taskId].title}`);
                
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = true;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.add('completed');
                    }
                }
                
                updateProgressDisplay();
            } else if (appState.progress[taskId].completed && completedSubtasks.length < allSubtaskCheckboxes.length) {
                appState.progress[taskId].completed = false;
                
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = false;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.remove('completed');
                    }
                }
                
                updateProgressDisplay();
            }
            
            saveUserProgress(taskId, appState.progress[taskId]);
        }

        // UI state management
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            
            document.body.classList.add('no-scroll', 'landing-page');
            
            const headerButtons = document.getElementById('headerButtons');
            const userMenu = document.getElementById('userMenu');
            
            if (headerButtons) headerButtons.classList.remove('hidden');
            if (userMenu) userMenu.classList.add('hidden');
            
            if (window.innerWidth <= 768) {
                if (headerButtons) {
                    headerButtons.style.display = 'none';
                    headerButtons.style.visibility = 'hidden';
                }
                if (userMenu) {
                    userMenu.style.display = 'none';
                    userMenu.style.visibility = 'hidden';
                    userMenu.style.pointerEvents = 'none';
                    userMenu.style.position = 'fixed';
                    userMenu.style.left = '-9999px';
                    userMenu.style.top = '-9999px';
                    userMenu.style.zIndex = '-1';
                }
                
                const userMenuDropdown = document.getElementById('userMenuDropdown');
                if (userMenuDropdown) {
                    userMenuDropdown.style.display = 'none';
                    userMenuDropdown.style.visibility = 'hidden';
                    userMenuDropdown.style.pointerEvents = 'none';
                }
            } else {
                if (headerButtons) {
                    headerButtons.style.display = '';
                    headerButtons.style.visibility = '';
                }
            }
            
            closeMobileMenu();
            updateMobileMenuItems();
        }

        function showDashboard() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            
            document.body.classList.remove('no-scroll', 'landing-page');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            if (mobileMenu) {
                mobileMenu.classList.remove('show', 'active');
            }
            if (hamburger) {
                hamburger.classList.remove('active');
            }
            
            const headerButtons = document.getElementById('headerButtons');
            const userMenu = document.getElementById('userMenu');
            
            if (headerButtons) headerButtons.classList.add('hidden');
            if (userMenu) userMenu.classList.remove('hidden');
            
            if (window.innerWidth > 768) {
                const userNameEl = document.getElementById('userName');
                if (userNameEl && appState.user) {
                    userNameEl.textContent = appState.user.name;
                }
                
                if (appState.user && appState.user.role === 'admin') {
                    const adminBtn = document.getElementById('adminButton');
                    if (adminBtn) adminBtn.style.display = 'block';
                }
            }
            
            // Show categories view by default
            showCategoriesView();
            closeMobileMenu();
            updateMobileMenuItems();
        }

        function generateCategoryCards() {
            const container = document.getElementById('categoriesContainer');
            if (!container) return;

            // Separate Exchange Lab and tutorials
            const labCategory = appState.categories.find(cat => cat.type === 'lab');
            const tutorialCategories = appState.categories.filter(cat => cat.type === 'tutorial');

            let labSection = '';
            if (labCategory) {
                const categoryTasks = appState.tasks.filter(task => task.category === labCategory.id);
                const completedTasks = categoryTasks.filter(task => 
                    appState.progress[task.id] && appState.progress[task.id].completed
                ).length;
                const totalTasks = categoryTasks.length || 43;
                const progressPercentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                labSection = `
                    <div class="lab-section">
                        <div class="lab-card-container">
                            <div class="category-card lab-card" onclick="showCategoryView('${labCategory.id}')">
                                <div class="category-header">
                                    <div class="category-icon">${labCategory.icon}</div>
                                    <div class="category-title">${labCategory.title}</div>
                                </div>
                                <div class="category-description">${labCategory.description}</div>
                                <div class="category-stats">
                                    <div class="category-count">${labCategory.courses.length} weeks</div>
                                    <div class="category-progress">${progressPercentage}% complete</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            const tutorialsSection = `
                <div class="tutorials-section">
                    <h2>Tutorials</h2>
                    <div class="tutorials-container">
                        ${tutorialCategories.map(category => `
                            <div class="category-card tutorial-card" onclick="showCategoryView('${category.id}')">
                                <div class="category-header">
                                    <div class="category-icon">${category.icon}</div>
                                    <div class="category-title">${category.title}</div>
                                </div>
                                <div class="category-description">${category.description}</div>
                                <div class="category-stats">
                                    <div class="category-count">${category.courses.length} topics</div>
                                    <div class="category-progress">Step-by-step</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = labSection + tutorialsSection;
        }

        function generateWeekCards() {
            const container = document.getElementById('weeksContainer');
            if (!container) return;

            if (appState.currentCategory !== 'exchange-lab') {
                container.innerHTML = '<p>Week cards are only available for the Exchange Hybrid LAB.</p>';
                return;
            }

            const weekGroups = groupTasksByWeek();
            
            container.innerHTML = Object.keys(weekGroups).map(weekNum => {
                const week = weekGroups[weekNum];
                const completedTasks = week.tasks.filter(task => 
                    appState.progress[task.id] && appState.progress[task.id].completed
                ).length;
                const progressPercentage = Math.round((completedTasks / week.tasks.length) * 100);
                
                return `
                    <div class="week-card" onclick="toggleWeekExpansion(${weekNum}, event)">
                        <div class="week-header">
                            <div>
                                <div class="week-title">${week.title}</div>
                                <div class="week-tasks">${completedTasks}/${week.tasks.length} tasks</div>
                            </div>
                            <div class="expand-icon">▼</div>
                        </div>
                        <div class="week-progress">
                            <div class="week-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="week-description">${week.description}</div>
                        
                        <div class="task-list">
                            ${week.tasks.map(task => {
                                const isCompleted = appState.progress[task.id] && appState.progress[task.id].completed;
                                return `
                                    <div class="task-item ${isCompleted ? 'completed' : ''}" onclick="event.stopPropagation()">
                                        <input type="checkbox" class="task-checkbox" 
                                               ${isCompleted ? 'checked' : ''} 
                                               onchange="toggleTaskCompletion('${task.id}')"
                                               onclick="event.stopPropagation()">
                                        <div class="task-content" onclick="event.stopPropagation(); showTaskDetail('${task.id}')">
                                            <div class="task-title">${task.title}</div>
                                            <div class="task-description">Click for details →</div>
                                        </div>
                                        <button class="task-detail-btn" onclick="event.stopPropagation(); showTaskDetail('${task.id}')">
                                            Details
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function groupTasksByWeek() {
            const weeks = {};
            
            // Define proper week descriptions for Exchange LAB
            const weekDescriptions = {
                1: {
                    title: 'Week 1: Foundation & Domain Setup',
                    description: '2012 Server promoted to DC, VM joined to domain, network shares with security groups'
                },
                2: {
                    title: 'Week 2: Infrastructure & Updates', 
                    description: 'Install 2nd server, setup WSUS, configure time servers'
                },
                3: {
                    title: 'Week 3: Exchange & Mail Flow',
                    description: 'Upgrade to Server 2016, install Exchange, create mailboxes, internal mail flow'
                },
                4: {
                    title: 'Week 4: Hybrid & External Access',
                    description: 'Publish mail externally, setup Office 365 hybrid environment'
                }
            };
            
            // Filter tasks for Exchange LAB only
            const labTasks = appState.tasks.filter(task => task.category === 'exchange-lab');
            
            labTasks.forEach(task => {
                const weekNum = task.week || 1;
                if (!weeks[weekNum]) {
                    const weekInfo = weekDescriptions[weekNum] || {
                        title: `Week ${weekNum}: Training`,
                        description: `Complete ${labTasks.filter(t => t.week === weekNum).length} tasks in this week`
                    };
                    
                    weeks[weekNum] = {
                        title: weekInfo.title,
                        description: weekInfo.description,
                        tasks: []
                    };
                }
                weeks[weekNum].tasks.push(task);
            });
            
            return weeks;
        }

        function updateProgressDisplay() {
            if (appState.currentCategory !== 'exchange-lab') return;
            
            const categoryTasks = appState.tasks.filter(task => task.category === 'exchange-lab');
            const totalTasks = categoryTasks.length || 43;
            const completedTasks = categoryTasks.filter(task => 
                appState.progress[task.id] && appState.progress[task.id].completed
            ).length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);
            
            const circumference = 2 * Math.PI * 54;
            const offset = circumference - (percentage / 100) * circumference;
            const progressRing = document.getElementById('progressRing');
            if (progressRing) {
                progressRing.style.strokeDasharray = `${circumference - offset} ${circumference}`;
            }
            
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
            
            const courseView = document.getElementById('courseView');
            if (courseView && !courseView.classList.contains('hidden')) {
                generateWeekCards();
            }
            
            if (appState.authenticated) {
                checkLabCompletion();
            }
        }

        // Admin functions
        function showAdminPanelFallback(customMessage) {
            const content = document.getElementById('adminContent');
            const message = customMessage || 'Admin features will be available once the backend is deployed.';
            
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">👑</div>
                    <h3>Admin Panel</h3>
                    <p>${message}</p>
                    <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem;">📚 To enable full admin features:</h4>
                        <ol style="text-align: left; max-width: 400px; margin: 0 auto;">
                            <li>Deploy the Functions files to <code>/functions/api/</code></li>
                            <li>Configure your serverless functions</li>
                            <li>Admin panel will automatically work</li>
                        </ol>
                        <div style="margin-top: 1rem; font-size: 0.9rem; background: var(--surface); padding: 0.5rem; border-radius: 4px;">
                            Files needed:<br>
                            <code>/functions/api/admin/users-progress.js</code><br>
                            <code>/functions/api/lab/start.js</code><br>
                            <code>/functions/api/user/lab-history.js</code>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        Current mode: <strong>KV Backend Required</strong>
                    </div>
                </div>
            `;
            showModal('adminModal');
        }

        function displayAdminPanel(usersData) {
            const content = document.getElementById('adminContent');
            
            if (!Array.isArray(usersData)) {
                console.error('Expected array but got:', usersData);
                content.innerHTML = '<p style="text-align: center; color: var(--danger); padding: 2rem;">Invalid data format received from server.</p>';
                return;
            }
            
            if (usersData.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No users found.</p>';
            } else {
                usersData.sort((a, b) => {
                    if (a.completedTasks !== b.completedTasks) {
                        return b.completedTasks - a.completedTasks;
                    }
                    return b.progressPercentage - a.progressPercentage;
                });
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Exchange LAB Leaderboard - ${usersData.length} Users</strong>
                        <small style="color: var(--text-secondary);">📊 Sorted by Progress</small>
                    </div>
                    ${usersData.map((user, index) => {
                        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `#${index + 1}`;
                        return `
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${medal} ${user.name}</span>
                                    <span style="color: var(--success); font-weight: 600;">${user.progressPercentage}%</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    ${user.email} • ${user.role}
                                </div>
                                <div style="background: var(--surface); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div style="height: 100%; background: var(--success); width: ${user.progressPercentage}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--primary);">${user.completedTasks}/43</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Tasks Done</div>
                                    </div>
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--success);">${user.completedLabs || 0}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Labs Completed</div>
                                    </div>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem; display: flex; justify-content: space-between;">
                                    <span>${user.hasNotes ? '📝 Has notes' : 'No notes'}</span>
                                    <span>Last: ${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never'}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }
            
            showModal('adminModal');
        }

        // Modal management functions
        window.showModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            closeMobileMenu();
        };

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        };

        window.showSignInModal = function() {
            const passwordGroup = document.getElementById('passwordGroup');
            const rememberGroup = document.getElementById('rememberGroup');
            const emailInput = document.getElementById('signInEmail');
            const passwordInput = document.getElementById('signInPassword');
            const submitBtn = document.querySelector('#signInForm .password-toggle');
            const modalBody = document.querySelector('#signInModal .modal-body');
            
            if (passwordGroup) passwordGroup.classList.add('hidden');
            if (rememberGroup) rememberGroup.classList.add('hidden');
            if (emailInput) {
                emailInput.value = '';
                emailInput.classList.remove('loading');
            }
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.type = 'password';
            }
            if (submitBtn) submitBtn.classList.remove('loading');
            if (modalBody) modalBody.classList.add('initial-state');
            
            showModal('signInModal');
        };

        window.toggleUserMenu = function() {
            const dropdown = document.getElementById('userMenuDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking session...');
            
            // Initialize systems
            loadTaskDefinitions();
            offlineSystem.init();
            checkExistingSession();
            setupMobileMenuHandlers();
            setupFormHandlers();
            
            // Clean up mobile menu state
            const mobileMenu = document.getElementById('mobileMenu');
            const hamburger = document.querySelector('.hamburger');
            if (mobileMenu) {
                mobileMenu.classList.remove('show', 'active');
            }
            if (hamburger) {
                hamburger.classList.remove('active');
            }
            
            // Handle window resize
            window.addEventListener('resize', function() {
                closeMobileMenu();
            });
            
            // Progressive Web App registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(function(registration) {
                    console.log('PWA Service Worker registered successfully:', registration.scope);
                }).catch(function(error) {
                    console.log('PWA Service Worker registration failed (optional):', error);
                });
            }
        });

        // Close modals and menus when clicking outside
        document.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
            
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userMenuDropdown');
            if (userMenu && dropdown && !userMenu.contains(event.target) && dropdown.classList.contains('active')) {
                dropdown.classList.remove('active');
            }
        });

        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error, e.filename, e.lineno);
            notificationSystem.error('An unexpected error occurred. Please refresh the page.');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            notificationSystem.error('A network error occurred. Please check your connection.');
        });

        // Performance monitoring
        window.addEventListener('load', function() {
            if ('performance' in window) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log('Page load time:', loadTime + 'ms');
            }
        });
    </script>
</body>
</html>