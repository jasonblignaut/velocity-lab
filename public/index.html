<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Velocity Lab - Exchange Hybrid Training</title>
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }
    
    :root {
      /* Apple/Azure inspired color palette */
      --primary: #007AFF;
      --primary-hover: #0056CC;
      --success: #34C759;
      --warning: #FF9500;
      --error: #FF3B30;
      --text-primary: #1D1D1F;
      --text-secondary: #8E8E93;
      --text-tertiary: #C7C7CC;
      --background: #F2F2F7;
      --surface: #FFFFFF;
      --surface-secondary: #F9F9F9;
      --border: #D1D1D6;
      --border-light: #E5E5EA;
      --shadow-light: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-medium: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-heavy: 0 8px 25px rgba(0,0,0,0.12);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
      --transition-fast: all 0.2s cubic-bezier(0.2, 0, 0, 1);
      
      /* Dark theme overrides */
      --dark-primary: #0A84FF;
      --dark-text-primary: #FFFFFF;
      --dark-text-secondary: #98989D;
      --dark-text-tertiary: #636366;
      --dark-background: #000000;
      --dark-surface: #1C1C1E;
      --dark-surface-secondary: #2C2C2E;
      --dark-border: #38383A;
      --dark-border-light: #48484A;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.5;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      transition: var(--transition);
    }
    
    body.dark {
      background: var(--dark-background);
      color: var(--dark-text-primary);
      --text-primary: var(--dark-text-primary);
      --text-secondary: var(--dark-text-secondary);
      --text-tertiary: var(--dark-text-tertiary);
      --surface: var(--dark-surface);
      --surface-secondary: var(--dark-surface-secondary);
      --border: var(--dark-border);
      --border-light: var(--dark-border-light);
      --primary: var(--dark-primary);
    }
    
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      padding: 0 20px; 
    }
    
    /* Header Styles */
    header {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border-light);
      z-index: 1000;
      transition: var(--transition);
    }
    
    body.dark header {
      background: rgba(28, 28, 30, 0.85);
    }
    
    nav {
      height: 64px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo img {
      height: 32px;
      transition: var(--transition-fast);
    }
    
    .logo img:hover { 
      transform: scale(1.05); 
    }
    
    .nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: var(--radius-lg);
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
      text-decoration: none;
      min-height: 36px;
      white-space: nowrap;
      position: relative;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    .btn-secondary {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--surface-secondary);
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }
    
    .btn-admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-admin:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    /* Lab Button with Dropdown */
    .lab-button-container {
      position: relative;
      display: inline-block;
    }
    
    .lab-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-medium);
      min-width: 200px;
      z-index: 1001;
      display: none;
      overflow: hidden;
    }
    
    .lab-dropdown.show {
      display: block;
    }
    
    .lab-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: var(--transition-fast);
      border-bottom: 1px solid var(--border-light);
    }
    
    .lab-dropdown-item:last-child {
      border-bottom: none;
    }
    
    .lab-dropdown-item:hover {
      background: var(--surface-secondary);
    }
    
    .lab-dropdown-header {
      font-weight: 600;
      color: var(--text-primary);
      background: var(--surface-secondary);
      border-bottom: 1px solid var(--border);
    }
    
    .theme-selector {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      min-width: 140px;
    }
    
    .theme-selector:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    .theme-selector:hover {
      border-color: var(--primary);
    }
    
    /* Layout Utilities */
    .hidden { 
      display: none !important; 
    }
    
    /* Landing Page */
    #landing {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 64px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    #landing h1 {
      font-size: clamp(48px, 8vw, 72px);
      font-weight: 700;
      margin-bottom: 24px;
      letter-spacing: -0.02em;
    }
    
    #landing p {
      font-size: 20px;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto 40px;
      line-height: 1.6;
    }
    
    .landing-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .landing-actions .btn {
      min-width: 120px;
      padding: 12px 24px;
      font-size: 16px;
    }
    
    /* Dashboard */
    #dashboard {
      padding: 100px 0 60px;
      min-height: 100vh;
    }
    
    /* Progress Card */
    .progress-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: 40px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-light);
      text-align: center;
      transition: var(--transition);
      border: 1px solid var(--border-light);
    }
    
    .progress-card:hover {
      box-shadow: var(--shadow-medium);
    }
    
    .progress-card h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 32px;
      color: var(--text-primary);
    }
    
    /* Progress Ring */
    .progress-ring {
      width: 180px;
      height: 180px;
      margin: 0 auto 32px;
      position: relative;
    }
    
    .progress-ring svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    
    .progress-ring circle {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
    }
    
    .progress-ring .background {
      stroke: var(--border);
    }
    
    .progress-ring .foreground {
      stroke: var(--primary);
      stroke-dasharray: 565;
      stroke-dashoffset: 565;
      transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .progress-percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      font-weight: 700;
      color: var(--primary);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 24px;
      margin: 32px 0;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    /* Week Cards */
    .weeks-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .week-card {
      background: var(--surface);
      border-radius: var(--radius-xl);
      overflow: hidden;
      transition: var(--transition);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-light);
    }
    
    .week-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }
    
    .week-header {
      padding: 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-fast);
      border-bottom: 1px solid transparent;
    }
    
    .week-header:hover {
      background: var(--surface-secondary);
    }
    
    .week-info h3 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }
    
    .week-info p {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .week-progress {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    
    .progress-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .progress-bar {
      width: 120px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary);
      transition: width var(--transition);
      border-radius: 3px;
    }
    
    .expand-icon {
      width: 20px;
      height: 20px;
      color: var(--text-secondary);
      transition: var(--transition-fast);
      margin-left: 16px;
    }
    
    .week-card.expanded .expand-icon {
      transform: rotate(90deg);
    }
    
    /* Tasks Container */
    .tasks-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-top: 1px solid var(--border-light);
    }
    
    .week-card.expanded .tasks-container {
      max-height: 2000px;
    }
    
    .tasks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      padding: 24px;
    }
    
    /* Task Items */
    .task-item {
      background: var(--surface-secondary);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .task-item:hover {
      background: var(--surface);
      transform: translateY(-1px);
      box-shadow: var(--shadow-light);
    }
    
    .task-item.completed {
      background: rgba(52, 199, 89, 0.1);
      border-color: var(--success);
    }
    
    .task-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
    }
    
    .task-checkbox:checked {
      background: var(--success);
      border-color: var(--success);
    }
    
    .task-checkbox:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .task-content {
      flex: 1;
    }
    
    .task-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    
    .task-description {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      z-index: 2000;
      padding: 20px;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: var(--surface);
      border-radius: var(--radius-xl);
      padding: 32px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-heavy);
      position: relative;
      animation: modalAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--surface-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: var(--transition-fast);
    }
    
    .modal-close:hover {
      background: var(--border);
      color: var(--text-primary);
    }
    
    /* Form Styles */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 16px;
      transition: var(--transition-fast);
      background: var(--surface);
      color: var(--text-primary);
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .form-checkbox {
      margin-right: 8px;
    }
    
    .form-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      margin-bottom: 16px;
      cursor: pointer;
    }
    
    /* Subtask Styles */
    .subtask-container {
      margin: 16px 0;
    }
    
    .subtask-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }
    
    .subtask-item:hover {
      background: var(--surface-secondary);
    }
    
    .subtask {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }
    
    .subtask:hover {
      background: var(--surface-secondary);
    }
    
    .subtask input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      margin-top: 2px;
      transition: var(--transition-fast);
      appearance: none;
      -webkit-appearance: none;
    }
    
    .subtask input[type="checkbox"]:checked {
      background: var(--success);
      border-color: var(--success);
    }
    
    .subtask input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 11px;
      font-weight: bold;
    }
    
    .subtask label {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-primary);
      cursor: pointer;
      flex: 1;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 84px;
      right: 20px;
      padding: 16px 24px;
      border-radius: var(--radius-md);
      color: white;
      font-weight: 600;
      transform: translateX(320px);
      transition: var(--transition);
      box-shadow: var(--shadow-medium);
      z-index: 3000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      background: var(--success);
    }
    
    .notification.error {
      background: var(--error);
    }
    
    /* Admin Portal Styles */
    .admin-content {
      max-width: 1000px;
      width: 100%;
    }
    
    .admin-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 32px;
      background: var(--surface-secondary);
      padding: 4px;
      border-radius: var(--radius-md);
    }
    
    .admin-tab {
      flex: 1;
      padding: 12px 20px;
      text-align: center;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
      font-weight: 600;
      color: var(--text-secondary);
    }
    
    .admin-tab.active {
      background: var(--surface);
      color: var(--primary);
      box-shadow: var(--shadow-light);
    }
    
    .admin-section {
      display: none;
    }
    
    .admin-section.active {
      display: block;
    }
    
    /* Table Styles */
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-light);
    }
    
    .admin-table th,
    .admin-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-light);
    }
    
    .admin-table th {
      background: var(--surface-secondary);
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .admin-table tbody tr:hover {
      background: var(--surface-secondary);
    }
    
    /* User Cards */
    .user-card {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: var(--transition-fast);
    }
    
    .user-card:hover {
      box-shadow: var(--shadow-light);
      transform: translateY(-1px);
    }
    
    .user-info h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .user-info p {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .user-actions {
      display: flex;
      gap: 12px;
    }
    
    .user-progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin: 8px 0;
      width: 200px;
    }
    
    .user-progress-fill {
      height: 100%;
      background: var(--primary);
      transition: var(--transition);
    }
    
    /* Loading State */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 0 16px;
      }
      
      nav {
        height: 56px;
      }
      
      .nav-right {
        gap: 8px;
      }
      
      #dashboard {
        padding: 80px 0 40px;
      }
      
      .progress-card {
        padding: 24px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .tasks-grid {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      
      .week-header {
        padding: 16px;
      }
      
      .week-progress {
        align-items: center;
      }
      
      .progress-bar {
        width: 80px;
      }
      
      .modal-content {
        padding: 24px;
        margin: 10px;
      }
      
      .landing-actions {
        flex-direction: column;
        align-items: center;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .user-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .user-actions {
        width: 100%;
        justify-content: flex-end;
      }
      
      .lab-dropdown {
        right: 0;
        left: auto;
      }
    }
    
    @media (max-width: 480px) {
      #landing h1 {
        font-size: 36px;
      }
      
      #landing p {
        font-size: 18px;
      }
      
      .progress-ring {
        width: 140px;
        height: 140px;
      }
      
      .progress-percentage {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav class="container">
      <div class="logo">
        <img src="/assets/Velocity-Logo.png" alt="Velocity Lab">
      </div>
      <div class="nav-right">
        <span id="auth-buttons">
          <button onclick="window.showLogin()" class="btn btn-secondary">Sign In</button>
          <button onclick="window.showRegister()" class="btn btn-primary">Register</button>
        </span>
        <span id="user-menu" class="hidden">
          <span id="user-name" style="margin-right: 12px; font-weight: 600;"></span>
          <button id="admin-button" class="btn btn-admin hidden" onclick="window.showAdmin()">Admin Portal</button>
          <button onclick="window.logout()" class="btn btn-secondary">Sign Out</button>
          <select class="theme-selector" onchange="window.changeTheme(this.value)">
            <option value="auto">Force Balance (Auto)</option>
            <option value="light">Jedi (Light)</option>
            <option value="dark">Sith (Dark)</option>
          </select>
        </span>
      </div>
    </nav>
  </header>

  <main>
    <section id="landing">
      <div class="container">
        <h1>Master Exchange Hybrid</h1>
        <p>42 hands-on tasks over 4 weeks. Build a comprehensive lab with Domain Controllers, Exchange Server, and workstation VMs in a production-ready environment.</p>
        <div class="landing-actions">
          <button class="btn btn-primary" onclick="window.showRegister()">Get Started</button>
          <button class="btn btn-secondary" onclick="window.showLogin()">Sign In</button>
        </div>
      </div>
    </section>

    <section id="dashboard" class="hidden">
      <div class="container">
        <div class="progress-card">
          <h2>Training Progress</h2>
          <div class="progress-ring">
            <svg viewBox="0 0 180 180">
              <circle cx="90" cy="90" r="85" class="foreground" id="progress-ring"/>
            </svg>
            <div class="progress-percentage" id="progress-percentage">0%</div>
          </div>
          <div class="stats-grid">
            <div class="stat">
              <div class="stat-value" id="completed-tasks">0</div>
              <div class="stat-label">Tasks Done</div>
            </div>
            <div class="stat">
              <div class="stat-value">42</div>
              <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat">
              <div class="stat-value" id="current-week">Week 1</div>
              <div class="stat-label">Current</div>
            </div>
            <div class="stat">
              <div class="stat-value">3</div>
              <div class="stat-label">VMs</div>
            </div>
          </div>
          <div class="lab-button-container">
            <button class="btn btn-primary" onclick="window.toggleLabDropdown()">Start New Lab ▼</button>
            <div class="lab-dropdown" id="lab-dropdown">
              <div class="lab-dropdown-header">Lab Options</div>
              <div class="lab-dropdown-item" onclick="window.startNewLab(); window.closeLabDropdown();">
                🚀 Start Fresh Lab
              </div>
              <div class="lab-dropdown-item" onclick="window.showLabHistory(); window.closeLabDropdown();">
                📅 Lab History
              </div>
            </div>
          </div>
        </div>

        <div class="weeks-container" id="weeks-container">
          <div class="week-card" id="week1-card">
            <div class="week-header" onclick="window.toggleWeek('week1')">
              <div class="week-info">
                <h3>Week 1: Foundation Setup</h3>
                <p>Domain Controller setup, domain join, and file shares</p>
              </div>
              <div class="week-progress">
                <div class="progress-text"><span id="week1-completed">0</span>/13 tasks</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="week1-progress" style="width: 0%;"></div>
                </div>
              </div>
              <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
              </svg>
            </div>
            <div class="tasks-container" id="week1-tasks">
              <div class="tasks-grid" id="week1-tasks-grid"></div>
            </div>
          </div>

          <div class="week-card" id="week2-card">
            <div class="week-header" onclick="window.toggleWeek('week2')">
              <div class="week-info">
                <h3>Week 2: Infrastructure Services</h3>
                <p>Second DC, WSUS server, and time synchronization</p>
              </div>
              <div class="week-progress">
                <div class="progress-text"><span id="week2-completed">0</span>/8 tasks</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="week2-progress" style="width: 0%;"></div>
                </div>
              </div>
              <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
              </svg>
            </div>
            <div class="tasks-container" id="week2-tasks">
              <div class="tasks-grid" id="week2-tasks-grid"></div>
            </div>
          </div>

          <div class="week-card" id="week3-card">
            <div class="week-header" onclick="window.toggleWeek('week3')">
              <div class="week-info">
                <h3>Week 3: Exchange Server</h3>
                <p>DC upgrades, Exchange 2019 installation and configuration</p>
              </div>
              <div class="week-progress">
                <div class="progress-text"><span id="week3-completed">0</span>/12 tasks</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="week3-progress" style="width: 0%;"></div>
                </div>
              </div>
              <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
              </svg>
            </div>
            <div class="tasks-container" id="week3-tasks">
              <div class="tasks-grid" id="week3-tasks-grid"></div>
            </div>
          </div>

          <div class="week-card" id="week4-card">
            <div class="week-header" onclick="window.toggleWeek('week4')">
              <div class="week-info">
                <h3>Week 4: Hybrid Configuration</h3>
                <p>Microsoft 365 integration and hybrid mail flow</p>
              </div>
              <div class="week-progress">
                <div class="progress-text"><span id="week4-completed">0</span>/10 tasks</div>
                <div class="progress-bar">
                  <div class="progress-fill" id="week4-progress" style="width: 0%;"></div>
                </div>
              </div>
              <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9,18 15,12 9,6"></polyline>
              </svg>
            </div>
            <div class="tasks-container" id="week4-tasks">
              <div class="tasks-grid" id="week4-tasks-grid"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Sign In</h2>
        <button class="modal-close" onclick="window.closeModal()">&times;</button>
      </div>
      <form id="login-form">
        <div class="form-group">
          <input type="email" name="email" placeholder="Email address" required class="form-input">
        </div>
        <div class="form-group">
          <input type="password" name="password" placeholder="Password" required class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" name="remember" class="form-checkbox"> Remember me
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 16px;">Sign In</button>
        <p style="text-align: center; color: var(--text-secondary);">
          New to Velocity Lab? <a href="#" onclick="window.showRegister()" style="color: var(--primary);">Create account</a>
        </p>
      </form>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="register-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Account</h2>
        <button class="modal-close" onclick="window.closeModal()">&times;</button>
      </div>
      <form id="register-form">
        <div class="form-group">
          <input type="text" name="name" placeholder="Full name" required class="form-input">
        </div>
        <div class="form-group">
          <input type="email" name="email" placeholder="Email address" required class="form-input">
        </div>
        <div class="form-group">
          <input type="password" name="password" placeholder="Password (8+ characters)" required minlength="8" class="form-input">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 16px;">Create Account</button>
        <p style="text-align: center; color: var(--text-secondary);">
          Already have an account? <a href="#" onclick="window.showLogin()" style="color: var(--primary);">Sign in</a>
        </p>
      </form>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="task-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title" id="task-title"></h2>
        <button class="modal-close" onclick="window.closeModal()">&times;</button>
      </div>
      <div id="task-content"></div>
    </div>
  </div>

  <!-- Lab History Modal -->
  <div id="lab-history-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Lab History</h2>
        <button class="modal-close" onclick="window.closeModal()">&times;</button>
      </div>
      <div id="lab-history-content">
        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
          No lab history available yet. Complete your first lab to see history here.
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Portal Modal -->
  <div id="admin-modal" class="modal">
    <div class="admin-content modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Admin Portal</h2>
        <button class="modal-close" onclick="window.closeModal()">&times;</button>
      </div>
      
      <div class="admin-tabs">
        <div class="admin-tab active" onclick="window.switchAdminTab('leaderboard')">Leaderboard</div>
        <div class="admin-tab" onclick="window.switchAdminTab('users')">Users</div>
        <div class="admin-tab" onclick="window.switchAdminTab('data')">Data Tools</div>
      </div>

      <div id="admin-leaderboard" class="admin-section active">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Name</th>
              <th>Progress</th>
              <th>Tasks</th>
              <th>Last Login</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <tr>
              <td colspan="5" style="text-align: center; padding: 40px;">
                <div class="loading"></div>
              </td>
            </tr>
          </tbody>
        </table>
        <button class="btn btn-secondary" onclick="window.refreshLeaderboard()" style="margin-top: 16px;">
          Refresh Data
        </button>
      </div>

      <div id="admin-users" class="admin-section">
        <div id="users-list">
          <div style="text-align: center; padding: 40px;">
            <div class="loading"></div>
          </div>
        </div>
      </div>

      <div id="admin-data" class="admin-section">
        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="window.exportProgress()">Export Progress (CSV)</button>
          <input type="file" accept=".csv" id="import-file" onchange="window.importProgress(this.files)" style="display: none;">
          <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">Import Progress</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <script src="/task-definitions.js"></script>
  <script>
    // IMMEDIATE GLOBAL FUNCTION DEFINITIONS - Must be first!
    window.showLogin = function() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
      document.getElementById('login-modal').style.display = 'flex';
    };

    window.showRegister = function() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
      document.getElementById('register-modal').style.display = 'flex';
    };

    window.closeModal = function() {
      document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
    };

    window.logout = function() {
      if (window.authSystem) {
        window.authSystem.logout();
      }
    };

    // Assign to window for global access  
    window.taskSystem = tasks;

    // Assign to window for global access
    window.uiSystem = ui;

    window.startNewLab = function() {
      if (window.labSystem) {
        window.labSystem.startNew();
      }
    };

    window.showAdmin = function() {
      if (window.adminSystem) {
        window.adminSystem.showPortal();
      }
    };

    window.toggleWeek = function(week) {
      if (window.uiSystem) {
        window.uiSystem.toggleWeek(week);
      }
    };

    window.toggleLabDropdown = function() {
      if (window.uiSystem) {
        window.uiSystem.toggleLabDropdown();
      }
    };

    window.closeLabDropdown = function() {
      if (window.uiSystem) {
        window.uiSystem.closeLabDropdown();
      }
    };

    window.showLabHistory = function() {
      if (window.uiSystem) {
        window.uiSystem.showLabHistory();
      }
    };

    window.switchAdminTab = function(tab) {
      if (window.adminSystem) {
        window.adminSystem.switchTab(tab);
      }
    };

    window.refreshLeaderboard = function() {
      if (window.adminSystem) {
        window.adminSystem.refreshLeaderboard();
      }
    };

    window.exportProgress = function() {
      if (window.adminSystem) {
        window.adminSystem.exportProgress();
      }
    };

    window.importProgress = function(files) {
      if (window.adminSystem) {
        window.adminSystem.importProgress(files);
      }
    };

    window.changeTheme = function(theme) {
      if (window.uiSystem) {
        window.uiSystem.changeTheme(theme);
      }
    };

    window.openTaskModal = function(week, task) {
      if (window.taskSystem) {
        window.taskSystem.openModal(week, task);
      }
    };

    window.toggleTask = function(week, task, checked) {
      if (window.taskSystem) {
        window.taskSystem.toggle(week, task, checked);
      }
    };

    // NOW START THE MAIN APPLICATION CODE
    (function() {
    // Task structure matching backend
    const TASKS = {
      week1: ['install-server2012', 'configure-static-ip', 'install-adds-role', 'promote-to-dc', 'configure-dns-server', 'create-domain-users', 'join-vm-domain', 'create-hidden-share', 'map-drive-gpo', 'map-drive-script', 'map-drive-powershell', 'create-security-group', 'restrict-share-access'],
      week2: ['install-second-server', 'promote-additional-dc', 'install-wsus-role', 'configure-wsus-settings', 'setup-wsus-gpo', 'configure-primary-time', 'configure-secondary-time', 'test-infrastructure'],
      week3: ['backup-servers', 'upgrade-dc1-2016', 'upgrade-dc2-2016', 'raise-functional-levels', 'install-exchange-server', 'install-exchange-prereqs', 'extend-ad-schema', 'install-exchange-2019', 'configure-exchange-basic', 'create-mailboxes', 'test-mailbox-access', 'configure-internal-mailflow'],
      week4: ['configure-external-dns', 'setup-firewall-rules', 'install-ssl-certificates', 'configure-external-mailflow', 'setup-modern-auth', 'prepare-m365-tenant', 'install-aad-connect', 'run-hybrid-wizard', 'configure-hybrid-mailflow', 'verify-hybrid-functionality']
    };

    // Application state
    let appState = {
      user: null,
      progress: {},
      authenticated: false,
      sessionToken: null,
      isLoading: false,
      labHistory: []
    };

    // Utility functions
    const $ = id => document.getElementById(id);
    const show = element => element?.classList.remove('hidden');
    const hide = element => element?.classList.add('hidden');

    // Define closeModal as a standalone function too for internal use
    function closeModal() {
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
    }

    // Cookie management
    const cookies = {
      get: name => document.cookie.match(`${name}=([^;]+)`)?.[1],
      set: (name, value, days = 7) => {
        document.cookie = `${name}=${value};path=/;max-age=${days * 86400};SameSite=Strict;Secure`;
      },
      delete: name => {
        document.cookie = `${name}=;path=/;max-age=0;SameSite=Strict;Secure`;
      }
    };

    // Notification system
    function showNotification(message, type = 'success') {
      const notification = $('notification');
      notification.textContent = message;
      notification.className = `notification ${type} show`;
      setTimeout(() => notification.classList.remove('show'), 4000);
    }

    // API helper with improved error handling and timeout management
    async function apiCall(endpoint, options = {}) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
      
      try {
        appState.isLoading = true;
        const headers = new Headers(options.headers || {});
        
        if (appState.sessionToken) {
          headers.set('Authorization', `Bearer ${appState.sessionToken}`);
        }

        const isGet = !options.method || options.method.toUpperCase() === 'GET';
        let body;

        if (!isGet) {
          // Get CSRF token for non-GET requests
          const csrfResponse = await fetch('/api/csrf', { 
            credentials: 'same-origin',
            signal: controller.signal
          });
          if (!csrfResponse.ok) {
            throw new Error('Failed to get CSRF token');
          }
          const { token } = await csrfResponse.json();

          if (options.body instanceof FormData) {
            body = options.body;
            body.append('csrf_token', token);
          } else {
            body = new FormData();
            if (options.body) {
              for (const [key, value] of Object.entries(options.body)) {
                body.append(key, value);
              }
            }
            body.append('csrf_token', token);
          }
        }

        const response = await fetch(endpoint, {
          credentials: 'same-origin',
          headers,
          method: options.method || 'GET',
          body,
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          // Handle specific error cases
          if (response.status === 401) {
            throw new Error('Invalid credentials or session expired');
          } else if (response.status === 403) {
            throw new Error('Access denied - insufficient permissions');
          } else if (response.status === 409) {
            throw new Error('Email already registered');
          }
          throw new Error(`Server error (${response.status})`);
        }

        const data = await response.json();
        if (!data.success) {
          throw new Error(data.error || 'Request failed');
        }

        return data;
      } catch (error) {
        clearTimeout(timeoutId);
        if (error.name === 'AbortError') {
          throw new Error('Request timed out');
        }
        console.error(`API error for ${endpoint}:`, error);
        throw error;
      } finally {
        appState.isLoading = false;
      }
    }

    // Authentication functions
    const auth = {
      async checkSession() {
        const userCookie = cookies.get('user');
        appState.sessionToken = cookies.get('session');
        
        if (userCookie && appState.sessionToken) {
          try {
            appState.user = JSON.parse(decodeURIComponent(userCookie));
            appState.authenticated = true;
            
            if (appState.user.role === 'admin') {
              show($('admin-button'));
            }
            
            ui.showDashboard();
            await dashboard.loadProgress();
          } catch (error) {
            console.error('Session check error:', error);
            auth.logout();
          }
        } else {
          ui.showLanding();
        }
      },

      async login(formData) {
        try {
          const response = await apiCall('/api/login', {
            method: 'POST',
            body: formData
          });

          cookies.set('user', encodeURIComponent(JSON.stringify({
            name: response.name,
            role: response.role,
            email: response.email
          })));
          cookies.set('session', response.sessionToken);

          appState.user = {
            name: response.name,
            role: response.role,
            email: response.email
          };
          appState.authenticated = true;
          appState.sessionToken = response.sessionToken;

          if (appState.user.role === 'admin') {
            show($('admin-button'));
          }

          ui.showDashboard();
          await dashboard.loadProgress();
          closeModal();
          showNotification(`Welcome back, ${response.name}!`);
        } catch (error) {
          showNotification(error.message, 'error');
        }
      },

      async register(formData) {
        try {
          const response = await apiCall('/api/register', {
            method: 'POST',
            body: formData
          });

          cookies.set('user', encodeURIComponent(JSON.stringify({
            name: response.name,
            role: response.role,
            email: response.email
          })));
          cookies.set('session', response.sessionToken);

          appState.user = {
            name: response.name,
            role: response.role,
            email: response.email
          };
          appState.authenticated = true;
          appState.sessionToken = response.sessionToken;

          ui.showDashboard();
          await dashboard.loadProgress();
          closeModal();
          showNotification(`Welcome to Velocity Lab, ${response.name}!`);
        } catch (error) {
          showNotification(error.message, 'error');
        }
      },

      logout() {
        apiCall('/api/logout', { method: 'POST' }).catch(console.error);
        
        cookies.delete('user');
        cookies.delete('session');
        
        appState = {
          user: null,
          progress: {},
          authenticated: false,
          sessionToken: null,
          isLoading: false,
          labHistory: []
        };

        hide($('admin-button'));
        ui.showLanding();
        showNotification('Signed out successfully');
      }
    };

    // UI management
    const ui = {
      showLanding() {
        hide($('dashboard'));
        show($('landing'));
        hide($('user-menu'));
        show($('auth-buttons'));
      },

      showDashboard() {
        hide($('landing'));
        show($('dashboard'));
        show($('user-menu'));
        hide($('auth-buttons'));
        $('user-name').textContent = appState.user?.name || '';
      },

      toggleWeek(week) {
        const weekCard = $(`${week}-card`);
        const isExpanded = weekCard.classList.contains('expanded');
        
        // Close all other weeks first
        document.querySelectorAll('.week-card').forEach(card => {
          card.classList.remove('expanded');
        });
        
        // Toggle current week
        if (!isExpanded) {
          weekCard.classList.add('expanded');
        }
      },

      toggleLabDropdown() {
        const dropdown = $('lab-dropdown');
        dropdown.classList.toggle('show');
        
        // Close dropdown when clicking outside
        setTimeout(() => {
          document.addEventListener('click', this.closeLabDropdownOnOutsideClick, { once: true });
        }, 0);
      },

      closeLabDropdown() {
        $('lab-dropdown').classList.remove('show');
      },

      closeLabDropdownOnOutsideClick(e) {
        const dropdown = $('lab-dropdown');
        const container = document.querySelector('.lab-button-container');
        if (!container.contains(e.target)) {
          ui.closeLabDropdown();
        }
      },

      showLabHistory() {
        // For now, show a placeholder. This can be extended with actual history data
        const historyContent = $('lab-history-content');
        
        // Get completion dates from localStorage (simple implementation)
        const labHistory = JSON.parse(localStorage.getItem('labHistory') || '[]');
        
        if (labHistory.length === 0) {
          historyContent.innerHTML = `
            <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
              No lab history available yet. Complete your first lab to see history here.
            </p>
          `;
        } else {
          historyContent.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 16px;">
              ${labHistory.map((lab, index) => `
                <div style="background: var(--surface-secondary); padding: 16px; border-radius: var(--radius-md); border: 1px solid var(--border-light);">
                  <h4 style="margin-bottom: 8px;">Lab #${index + 1}</h4>
                  <p style="color: var(--text-secondary); font-size: 14px;">
                    Started: ${new Date(lab.startDate).toLocaleDateString()}<br>
                    ${lab.endDate ? `Completed: ${new Date(lab.endDate).toLocaleDateString()}` : 'In Progress'}<br>
                    Progress: ${lab.progress || 0}% (${lab.completedTasks || 0}/42 tasks)
                  </p>
                </div>
              `).join('')}
            </div>
          `;
        }
        
        $('lab-history-modal').style.display = 'flex';
      },

      changeTheme(theme) {
        localStorage.setItem('theme', theme);
        
        if (theme === 'dark') {
          document.body.classList.add('dark');
        } else if (theme === 'light') {
          document.body.classList.remove('dark');
        } else if (theme === 'auto') {
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark');
          } else {
            document.body.classList.remove('dark');
          }
        }
      }
    };

    // Assign to window for global access
    window.authSystem = auth;

    // Assign to window for global access
    window.adminSystem = admin;

    // Dashboard functionality
    const dashboard = {
      async loadProgress() {
        if (!appState.authenticated) return;
        
        try {
          const response = await apiCall('/api/progress');
          appState.progress = response.data || {};
          dashboard.updateDisplay();
        } catch (error) {
          console.error('Progress load error:', error);
          showNotification('Failed to load progress', 'error');
        }
      },

      updateDisplay() {
        let totalCompleted = 0;
        const totalTasks = 42;

        Object.entries(TASKS).forEach(([week, tasks]) => {
          const weekProgress = appState.progress[week] || {};
          const weekCompleted = tasks.filter(task => weekProgress[task]?.completed).length;
          totalCompleted += weekCompleted;

          // Update week progress
          const completedElement = $(`${week}-completed`);
          const progressElement = $(`${week}-progress`);
          const tasksGrid = $(`${week}-tasks-grid`);

          if (completedElement) {
            completedElement.textContent = weekCompleted;
          }
          
          if (progressElement) {
            const percentage = (weekCompleted / tasks.length) * 100;
            progressElement.style.width = `${percentage}%`;
          }

          // Update tasks grid
          if (tasksGrid) {
            tasksGrid.innerHTML = tasks.map(task => {
              const isCompleted = weekProgress[task]?.completed || false;
              const taskTitle = task.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
              
              return `
                <div class="task-item ${isCompleted ? 'completed' : ''}" onclick="openTaskModal('${week}', '${task}')">
                  <input type="checkbox" class="task-checkbox" ${isCompleted ? 'checked' : ''} 
                         onchange="toggleTask('${week}', '${task}', this.checked)" 
                         onclick="event.stopPropagation()">
                  <div class="task-content">
                    <div class="task-title">${taskTitle}</div>
                    <div class="task-description">Click for details</div>
                  </div>
                </div>
              `;
            }).join('');
          }
        });

        // Update overall progress
        const progressPercentage = Math.round((totalCompleted / totalTasks) * 100);
        const progressRing = $('progress-ring');
        const progressText = $('progress-percentage');
        const completedTasksElement = $('completed-tasks');
        const currentWeekElement = $('current-week');

        if (progressText) {
          progressText.textContent = `${progressPercentage}%`;
        }
        
        if (completedTasksElement) {
          completedTasksElement.textContent = totalCompleted;
        }
        
        if (currentWeekElement) {
          let currentWeek = 'Week 1';
          if (totalCompleted >= 32) currentWeek = 'Week 4';
          else if (totalCompleted >= 20) currentWeek = 'Week 3';
          else if (totalCompleted >= 13) currentWeek = 'Week 2';
          currentWeekElement.textContent = currentWeek;
        }

        if (progressRing) {
          const circumference = 2 * Math.PI * 85; // radius = 85
          const offset = circumference - (progressPercentage / 100) * circumference;
          progressRing.style.strokeDashoffset = offset;
        }
      }
    };

    // Task management with auto-tick functionality
    async function toggleTask(week, task, checked) {
      try {
        const formData = new FormData();
        formData.append('week', week);
        formData.append('task', task);
        formData.append('checked', checked.toString());

        await apiCall('/api/progress', {
          method: 'POST',
          body: formData
        });

        // Update local state
        if (!appState.progress[week]) {
          appState.progress[week] = {};
        }
        if (!appState.progress[week][task]) {
          appState.progress[week][task] = {};
        }
        appState.progress[week][task].completed = checked;

        dashboard.updateDisplay();
        showNotification(checked ? '✅ Task completed!' : 'Task unmarked');
      } catch (error) {
        console.error('Toggle task error:', error);
        showNotification('Failed to update task', 'error');
        // Revert checkbox state on error
        event.target.checked = !checked;
      }
    }

    async function toggleSubtask(week, task, step, checked) {
      try {
        const formData = new FormData();
        formData.append('week', week);
        formData.append('task', task);
        formData.append('subtask', `step${step}`);
        formData.append('subtask_checked', checked.toString());

        await apiCall('/api/progress', {
          method: 'POST',
          body: formData
        });

        // Update local state
        if (!appState.progress[week]) appState.progress[week] = {};
        if (!appState.progress[week][task]) appState.progress[week][task] = { subtasks: {} };
        if (!appState.progress[week][task].subtasks) appState.progress[week][task].subtasks = {};
        appState.progress[week][task].subtasks[`step${step}`] = checked;

        // Auto-tick main task if all subtasks are completed
        await checkAndAutoTickMainTask(week, task);

        showNotification(checked ? '✅ Step completed!' : 'Step unmarked');
      } catch (error) {
        console.error('Toggle subtask error:', error);
        showNotification('Failed to update step', 'error');
      }
    }

    // Auto-tick main task when all subtasks are completed
    async function checkAndAutoTickMainTask(week, task) {
      const taskProgress = appState.progress[week]?.[task];
      if (!taskProgress || !taskProgress.subtasks) return;

      // Get the task definition to count expected subtasks
      const taskKey = `${week}-${task}`;
      const taskDefinition = window.TASK_DEFINITIONS?.[taskKey];
      if (!taskDefinition) return;

      // Count subtasks in the task definition
      const subtaskMatches = taskDefinition.description.match(/data-step="\d+"/g);
      const expectedSubtasks = subtaskMatches ? subtaskMatches.length : 0;
      
      if (expectedSubtasks === 0) return;

      // Count completed subtasks
      const completedSubtasks = Object.values(taskProgress.subtasks).filter(Boolean).length;

      // If all subtasks are completed and main task isn't already completed, auto-tick it
      if (completedSubtasks === expectedSubtasks && !taskProgress.completed) {
        const mainTaskCheckbox = document.querySelector(`input[onchange*="toggleTask('${week}', '${task}'"]`);
        if (mainTaskCheckbox && !mainTaskCheckbox.checked) {
          mainTaskCheckbox.checked = true;
          await toggleTask(week, task, true);
          showNotification('🎉 Task auto-completed! All steps finished.');
        }
      }
    }

    // Week expansion/collapse
    function toggleWeek(week) {
      const weekCard = $(`${week}-card`);
      const isExpanded = weekCard.classList.contains('expanded');
      
      // Close all other weeks first
      document.querySelectorAll('.week-card').forEach(card => {
        card.classList.remove('expanded');
      });
      
      // Toggle current week
      if (!isExpanded) {
        weekCard.classList.add('expanded');
      }
    }

    // Lab dropdown management
    function toggleLabDropdown() {
      const dropdown = $('lab-dropdown');
      dropdown.classList.toggle('show');
      
      // Close dropdown when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeLabDropdownOnOutsideClick, { once: true });
      }, 0);
    }

    function closeLabDropdown() {
      $('lab-dropdown').classList.remove('show');
    }

    function closeLabDropdownOnOutsideClick(e) {
      const dropdown = $('lab-dropdown');
      const container = document.querySelector('.lab-button-container');
      if (!container.contains(e.target)) {
        closeLabDropdown();
      }
    }

    // Lab History functionality
    function showLabHistory() {
      // For now, show a placeholder. This can be extended with actual history data
      const historyContent = $('lab-history-content');
      
      // Get completion dates from localStorage (simple implementation)
      const labHistory = JSON.parse(localStorage.getItem('labHistory') || '[]');
      
      if (labHistory.length === 0) {
        historyContent.innerHTML = `
          <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
            No lab history available yet. Complete your first lab to see history here.
          </p>
        `;
      } else {
        historyContent.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 16px;">
            ${labHistory.map((lab, index) => `
              <div style="background: var(--surface-secondary); padding: 16px; border-radius: var(--radius-md); border: 1px solid var(--border-light);">
                <h4 style="margin-bottom: 8px;">Lab #${index + 1}</h4>
                <p style="color: var(--text-secondary); font-size: 14px;">
                  Started: ${new Date(lab.startDate).toLocaleDateString()}<br>
                  ${lab.endDate ? `Completed: ${new Date(lab.endDate).toLocaleDateString()}` : 'In Progress'}<br>
                  Progress: ${lab.progress || 0}% (${lab.completedTasks || 0}/42 tasks)
                </p>
              </div>
            `).join('')}
          </div>
        `;
      }
       class="background"/>
              <circle cx="90" cy="90" r="85"