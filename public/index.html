showLanding() {
                utils.hide(utils.getId('dashboard'));
                utils.show(utils.getId('landing'));
                utils.hide(utils.getId('user-menu'));
                utils.show(utils.getId('auth-buttons'));
                
                const labButton = utils.getId('lab-env-button');
                if (labButton) labButton.classList.remove('authenticated');
                
                // Update mobile menu
                utils.show(utils.getId('mobile-auth-buttons'));
                utils.hide(utils.getId('mobile-user-menu'));
                utils.hide(utils.getId('mobile-lab-section'));
                utils.hide(utils.getId('mobile-admin-section'));
                utils.hide(utils.getId('mobile-signout-section'));
                
                document.body.style.overflow = 'auto';
            },<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Velocity Lab - Exchange Hybrid Migration</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <script src="/assets/task-definitions.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Enhanced Color System */
            --primary: #007AFF; --primary-hover: #0056CC; --primary-light: #3395FF; --primary-dark: #004999;
            --success: #34C759; --success-light: #5AD577; --warning: #FF9500; --warning-light: #FFB340;
            --error: #FF3B30; --error-light: #FF6B5B; --info: #5AC8FA; --info-light: #7DD4FB;
            
            /* Enhanced Text Colors */
            --text-primary: #1D1D1F; --text-secondary: #6B7280; --text-tertiary: #9CA3AF; --text-muted: #BEBEBE;
            
            /* Enhanced Backgrounds */
            --background: #F2F2F7; --background-secondary: #FFFFFF; --surface: #FFFFFF; --surface-secondary: #F9F9F9;
            --surface-tertiary: #F0F0F0; --surface-elevated: #FEFEFE;
            
            /* Enhanced Borders */
            --border: #D1D1D6; --border-light: #E5E5EA; --border-heavy: #AEAEB2;
            
            /* Enhanced Shadows */
            --shadow-color: rgba(0,0,0,.08); --shadow-color-light: rgba(0,0,0,.04); --shadow-color-medium: rgba(0,0,0,.12);
            --shadow-light: 0 1px 3px var(--shadow-color-light); --shadow-medium: 0 4px 12px var(--shadow-color);
            --shadow-heavy: 0 8px 25px var(--shadow-color-medium); --shadow-focus: 0 0 0 4px rgba(0,122,255,.25);
            
            /* Enhanced Spacing */
            --spacing-xs: 4px; --spacing-sm: 8px; --spacing-md: 16px; --spacing-lg: 24px; --spacing-xl: 32px; --spacing-xxl: 48px;
            
            /* Enhanced Radius */
            --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px; --radius-xxl: 24px; --radius-full: 50%;
            
            /* Enhanced Transitions */
            --transition: all .3s cubic-bezier(0.25, 0.46, 0.45, 0.94); --transition-fast: all .15s ease; --transition-bounce: all .4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Dark Mode Variables */
            --dark-primary: #0A84FF; --dark-text-primary: #FFFFFF; --dark-text-secondary: #9CA3AF; --dark-text-tertiary: #6B7280;
            --dark-background: #000000; --dark-background-secondary: #0A0A0A; --dark-surface: #1C1C1E; --dark-surface-secondary: #2C2C2E;
            --dark-surface-tertiary: #3A3A3C; --dark-border: #38383A; --dark-border-light: #48484A; --dark-shadow-color: rgba(0,0,0,0.5);
            
            /* Animation Variables */
            --bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55); --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        /* Dark Mode Implementation */
        body.dark {
            background: var(--dark-background); color: var(--dark-text-primary);
            --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary); --text-tertiary: var(--dark-text-tertiary);
            --background: var(--dark-background); --background-secondary: var(--dark-background-secondary);
            --surface: var(--dark-surface); --surface-secondary: var(--dark-surface-secondary); --surface-tertiary: var(--dark-surface-tertiary);
            --border: var(--dark-border); --border-light: var(--dark-border-light); --primary: var(--dark-primary);
            --shadow-color: var(--dark-shadow-color); --shadow-color-light: rgba(255,255,255,0.05); --shadow-color-medium: rgba(0,0,0,0.8);
        }
        
        /* Enhanced Typography */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', system-ui, sans-serif;
            background: var(--background); color: var(--text-primary); line-height: 1.6; font-size: 16px;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden;
            letter-spacing: -0.01em;
        }
        
        /* Enhanced Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--spacing-md); }
        @media (max-width: 768px) { .container { padding: 0 var(--spacing-sm); } }
        
        /* Enhanced Header */
        header {
            position: fixed; top: 0; width: 100%; 
            background: rgba(255,255,255,.85); backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border-light); z-index: 1000; transition: var(--transition);
            height: 60px;
        }
        body.dark header { background: rgba(28,28,30,.85); }
        
        nav { 
            height: 60px; display: flex; justify-content: space-between; align-items: center; 
            position: relative;
        }
        
        /* Enhanced Logo */
        .logo {
            display: flex; align-items: center;
        }
        .logo img { 
            height: 32px; width: auto; transition: var(--transition-bounce); 
            filter: drop-shadow(0 2px 4px var(--shadow-color));
        }
        .logo img:hover { transform: scale(1.05) rotate(5deg); }
        
        /* Enhanced Navigation */
        .nav-right { display: flex; align-items: center; gap: var(--spacing-sm); }
        
        /* Mobile Navigation */
        .mobile-menu-button {
            display: none; width: 40px; height: 40px; border: none; background: var(--surface);
            border-radius: var(--radius-lg); cursor: pointer; transition: var(--transition);
            box-shadow: var(--shadow-light); position: relative; overflow: hidden;
        }
        .mobile-menu-button:hover { background: var(--surface-secondary); transform: scale(1.05); }
        
        .hamburger {
            width: 18px; height: 2px; background: var(--text-primary); position: relative;
            margin: 0 auto; transition: var(--transition);
        }
        .hamburger::before, .hamburger::after {
            content: ''; position: absolute; width: 18px; height: 2px; background: var(--text-primary);
            transition: var(--transition); left: 0;
        }
        .hamburger::before { top: -6px; }
        .hamburger::after { top: 6px; }
        
        .mobile-menu-button.active .hamburger { background: transparent; }
        .mobile-menu-button.active .hamburger::before { transform: rotate(45deg); top: 0; }
        .mobile-menu-button.active .hamburger::after { transform: rotate(-45deg); top: 0; }
        
        .mobile-nav {
            position: absolute; top: 100%; right: 0; background: var(--surface-elevated);
            border: 1px solid var(--border); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-heavy); min-width: 280px; z-index: 1001;
            opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.95);
            transition: var(--transition); overflow: hidden; max-height: 80vh;
            overflow-y: auto;
        }
        .mobile-nav.show { 
            opacity: 1; visibility: visible; transform: translateY(0) scale(1); 
        }
        
        .mobile-nav-section {
            padding: var(--spacing-md); border-bottom: 1px solid var(--border-light);
        }
        .mobile-nav-section:last-child { border-bottom: none; }
        .mobile-nav-section h3 {
            font-size: 14px; font-weight: 700; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: var(--spacing-sm);
        }
        
        .mobile-nav-item {
            display: flex; align-items: center; gap: var(--spacing-sm); padding: var(--spacing-sm);
            cursor: pointer; border-radius: var(--radius-md); transition: var(--transition);
            margin-bottom: var(--spacing-xs); font-size: 14px; color: var(--text-primary);
        }
        .mobile-nav-item:hover { background: var(--surface-secondary); }
        .mobile-nav-item:last-child { margin-bottom: 0; }
        
        /* Lab Environment Button in Navbar */
        .lab-env-button {
            display: none; /* Hidden until authenticated */
        }
        .lab-env-button.authenticated { display: inline-flex; }
        
        /* Enhanced Buttons */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-lg); border: none;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition);
            min-height: 36px; white-space: nowrap; position: relative; overflow: hidden;
            font-family: inherit; display: inline-flex; align-items: center; justify-content: center;
            text-decoration: none; user-select: none; outline: none;
        }
        .btn:focus-visible { box-shadow: var(--shadow-focus); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); 
            color: #ffffff; box-shadow: var(--shadow-light);
        }
        .btn-primary:hover:not(:disabled) { 
            background: linear-gradient(135deg, var(--primary-hover) 0%, var(--primary) 100%); 
            transform: translateY(-1px); box-shadow: var(--shadow-medium);
        }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-secondary { 
            background: var(--surface); color: var(--text-primary); border: 1px solid var(--border);
            box-shadow: var(--shadow-light);
        }
        .btn-secondary:hover:not(:disabled) { 
            background: var(--surface-secondary); transform: translateY(-1px); 
            border-color: var(--border-heavy); box-shadow: var(--shadow-medium);
        }
        
        .btn-admin { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: #ffffff; position: relative; overflow: hidden;
        }
        .btn-admin::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        .btn-admin:hover::before { left: 100%; }
        .btn-admin:hover:not(:disabled) { transform: translateY(-1px); box-shadow: var(--shadow-heavy); }
        
        /* Enhanced Dropdowns */
        .lab-button-container { position: relative; display: inline-block; }
        .lab-dropdown {
            position: absolute; top: calc(100% + var(--spacing-xs)); right: 0; 
            background: var(--surface-elevated); border: 1px solid var(--border); 
            border-radius: var(--radius-lg); box-shadow: var(--shadow-heavy); 
            min-width: 220px; z-index: 1001; 
            opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.95);
            transition: var(--transition); overflow: hidden;
        }
        .lab-dropdown.show { 
            opacity: 1; visibility: visible; transform: translateY(0) scale(1); 
        }
        .lab-dropdown-item {
            padding: var(--spacing-md); cursor: pointer; transition: var(--transition-fast);
            border-bottom: 1px solid var(--border-light); font-size: 14px; color: var(--text-primary);
            display: flex; align-items: center; gap: var(--spacing-sm);
        }
        .lab-dropdown-item:last-child { border-bottom: none; }
        .lab-dropdown-item:hover { 
            background: var(--surface-secondary); 
            padding-left: calc(var(--spacing-md) + var(--spacing-xs));
        }
        
        /* Enhanced Theme Selector */
        .theme-selector {
            padding: var(--spacing-sm) var(--spacing-md); border: 1px solid var(--border); 
            border-radius: var(--radius-lg); background: var(--surface); color: var(--text-primary); 
            font-size: 14px; font-weight: 600; cursor: pointer; min-width: 100px; font-family: inherit;
            appearance: none; transition: var(--transition);
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2212%22%20height%3D%228%22%20viewBox%3D%220%200%2012%208%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M1%201L6%206L11%201%22%20stroke%3D%22%236B7280%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right var(--spacing-sm) center; 
            padding-right: calc(var(--spacing-md) + 16px);
        }
        .theme-selector:hover { border-color: var(--border-heavy); background-color: var(--surface-secondary); }
        .theme-selector:focus { box-shadow: var(--shadow-focus); }
        body.dark .theme-selector {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2212%22%20height%3D%228%22%20viewBox%3D%220%200%2012%208%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cpath%20d%3D%22M1%201L6%206L11%201%22%20stroke%3D%22%239CA3AF%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%2F%3E%3C%2Fsvg%3E');
        }
        
        @media (max-width: 968px) {
            .nav-right > *:not(.mobile-menu-button) { display: none; }
            .mobile-menu-button { display: flex; align-items: center; justify-content: center; }
            .lab-env-button.authenticated { display: none; } /* Hide in mobile, show in dropdown */
        }
        
        /* Enhanced Utility Classes */
        .hidden { display: none !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        
        /* Enhanced Landing Section */
        #landing {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            text-align: center; padding-top: 60px; background: var(--background);
            position: relative; overflow: hidden;
        }
        #landing::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(0,122,255,0.05) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(52,199,89,0.05) 0%, transparent 50%);
            pointer-events: none;
        }
        #landing .container { position: relative; z-index: 1; }
        #landing h1 { 
            font-size: clamp(32px, 6vw, 64px); font-weight: 800; margin-bottom: var(--spacing-lg); 
            line-height: 1.1; background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            animation: fadeInUp 0.8s var(--ease-out-quart);
        }
        #landing p { 
            font-size: 18px; opacity: 0.85; max-width: 600px; margin: 0 auto var(--spacing-xl); 
            line-height: 1.6; color: var(--text-secondary);
            animation: fadeInUp 0.8s var(--ease-out-quart) 0.2s both;
        }
        .landing-actions { 
            display: flex; gap: var(--spacing-md); justify-content: center; align-items: center; flex-wrap: wrap;
            animation: fadeInUp 0.8s var(--ease-out-quart) 0.4s both;
        }
        
        /* Enhanced Dashboard */
        #dashboard { padding: calc(60px + var(--spacing-xl)) 0 var(--spacing-xl); min-height: 100vh; }
        
        /* Enhanced Progress Card */
        .progress-card {
            background: var(--surface-elevated); border-radius: var(--radius-xxl); 
            padding: var(--spacing-xl); margin-bottom: var(--spacing-xl); 
            box-shadow: var(--shadow-medium); text-align: center; border: 1px solid var(--border-light);
            position: relative; overflow: hidden;
        }
        .progress-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--success) 50%, var(--warning) 100%);
        }
        .progress-card h2 { 
            font-size: 24px; font-weight: 700; margin-bottom: var(--spacing-lg); 
            color: var(--text-primary);
        }
        
        /* Enhanced Progress Ring */
        .progress-ring { 
            width: 160px; height: 160px; margin: 0 auto var(--spacing-lg); position: relative;
            animation: scaleIn 0.6s var(--bounce) 0.5s both;
        }
        .progress-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .progress-ring circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .progress-ring .background { stroke: var(--border); opacity: 0.3; }
        .progress-ring .foreground { 
            stroke: url(#progressGradient); stroke-dasharray: calc(2 * 3.14159 * 70); 
            stroke-dashoffset: calc(2 * 3.14159 * 70); transition: stroke-dashoffset 1s var(--ease-out-quart);
        }
        .progress-percentage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 32px; font-weight: 800; color: var(--primary);
            animation: countUp 1s var(--ease-out-quart) 0.8s both;
        }
        
        /* Enhanced Stats Grid */
        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: var(--spacing-md); margin: var(--spacing-lg) 0; 
        }
        .stat { 
            text-align: center; padding: var(--spacing-md); border-radius: var(--radius-lg);
            background: var(--surface-secondary); transition: var(--transition);
        }
        .stat:hover { transform: translateY(-2px); box-shadow: var(--shadow-light); }
        .stat-value { 
            font-size: 28px; font-weight: 800; color: var(--primary); 
            margin-bottom: var(--spacing-xs); display: block;
        }
        .stat-label { 
            font-size: 12px; color: var(--text-secondary); text-transform: uppercase; 
            letter-spacing: 0.5px; font-weight: 600;
        }
        
        /* Enhanced Week Cards */
        .weeks-container { display: flex; flex-direction: column; gap: var(--spacing-md); }
        .week-card {
            background: var(--surface-elevated); border-radius: var(--radius-xl); overflow: hidden;
            border: 1px solid var(--border-light); box-shadow: var(--shadow-light);
            transition: var(--transition); position: relative;
        }
        .week-card:hover { box-shadow: var(--shadow-medium); transform: translateY(-2px); }
        .week-card[aria-expanded="true"] { box-shadow: var(--shadow-heavy); }
        .week-card[aria-expanded="true"] .expand-icon { transform: rotate(90deg); }
        
        .week-header {
            padding: var(--spacing-lg); cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; transition: var(--transition); user-select: none; position: relative;
        }
        .week-header:hover { background: var(--surface-secondary); }
        .week-header:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        .week-header::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(45deg, var(--primary), var(--success)); opacity: 0; transition: var(--transition);
        }
        .week-card[aria-expanded="true"] .week-header::before { opacity: 1; }
        
        .week-info h3 { 
            font-size: 20px; font-weight: 700; margin-bottom: var(--spacing-xs); 
            color: var(--text-primary);
        }
        .week-info p { color: var(--text-secondary); font-size: 14px; line-height: 1.4; }
        
        .week-progress { 
            text-align: right; display: flex; flex-direction: column; align-items: flex-end; 
            gap: var(--spacing-sm); 
        }
        .progress-text { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .progress-bar { 
            width: 100px; height: 8px; background: var(--border); border-radius: var(--radius-sm); 
            overflow: hidden; position: relative;
        }
        .progress-fill { 
            height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); 
            transition: width 0.8s var(--ease-out-quart); border-radius: var(--radius-sm);
            position: relative; overflow: hidden;
        }
        .progress-fill::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        .expand-icon { 
            width: 20px; height: 20px; color: var(--text-secondary); 
            transition: var(--transition); flex-shrink: 0;
        }
        
        /* Enhanced Tasks Container */
        .tasks-container { 
            max-height: 0; overflow: hidden; 
            transition: max-height 0.5s var(--ease-out-quart), padding 0.3s ease; 
        }
        .week-card[aria-expanded="true"] .tasks-container { max-height: 3000px; padding-bottom: var(--spacing-md); }
        
        .tasks-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: var(--spacing-md); padding: 0 var(--spacing-lg); 
        }
        
        /* Enhanced Task Items with Subtask Support */
        .task-item {
            background: var(--surface-secondary); border-radius: var(--radius-lg); 
            padding: var(--spacing-md); cursor: pointer; transition: var(--transition); 
            border: 1px solid var(--border-light); position: relative; overflow: hidden;
            flex-direction: column; align-items: stretch; gap: var(--spacing-sm);
        }
        
        .task-main {
            display: flex; align-items: flex-start; gap: var(--spacing-md);
        }
        
        .task-item::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--success)); 
            transform: scaleX(0); transition: transform 0.3s ease; transform-origin: left;
        }
        .task-item:hover { 
            background: var(--surface); transform: translateY(-2px); 
            box-shadow: var(--shadow-medium); border-color: var(--primary);
        }
        .task-item:hover::before { transform: scaleX(1); }
        .task-item.completed { 
            background: rgba(52,199,89,.08); border-color: var(--success); 
            box-shadow: 0 0 0 1px rgba(52,199,89,.1);
        }
        .task-item.completed::before { transform: scaleX(1); background: var(--success); }
        
        /* Subtasks */
        .subtasks-container {
            margin-top: var(--spacing-sm); padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-light); display: none;
        }
        .task-item.has-subtasks .subtasks-container { display: block; }
        
        .subtask-item {
            display: flex; align-items: flex-start; gap: var(--spacing-sm);
            padding: var(--spacing-xs) 0; font-size: 13px; line-height: 1.4;
        }
        
        .subtask-checkbox {
            width: 16px; height: 16px; border: 2px solid var(--border); border-radius: var(--radius-sm);
            cursor: pointer; appearance: none; position: relative; transition: var(--transition);
            flex-shrink: 0; margin-top: 2px;
        }
        .subtask-checkbox:hover { border-color: var(--primary); }
        .subtask-checkbox:checked { 
            background: var(--primary); border-color: var(--primary); 
        }
        .subtask-checkbox:checked::after {
            content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 10px; font-weight: bold;
        }
        
        .subtask-label {
            flex: 1; color: var(--text-secondary); cursor: pointer;
        }
        .subtask-item.completed .subtask-label {
            text-decoration: line-through; opacity: 0.7;
        }
        
        /* Enhanced Task Checkbox */
        .task-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--border); border-radius: var(--radius-sm);
            cursor: pointer; appearance: none; position: relative; transition: var(--transition);
            flex-shrink: 0; margin-top: 2px;
        }
        .task-checkbox:hover { border-color: var(--primary); }
        .task-checkbox:checked { 
            background: var(--success); border-color: var(--success); 
            transform: scale(1.1); 
        }
        .task-checkbox:checked::after {
            content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 12px; font-weight: bold; animation: checkmark 0.3s var(--bounce);
        }
        
        .task-content { flex: 1; min-width: 0; }
        .task-title { 
            font-weight: 600; font-size: 15px; margin-bottom: var(--spacing-xs); 
            color: var(--text-primary); line-height: 1.3;
        }
        .task-description { 
            font-size: 13px; color: var(--text-secondary); line-height: 1.4; 
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        /* Enhanced Modals */
        .modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4);
            backdrop-filter: blur(20px); z-index: 2000; padding: var(--spacing-md); 
            justify-content: center; align-items: center; overflow-y: auto;
            animation: fadeIn 0.3s ease both;
        }
        .modal[aria-hidden="false"] { display: flex; }
        
        .modal-content {
            background: var(--surface-elevated); border-radius: var(--radius-xxl); 
            padding: var(--spacing-xl); max-width: 500px; width: 100%; max-height: 90vh; 
            overflow-y: auto; box-shadow: var(--shadow-heavy); position: relative;
            animation: slideInUp 0.4s var(--ease-out-quart) both;
            border: 1px solid var(--border-light);
        }
        
        .modal-branded {
            background: var(--surface-elevated); position: relative; overflow: hidden;
        }
        .modal-branded::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.05; pointer-events: none;
        }
        body.dark .modal-branded::before { opacity: 0.03; }
        
        .modal-logo { 
            display: block; margin: 0 auto var(--spacing-md); max-height: 40px; max-width: 100%; 
            filter: drop-shadow(0 2px 8px var(--shadow-color));
        }
        
        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: var(--spacing-lg); position: relative; z-index: 1;
        }
        .modal-title { 
            font-size: 24px; font-weight: 800; color: var(--text-primary); 
            margin: 0; line-height: 1.2;
        }
        .modal-close {
            width: 32px; height: 32px; border-radius: var(--radius-full); 
            background: var(--surface-secondary); cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: var(--transition);
            border: none; padding: 0;
        }
        .modal-close:hover { 
            background: var(--border); transform: scale(1.1); 
            box-shadow: var(--shadow-light);
        }
        .modal-close svg { width: 16px; height: 16px; stroke: var(--text-secondary); }
        
        /* Enhanced Form Elements */
        .form-group { margin-bottom: var(--spacing-lg); position: relative; }
        .form-input {
            width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); 
            border-radius: var(--radius-lg); font-size: 16px; transition: var(--transition); 
            background: var(--surface); color: var(--text-primary); font-family: inherit;
            outline: none;
        }
        .form-input:focus { 
            border-color: var(--primary); box-shadow: var(--shadow-focus); 
            transform: translateY(-1px);
        }
        .form-input:hover:not(:focus) { border-color: var(--border-heavy); }
        
        .form-label { 
            display: flex; align-items: center; gap: var(--spacing-sm); 
            margin-bottom: var(--spacing-md); cursor: pointer; font-weight: 500;
            color: var(--text-primary); transition: var(--transition);
        }
        .form-label:hover { color: var(--primary); }
        
        .form-checkbox {
            width: 18px; height: 18px; border: 2px solid var(--border); 
            border-radius: var(--radius-sm); cursor: pointer; appearance: none; 
            position: relative; transition: var(--transition);
        }
        .form-checkbox:checked { background: var(--primary); border-color: var(--primary); }
        .form-checkbox:checked::after {
            content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 11px; font-weight: bold;
        }
        
        /* Enhanced Task Notes */
        .task-notes-section { 
            margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); 
            border-top: 1px solid var(--border-light); position: relative; z-index: 1;
        }
        #task-notes {
            width: 100%; padding: var(--spacing-md); border: 2px solid var(--border); 
            border-radius: var(--radius-lg); font-size: 14px; resize: vertical; 
            transition: var(--transition); background: var(--surface); color: var(--text-primary);
            min-height: 120px; font-family: inherit; outline: none;
        }
        #task-notes:focus { 
            border-color: var(--primary); box-shadow: var(--shadow-focus); 
            transform: translateY(-1px);
        }
        #task-notes::placeholder { color: var(--text-tertiary); }
        
        /* Enhanced Notifications */
        .notification {
            position: fixed; top: 80px; right: var(--spacing-md); padding: var(--spacing-md) var(--spacing-lg); 
            border-radius: var(--radius-lg); color: #fff; font-weight: 600; 
            transform: translateX(400px); transition: var(--transition); 
            box-shadow: var(--shadow-heavy); z-index: 3000; max-width: 350px; 
            text-align: left; backdrop-filter: blur(10px);
        }
        .notification.show { transform: translateX(0); }
        .notification.success { 
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%); 
        }
        .notification.error { 
            background: linear-gradient(135deg, var(--error) 0%, var(--error-light) 100%); 
        }
        .notification.info { 
            background: linear-gradient(135deg, var(--info) 0%, var(--info-light) 100%); 
        }
        
        /* Enhanced Admin Interface */
        .admin-content { max-width: 1000px; width: 100%; }
        .admin-tabs { 
            display: flex; gap: var(--spacing-xs); margin-bottom: var(--spacing-xl); 
            background: var(--surface-secondary); padding: var(--spacing-xs); 
            border-radius: var(--radius-lg); 
        }
        .admin-tab {
            flex: 1; padding: var(--spacing-md); text-align: center; border-radius: var(--radius-md);
            cursor: pointer; transition: var(--transition); font-weight: 600; 
            color: var(--text-secondary); position: relative; overflow: hidden;
        }
        .admin-tab::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--success)); 
            opacity: 0; transition: var(--transition); border-radius: var(--radius-md);
        }
        .admin-tab:hover { 
            background: var(--surface); color: var(--text-primary); 
            transform: translateY(-1px); box-shadow: var(--shadow-light);
        }
        .admin-tab.active { 
            background: var(--surface-elevated); color: var(--primary); 
            box-shadow: var(--shadow-medium); position: relative;
        }
        .admin-tab.active::before { opacity: 0.1; }
        .admin-tab:focus { outline: 2px solid var(--primary); outline-offset: -2px; }
        
        .admin-section { display: none; animation: fadeIn 0.3s ease both; }
        .admin-section.active { display: block; }
        
        /* Enhanced Tables */
        .admin-table {
            width: 100%; border-collapse: collapse; background: var(--surface-elevated);
            border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-medium);
            border: 1px solid var(--border-light);
        }
        .admin-table th, .admin-table td { 
            padding: var(--spacing-md); text-align: left; 
            border-bottom: 1px solid var(--border-light); 
        }
        .admin-table th { 
            background: var(--surface-secondary); font-weight: 700; 
            color: var(--text-secondary); font-size: 12px; text-transform: uppercase; 
            letter-spacing: 0.5px; position: relative;
        }
        .admin-table th::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--success)); opacity: 0.3;
        }
        .admin-table tbody tr { transition: var(--transition); }
        .admin-table tbody tr:hover { 
            background: var(--surface-secondary); transform: scale(1.01); 
        }
        .admin-table tbody tr:last-child td { border-bottom: none; }
        
        .leaderboard-table th { scope: col; }
        .rank-cell { text-align: center; font-weight: bold; position: relative; }
        .medal-icon { font-size: 20px; margin-right: var(--spacing-xs); }
        
        /* Enhanced Progress Indicators */
        .progress-container { display: flex; align-items: center; gap: var(--spacing-sm); }
        .progress-bar-mini { 
            flex: 1; height: 8px; background: var(--border); border-radius: var(--radius-sm); 
            overflow: hidden; position: relative;
        }
        .progress-fill-mini { 
            height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); 
            transition: width 0.8s var(--ease-out-quart); border-radius: var(--radius-sm);
        }
        .progress-text-mini { font-size: 12px; font-weight: 600; min-width: 35px; }
        
        .notes-badge { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: #fff; padding: var(--spacing-xs) var(--spacing-sm); 
            border-radius: var(--radius-full); font-size: 11px; font-weight: 600;
            box-shadow: var(--shadow-light);
        }
        
        /* Enhanced User Cards */
        .user-card {
            background: var(--surface-elevated); border-radius: var(--radius-lg); 
            padding: var(--spacing-md); margin-bottom: var(--spacing-md); 
            border: 1px solid var(--border-light); display: flex; 
            justify-content: space-between; align-items: center; 
            transition: var(--transition); position: relative; overflow: hidden;
        }
        .user-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--success)); 
            transform: scaleX(0); transition: transform 0.3s ease;
        }
        .user-card:hover { 
            box-shadow: var(--shadow-medium); transform: translateY(-2px); 
            border-color: var(--primary);
        }
        .user-card:hover::before { transform: scaleX(1); }
        
        .user-info h4 { 
            font-size: 16px; font-weight: 600; margin-bottom: var(--spacing-xs); 
            color: var(--text-primary); 
        }
        .user-info p { font-size: 13px; color: var(--text-secondary); }
        .user-actions { display: flex; gap: var(--spacing-sm); }
        .user-progress-bar { 
            height: 6px; background: var(--border); border-radius: var(--radius-sm); 
            overflow: hidden; margin: var(--spacing-sm) 0; width: 100px; 
        }
        .user-progress-fill { 
            height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); 
            transition: width 0.8s var(--ease-out-quart); 
        }
        
        /* Enhanced Loading States */
        .loading {
            width: 16px; height: 16px; border: 2px solid var(--border); border-radius: var(--radius-full);
            border-top-color: var(--primary); animation: spin 1s linear infinite;
            display: inline-block;
        }
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 10;
            border-radius: inherit;
        }
        body.dark .loading-overlay { background: rgba(0,0,0,0.8); }
        
        /* Enhanced Animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes slideInUp { 
            from { opacity: 0; transform: translateY(50px) scale(0.9); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        @keyframes scaleIn { 
            from { opacity: 0; transform: scale(0.8); } 
            to { opacity: 1; transform: scale(1); } 
        }
        @keyframes countUp { 
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); } 
        }
        @keyframes checkmark { 
            from { transform: translate(-50%, -50%) scale(0); } 
            to { transform: translate(-50%, -50%) scale(1); } 
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 968px) {
            .container { padding: 0 var(--spacing-md); }
            .tasks-grid { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
            .modal-content { padding: var(--spacing-lg); margin: var(--spacing-sm); }
            .modal-logo { max-height: 32px; }
            .admin-tabs { flex-direction: column; gap: var(--spacing-xs); }
            .admin-tab { padding: var(--spacing-sm); }
            .user-card { flex-direction: column; align-items: flex-start; gap: var(--spacing-md); }
            .user-actions { width: 100%; justify-content: flex-end; }
            .leaderboard-table th, .leaderboard-table td { padding: var(--spacing-sm); font-size: 12px; }
            .progress-bar { width: 80px; }
            .nav-right { gap: var(--spacing-xs); }
            .btn { padding: var(--spacing-xs) var(--spacing-md); font-size: 13px; }
            .theme-selector { min-width: 80px; font-size: 13px; }
        }
        
        @media (max-width: 640px) {
            #landing h1 { font-size: 28px; }
            #landing p { font-size: 16px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .progress-ring { width: 140px; height: 140px; }
            .progress-percentage { font-size: 28px; }
            .stat-value { font-size: 24px; }
            .landing-actions { flex-direction: column; gap: var(--spacing-sm); }
            .landing-actions .btn { width: 100%; max-width: 200px; }
            .tasks-grid { grid-template-columns: 1fr; }
            .week-header { padding: var(--spacing-md); }
            .week-progress { align-items: center; text-align: center; }
            .progress-bar { width: 60px; }
            .notification { left: var(--spacing-sm); right: var(--spacing-sm); transform: translateY(-100px); }
            .notification.show { transform: translateY(0); }
        }
        
        /* Enhanced Print Styles */
        @media print {
            * { background: white !important; color: black !important; box-shadow: none !important; }
            header { display: none; }
            .modal { display: none; }
            .btn { border: 1px solid black; }
            .week-card { break-inside: avoid; }
        }
        
        /* Enhanced Focus Styles */
        .focus-visible:focus-visible, 
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
        
        /* Enhanced High Contrast Mode */
        @media (prefers-contrast: high) {
            :root {
                --border: #000000;
                --text-secondary: #000000;
                --shadow-color: rgba(0,0,0,0.3);
            }
            body.dark {
                --border: #ffffff;
                --text-secondary: #ffffff;
            }
        }
        
        /* Enhanced Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* SVG Definitions */
        .svg-defs { position: absolute; width: 0; height: 0; }
    </style>
</head>
<body>
    <!-- SVG Definitions -->
    <div class="svg-defs">
        <svg>
            <defs>
                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#007AFF"/>
                    <stop offset="100%" style="stop-color:#34C759"/>
                </linearGradient>
            </defs>
        </svg>
    </div>

    <header>
        <nav class="container">
            <div class="logo">
                <img src="/assets/Velocity-Logo.png" alt="Velocity Lab Logo" aria-label="Velocity Lab">
            </div>
            <div class="nav-right">
                <span id="auth-buttons">
                    <button onclick="showLogin()" class="btn btn-secondary" aria-label="Sign In">
                        <span>Sign In</span>
                    </button>
                    <button onclick="showRegister()" class="btn btn-primary" aria-label="Get Started">
                        <span>Get Started</span>
                    </button>
                </span>
                <span id="user-menu" class="hidden">
                    <span id="user-name" style="margin-right: var(--spacing-sm); font-weight: 600; color: var(--text-primary);"></span>
                    <button id="lab-env-button" class="btn btn-primary lab-env-button" onclick="uiSystem.toggleLabDropdown()" aria-haspopup="true" aria-expanded="false">
                        <span>ðŸš€ Lab Environment â–¼</span>
                    </button>
                    <button id="admin-button" class="btn btn-admin hidden" onclick="showAdmin()" aria-label="Admin Portal">
                        <span>ðŸ‘‘ Admin</span>
                    </button>
                    <button onclick="authSystem.logout()" class="btn btn-secondary" aria-label="Sign Out">
                        <span>Sign Out</span>
                    </button>
                    <select id="theme-selector" class="theme-selector" onchange="uiSystem.changeTheme(this.value)" aria-label="Select Theme">
                        <option value="auto">ðŸŒ“ Auto</option>
                        <option value="light">ðŸŒ… Light (Jedi)</option>
                        <option value="dark">ðŸŒ™ Dark (Sith)</option>
                    </select>
                </span>
                
                <!-- Mobile Menu Button -->
                <button class="mobile-menu-button" onclick="uiSystem.toggleMobileMenu()" aria-label="Menu" aria-expanded="false">
                    <div class="hamburger"></div>
                </button>
                
                <!-- Mobile Navigation -->
                <div class="mobile-nav" id="mobile-nav" role="menu">
                    <div id="mobile-auth-section" class="mobile-nav-section">
                        <h3>Account</h3>
                        <div id="mobile-auth-buttons">
                            <div class="mobile-nav-item" onclick="showLogin(); uiSystem.closeMobileMenu()" role="menuitem">
                                ðŸ‘¤ <span>Sign In</span>
                            </div>
                            <div class="mobile-nav-item" onclick="showRegister(); uiSystem.closeMobileMenu()" role="menuitem">
                                ðŸš€ <span>Get Started</span>
                            </div>
                        </div>
                        <div id="mobile-user-menu" class="hidden">
                            <div class="mobile-nav-item" style="pointer-events: none; opacity: 0.7;">
                                ðŸ‘‹ <span id="mobile-user-name">User</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mobile-lab-section" class="mobile-nav-section hidden">
                        <h3>Lab Environment</h3>
                        <div class="mobile-nav-item" onclick="labSystem.startNew(); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸš€ <span>Start Fresh Lab</span>
                        </div>
                        <div class="mobile-nav-item" onclick="uiSystem.showLabHistory(); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸ“… <span>Lab History</span>
                        </div>
                    </div>
                    
                    <div id="mobile-admin-section" class="mobile-nav-section hidden">
                        <h3>Administration</h3>
                        <div class="mobile-nav-item" onclick="showAdmin(); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸ‘‘ <span>Admin Portal</span>
                        </div>
                    </div>
                    
                    <div class="mobile-nav-section">
                        <h3>Settings</h3>
                        <div class="mobile-nav-item" onclick="uiSystem.changeTheme('auto'); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸŒ“ <span>Auto Theme</span>
                        </div>
                        <div class="mobile-nav-item" onclick="uiSystem.changeTheme('light'); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸŒ… <span>Light (Jedi)</span>
                        </div>
                        <div class="mobile-nav-item" onclick="uiSystem.changeTheme('dark'); uiSystem.closeMobileMenu()" role="menuitem">
                            ðŸŒ™ <span>Dark (Sith)</span>
                        </div>
                    </div>
                    
                    <div id="mobile-signout-section" class="mobile-nav-section hidden">
                        <div class="mobile-nav-item" onclick="authSystem.logout(); uiSystem.closeMobileMenu()" role="menuitem" style="color: var(--error);">
                            ðŸ‘‹ <span>Sign Out</span>
                        </div>
                    </div>
                </div>
                
                <!-- Lab Dropdown (for desktop) -->
                <div class="lab-dropdown" id="lab-dropdown" role="menu">
                    <div class="lab-dropdown-item" onclick="labSystem.startNew(); uiSystem.closeLabDropdown()" role="menuitem">
                        ðŸš€ <span>Start Fresh Lab Environment</span>
                    </div>
                    <div class="lab-dropdown-item" onclick="uiSystem.showLabHistory(); uiSystem.closeLabDropdown()" role="menuitem">
                        ðŸ“… <span>View Lab History</span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section id="landing" aria-labelledby="landing-title">
            <div class="container">
                <h1 id="landing-title">Master Exchange Hybrid</h1>
                <p>Embark on a comprehensive 4-week journey with 42 hands-on tasks to build a complete Exchange Hybrid lab environment, from Domain Controllers to Microsoft 365 integration.</p>
                <div class="landing-actions">
                    <button class="btn btn-primary" onclick="showRegister()" aria-label="Start Your Journey">
                        <span>ðŸš€ Start Your Journey</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showLogin()" aria-label="Sign In">
                        <span>ðŸ‘¤ Sign In</span>
                    </button>
                </div>
            </div>
        </section>

        <section id="dashboard" class="hidden" aria-labelledby="dashboard-title">
            <div class="container">
                <div class="progress-card">
                    <h2 id="dashboard-title">Training Progress</h2>
                    <div class="progress-ring">
                        <svg viewBox="0 0 160 160" aria-label="Overall Progress">
                            <circle cx="80" cy="80" r="70" class="background" />
                            <circle cx="80" cy="80" r="70" class="foreground" id="progress-ring" />
                        </svg>
                        <div class="progress-percentage" id="progress-percentage">0%</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat">
                            <span class="stat-value" id="completed-tasks">0</span>
                            <div class="stat-label">Tasks Completed</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value">42</span>
                            <div class="stat-label">Total Tasks</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="current-week">Week 1</span>
                            <div class="stat-label">Current Phase</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value">4</span>
                            <div class="stat-label">Virtual Machines</div>
                        </div>
                    </div>
                    <div class="lab-button-container">
                        <!-- Lab Environment button moved to navbar -->
                    </div>
                </div>

                <div class="weeks-container" id="weeks-container">
                    <!-- Week 1 -->
                    <div class="week-card" id="week1-card" role="region" aria-expanded="false" aria-labelledby="week1-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week1')" role="button" tabindex="0">
                            <div class="week-info">
                                <h3 id="week1-title">Week 1: Foundation Setup</h3>
                                <p>Configure Domain Controllers, establish domain infrastructure, and set up file sharing with Group Policy</p>
                            </div>
                            <div class="week-progress">
                                <div class="progress-text"><span id="week1-completed">0</span>/12 tasks</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="week1-progress" style="width: 0%;"></div>
                                </div>
                            </div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </div>
                        <div class="tasks-container">
                            <div class="tasks-grid" id="week1-tasks-grid"></div>
                        </div>
                    </div>

                    <!-- Week 2 -->
                    <div class="week-card" id="week2-card" role="region" aria-expanded="false" aria-labelledby="week2-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week2')" role="button" tabindex="0">
                            <div class="week-info">
                                <h3 id="week2-title">Week 2: Infrastructure Expansion</h3>
                                <p>Deploy secondary Domain Controller, configure WSUS for updates, and establish time synchronization</p>
                            </div>
                            <div class="week-progress">
                                <div class="progress-text"><span id="week2-completed">0</span>/8 tasks</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="week2-progress" style="width: 0%;"></div>
                                </div>
                            </div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </div>
                        <div class="tasks-container">
                            <div class="tasks-grid" id="week2-tasks-grid"></div>
                        </div>
                    </div>

                    <!-- Week 3 -->
                    <div class="week-card" id="week3-card" role="region" aria-expanded="false" aria-labelledby="week3-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week3')" role="button" tabindex="0">
                            <div class="week-info">
                                <h3 id="week3-title">Week 3: Exchange Deployment</h3>
                                <p>Upgrade servers to 2016, extend AD schema, and deploy Exchange Server 2019 with mailbox configuration</p>
                            </div>
                            <div class="week-progress">
                                <div class="progress-text"><span id="week3-completed">0</span>/12 tasks</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="week3-progress" style="width: 0%;"></div>
                                </div>
                            </div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </div>
                        <div class="tasks-container">
                            <div class="tasks-grid" id="week3-tasks-grid"></div>
                        </div>
                    </div>

                    <!-- Week 4 -->
                    <div class="week-card" id="week4-card" role="region" aria-expanded="false" aria-labelledby="week4-title">
                        <div class="week-header" onclick="progressSystem.toggleWeek('week4')" role="button" tabindex="0">
                            <div class="week-info">
                                <h3 id="week4-title">Week 4: Hybrid Integration</h3>
                                <p>Configure external access, deploy SSL certificates, and integrate with Microsoft 365 for hybrid mail flow</p>
                            </div>
                            <div class="week-progress">
                                <div class="progress-text"><span id="week4-completed">0</span>/10 tasks</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="week4-progress" style="width: 0%;"></div>
                                </div>
                            </div>
                            <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9,18 15,12 9,6"></polyline>
                            </svg>
                        </div>
                        <div class="tasks-container">
                            <div class="tasks-grid" id="week4-tasks-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" role="dialog" aria-labelledby="login-title" aria-hidden="true">
        <div class="modal-content modal-branded">
            <img src="/assets/Velocity-Logo.png" alt="Velocity Lab Logo" class="modal-logo">
            <div class="modal-header">
                <h2 class="modal-title" id="login-title">Welcome Back</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close Modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="login-form" novalidate>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Email Address" required class="form-input" aria-label="Email Address" autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="password" name="password" placeholder="Password" required class="form-input" aria-label="Password" autocomplete="current-password">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" name="remember" class="form-checkbox" aria-label="Remember me">
                        <span>Remember me for 30 days</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" aria-label="Sign In">
                    <span>Sign In</span>
                </button>
                <p style="text-align: center; color: var(--text-secondary); margin-top: var(--spacing-md); font-size: 14px;">
                    New to Velocity Lab? <a href="#" onclick="showRegister()" style="color: var(--primary); text-decoration: none; font-weight: 600;">Create an account</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal" role="dialog" aria-labelledby="register-title" aria-hidden="true">
        <div class="modal-content modal-branded">
            <img src="/assets/Velocity-Logo.png" alt="Velocity Lab Logo" class="modal-logo">
            <div class="modal-header">
                <h2 class="modal-title" id="register-title">Start Your Journey</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close Modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="register-form" novalidate>
                <div class="form-group">
                    <input type="text" name="name" placeholder="Full Name" required class="form-input" aria-label="Full Name" autocomplete="name">
                </div>
                <div class="form-group">
                    <input type="email" name="email" placeholder="Email Address" required class="form-input" aria-label="Email Address" autocomplete="email">
                </div>
                <div class="form-group">
                    <input type="password" name="password" placeholder="Password (8+ characters)" required minlength="8" class="form-input" aria-label="Password" autocomplete="new-password">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" aria-label="Create Account">
                    <span>Create Account</span>
                </button>
                <p style="text-align: center; color: var(--text-secondary); margin-top: var(--spacing-md); font-size: 14px;">
                    Already have an account? <a href="#" onclick="showLogin()" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign in</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal" role="dialog" aria-labelledby="task-title" aria-hidden="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="task-title">Task Details</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close Modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="task-content" style="font-size: 14px; line-height: 1.6; color: var(--text-primary);"></div>
            <div class="task-notes-section">
                <h3 style="font-size: 16px; margin-bottom: var(--spacing-sm); color: var(--text-primary); display: flex; align-items: center; gap: var(--spacing-sm);">
                    ðŸ“ <span>Personal Notes</span>
                </h3>
                <textarea id="task-notes" placeholder="Add your notes, observations, and key learnings here..." maxlength="500" rows="4" aria-label="Task Notes"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--spacing-sm);">
                    <small id="notes-counter" style="color: var(--text-secondary); font-size: 12px;">0/500 characters</small>
                    <button id="save-notes-btn" class="btn btn-primary" onclick="taskSystem.saveNotes()" aria-label="Save Notes">
                        ðŸ’¾ <span>Save Notes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lab History Modal -->
    <div id="lab-history-modal" class="modal" role="dialog" aria-labelledby="lab-history-title" aria-hidden="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="lab-history-title">Lab Environment History</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close Modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="lab-history-content" style="font-size: 14px;"></div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="modal" role="dialog" aria-labelledby="admin-title" aria-hidden="true">
        <div class="admin-content modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="admin-title">Admin Portal</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close Modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="admin-tabs" role="tablist">
                <div class="admin-tab active" onclick="adminSystem.switchTab('leaderboard')" role="tab" aria-selected="true" id="tab-leaderboard" tabindex="0">
                    ðŸ† <span>Leaderboard</span>
                </div>
                <div class="admin-tab" onclick="adminSystem.switchTab('users')" role="tab" aria-selected="false" id="tab-users" tabindex="0">
                    ðŸ‘¥ <span>Users</span>
                </div>
                <div class="admin-tab" onclick="adminSystem.switchTab('analytics')" role="tab" aria-selected="false" id="tab-analytics" tabindex="0">
                    ðŸ“Š <span>Analytics</span>
                </div>
                <div class="admin-tab" onclick="adminSystem.switchTab('data')" role="tab" aria-selected="false" id="tab-data" tabindex="0">
                    ðŸ”§ <span>Data Tools</span>
                </div>
            </div>
            
            <div id="admin-leaderboard" class="admin-section active" role="tabpanel" aria-labelledby="tab-leaderboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary);">ðŸ† Training Leaderboard</h3>
                    <button class="btn btn-secondary" onclick="adminSystem.refreshLeaderboard(true)" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 14px;" aria-label="Refresh Leaderboard">
                        ðŸ”„ <span>Refresh</span>
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table leaderboard-table">
                        <thead>
                            <tr>
                                <th scope="col">Rank</th>
                                <th scope="col">Student</th>
                                <th scope="col">Progress</th>
                                <th scope="col">Tasks</th>
                                <th scope="col">Notes</th>
                                <th scope="col">Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                                    <div class="loading"></div>
                                    <div style="margin-top: var(--spacing-sm);">Loading leaderboard...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="admin-users" class="admin-section" role="tabpanel" aria-labelledby="tab-users">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary);">ðŸ‘¥ User Management</h3>
                    <button class="btn btn-primary" onclick="adminSystem.refreshUsers()" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 14px;" aria-label="Refresh Users">
                        ðŸ”„ <span>Refresh</span>
                    </button>
                </div>
                <div id="users-list">
                    <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                        <div class="loading"></div>
                        <div style="margin-top: var(--spacing-sm);">Loading users...</div>
                    </div>
                </div>
            </div>
            
            <div id="admin-analytics" class="admin-section" role="tabpanel" aria-labelledby="tab-analytics">
                <div style="margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary);">ðŸ“Š Training Analytics</h3>
                </div>
                <div class="stats-grid" style="margin-bottom: var(--spacing-xl);">
                    <div class="stat">
                        <span class="stat-value" id="total-users-stat">-</span>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="active-users-stat">-</span>
                        <div class="stat-label">Active This Week</div>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="avg-progress-stat">-</span>
                        <div class="stat-label">Avg Progress</div>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="completion-rate-stat">-</span>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
                <div style="background: var(--surface-elevated); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                    <h4 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Task Completion Distribution</h4>
                    <div id="analytics-chart" style="height: 200px; display: flex; align-items: center; justify-content: center; color: var(--text-secondary);">
                        Analytics visualization will be available when multiple users are active
                    </div>
                </div>
            </div>
            
            <div id="admin-data" class="admin-section" role="tabpanel" aria-labelledby="tab-data">
                <div style="margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--text-primary);">ðŸ”§ Data Management Tools</h3>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-lg);">
                    <div style="background: var(--surface-elevated); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                        <h4 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Export Data</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md);">Download user progress and analytics data in CSV format for external analysis.</p>
                        <button class="btn btn-primary" onclick="adminSystem.exportProgress()" aria-label="Export Progress as CSV" style="width: 100%;">
                            ðŸ“¥ <span>Export CSV</span>
                        </button>
                    </div>
                    <div style="background: var(--surface-elevated); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                        <h4 style="margin-bottom: var(--spacing-md); color: var(--text-primary);">Import Data</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-md);">Restore user progress from a previously exported CSV file.</p>
                        <input type="file" accept=".csv" id="import-file" style="display: none;" onchange="adminSystem.importProgress(this.files[0])" aria-label="Import CSV File">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()" aria-label="Import Progress CSV" style="width: 100%;">
                            ðŸ“¤ <span>Import CSV</span>
                        </button>
                    </div>
                </div>
                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-secondary); border-radius: var(--radius-lg); border-left: 4px solid var(--info);">
                    <h5 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">âš ï¸ Important Notes</h5>
                    <ul style="color: var(--text-secondary); font-size: 14px; margin: 0; padding-left: var(--spacing-lg);">
                        <li>Exported data includes user progress, task completion status, and timestamps</li>
                        <li>Personal notes and sensitive information are excluded from exports</li>
                        <li>Import operations will merge with existing data, not replace it</li>
                        <li>Always backup data before performing import operations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification" role="alert" aria-live="assertive"></div>

    <script>
        // Enhanced Application State with better organization
        let appState = {
            user: null,
            progress: {},
            authenticated: false,
            sessionToken: null,
            settings: {
                theme: 'auto',
                animations: true,
                notifications: true
            },
            cache: {
                leaderboard: null,
                users: null,
                lastUpdated: null
            }
        };

        // Enhanced Utility Functions with better error handling
        const utils = {
            getId: id => document.getElementById(id),
            show: element => element?.classList.remove('hidden'),
            hide: element => element?.classList.add('hidden'),
            
            // Enhanced cookie management
            cookies: {
                get(name) {
                    try {
                        const match = document.cookie.match(`(?:${name}=)([^;]*)`);
                        return match ? decodeURIComponent(match[1]) : null;
                    } catch (error) {
                        console.warn('Error reading cookie:', name, error);
                        return null;
                    }
                },
                set(name, value, days = 30) {
                    try {
                        const expires = new Date(Date.now() + days * 86400000).toUTCString();
                        const secure = location.protocol === 'https:' ? '; Secure' : '';
                        document.cookie = `${name}=${encodeURIComponent(value)}; path=/; SameSite=Strict; expires=${expires}${secure}`;
                    } catch (error) {
                        console.warn('Error setting cookie:', name, error);
                    }
                },
                delete(name) {
                    try {
                        document.cookie = `${name}=; path=/; SameSite=Strict; max-age=0`;
                    } catch (error) {
                        console.warn('Error deleting cookie:', name, error);
                    }
                }
            },

            // Enhanced date formatting
            formatDate(dateString) {
                if (!dateString) return 'Never';
                try {
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) return 'Today';
                    if (diffDays === 1) return 'Yesterday';
                    if (diffDays < 7) return `${diffDays} days ago`;
                    
                    return date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined 
                    });
                } catch (error) {
                    console.warn('Error formatting date:', dateString, error);
                    return 'Unknown';
                }
            },

            // Enhanced debouncing for performance
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            // Enhanced sanitization
            sanitizeHtml(str) {
                const temp = document.createElement('div');
                temp.textContent = str;
                return temp.innerHTML;
            }
        };

        // Enhanced Notification System with queue and animations
        const notificationSystem = {
            queue: [],
            current: null,
            
            show(message, type = 'success', duration = 4000) {
                this.queue.push({ message, type, duration });
                this.processQueue();
            },
            
            processQueue() {
                if (this.current || this.queue.length === 0) return;
                
                const { message, type, duration } = this.queue.shift();
                this.current = { message, type, duration };
                
                const notification = utils.getId('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        this.current = null;
                        this.processQueue();
                    }, 300);
                }, duration);
            },
            
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            info(message) { this.show(message, 'info'); }
        };

        // Enhanced API Handler with retry logic and better error handling
        const api = {
            baseUrl: '',
            defaultHeaders: {
                'Accept': 'application/json'
            },
            
            async call(endpoint, options = {}) {
                const headers = new Headers({ ...this.defaultHeaders, ...options.headers });
                
                if (appState.sessionToken) {
                    headers.set('Authorization', `Bearer ${appState.sessionToken}`);
                }
                
                let body = options.body;
                const method = options.method || 'GET';
                
                // Handle FormData or convert object to FormData for non-GET requests
                if (method !== 'GET' && !(body instanceof FormData)) {
                    if (body && typeof body === 'object') {
                        const formData = new FormData();
                        Object.entries(body).forEach(([key, value]) => {
                            formData.append(key, value);
                        });
                        body = formData;
                    }
                }
                
                const maxRetries = 3;
                let lastError;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000);
                        
                        const response = await fetch(endpoint, {
                            method,
                            headers,
                            body,
                            credentials: 'same-origin',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`HTTP ${response.status}: ${errorText || response.statusText}`);
                        }
                        
                        const data = await response.json();
                        
                        if (!data.success) {
                            throw new Error(data.message || 'Request failed');
                        }
                        
                        return data;
                    } catch (error) {
                        lastError = error;
                        console.error(`API call attempt ${attempt} failed:`, error);
                        
                        if (attempt === maxRetries || error.name === 'AbortError') {
                            throw error;
                        }
                        
                        // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 500));
                    }
                }
                
                throw lastError;
            }
        };

        // Enhanced Authentication System
        const authSystem = {
            async checkSession() {
                try {
                    const userCookie = utils.cookies.get('user');
                    const sessionCookie = utils.cookies.get('session');
                    
                    if (!userCookie || !sessionCookie) return;
                    
                    appState.user = JSON.parse(userCookie);
                    appState.sessionToken = sessionCookie;
                    appState.authenticated = true;
                    
                    if (appState.user.role === 'admin') {
                        utils.show(utils.getId('admin-button'));
                    }
                    
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                } catch (err) {
                    console.warn('Invalid session, logging out:', err);
                    this.logout();
                }
            },
            
            async login(formData) {
                try {
                    const { data } = await api.call('/api/users/login', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const { name, role, email, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, role, email }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, role, email };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        utils.show(utils.getId('admin-button'));
                    }
                    
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                    closeModal();
                    notificationSystem.success(`Welcome back, ${name}! ðŸŽ‰`);
                } catch (err) {
                    notificationSystem.error(err.message || 'Login failed. Please check your credentials.');
                }
            },
            
            async register(formData) {
                try {
                    const { data } = await api.call('/api/users/register', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const { name, email, role, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, email, role }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, email, role };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        utils.show(utils.getId('admin-button'));
                    }
                    
                    uiSystem.showDashboard();
                    await progressSystem.loadProgress();
                    closeModal();
                    notificationSystem.success(`Welcome to Velocity Lab, ${name}! ðŸš€`);
                } catch (err) {
                    notificationSystem.error(err.message || 'Registration failed. Please try again.');
                }
            },
            
            async logout() {
                try {
                    await api.call('/api/users/logout', { method: 'POST' });
                } catch (err) {
                    console.error('Logout API call failed:', err);
                }
                
                utils.cookies.delete('user');
                utils.cookies.delete('session');
                
                appState.user = null;
                appState.progress = {};
                appState.authenticated = false;
                appState.sessionToken = null;
                appState.cache = { leaderboard: null, users: null, lastUpdated: null };
                
                utils.hide(utils.getId('admin-button'));
                uiSystem.showLanding();
                notificationSystem.info('Signed out successfully');
            }
        };

        // Enhanced UI System with better animations and interactions
        const uiSystem = {
            showLanding() {
                utils.hide(utils.getId('dashboard'));
                utils.show(utils.getId('landing'));
                utils.hide(utils.getId('user-menu'));
                utils.show(utils.getId('auth-buttons'));
                document.body.style.overflow = 'auto';
            },
            
            showDashboard() {
                utils.show(utils.getId('dashboard'));
                utils.hide(utils.getId('landing'));
                utils.show(utils.getId('user-menu'));
                utils.hide(utils.getId('auth-buttons'));
                
                const userName = utils.getId('user-name');
                const mobileUserName = utils.getId('mobile-user-name');
                const labButton = utils.getId('lab-env-button');
                
                userName.textContent = appState.user?.name || '';
                userName.setAttribute('aria-label', `Logged in as ${appState.user.name}`);
                
                if (mobileUserName) mobileUserName.textContent = appState.user?.name || '';
                if (labButton) labButton.classList.add('authenticated');
                
                // Update mobile menu
                utils.hide(utils.getId('mobile-auth-buttons'));
                utils.show(utils.getId('mobile-user-menu'));
                utils.show(utils.getId('mobile-lab-section'));
                utils.show(utils.getId('mobile-signout-section'));
                
                if (appState.user?.role === 'admin') {
                    utils.show(utils.getId('mobile-admin-section'));
                }
                
                document.body.style.overflow = 'auto';
            },
            
            toggleMobileMenu() {
                const mobileNav = utils.getId('mobile-nav');
                const button = document.querySelector('.mobile-menu-button');
                const isExpanded = mobileNav.classList.toggle('show');
                
                button.setAttribute('aria-expanded', isExpanded.toString());
                button.classList.toggle('active', isExpanded);
                
                if (isExpanded) {
                    const handleClickOutside = (event) => {
                        if (!mobileNav.contains(event.target) && !button.contains(event.target)) {
                            this.closeMobileMenu();
                            document.removeEventListener('mousedown', handleClickOutside);
                        }
                    };
                    document.addEventListener('mousedown', handleClickOutside);
                }
            },
            
            closeMobileMenu() {
                const mobileNav = utils.getId('mobile-nav');
                const button = document.querySelector('.mobile-menu-button');
                mobileNav.classList.remove('show');
                button.setAttribute('aria-expanded', 'false');
                button.classList.remove('active');
            },
            
            toggleLabDropdown() {
                const dropdown = utils.getId('lab-dropdown');
                const button = utils.getId('lab-env-button');
                if (!dropdown || !button) return;
                
                const isExpanded = dropdown.classList.toggle('show');
                button.setAttribute('aria-expanded', isExpanded.toString());
                
                if (isExpanded) {
                    const handleClickOutside = (event) => {
                        if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                            this.closeLabDropdown();
                            document.removeEventListener('mousedown', handleClickOutside);
                        }
                    };
                    document.addEventListener('mousedown', handleClickOutside);
                    dropdown.querySelector('.lab-dropdown-item')?.focus();
                }
            },
            
            closeLabDropdown() {
                const dropdown = utils.getId('lab-dropdown');
                const button = utils.getId('lab-env-button');
                if (dropdown) dropdown.classList.remove('show');
                if (button) button.setAttribute('aria-expanded', 'false');
            },
            
            showLabHistory() {
                closeModal();
                const modal = utils.getId('lab-history-modal');
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                labSystem.loadHistory();
            },
            
            changeTheme(theme) {
                const body = document.body;
                appState.settings.theme = theme;
                
                body.classList.remove('dark', 'light');
                
                if (theme === 'auto') {
                    localStorage.removeItem('theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) body.classList.add('dark');
                } else {
                    body.classList.add(theme);
                    localStorage.setItem('theme', theme);
                }
                
                const themeSelector = utils.getId('theme-selector');
                if (themeSelector) themeSelector.value = theme;
            },
            
            initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'auto';
                this.changeTheme(savedTheme);
                
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme') || localStorage.getItem('theme') === 'auto') {
                        this.changeTheme('auto');
                    }
                });
            }
        };

        // Enhanced Progress System with better performance and caching
        const progressSystem = {
            observer: null,
            tasksByWeek: {
                1: ["install-server2012", "configure-static-ip", "install-adds-role", "promote-to-dc", "configure-dns-server", "create-domain-users", "setup-vm-dns", "join-vm-domain", "create-hidden-share", "map-drive-gpo", "map-drive-script", "create-security-group"],
                2: ["install-second-server", "promote-additional-dc", "install-wsus-role", "configure-wsus-settings", "setup-wsus-gpo", "configure-primary-time", "configure-secondary-time", "test-infrastructure"],
                3: ["backup-servers", "upgrade-dc1-2016", "upgrade-dc2-2016", "raise-functional-levels", "prepare-exchange-server", "install-exchange-prereqs", "extend-ad-schema", "install-exchange-2019", "configure-exchange-basic", "create-mailboxes", "test-mailbox-access", "configure-internal-mailflow"],
                4: ["configure-external-dns", "setup-firewall-rules", "install-ssl-certificates", "configure-external-mailflow", "setup-modern-auth", "prepare-m365-tenant", "install-aad-connect", "run-hybrid-wizard", "configure-hybrid-mailflow", "verify-hybrid-functionality"]
            },
            
            initObserver() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const weekId = entry.target.id.replace('-card', '');
                            this.loadWeekTasks(weekId);
                            this.observer.unobserve(entry.target);
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0.1
                });
                
                document.querySelectorAll('.week-card').forEach(card => {
                    this.observer.observe(card);
                });
            },
            
            async loadProgress() {
                try {
                    const { data } = await api.call('/api/user/progress');
                    appState.progress = data || {};
                    this.updateProgressUI();
                    this.initObserver();
                } catch (err) {
                    notificationSystem.error('Failed to load progress data.');
                    console.error('Progress load error:', err);
                }
            },
            
            updateProgressUI() {
                const totalTasks = Object.values(this.tasksByWeek).reduce((sum, tasks) => sum + tasks.length, 0);
                const completedTasks = Object.values(appState.progress).filter(task => task?.completed).length;
                const percentage = Math.round((completedTasks / totalTasks) * 100);
                
                // Animate progress ring
                const progressRing = utils.getId('progress-ring');
                const circumference = 2 * Math.PI * 70;
                const offset = circumference - (percentage / 100) * circumference;
                
                progressRing.style.strokeDashoffset = offset;
                
                // Animate percentage counter
                this.animateCounter(utils.getId('progress-percentage'), percentage, '%');
                this.animateCounter(utils.getId('completed-tasks'), completedTasks);
                
                // Update current week
                const currentWeek = Math.min(Math.floor(completedTasks / 10) + 1, 4);
                utils.getId('current-week').textContent = `Week ${currentWeek}`;
                
                // Update week progress
                Object.keys(this.tasksByWeek).forEach(week => {
                    this.updateWeekProgress(`week${week}`);
                });
            },
            
            animateCounter(element, target, suffix = '') {
                const start = parseInt(element.textContent) || 0;
                const increment = (target - start) / 30;
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 16);
            },
            
            updateWeekProgress(weekId) {
                const weekNumber = weekId.replace('week', '');
                const tasks = this.tasksByWeek[weekNumber] || [];
                const completed = tasks.filter(taskId => 
                    appState.progress[`week${weekNumber}-${taskId}`]?.completed
                ).length;
                const progressPercentage = tasks.length ? Math.round((completed / tasks.length) * 100) : 0;
                
                const completedElement = utils.getId(`${weekId}-completed`);
                const progressFill = utils.getId(`${weekId}-progress`);
                
                if (completedElement) {
                    this.animateCounter(completedElement, completed);
                    completedElement.setAttribute('aria-label', `${completed} of ${tasks.length} tasks completed`);
                }
                
                if (progressFill) {
                    progressFill.style.width = `${progressPercentage}%`;
                }
            },
            
            loadWeekTasks(weekId) {
                const weekNumber = weekId.replace('week', '');
                const grid = utils.getId(`${weekId}-tasks-grid`);
                
                if (grid?.dataset.loaded) return;
                if (grid) grid.dataset.loaded = 'true';
                
                const fragment = document.createDocumentFragment();
                const tasks = this.tasksByWeek[weekNumber] || [];
                
                tasks.forEach((taskId, index) => {
                    const taskKey = `week${weekNumber}-${taskId}`;
                    const task = appState.progress[taskKey] || {};
                    const taskDef = window.TASK_DEFINITIONS?.[taskKey] || {
                        title: taskId.replace(/[-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                        description: 'Click to view detailed task instructions and guidance.'
                    };
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-item ${task.completed ? 'completed' : ''}`;
                    taskElement.style.animationDelay = `${index * 0.05}s`;
                    
                    // Check if task has subtasks
                    const hasSubtasks = taskDef.description.includes('subtask-container');
                    if (hasSubtasks) {
                        taskElement.classList.add('has-subtasks');
                    }
                    
                    taskElement.innerHTML = `
                        <div class="task-main">
                            <input type="checkbox" 
                                   class="task-checkbox" 
                                   id="task-${weekNumber}-${taskId}" 
                                   ${task.completed ? 'checked' : ''} 
                                   onchange="progressSystem.toggleTask('${weekNumber}', '${taskId}', this.checked)" 
                                   aria-label="Toggle completion of ${utils.sanitizeHtml(taskDef.title)}">
                            <label for="task-${weekNumber}-${taskId}" class="task-content">
                                <div class="task-title">${utils.sanitizeHtml(taskDef.title)}</div>
                                <div class="task-description">${utils.sanitizeHtml(taskDef.description.replace(/<[^>]*>/g, '').substring(0, 100))}...</div>
                            </label>
                        </div>
                        ${hasSubtasks ? this.generateSubtasks(taskKey, taskDef) : ''}
                    `;
                    
                    taskElement.setAttribute('role', 'button');
                    taskElement.setAttribute('tabindex', '0');
                    
                    const handleClick = (event) => {
                        if (!event.target.matches('input[type="checkbox"]') && !event.target.closest('.subtasks-container')) {
                            taskSystem.showTaskModal(weekNumber, taskId);
                        }
                    };
                    
                    const handleKeydown = (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            taskSystem.showTaskModal(weekNumber, taskId);
                        }
                    };
                    
                    taskElement.addEventListener('click', handleClick);
                    taskElement.addEventListener('keydown', handleKeydown);
                    
                    fragment.appendChild(taskElement);
                });
                
                if (grid) {
                    grid.appendChild(fragment);
                }
            },
            
            generateSubtasks(taskKey, taskDef) {
                // Extract subtasks from task definition HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = taskDef.description;
                const subtaskContainer = tempDiv.querySelector('.subtask-container');
                
                if (!subtaskContainer) return '';
                
                const subtaskItems = subtaskContainer.querySelectorAll('.subtask-item');
                if (!subtaskItems.length) return '';
                
                const subtasksHtml = Array.from(subtaskItems).map((item, index) => {
                    const stepNumber = index + 1;
                    const subtaskId = `${taskKey}-subtask-${stepNumber}`;
                    const labelText = item.querySelector('label')?.textContent || `Subtask ${stepNumber}`;
                    const isCompleted = appState.progress[subtaskId]?.completed || false;
                    
                    return `
                        <div class="subtask-item ${isCompleted ? 'completed' : ''}">
                            <input type="checkbox" 
                                   class="subtask-checkbox" 
                                   id="${subtaskId}" 
                                   ${isCompleted ? 'checked' : ''}
                                   onchange="progressSystem.toggleSubtask('${taskKey}', ${stepNumber}, this.checked)"
                                   data-task="${taskKey}"
                                   data-step="${stepNumber}">
                            <label for="${subtaskId}" class="subtask-label">
                                ${utils.sanitizeHtml(labelText)}
                            </label>
                        </div>
                    `;
                }).join('');
                
                return `<div class="subtasks-container">${subtasksHtml}</div>`;
            },
            
            async toggleSubtask(taskKey, stepNumber, completed) {
                const subtaskId = `${taskKey}-subtask-${stepNumber}`;
                
                // Update subtask state
                appState.progress[subtaskId] = {
                    completed,
                    updatedAt: new Date().toISOString()
                };
                
                // Check if all subtasks are completed
                const allSubtasks = document.querySelectorAll(`input[data-task="${taskKey}"][data-step]`);
                const completedSubtasks = Array.from(allSubtasks).filter(checkbox => checkbox.checked);
                
                // Auto-complete main task if all subtasks are done
                if (allSubtasks.length > 0 && completedSubtasks.length === allSubtasks.length) {
                    const [week, taskId] = taskKey.split('-').slice(0, 2);
                    const weekNumber = week.replace('week', '');
                    const mainTaskCheckbox = document.getElementById(`task-${weekNumber}-${taskId.substring(0)}`);
                    
                    if (mainTaskCheckbox && !mainTaskCheckbox.checked) {
                        mainTaskCheckbox.checked = true;
                        await this.toggleTask(weekNumber, taskKey.replace(`week${weekNumber}-`, ''), true);
                    }
                }
                
                // Update UI
                const subtaskItem = document.getElementById(subtaskId)?.closest('.subtask-item');
                if (subtaskItem) {
                    subtaskItem.classList.toggle('completed', completed);
                }
                
                // Save progress (you might want to add this to your API)
                try {
                    // For now, just store locally - you can add API call later
                    localStorage.setItem(`subtask_${subtaskId}`, JSON.stringify({ completed, updatedAt: new Date().toISOString() }));
                } catch (err) {
                    console.warn('Failed to save subtask progress:', err);
                }
            },
            
            toggleWeek(weekId) {
                const weekCard = utils.getId(`${weekId}-card`);
                if (!weekCard) return;
                
                const isExpanded = weekCard.getAttribute('aria-expanded') === 'true';
                weekCard.setAttribute('aria-expanded', (!isExpanded).toString());
                
                if (!isExpanded && !weekCard.querySelector('.tasks-grid')?.dataset.loaded) {
                    this.loadWeekTasks(weekId);
                }
            },
            
            async toggleTask(week, taskId, completed) {
                const taskKey = `week${week}-${taskId}`;
                const checkbox = document.getElementById(`task-${week}-${taskId}`);
                
                try {
                    await api.call('/api/user/task', {
                        method: 'POST',
                        body: { week, task: taskId, completed }
                    });
                    
                    appState.progress[taskKey] = {
                        ...appState.progress[taskKey],
                        completed,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Update UI
                    const taskItem = checkbox?.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.toggle('completed', completed);
                    }
                    
                    this.updateProgressUI();
                    
                    const message = completed ? 'âœ… Task completed! Great progress!' : 'â¸ï¸ Task marked incomplete';
                    notificationSystem.success(message);
                    
                } catch (err) {
                    notificationSystem.error('Failed to update task status.');
                    console.error('Task toggle error:', err);
                    
                    // Revert checkbox state
                    if (checkbox) {
                        checkbox.checked = !completed;
                    }
                }
            }
        };

        // Enhanced Lab System
        const labSystem = {
            async startNew() {
                try {
                    const { data } = await api.call('/api/lab/start', {
                        method: 'POST',
                        body: {}
                    });
                    
                    notificationSystem.success('ðŸš€ New lab environment started successfully!');
                    await progressSystem.loadProgress();
                } catch (err) {
                    notificationSystem.error('Failed to start lab environment. Please try again.');
                    console.error('Start lab error:', err);
                }
            },
            
            async loadHistory() {
                const content = utils.getId('lab-history-content');
                if (!content) return;
                
                content.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl);">
                        <div class="loading"></div>
                        <div style="margin-top: var(--spacing-sm); color: var(--text-secondary);">Loading lab history...</div>
                    </div>
                `;
                
                try {
                    const { data } = await api.call('/api/lab/history');
                    
                    if (data.length === 0) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                                <div style="font-size: 48px; margin-bottom: var(--spacing-md);">ðŸ”¬</div>
                                <h3 style="margin-bottom: var(--spacing-sm);">No lab history yet</h3>
                                <p>Start your first lab environment to see your training history here.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    const html = data.map((lab, index) => `
                        <div class="user-card" role="article" style="animation-delay: ${index * 0.1}s;">
                            <div class="user-info">
                                <h4 style="display: flex; align-items: center; gap: var(--spacing-sm);">
                                    ${lab.statusIcon || 'ðŸ”¬'} Lab Session #${lab.id.split('_')[1] || 'Unknown'}
                                </h4>
                                <p><strong>Started:</strong> ${utils.formatDate(lab.startTime)}</p>
                                <p><strong>Environment:</strong> ${utils.sanitizeHtml(lab.environment || 'Exchange Hybrid Lab')}</p>
                                <p><strong>Status:</strong> 
                                    <span style="color: ${lab.status === 'Active' ? 'var(--success)' : 'var(--text-secondary)'}">
                                        ${lab.status}
                                    </span>
                                </p>
                            </div>
                        </div>
                    `).join('');
                    
                    content.innerHTML = html;
                } catch (err) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--error);">
                            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">âš ï¸</div>
                            <h3 style="margin-bottom: var(--spacing-sm);">Failed to load lab history</h3>
                            <p>Please try again or contact support if the problem persists.</p>
                        </div>
                    `;
                    console.error('Lab history error:', err);
                }
            }
        };

        // Enhanced Task System
        const taskSystem = {
            currentTask: { week: null, taskId: null },
            
            showTaskModal(week, taskId) {
                if (!appState.authenticated) {
                    notificationSystem.error('Please sign in to view task details.');
                    showLogin();
                    return;
                }
                
                this.currentTask = { week, taskId };
                const taskKey = `week${week}-${taskId}`;
                const taskDef = window.TASK_DEFINITIONS?.[taskKey] || {
                    title: taskId.replace(/[-]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                    description: '<p>Task details are being loaded. Please check back shortly.</p>'
                };
                
                const titleElement = utils.getId('task-title');
                const contentElement = utils.getId('task-content');
                
                if (titleElement) titleElement.textContent = taskDef.title || 'Task Details';
                if (contentElement) contentElement.innerHTML = taskDef.description || '<p>No details available.</p>';
                
                this.loadNotes();
                
                const modalElement = utils.getId('task-modal');
                if (modalElement) {
                    modalElement.style.display = 'flex';
                    modalElement.setAttribute('aria-hidden', 'false');
                    contentElement?.focus();
                }
            },
            
            async loadNotes() {
                const { week, taskId } = this.currentTask;
                if (!week || !taskId) return;
                
                const notesInput = utils.getId('task-notes');
                const counter = utils.getId('notes-counter');
                
                if (!notesInput || !counter) return;
                
                try {
                    const { data } = await api.call(`/api/task/notes?week=${week}&task=${encodeURIComponent(taskId)}`);
                    
                    notesInput.value = data.notes || '';
                    counter.textContent = `${notesInput.value.length}/500 characters`;
                    
                    // Auto-resize textarea
                    notesInput.style.height = 'auto';
                    notesInput.style.height = Math.max(120, notesInput.scrollHeight) + 'px';
                    
                } catch (err) {
                    console.warn('Failed to load notes:', err);
                    notesInput.value = '';
                    counter.textContent = '0/500 characters';
                }
                
                // Enhanced input handler with debouncing
                const updateCounter = utils.debounce(() => {
                    const length = notesInput.value.length;
                    counter.textContent = `${length}/500 characters`;
                    counter.style.color = length > 450 ? 'var(--warning)' : 'var(--text-secondary)';
                    
                    // Auto-resize
                    notesInput.style.height = 'auto';
                    notesInput.style.height = Math.max(120, notesInput.scrollHeight) + 'px';
                }, 100);
                
                notesInput.removeEventListener('input', updateCounter);
                notesInput.addEventListener('input', updateCounter);
            },
            
            async saveNotes() {
                const { week, taskId } = this.currentTask;
                if (!week || !taskId) return;
                
                const notesInput = utils.getId('task-notes');
                const saveButton = utils.getId('save-notes-btn');
                
                if (!notesInput || !saveButton) return;
                
                const notes = notesInput.value.trim();
                const originalText = saveButton.innerHTML;
                
                try {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '<div class="loading"></div> <span>Saving...</span>';
                    
                    await api.call('/api/task/notes', {
                        method: 'POST',
                        body: { week, task: taskId, notes }
                    });
                    
                    notificationSystem.success('ðŸ“ Notes saved successfully!');
                    
                    // Brief success animation
                    saveButton.innerHTML = 'âœ… <span>Saved!</span>';
                    setTimeout(() => {
                        saveButton.innerHTML = originalText;
                    }, 1500);
                    
                } catch (err) {
                    notificationSystem.error('Failed to save notes. Please try again.');
                    console.error('Notes save error:', err);
                } finally {
                    saveButton.disabled = false;
                    if (saveButton.innerHTML.includes('Saving')) {
                        saveButton.innerHTML = originalText;
                    }
                }
            }
        };

        // Enhanced Admin System
        const adminSystem = {
            switchTab(tab) {
                const tabs = ['leaderboard', 'users', 'analytics', 'data'];
                
                tabs.forEach(tabName => {
                    const tabElement = utils.getId(`tab-${tabName}`);
                    const section = utils.getId(`admin-${tabName}`);
                    const isActive = tabName === tab;
                    
                    if (tabElement) {
                        tabElement.classList.toggle('active', isActive);
                        tabElement.setAttribute('aria-selected', isActive.toString());
                    }
                    
                    if (section) {
                        section.classList.toggle('active', isActive);
                    }
                });
                
                // Load data for the selected tab
                switch (tab) {
                    case 'leaderboard':
                        this.refreshLeaderboard();
                        break;
                    case 'users':
                        this.loadUsers();
                        break;
                    case 'analytics':
                        this.loadAnalytics();
                        break;
                }
            },
            
            async refreshLeaderboard(forceLoad = false) {
                const tbody = utils.getId('leaderboard-body');
                if (!tbody) return;
                
                // Check cache
                const cacheKey = 'leaderboard-cache-v2';
                const cache = JSON.parse(sessionStorage.getItem(cacheKey) || '{}');
                const cacheTTL = 5 * 60 * 1000; // 5 minutes
                
                if (!forceLoad && cache.data && (Date.now() - cache.timestamp < cacheTTL)) {
                    tbody.innerHTML = cache.html;
                    return;
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--spacing-xl);">
                            <div class="loading"></div>
                            <div style="margin-top: var(--spacing-sm); color: var(--text-secondary);">Loading leaderboard data...</div>
                        </td>
                    </tr>
                `;
                
                try {
                    const { data } = await api.call('/api/admin/users-progress');
                    
                    const users = data.map((user, index) => ({
                        ...user,
                        rank: index + 1,
                        medal: index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : ''
                    }));
                    
                    const fragment = document.createDocumentFragment();
                    
                    users.forEach((user, index) => {
                        const tr = document.createElement('tr');
                        tr.style.animationDelay = `${index * 0.05}s`;
                        tr.innerHTML = `
                            <td class="rank-cell">
                                ${user.medal ? 
                                    `<span class="medal-icon" aria-label="Rank ${user.rank} with medal">${user.medal}</span>` : 
                                    `<strong>#${user.rank}</strong>`
                                }
                            </td>
                            <td>
                                <div style="line-height: 1.4;">
                                    <strong style="color: var(--text-primary);">${utils.sanitizeHtml(user.name)}</strong><br>
                                    <small style="color: var(--text-secondary);">${utils.sanitizeHtml(user.email)}</small>
                                </div>
                            </td>
                            <td>
                                <div class="progress-container">
                                    <div class="progress-bar-mini">
                                        <div class="progress-fill-mini" style="width: ${user.progress}%"></div>
                                    </div>
                                    <span class="progress-text-mini" aria-label="Progress: ${user.progress}%">${user.progress}%</span>
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <strong style="color: var(--primary);">${user.completedTasks}</strong><span style="color: var(--text-secondary);">/42</span>
                            </td>
                            <td>
                                ${user.notesCount ? 
                                    `<span class="notes-badge" aria-label="${user.notesCount} notes">${user.notesCount} notes</span>` : 
                                    '<span style="color: var(--text-secondary);">No notes</span>'
                                }
                            </td>
                            <td>
                                <small style="color: var(--text-secondary);">${utils.formatDate(user.lastLogin)}</small>
                            </td>
                        `;
                        fragment.appendChild(tr);
                    });
                    
                    tbody.innerHTML = '';
                    tbody.appendChild(fragment);
                    
                    // Cache the results
                    sessionStorage.setItem(cacheKey, JSON.stringify({
                        timestamp: Date.now(),
                        html: tbody.innerHTML,
                        data: users
                    }));
                    
                } catch (err) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: var(--error); padding: var(--spacing-xl);">
                                <div style="font-size: 48px; margin-bottom: var(--spacing-sm);">âš ï¸</div>
                                <div>Failed to load leaderboard data</div>
                                <button onclick="adminSystem.refreshLeaderboard(true)" class="btn btn-secondary" style="margin-top: var(--spacing-sm);">
                                    Try Again
                                </button>
                            </td>
                        </tr>
                    `;
                    console.error('Leaderboard load error:', err);
                }
            },
            
            async loadUsers() {
                const usersList = utils.getId('users-list');
                if (!usersList) return;
                
                usersList.innerHTML = `
                    <div style="text-align: center; padding: var(--spacing-xl);">
                        <div class="loading"></div>
                        <div style="margin-top: var(--spacing-sm); color: var(--text-secondary);">Loading users...</div>
                    </div>
                `;
                
                try {
                    const { data: users } = await api.call('/api/admin/users-progress');
                    
                    if (!users.length) {
                        usersList.innerHTML = `
                            <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                                <div style="font-size: 48px; margin-bottom: var(--spacing-md);">ðŸ‘¥</div>
                                <h3 style="margin-bottom: var(--spacing-sm);">No users found</h3>
                                <p>Users will appear here once they register for the training program.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    usersList.innerHTML = users.map((user, index) => `
                        <div class="user-card" style="animation-delay: ${index * 0.05}s;">
                            <div class="user-info">
                                <h4 style="color: var(--text-primary);">${utils.sanitizeHtml(user.name)}</h4>
                                <p style="color: var(--text-secondary); margin-bottom: var(--spacing-xs);">
                                    ${utils.sanitizeHtml(user.email)} â€¢ ${user.role === 'admin' ? 'ðŸ‘‘ Admin' : 'ðŸ‘¤ Student'}
                                </p>
                                <div class="user-progress-bar">
                                    <div class="user-progress-fill" style="width: ${user.progress}%"></div>
                                </div>
                                <p style="font-size: 12px; color: var(--text-tertiary);">
                                    ${user.completedTasks}/42 tasks â€¢ Last active: ${utils.formatDate(user.lastLogin)}
                                </p>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-secondary" style="padding: var(--spacing-xs) var(--spacing-sm); font-size: 12px;" onclick="adminSystem.viewUserProgress('${user.email}')" aria-label="View progress for ${user.name}">
                                    ðŸ“Š Progress
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (err) {
                    usersList.innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--error);">
                            <div style="font-size: 48px; margin-bottom: var(--spacing-md);">âš ï¸</div>
                            <h3 style="margin-bottom: var(--spacing-sm);">Failed to load users</h3>
                            <button onclick="adminSystem.loadUsers()" class="btn btn-secondary">Try Again</button>
                        </div>
                    `;
                    console.error('Users load error:', err);
                }
            },
            
            async loadAnalytics() {
                try {
                    const { data: users } = await api.call('/api/admin/users-progress');
                    
                    const totalUsers = users.length;
                    const activeUsers = users.filter(user => {
                        const lastLogin = new Date(user.lastLogin);
                        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        return lastLogin > weekAgo;
                    }).length;
                    
                    const avgProgress = totalUsers > 0 ? 
                        Math.round(users.reduce((sum, user) => sum + user.progress, 0) / totalUsers) : 0;
                    
                    const completedUsers = users.filter(user => user.progress >= 100).length;
                    const completionRate = totalUsers > 0 ? Math.round((completedUsers / totalUsers) * 100) : 0;
                    
                    // Update stats
                    this.animateStatCounter('total-users-stat', totalUsers);
                    this.animateStatCounter('active-users-stat', activeUsers);
                    this.animateStatCounter('avg-progress-stat', avgProgress, '%');
                    this.animateStatCounter('completion-rate-stat', completionRate, '%');
                    
                } catch (err) {
                    console.error('Analytics load error:', err);
                }
            },
            
            animateStatCounter(elementId, target, suffix = '') {
                const element = utils.getId(elementId);
                if (!element) return;
                
                const start = parseInt(element.textContent) || 0;
                const increment = (target - start) / 20;
                let current = start;
                
                const timer = setInterval(() => {
                    current += increment;
                    if ((increment > 0 && current >= target) || (increment < 0 && current <= target)) {
                        current = target;
                        clearInterval(timer);
                    }
                    element.textContent = Math.round(current) + suffix;
                }, 50);
            },
            
            async viewUserProgress(email) {
                notificationSystem.info('User progress detail view coming soon!');
            },
            
            async exportProgress() {
                try {
                    const { data } = await api.call('/api/admin/users-progress');
                    
                    // Convert to CSV
                    const headers = ['Name', 'Email', 'Role', 'Progress (%)', 'Completed Tasks', 'Notes Count', 'Last Login'];
                    const csvData = [
                        headers.join(','),
                        ...data.map(user => [
                            `"${user.name}"`,
                            `"${user.email}"`,
                            `"${user.role}"`,
                            user.progress,
                            user.completedTasks,
                            user.notesCount,
                            `"${user.lastLogin}"`
                        ].join(','))
                    ].join('\n');
                    
                    // Create and download file
                    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `velocity_lab_progress_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    notificationSystem.success('ðŸ“¥ Progress data exported successfully!');
                } catch (err) {
                    notificationSystem.error('Failed to export progress data.');
                    console.error('Export progress error:', err);
                }
            },
            
            async importProgress(file) {
                if (!file) return;
                
                try {
                    notificationSystem.info('ðŸ“¤ Importing progress data...');
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    await api.call('/api/admin/import-progress', {
                        method: 'POST',
                        body: formData
                    });
                    
                    this.refreshLeaderboard(true);
                    this.loadUsers();
                    this.loadAnalytics();
                    
                    notificationSystem.success('ðŸ“¤ Progress data imported successfully!');
                } catch (err) {
                    notificationSystem.error('Failed to import progress data.');
                    console.error('Import progress error:', err);
                }
            }
        };

        // Enhanced Modal Management
        function showLogin() {
            closeModal();
            const modal = utils.getId('login-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                modal.querySelector('input[name="email"]')?.focus();
            }
        }

        function showRegister() {
            closeModal();
            const modal = utils.getId('register-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                modal.querySelector('input[name="name"]')?.focus();
            }
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            });
        }

        function showAdmin() {
            if (!appState.authenticated || appState.user?.role !== 'admin') {
                notificationSystem.error('Access denied. Admin privileges required.');
                return;
            }
            
            closeModal();
            const modal = utils.getId('admin-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                adminSystem.switchTab('leaderboard');
                modal.querySelector('.admin-tab.active')?.focus();
            }
        }

        // Enhanced Focus Management
        function trapFocus(event) {
            const modal = event.target.closest('.modal');
            if (!modal) return;
            
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            if (event.key === 'Tab') {
                if (event.shiftKey && document.activeElement === firstElement) {
                    event.preventDefault();
                    lastElement?.focus();
                } else if (!event.shiftKey && document.activeElement === lastElement) {
                    event.preventDefault();
                    firstElement?.focus();
                }
            } else if (event.key === 'Escape') {
                closeModal();
            }
        }

        // Enhanced Application Initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize theme system
            uiSystem.initTheme();

            // Check for existing session
            authSystem.checkSession();

            // Enhanced form handlers with validation
            const loginForm = utils.getId('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(loginForm);
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    await authSystem.login(formData);
                });
            }

            const registerForm = utils.getId('register-form');
            if (registerForm) {
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(registerForm);
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!name || !email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    if (password.length < 8) {
                        notificationSystem.error('Password must be at least 8 characters long.');
                        return;
                    }
                    
                    await authSystem.register(formData);
                });
            }

            // Enhanced keyboard navigation
            document.addEventListener('keydown', (event) => {
                // Global keyboard shortcuts
                if (event.ctrlKey || event.metaKey) {
                    switch (event.key) {
                        case '/':
                            event.preventDefault();
                            if (appState.authenticated) {
                                // Focus search or toggle lab dropdown
                                uiSystem.toggleLabDropdown();
                            }
                            break;
                        case 'k':
                            event.preventDefault();
                            if (appState.authenticated && appState.user?.role === 'admin') {
                                showAdmin();
                            }
                            break;
                    }
                }
                
                // Enhanced modal focus trapping
                if (document.querySelector('.modal[aria-hidden="false"]')) {
                    trapFocus(event);
                }
            });

            // Enhanced week header keyboard navigation
            document.querySelectorAll('.week-header').forEach(header => {
                header.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        const weekId = header.parentElement?.id.replace('-card', '');
                        if (weekId) progressSystem.toggleWeek(weekId);
                    }
                });
            });

            // Enhanced admin tab keyboard navigation
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        const tabId = tab.id.replace('tab-', '');
                        adminSystem.switchTab(tabId);
                    }
                });
            });

            // Enhanced click outside handlers
            document.addEventListener('click', (event) => {
                const labDropdown = utils.getId('lab-dropdown');
                const labButton = utils.getId('lab-env-button');
                const mobileNav = utils.getId('mobile-nav');
                const mobileButton = document.querySelector('.mobile-menu-button');
                
                // Close lab dropdown
                if (labDropdown?.classList.contains('show') && 
                    !labDropdown.contains(event.target) && 
                    !labButton?.contains(event.target)) {
                    uiSystem.closeLabDropdown();
                }
                
                // Close mobile menu
                if (mobileNav?.classList.contains('show') && 
                    !mobileNav.contains(event.target) && 
                    !mobileButton?.contains(event.target)) {
                    uiSystem.closeMobileMenu();
                }
            });

            // Enhanced intersection observer for animations
            if ('IntersectionObserver' in window) {
                const animationObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.animationPlayState = 'running';
                        }
                    });
                }, { threshold: 0.1 });

                // Observe animated elements
                document.querySelectorAll('.week-card, .task-item, .user-card').forEach(el => {
                    animationObserver.observe(el);
                });
            }

            // Enhanced performance monitoring
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const perfData = performance.getEntriesByType('navigation')[0];
                        if (perfData) {
                            console.log('Page load performance:', {
                                domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                                loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
                                totalTime: perfData.loadEventEnd - perfData.fetchStart
                            });
                        }
                    }, 0);
                });
            }

            // Enhanced error handling
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                if (!navigator.onLine) {
                    notificationSystem.error('You appear to be offline. Please check your connection.');
                }
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                event.preventDefault();
            });

            // Enhanced online/offline detection
            window.addEventListener('online', () => {
                notificationSystem.success('Connection restored! ðŸŒ');
            });

            window.addEventListener('offline', () => {
                notificationSystem.error('You\'re currently offline. Some features may not work.');
            });

            // Prevent form resubmission on page refresh
            if (window.history.replaceState) {
                window.history.replaceState(null, null, window.location.href);
            }

            // Enhanced accessibility announcements
            const announceToScreenReader = (message) => {
                const announcement = document.createElement('div');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                setTimeout(() => document.body.removeChild(announcement), 1000);
            };

            // Enhanced viewport height fix for mobile
            const setViewportHeight = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };

            setViewportHeight();
            window.addEventListener('resize', utils.debounce(setViewportHeight, 100));

            // Enhanced reduced motion preference detection
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)');
            
            const handleMotionPreference = (mediaQuery) => {
                if (mediaQuery.matches) {
                    document.documentElement.style.setProperty('--transition', 'none');
                    document.documentElement.style.setProperty('--transition-fast', 'none');
                    document.documentElement.style.setProperty('--transition-bounce', 'none');
                } else {
                    document.documentElement.style.removeProperty('--transition');
                    document.documentElement.style.removeProperty('--transition-fast');
                    document.documentElement.style.removeProperty('--transition-bounce');
                }
            };

            handleMotionPreference(prefersReducedMotion);
            prefersReducedMotion.addEventListener('change', handleMotionPreference);

            console.log('ðŸš€ Velocity Lab Enhanced - Fully loaded and ready!');
        });

        // Enhanced Service Worker Registration (Progressive Web App support)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Enhanced Performance Optimization
        const performanceOptimizations = {
            // Lazy load images when they come into viewport
            initLazyLoading() {
                if ('IntersectionObserver' in window) {
                    const imageObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                if (img.dataset.src) {
                                    img.src = img.dataset.src;
                                    img.removeAttribute('data-src');
                                    imageObserver.unobserve(img);
                                }
                            }
                        });
                    });

                    document.querySelectorAll('img[data-src]').forEach(img => {
                        imageObserver.observe(img);
                    });
                }
            },

            // Preload critical resources
            preloadResources() {
                const criticalResources = [
                    '/assets/task-definitions.js',
                    '/assets/Velocity-Logo.png'
                ];

                criticalResources.forEach(resource => {
                    const link = document.createElement('link');
                    link.rel = 'preload';
                    link.href = resource;
                    link.as = resource.endsWith('.js') ? 'script' : 'image';
                    document.head.appendChild(link);
                });
            }
        };

        // Initialize performance optimizations
        performanceOptimizations.initLazyLoading();
        performanceOptimizations.preloadResources();

        // Enhanced Global Exposure for Console Debugging (Development)
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
            window.VelocityLab = {
                appState,
                authSystem,
                progressSystem,
                taskSystem,
                labSystem,
                adminSystem,
                uiSystem,
                api,
                utils,
                notificationSystem
            };
            console.log('ðŸ”§ Development mode: VelocityLab object available in console');
        }
    </script>
</body>
</html>