<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Velocity Lab</title>
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --p: #0071e3; /* Apple Blue */
      --s: #34c759; /* Unifi Green */
      --e: #ff3b30; /* Apple Red */
      --g1: #f5f5f7; /* Light Gray */
      --g5: #8e8e93; /* Gray Text */
      --g9: #1d1d1f; /* Dark Text */
      --r: 12px; /* Border Radius */
      --t: 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth Transition */
    }
    body {
      font-family: -apple-system, system-ui, sans-serif;
      background: var(--g1);
      color: var(--g9);
      line-height: 1.6;
      overflow-x: hidden;
    }
    .c { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
    header {
      position: fixed;
      top: 0;
      width: 100%;
      background: rgba(245,245,247,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      z-index: 100;
    }
    nav {
      height: 56px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img {
      height: 32px;
      transition: transform var(--t);
    }
    .logo img:hover { transform: scale(1.05); }
    .btn {
      padding: 8px 16px;
      border-radius: 20px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--t);
      background: transparent;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .btn-p {
      background: var(--p);
      color: #fff;
      border: none;
    }
    .btn-p:hover {
      background: #005bb5;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,113,227,0.3);
    }
    .btn-s:hover {
      background: rgba(0,0,0,0.04);
      transform: translateY(-1px);
    }
    .btn-a {
      background: linear-gradient(135deg, #ffd700, #ff9500);
      color: #fff;
      border: none;
    }
    .btn-a:hover {
      background: linear-gradient(135deg, #ff9500, #ffd700);
      transform: translateY(-1px);
    }
    .h { display: none !important; }
    #land {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 56px;
    }
    #land h1 {
      font-size: clamp(40px, 7vw, 64px);
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(180deg, var(--g9), #444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    #land p {
      font-size: 18px;
      color: var(--g5);
      max-width: 500px;
      margin: 0 auto 32px;
    }
    #dash {
      padding: 80px 0 40px;
      min-height: 100vh;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      transition: box-shadow var(--t);
    }
    .card:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.1); }
    .ring {
      width: 140px;
      height: 140px;
      margin: 0 auto 24px;
    }
    .ring svg { transform: rotate(-90deg); }
    .ring circle {
      fill: none;
      stroke-width: 10;
      stroke-linecap: round;
    }
    .ring .bg { stroke: #e8e8ed; }
    .ring .fg {
      stroke: var(--p);
      stroke-dasharray: 408;
      stroke-dashoffset: 408;
      transition: stroke-dashoffset 1s var(--t);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }
    .stat { text-align: center; }
    .stat-v {
      font-size: 28px;
      font-weight: 700;
      color: var(--p);
    }
    .stat-l {
      font-size: 12px;
      color: var(--g5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .week {
      background: #fff;
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      transition: all var(--t);
      cursor: pointer;
    }
    .week:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .wh {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wh h3 {
      font-size: 18px;
      font-weight: 600;
    }
    .wh p {
      color: var(--g5);
      font-size: 13px;
    }
    .wp { text-align: right; }
    .bar {
      width: 80px;
      height: 4px;
      background: #e8e8ed;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 6px;
    }
    .fill {
      height: 100%;
      background: var(--p);
      transition: width var(--t);
    }
    .tasks {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
      padding: 0 20px 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--t);
    }
    .tasks.show { max-height: 2000px; }
    .task {
      background: var(--g1);
      border-radius: var(--r);
      padding: 14px;
      cursor: pointer;
      transition: all var(--t);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .task:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }
    .task.done {
      background: rgba(52,199,89,0.05);
      border: 1px solid var(--s);
    }
    .task input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .task-t {
      font-weight: 500;
      font-size: 14px;
    }
    .task-d {
      font-size: 12px;
      color: var(--g5);
    }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal-c {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    .modal-h {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-h h2 {
      font-size: 20px;
      font-weight: 700;
    }
    .close {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: var(--g1);
      cursor: pointer;
      font-size: 16px;
      transition: all var(--t);
    }
    .close:hover { background: var(--g5); color: #fff; }
    .modal input {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      transition: border-color var(--t);
    }
    .modal input:focus {
      outline: none;
      border-color: var(--p);
    }
    .subtask { margin: 12px 0; }
    .sub-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
    }
    .sub-item input {
      width: 16px;
      height: 16px;
    }
    .sub-item label {
      font-size: 13px;
    }
    .notif {
      position: fixed;
      top: 72px;
      right: 16px;
      padding: 12px 20px;
      border-radius: 10px;
      color: #fff;
      font-size: 14px;
      transform: translateX(300px);
      transition: all var(--t);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .notif.show { transform: translateX(0); }
    .notif.s { background: var(--s); }
    .notif.e { background: var(--e); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    th {
      font-size: 12px;
      color: var(--g5);
      text-transform: uppercase;
      font-weight: 600;
    }
    @media (max-width: 768px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .tasks { grid-template-columns: 1fr; }
      #land h1 { font-size: clamp(32px, 6vw, 48px); }
      #land p { font-size: 16px; }
      .modal-c { padding: 16px; }
    }
  </style>
</head>
<body>
  <header>
    <nav class="c">
      <div class="logo">
        <img src="/assets/Velocity-Logo.png" alt="Velocity Lab">
      </div>
      <div>
        <span id="auth">
          <button onclick="showLogin()" class="btn btn-s">Sign In</button>
          <button onclick="showRegister()" class="btn btn-p">Get Started</button>
        </span>
        <span id="user" class="h">
          <span id="userName"></span>
          <button id="adminBtn" class="btn btn-a h" onclick="showAdmin()">Admin</button>
          <button onclick="logout()" class="btn btn-s">Sign Out</button>
        </span>
      </div>
    </nav>
  </header>

  <main>
    <section id="land">
      <div class="c">
        <h1>Master Exchange Hybrid</h1>
        <p>42 hands-on tasks over 4 weeks. Build a lab with DC, Exchange, and workstation VMs.</p>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-p" onclick="showRegister()">Start Training</button>
          <button class="btn btn-s" onclick="showLogin()">Sign In</button>
        </div>
      </div>
    </section>

    <section id="dash" class="h">
      <div class="c">
        <div class="card" style="text-align: center;">
          <h2 style="margin-bottom: 24px;">Training Progress</h2>
          <div class="ring">
            <svg viewBox="0 0 140 140">
              <circle cx="70" cy="70" r="65" class="bg"/>
              <circle cx="70" cy="70" r="65" class="fg" id="ring"/>
            </svg>
            <div style="margin-top: -90px; font-size: 32px; font-weight: 700;" id="pct">0%</div>
          </div>
          <div class="stats">
            <div class="stat"><div class="stat-v" id="done">0</div><div class="stat-l">Tasks Done</div></div>
            <div class="stat"><div class="stat-v">42</div><div class="stat-l">Total Tasks</div></div>
            <div class="stat"><div class="stat-v" id="curWeek">Week 1</div><div class="stat-l">Current</div></div>
            <div class="stat"><div class="stat-v">3</div><div class="stat-l">VMs</div></div>
          </div>
          <button class="btn btn-p" onclick="newLab()">Start New Lab</button>
        </div>

        <div id="weeks">
          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 1: Foundation</h3>
                <p>DC setup, domain join, shares</p>
              </div>
              <div class="wp">
                <div><span id="week1-done">0</span>/12 tasks</div>
                <div class="bar"><div class="fill" id="week1-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week1-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 2: Infrastructure</h3>
                <p>Second DC, WSUS, time</p>
              </div>
              <div class="wp">
                <div><span id="week2-done">0</span>/8 tasks</div>
                <div class="bar"><div class="fill" id="week2-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week2-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 3: Exchange</h3>
                <p>DC upgrade, Exchange setup</p>
              </div>
              <div class="wp">
                <div><span id="week3-done">0</span>/12 tasks</div>
                <div class="bar"><div class="fill" id="week3-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week3-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 4: Hybrid</h3>
                <p>M365 integration, hybrid</p>
              </div>
              <div class="wp">
                <div><span id="week4-done">0</span>/10 tasks</div>
                <div class="bar"><div class="fill" id="week4-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week4-tasks"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="loginModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Sign In</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <form id="loginForm">
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <input type="checkbox" name="remember" style="width: auto; margin: 0;"> Remember me
        </label>
        <button type="submit" class="btn btn-p" style="width: 100%;">Sign In</button>
        <p style="text-align: center; margin-top: 12px; font-size: 13px;">
          New? <a href="#" onclick="showRegister()">Create account</a>
        </p>
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Create Account</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <form id="registerForm">
        <input type="text" name="name" placeholder="Full Name" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password (8+ chars)" required minlength="8">
        <button type="submit" class="btn btn-p" style="width: 100%;">Get Started</button>
        <p style="text-align: center; margin-top: 12px; font-size: 13px;">
          Have account? <a href="#" onclick="showLogin()">Sign in</a>
        </p>
      </form>
    </div>
  </div>

  <div id="taskModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2 id="taskTitle"></h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <div id="taskBody"></div>
    </div>
  </div>

  <div id="adminModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Leaderboard</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <div id="leaderboard"></div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

  <script src="/task-definitions.js"></script>
  <script>
    const TASKS = {
      week1: { t: ['install-server2012', 'configure-static-ip', 'install-adds-role', 'promote-to-dc', 'configure-dns-server', 'create-domain-users', 'setup-vm-dns', 'join-vm-domain', 'create-hidden-share', 'map-drive-gpo', 'map-drive-script', 'create-security-group'] },
      week2: { t: ['install-second-server', 'promote-additional-dc', 'install-wsus-role', 'configure-wsus-settings', 'setup-wsus-gpo', 'configure-primary-time', 'configure-secondary-time', 'test-infrastructure'] },
      week3: { t: ['backup-servers', 'upgrade-dc1-2016', 'upgrade-dc2-2016', 'raise-functional-levels', 'prepare-exchange-server', 'install-exchange-prereqs', 'extend-ad-schema', 'install-exchange-2019', 'configure-exchange-basic', 'create-mailboxes', 'test-mailbox-access', 'configure-internal-mailflow'] },
      week4: { t: ['configure-external-dns', 'setup-firewall-rules', 'install-ssl-certificates', 'configure-external-mailflow', 'setup-modern-auth', 'prepare-m365-tenant', 'install-aad-connect', 'run-hybrid-wizard', 'configure-hybrid-mailflow', 'verify-hybrid-functionality'] }
    };
    let A = { u: null, p: {}, auth: false, sessionToken: null };
    const $ = id => document.getElementById(id);
    const show = e => e?.classList.remove('h');
    const hide = e => e?.classList.add('h');

    const ck = {
      get: n => document.cookie.match(`${n}=([^;]+)`)?.[1],
      set: (n, v) => {
        document.cookie = `${n}=${v};path=/;max-age=604800;SameSite=Strict;Secure`;
      },
      del: n => { document.cookie = `${n}=;path=/;max-age=0;SameSite=Strict;Secure`; }
    };

    const msg = (m, t = 's') => {
      const n = $('notif');
      n.textContent = m;
      n.className = `notif ${t} show`;
      setTimeout(() => n.classList.remove('show'), 3000);
    };

    const api = async (ep, opt = {}) => {
      try {
        const headers = new Headers(opt.headers || {});
        if (A.sessionToken) headers.set('Authorization', `Bearer ${A.sessionToken}`);
        const isGet = !opt.method || opt.method.toUpperCase() === 'GET';
        
        let body;
        if (!isGet) {
          const r = await fetch('/api/csrf', { credentials: 'same-origin' });
          if (!r.ok) throw new Error(`CSRF fetch failed: ${r.status}`);
          const { token } = await r.json();
          
          let fd;
          if (opt.body instanceof FormData) {
            fd = opt.body;
            fd.append('csrf_token', token);
          } else {
            fd = new FormData();
            if (opt.body) {
              for (const [key, value] of Object.entries(opt.body)) {
                fd.append(key, value);
              }
            }
            fd.append('csrf_token', token);
          }
          body = fd;
        }
        
        const res = await fetch(ep, {
          credentials: 'same-origin',
          headers,
          method: opt.method || 'GET',
          body
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const d = await res.json();
        if (!d.success) throw new Error(d.error || 'Request failed');
        return d;
      } catch (e) {
        console.error(`API error for ${ep}:`, e);
        throw e;
      }
    };

    const auth = {
      async check() {
        const u = ck.get('user');
        A.sessionToken = ck.get('session');
        if (u && A.sessionToken) {
          try {
            A.u = JSON.parse(decodeURIComponent(u));
            A.auth = true;
            if (A.u.role === 'admin') show($('adminBtn'));
            ui.dash();
            dash.load();
          } catch (e) {
            console.error('Auth check error:', e);
            auth.logout();
          }
        } else {
          ui.land();
        }
      },
      async login(fd) {
        try {
          const r = await api('/api/login', { method: 'POST', body: fd });
          ck.set('user', encodeURIComponent(JSON.stringify({ name: r.name, role: r.role })));
          ck.set('session', r.sessionToken);
          A.u = { name: r.name, role: r.role };
          A.auth = true;
          A.sessionToken = r.sessionToken;
          if (A.u.role === 'admin') show($('adminBtn'));
          ui.dash();
          dash.load();
          closeModal();
          msg(`Welcome, ${r.name}!`);
        } catch (e) {
          console.error('Login error:', e);
          msg(e.message || 'Login failed', 'e');
        }
      },
      async register(fd) {
        try {
          const r = await api('/api/register', { method: 'POST', body: fd });
          ck.set('user', encodeURIComponent(JSON.stringify({ name: r.name, role: r.role })));
          ck.set('session', r.sessionToken);
          A.u = { name: r.name, role: r.role };
          A.auth = true;
          A.sessionToken = r.sessionToken;
          ui.dash();
          dash.load();
          closeModal();
          msg(`Welcome, ${r.name}!`);
        } catch (e) {
          console.error('Register error:', e);
          msg(e.message || 'Registration failed', 'e');
        }
      },
      logout() {
        api('/api/logout', { method: 'POST' }).catch(e => console.error('Logout error:', e));
        ck.del('user');
        ck.del('session');
        A = { u: null, p: {}, auth: false, sessionToken: null };
        hide($('adminBtn'));
        ui.land();
        msg('Signed out');
      }
    };

    const ui = {
      land() {
        hide($('dash'));
        show($('land'));
        hide($('user'));
        show($('auth'));
      },
      dash() {
        hide($('land'));
        show($('dash'));
        show($('user'));
        hide($('auth'));
        $('userName').textContent = A.u?.name || '';
      }
    };

    const dash = {
      async load() {
        if (!A.auth) return;
        try {
          const r = await api('/api/progress');
          A.p = r.data || {};
          dash.update();
        } catch (e) {
          console.error('Progress load error:', e);
          msg('Failed to load progress', 'e');
        }
      },
      update() {
        let done = 0;
        Object.entries(TASKS).forEach(([w, d]) => {
          const wp = A.p[w] || {};
          const wd = d.t.filter(t => wp[t]?.completed).length;
          done += wd;
          const doneEl = $(`${w}-done`);
          const barEl = $(`${w}-bar`);
          const tasksEl = $(`${w}-tasks`);
          if (doneEl) doneEl.textContent = `${wd}`;
          if (barEl) barEl.style.width = `${(wd / d.t.length) * 100}%`;
          if (tasksEl) {
            tasksEl.innerHTML = d.t.map(t => `
              <div class="task ${wp[t]?.completed ? 'done' : ''}" onclick="openTask('${w}', '${t}')">
                <input type="checkbox" ${wp[t]?.completed ? 'checked' : ''} onchange="toggleTask('${w}', '${t}', this.checked)" onclick="event.stopPropagation()">
                <div>
                  <div class="task-t">${t.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                  <div class="task-d">Click for details</div>
                </div>
              </div>
            `).join('');
          }
        });
        const pct = Math.round((done / 42) * 100);
        const pctEl = $('pct');
        const doneEl = $('done');
        const curWeekEl = $('curWeek');
        const ringEl = $('ring');
        if (pctEl) pctEl.textContent = `${pct}%`;
        if (doneEl) doneEl.textContent = `${done}`;
        if (curWeekEl) curWeekEl.textContent = done >= 32 ? 'Week 4' : done >= 20 ? 'Week 3' : done >= 12 ? 'Week 2' : 'Week 1';
        if (ringEl) ringEl.style.strokeDashoffset = `${408 - (pct / 100) * 408}`;
      }
    };

    const toggleWeek = h => h.nextElementSibling.classList.toggle('show');

    const toggleTask = async (w, t, c) => {
      try {
        const fd = new FormData();
        fd.append('week', w);
        fd.append('task', t);
        fd.append('checked', c.toString());
        await api('/api/progress', { method: 'POST', body: fd });
        if (!A.p[w]) A.p[w] = {};
        if (!A.p[w][t]) A.p[w][t] = {};
        A.p[w][t].completed = c;
        dash.update();
        msg(c ? '✅ Task completed!' : 'Task unmarked');
      } catch (e) {
        console.error('Toggle task error:', e);
        msg('Failed to update task', 'e');
        event.target.checked = !c;
      }
    };

    const toggleSub = async (w, t, s, c) => {
      try {
        const fd = new FormData();
        fd.append('week', w);
        fd.append('task', t);
        fd.append('subtask', `step${s}`);
        fd.append('subtask_checked', c.toString());
        await api('/api/progress', { method: 'POST', body: fd });
        if (!A.p[w]) A.p[w] = {};
        if (!A.p[w][t]) A.p[w][t] = { subtasks: {} };
        if (!A.p[w][t].subtasks) A.p[w][t].subtasks = {};
        A.p[w][t].subtasks[`step${s}`] = c;
        msg(c ? '✅ Step completed!' : 'Step unmarked');
      } catch (e) {
        console.error('Toggle subtask error:', e);
        msg('Failed to update step', 'e');
      }
    };

    const openTask = (w, t) => {
      const k = `${w}-${t}`;
      const td = window.TASK_DEFINITIONS?.[k] || {
        title: t.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        description: '<p>Details coming soon...</p>'
      };
      $('taskTitle').textContent = td.title;
      $('taskBody').innerHTML = td.description;
      setTimeout(() => {
        document.querySelectorAll('.subtask input').forEach(cb => {
          const s = cb.dataset.step;
          cb.checked = A.p[w]?.[t]?.subtasks?.[`step${s}`] || false;
          cb.onchange = () => toggleSub(w, t, s, cb.checked);
        });
      }, 100);
      $('taskModal').style.display = 'flex';
    };

    const newLab = async () => {
      if (!confirm('Start a new lab? This will reset your progress.')) return;
      try {
        await api('/api/lab/start-new', { method: 'POST' });
        A.p = {};
        dash.update();
        msg('🚀 New lab started!');
      } catch (e) {
        console.error('New lab error:', e);
        msg('Failed to start new lab', 'e');
      }
    };

    const showAdmin = async () => {
      if (!A.u?.role === 'admin') {
        msg('Admin access required', 'e');
        return;
      }
      try {
        const r = await api('/api/admin/users-progress');
        $('leaderboard').innerHTML = `
          <table>
            <thead><tr><th>Rank</th><th>Name</th><th>Progress</th><th>Tasks</th></tr></thead>
            <tbody>
              ${r.data.map((u, i) => `
                <tr>
                  <td>${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : i + 1}</td>
                  <td>${u.name}</td>
                  <td>${u.progress}%</td>
                  <td>${u.completedTasks}/42</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        $('adminModal').style.display = 'flex';
      } catch (e) {
        console.error('Admin load error:', e);
        msg('Failed to load leaderboard', 'e');
      }
    };

    window.showLogin = () => {
      hide($('registerModal'));
      $('loginModal').style.display = 'flex';
    };
    window.showRegister = () => {
      hide($('loginModal'));
      $('registerModal').style.display = 'flex';
    };
    window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    window.logout = auth.logout;
    window.newLab = newLab;
    window.showAdmin = showAdmin;
    window.openTask = openTask;
    window.toggleTask = toggleTask;
    window.toggleWeek = toggleWeek;

    document.addEventListener('DOMContentLoaded', () => {
      $('loginForm').onsubmit = e => {
        e.preventDefault();
        auth.login(new FormData(e.target));
      };
      $('registerForm').onsubmit = e => {
        e.preventDefault();
        auth.register(new FormData(e.target));
      };
      document.onclick = e => {
        if (e.target.classList.contains('modal')) closeModal();
      };
      console.log('Loaded scripts:', Array.from(document.scripts).map(s => s.src));
      auth.check();
    });

    window.addEventListener('message', e => {
      if (e.data?.type === 'hide-notification') {
        console.error('Caught hide-notification message:', e);
      }
    }, true);
  </script>
</body>
</html>