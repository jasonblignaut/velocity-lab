<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocity Lab - Exchange Hybrid Training</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    
    <style>
        /* Apple White + Unifi Cloud Color Scheme with Dark Mode */
        :root {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #f8f9fa;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-hover: #e9ecef;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: #d2d2d7;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --jedi-glow: #00ff88;
            --sith-glow: #ff0066;
            --bg-secondary: #f0f0f5;
        }

        [data-theme="dark"] {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #1e1e1e;
            --background: #000000;
            --surface: #1e1e1e;
            --surface-hover: #2e2e2e;
            --text: #ffffff;
            --text-secondary: #a1a1a6;
            --border: #2e2e2e;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --shadow: rgba(255, 255, 255, 0.1);
            --shadow-heavy: rgba(255, 255, 255, 0.2);
            --bg-secondary: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* Background Image - Fixed to show in both themes */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.08;
            z-index: -1;
        }

        [data-theme="dark"] body::before {
            opacity: 0.05;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.95);
        }

        /* Logo */
        .logo {
            width: 80px;
            height: 80px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            cursor: pointer;
        }

        [data-theme="dark"] .logo {
            filter: invert(1) brightness(1.2);
        }

        /* Desktop Navigation */
        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Mobile Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .hamburger:hover {
            background: var(--surface-hover);
        }

        .hamburger span {
            width: 24px;
            height: 2px;
            background: var(--text);
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
            padding: 1rem;
        }

        [data-theme="dark"] .mobile-menu {
            background: rgba(0, 0, 0, 0.98);
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
        }

        .mobile-menu-item:hover, .mobile-menu-item.primary {
            background: var(--primary);
            color: white;
        }

        .mobile-menu-item.secondary {
            border: 1px solid var(--border);
        }

        /* Theme Menu */
        .theme-menu-item {
            position: relative;
        }

        .theme-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            color: var(--text);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .theme-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .theme-submenu {
            position: absolute;
            right: 100%;
            top: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 150px;
            z-index: 1001;
            display: none;
        }

        .theme-menu-item:hover .theme-submenu {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .theme-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .theme-option:hover {
            background: var(--surface-hover);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
        }

        .theme-option.jedi:hover {
            background: linear-gradient(45deg, var(--jedi-glow), #00ff88);
            color: white;
        }

        .theme-option.sith:hover {
            background: linear-gradient(45deg, var(--sith-glow), #ff0066);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
        }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative;
        }

        .welcome-notification {
            position: absolute;
            top: 100px;
            left: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            max-width: 300px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--text), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            padding: 0.2rem 0;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        .welcome-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* Modern Apple-style Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Apple-style Modal Content */
        .modal-content {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 0;
            width: 100%;
            max-width: 400px;
            height: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .modal-content.large {
            max-width: 800px;
            background: var(--background);
            height: auto;
            min-height: unset;
            max-height: unset;
        }

        /* Apple-style signin has dark background */
        .apple-modal {
            background: #1a1a1a;
            color: white;
        }

        @keyframes modalSlideIn {
            from { 
                transform: scale(0.8) translateY(60px); 
                opacity: 0; 
            }
            to { 
                transform: scale(1) translateY(0); 
                opacity: 1; 
            }
        }

        /* Clean header with logo */
        .modal-header-clean {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: #1a1a1a;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Velocity logo in the center - properly sized and colored */
        .modal-logo {
            width: 120px;
            height: 35px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            filter: invert(1) brightness(1.2);
        }

        /* Modal content area with better centering */
        .modal-body {
            padding: 130px 35px 35px;
            text-align: center;
            height: calc(100% - 120px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .modal-body.initial-state {
            justify-content: center;
        }

        .apple-modal .modal-body {
            color: white;
        }

        .modal-title {
            font-size: clamp(22px, 5vw, 28px);
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            line-height: 1.2;
        }

        .modal-subtitle {
            color: #a1a1a6;
            margin-bottom: 32px;
            font-size: clamp(15px, 4vw, 17px);
            line-height: 1.3;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            z-index: 20;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Form Styles for Apple Modal */
        .apple-form-group {
            margin-bottom: 16px;
            text-align: left;
            position: relative;
        }

        .apple-form-group.hidden {
            display: none;
        }

        .apple-form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid #3a3a3c;
            border-radius: 12px;
            font-size: 17px;
            background: #2c2c2e;
            color: white;
            transition: all 0.3s ease;
        }

        .apple-form-input:focus {
            outline: none;
            border-color: #0a84ff;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
        }

        .apple-form-input::placeholder {
            color: #6d6d70;
        }

        .apple-form-input.loading {
            background: #2c2c2e url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgc3Ryb2tlPSIjNmQ2ZDcwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWRhc2hhcnJheT0iNCAyIiBvcGFjaXR5PSIwLjUiPgogIDxhbmltYXRlVHJhbnNmb3JtIGF0dHJpYnV0ZU5hbWU9InRyYW5zZm9ybSIgYXR0cmlidXRlVHlwZT0iWE1MIiB0eXBlPSJyb3RhdGUiIHZhbHVlcz0iMCAxMCAxMDszNjAgMTAgMTAiIGR1cj0iMXMiIHJlcGVhdENvdW50PSJpbmRlZmluaXRlIi8+CjwvY2lyY2xlPgo8L3N2Zz4K') no-repeat right 16px center;
            pointer-events: none;
        }

        /* Password field with styled arrow button */
        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: #6d6d70;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .password-toggle:hover {
            background: #8e8e93;
            transform: translateY(-50%) scale(1.05);
        }

        .password-toggle:active {
            background: #34c759;
            transform: translateY(-50%) scale(0.95);
        }

        .password-toggle.loading {
            background: #6d6d70;
            color: transparent;
            pointer-events: none;
        }

        .password-toggle.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .apple-checkbox-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .apple-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: #0a84ff;
        }

        .apple-checkbox-label {
            color: #a1a1a6;
            font-size: 15px;
        }

        /* Non-Apple modals keep original styling */
        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Task Detail Modal */
        .task-detail-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .subtask-container {
            margin: 1rem 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .subtask-item:hover {
            background: var(--surface-hover);
        }

        .subtask-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }

        .subtask-item label {
            cursor: pointer;
            line-height: 1.4;
        }

        .subtask-item.completed {
            opacity: 0.7;
        }

        .subtask-item.completed label {
            text-decoration: line-through;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-submit {
            width: 100%;
            margin-top: 1rem;
        }

        /* Main Dashboard */
        .main-content {
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Progress Ring */
        .progress-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Week Cards */
        .weeks-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .week-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .week-card.expanded {
            cursor: default;
        }

        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .week-tasks {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .week-progress {
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .week-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .week-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .week-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Task List */
        .task-list {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .week-card.expanded .task-list {
            display: block;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            background: var(--surface-hover);
        }

        .task-checkbox {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-detail-btn {
            margin-left: 1rem;
            padding: 4px 8px;
            font-size: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .task-item:hover .task-detail-btn {
            opacity: 1;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: background-color 0.2s ease;
        }

        .user-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-menu-dropdown.active {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .user-menu-item:hover {
            background: var(--surface-hover);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                justify-content: center;
                position: relative;
            }

            .logo {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 100px;
                height: 100px;
            }

            .header-buttons {
                display: none;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 1rem;
            }

            .user-menu {
                display: none;
            }

            .welcome-screen {
                padding: 1rem;
            }

            .welcome-notification {
                position: static;
                margin-bottom: 2rem;
                max-width: none;
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }

            .btn-large {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
                margin-top: 70px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .progress-ring {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 1.5rem;
            }

            .weeks-container {
                flex-direction: column;
                gap: 1rem;
            }

            .week-card {
                padding: 1rem;
            }

            .week-title {
                font-size: 1.1rem;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 0;
                margin: auto;
                max-width: 90vw;
                height: 420px;
            }

            .modal-body {
                padding: 110px 20px 30px;
                height: calc(100% - 100px);
            }

            .modal-body.initial-state {
                justify-content: center;
            }

            .modal-logo {
                width: 100px;
                height: 29px;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px 16px;
                justify-content: center;
            }

            .form-input {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
                padding: 0 0.75rem;
            }

            .main-content {
                margin-top: 60px;
                padding: 0.75rem;
            }

            .mobile-menu {
                top: 60px;
            }

            .logo {
                width: 90px;
                height: 90px;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                border-radius: 16px;
                max-width: 95vw;
                height: 400px;
            }

            .modal-body {
                padding: 90px 18px 25px;
                height: calc(100% - 90px);
            }

            .modal-body.initial-state {
                justify-content: center;
            }

            .modal-header-clean {
                height: 90px;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Hide elements by default */
        .hidden {
            display: none !important;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--primary);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Header -->
    <div class="header" id="header">
        <!-- Logo only (no text) -->
        <div class="logo" onclick="goHome()"></div>
        
        <!-- Desktop Navigation - Always shows both Sign In and Get Started -->
        <div class="header-buttons" id="headerButtons">
            <button class="btn btn-secondary" onclick="showSignInModal()">Sign In</button>
            <button class="btn btn-primary" onclick="showRegisterModal()">Get Started</button>
        </div>
        
        <!-- Mobile Hamburger Menu -->
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <!-- Desktop User Menu -->
        <div class="user-menu hidden" id="userMenu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()">
                <span id="userName">User</span>
                <span>â–¼</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <button class="user-menu-item" onclick="startLabEnvironment()">ðŸš€ Start New Lab</button>
                <button class="user-menu-item" onclick="showLabHistoryModal()" id="labHistoryButton">ðŸ“Š Lab History</button>
                <button class="user-menu-item" onclick="showAdminPanel()" id="adminButton" style="display: none;">ðŸ‘‘ Admin Panel</button>
                <div class="theme-menu-item">
                    <button class="theme-menu-toggle">
                        <span>ðŸŽ¨ Theme</span>
                        <span>â–¶</span>
                    </button>
                    <div class="theme-submenu">
                        <button class="theme-option jedi" onclick="setTheme('light')">
                            ðŸŒŸ Light Jedi
                        </button>
                        <button class="theme-option sith active" onclick="setTheme('dark')">
                            âš¡ Dark Sith
                        </button>
                    </div>
                </div>
                <button class="user-menu-item" onclick="logout()">ðŸšª Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-items" id="mobileMenuItems">
            <!-- Items populated by JavaScript based on auth state -->
        </div>
    </div>

    <!-- Welcome Screen - Only Sign In button -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-notification">
            ðŸ‘‹ Welcome to Velocity Lab! Sign in to access your Exchange Hybrid training journey.
        </div>
        
        <h1 class="welcome-title">Master Exchange Hybrid</h1>
        <p class="welcome-subtitle">
            Embark on a comprehensive 4-week journey with 42 hands-on tasks to build
            a complete Exchange Hybrid lab environment, from Domain Controllers to
            Microsoft 365 integration.
        </p>
        
        <div class="welcome-buttons">
            <button class="btn btn-primary btn-large" onclick="showSignInModal()">
                ðŸ‘¤ Sign In
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="main-content hidden" id="mainContent">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Exchange Hybrid Journey</h1>
            <p class="dashboard-subtitle">Track your progress through 42 hands-on tasks across 4 comprehensive weeks</p>
        </div>

        <!-- Progress Ring -->
        <div class="progress-section">
            <div class="progress-ring">
                <svg viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="54"/>
                    <circle class="progress-ring-fill" cx="60" cy="60" r="54" 
                            stroke-dasharray="0 339.292" id="progressRing"/>
                </svg>
                <div class="progress-text">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Week Cards -->
        <div class="weeks-container" id="weeksContainer">
            <!-- Week cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Apple-style Sign In Modal -->
    <div class="modal" id="signInModal">
        <div class="modal-content apple-modal">
            <button class="modal-close" onclick="closeModal('signInModal')">&times;</button>
            
            <!-- Clean header with logo -->
            <div class="modal-header-clean">
                <div class="modal-logo"></div>
            </div>
            
            <div class="modal-body">
                <h2 class="modal-title">Sign in with Velocity Lab</h2>
                <p class="modal-subtitle">Welcome back to your training journey</p>
                
                <form id="signInForm">
                    <div class="apple-form-group">
                        <input type="email" class="apple-form-input" id="signInEmail" name="email" 
                               placeholder="Email" required>
                    </div>
                    
                    <div class="apple-form-group hidden" id="passwordGroup">
                        <div class="password-field">
                            <input type="password" class="apple-form-input" id="signInPassword" name="password" 
                                   placeholder="Password" required>
                            <button type="submit" class="password-toggle" title="Sign In">
                                â†’
                            </button>
                        </div>
                    </div>
                    
                    <div class="apple-checkbox-container hidden" id="rememberGroup">
                        <input type="checkbox" class="apple-checkbox" name="remember" id="rememberMe">
                        <label class="apple-checkbox-label" for="rememberMe">Remember me for 30 days</label>
                    </div>
                    
                    <div id="signInMessage"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Apple-style Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content apple-modal">
            <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            
            <!-- Clean header with logo -->
            <div class="modal-header-clean">
                <div class="modal-logo"></div>
            </div>
            
            <div class="modal-body">
                <h2 class="modal-title">Create Velocity Lab Account</h2>
                <p class="modal-subtitle">Start your Exchange Hybrid journey today</p>
                
                <form id="registerForm">
                    <div class="apple-form-group">
                        <input type="text" class="apple-form-input" id="registerName" name="name" 
                               placeholder="Full Name" required>
                    </div>
                    
                    <div class="apple-form-group">
                        <input type="email" class="apple-form-input" id="registerEmail" name="email" 
                               placeholder="Email" required>
                    </div>
                    
                    <div class="apple-form-group">
                        <div class="password-field">
                            <input type="password" class="apple-form-input" id="registerPassword" name="password" 
                                   placeholder="Password" required>
                            <button type="submit" class="password-toggle" title="Create Account">
                                â†’
                            </button>
                        </div>
                    </div>
                    
                    <div id="registerMessage"></div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('taskDetailModal')">&times;</button>
            <div class="modal-header">
                <h2 id="taskDetailTitle">Task Details</h2>
            </div>
            <div class="task-detail-content" id="taskDetailContent">
                <!-- Task details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Lab History Modal -->
    <div class="modal" id="labHistoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('labHistoryModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸ“Š Lab History</h2>
                <p style="color: var(--text-secondary);">Your training progress timeline</p>
            </div>
            <div id="labHistoryModalContent">
                <!-- Lab history content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸ‘‘ Admin Panel</h2>
                <p style="color: var(--text-secondary);">User progress leaderboard</p>
            </div>
            <div id="adminContent">
                <!-- Admin content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load Task Definitions -->
    <script src="/assets/task-definitions.js"></script>

    <script>
        // Global application state
        const appState = {
            user: null,
            sessionToken: null,
            progress: {},
            authenticated: false,
            labHistory: [],
            tasks: [], // Will be populated from task-definitions.js
            isWelcomeShown: false, // Flag to prevent duplicate welcome messages
            shownNotifications: new Set() // Track shown notifications to prevent duplicates
        };

        // API configuration
        const API_BASE = '/api';

        // Utility functions for cookies and DOM manipulation - NO localStorage
        const utils = {
            cookies: {
                set(name, value) {
                    const expires = new Date();
                    expires.setTime(expires.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
                    document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/; SameSite=Strict`;
                },
                get(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                },
                delete(name) {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict`;
                }
            },
            getId(id) {
                return document.getElementById(id);
            }
        };

        // API call function - Cloudflare KV backend only, no localStorage fallback
        const api = {
            async call(url, options = {}) {
                try {
                    console.log('ðŸŒ API Call:', options.method || 'GET', url);
                    
                    // Debug FormData contents (for login/register)
                    if (options.body instanceof FormData) {
                        console.log('ðŸ“‹ FormData contents:');
                        for (let [key, value] of options.body.entries()) {
                            if (key === 'password') {
                                console.log(`  ${key}: [${value.length} characters]`);
                            } else {
                                console.log(`  ${key}:`, value);
                            }
                        }
                    }
                    
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        body: options.body,
                        headers: {
                            ...options.headers
                        }
                    });

                    console.log('ðŸ“¡ Response status:', response.status, response.statusText);

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('âŒ Expected JSON response but got:', contentType);
                        const responseText = await response.text();
                        console.error('âŒ Response body:', responseText);
                        throw new Error(`API returned ${response.status}: Expected JSON response but got ${contentType}`);
                    }

                    const result = await response.json();
                    console.log('ðŸ“¡ Response data:', result);
                    
                    if (!result.success) {
                        throw new Error(result.message || 'API call failed');
                    }
                    
                    return result;
                } catch (error) {
                    console.error('âŒ API call failed:', error);
                    throw error;
                }
            }
        };

        // Enhanced notification system with deduplication
        const notificationSystem = {
            notifications: [],
            
            success(message) {
                console.log('âœ… Success:', message);
                this.show(message, 'success');
            },
            
            error(message) {
                console.log('âŒ Error:', message);
                this.show(message, 'error');
            },
            
            info(message) {
                console.log('â„¹ï¸ Info:', message);
                this.show(message, 'info');
            },
            
            show(message, type) {
                // Create unique notification ID based on message and type
                const notificationId = `${type}:${message}`;
                
                // Check if this notification was already shown
                if (appState.shownNotifications.has(notificationId)) {
                    console.log('ðŸš« Duplicate notification prevented:', message);
                    return;
                }
                
                // For welcome messages, use the isWelcomeShown flag
                if (message.includes('Welcome back') || message.includes('Welcome to Velocity Lab')) {
                    if (appState.isWelcomeShown) {
                        console.log('ðŸš« Duplicate welcome notification prevented:', message);
                        return;
                    }
                    appState.isWelcomeShown = true;
                }
                
                // Mark this notification as shown
                appState.shownNotifications.add(notificationId);
                
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // Calculate position based on existing notifications
                const offset = this.notifications.length * 80;
                notification.style.top = `${90 + offset}px`;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.remove();
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                        // Reposition remaining notifications
                        this.notifications.forEach((notif, i) => {
                            notif.style.top = `${90 + (i * 80)}px`;
                        });
                    }
                    
                    // Remove from shown notifications after display
                    // This allows the same notification to be shown again later if needed
                    setTimeout(() => {
                        appState.shownNotifications.delete(notificationId);
                    }, 1000);
                }, 5000);
            },
            
            // Method to clear all shown notifications (useful for new sessions)
            clearShownNotifications() {
                appState.shownNotifications.clear();
                appState.isWelcomeShown = false;
            }
        };

        // Authentication system - KV backend only
        const authSystem = {
            async login(formData) {
                const submitBtn = document.querySelector('#signInForm .password-toggle');
                
                try {
                    // Show loading spinner
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                    }
                    
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        throw new Error('Please fill in all required fields.');
                    }

                    console.log('ðŸ”„ Attempting login with Cloudflare KV backend...');
                    
                    // Call Cloudflare KV backend directly
                    const { data } = await api.call('/api/users/login', {
                        method: 'POST',
                        body: formData  // Send FormData directly to match backend expectations
                    });
                    
                    console.log('âœ… Login successful with Cloudflare KV backend');
                    
                    const { name, role, email: userEmail, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, role, email: userEmail }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, role, email: userEmail };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        const adminBtn = document.getElementById('adminButton');
                        if (adminBtn) adminBtn.style.display = 'block';
                    }
                    
                    showDashboard();
                    await loadUserProgress();
                    await loadLabHistory();
                    closeModal('signInModal');
                    
                    // Show welcome notification only if not already shown
                    if (!appState.isWelcomeShown) {
                        notificationSystem.success(`Welcome back, ${name}! ðŸŽ‰`);
                    }
                } catch (err) {
                    console.error('âŒ Login failed:', err);
                    notificationSystem.error(err.message || 'Login failed. Please check your credentials.');
                } finally {
                    // Remove loading spinner
                    if (submitBtn) {
                        submitBtn.classList.remove('loading');
                    }
                }
            },
            
            async register(formData) {
                const submitBtn = document.querySelector('#registerForm .password-toggle');
                
                try {
                    // Show loading spinner
                    if (submitBtn) {
                        submitBtn.classList.add('loading');
                    }
                    
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!name || !email || !password) {
                        throw new Error('Please fill in all required fields.');
                    }
                    
                    if (password.length < 8) {
                        throw new Error('Password must be at least 8 characters long.');
                    }

                    console.log('ðŸ”„ Attempting registration with Cloudflare KV backend...');
                    
                    // Call Cloudflare KV backend directly
                    const { data } = await api.call('/api/users/register', {
                        method: 'POST',
                        body: formData  // Send FormData directly to match backend expectations
                    });
                    
                    console.log('âœ… Registration successful with Cloudflare KV backend');
                    
                    const { name: userName, email: userEmail, role, sessionToken } = data;
                    
                    // Note: Backend ensures new users get role 'user', not 'admin'
                    utils.cookies.set('user', JSON.stringify({ name: userName, email: userEmail, role }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name: userName, email: userEmail, role };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    // Only show admin button if user is admin (should not happen for new registrations)
                    if (role === 'admin') {
                        const adminBtn = document.getElementById('adminButton');
                        if (adminBtn) adminBtn.style.display = 'block';
                    }
                    
                    showDashboard();
                    await loadUserProgress();
                    await loadLabHistory();
                    closeModal('registerModal');
                    
                    // Show welcome notification only if not already shown
                    if (!appState.isWelcomeShown) {
                        notificationSystem.success(`Welcome to Velocity Lab, ${userName}! ðŸš€`);
                    }
                } catch (err) {
                    console.error('âŒ Registration failed:', err);
                    notificationSystem.error(err.message || 'Registration failed. Please try again.');
                } finally {
                    // Remove loading spinner
                    if (submitBtn) {
                        submitBtn.classList.remove('loading');
                    }
                }
            },
            
            async logout() {
                try {
                    if (appState.sessionToken) {
                        await api.call('/api/users/logout', { 
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`
                            }
                        });
                    }
                } catch (err) {
                    console.log('â„¹ï¸ Logout API call failed (expected if no backend logout endpoint):', err);
                    // Don't show error for logout API failures - backend might not have logout endpoint
                }
                
                utils.cookies.delete('user');
                utils.cookies.delete('session');
                
                appState.user = null;
                appState.progress = {};
                appState.authenticated = false;
                appState.sessionToken = null;
                appState.labHistory = [];
                
                // Clear notification history on logout
                notificationSystem.clearShownNotifications();
                
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.style.display = 'none';
                showWelcomeScreen();
                notificationSystem.info('Signed out successfully');
            }
        };

        // Theme management with KV backend sync
        const themeSystem = {
            async setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                
                // Try to save to KV backend
                try {
                    if (appState.sessionToken) {
                        await api.call('/api/user/preferences', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ theme: theme })
                        });
                        console.log('âœ… Theme preference saved to KV backend');
                    }
                } catch (error) {
                    console.warn('Failed to save theme to backend, using client-side only:', error);
                    // Fallback to cookie for persistence
                    utils.cookies.set('theme', theme);
                }
                
                // Update active states in desktop menu
                const themeOptions = document.querySelectorAll('.theme-option');
                themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if ((theme === 'light' && option.classList.contains('jedi')) || 
                        (theme === 'dark' && option.classList.contains('sith'))) {
                        option.classList.add('active');
                    }
                });
                
                // Show notification
                if (theme === 'light') {
                    notificationSystem.success('ðŸŒŸ Light Jedi theme activated!');
                } else {
                    notificationSystem.success('âš¡ Dark Sith theme activated!');
                }
            },

            async loadTheme() {
                try {
                    // Try to load from KV backend first
                    if (appState.sessionToken) {
                        const response = await api.call('/api/user/preferences', {
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`
                            }
                        });
                        
                        if (response.success && response.data.theme) {
                            document.body.setAttribute('data-theme', response.data.theme);
                            console.log('âœ… Theme loaded from KV backend:', response.data.theme);
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load theme from backend, using default:', error);
                }
                
                // Fallback to cookie
                const savedTheme = utils.cookies.get('theme') || 'dark';
                document.body.setAttribute('data-theme', savedTheme);
                console.log('âœ… Theme loaded from cookie:', savedTheme);
            }
        };

        // Load task definitions from task-definitions.js
        function loadTaskDefinitions() {
            if (typeof window !== 'undefined' && window.TASK_DEFINITIONS) {
                // Convert object to array format
                appState.tasks = [];
                Object.keys(window.TASK_DEFINITIONS).forEach(taskId => {
                    const task = window.TASK_DEFINITIONS[taskId];
                    appState.tasks.push({
                        id: taskId,
                        title: task.title,
                        description: task.description || 'No description available',
                        week: parseInt(taskId.split('-')[0].replace('week', '')) || 1,
                        category: task.category || 'General'
                    });
                });
                console.log('Task definitions loaded:', appState.tasks.length, 'tasks');
            } else {
                console.warn('Task definitions not loaded from task-definitions.js');
                // Fallback task structure
                appState.tasks = generateFallbackTasks();
            }
        }

        function generateFallbackTasks() {
            const weeks = [
                {
                    title: 'Foundation Setup',
                    tasks: [
                        'Install Windows Server 2012 R2',
                        'Configure Domain Controller',
                        'Create Organizational Units',
                        'Add Domain Users',
                        'Configure DNS',
                        'Setup DHCP',
                        'Join Client Machine',
                        'Test Domain Authentication',
                        'Configure Group Policy',
                        'Create Security Groups',
                        'Configure File Shares',
                        'Verify Network Services'
                    ]
                },
                {
                    title: 'Exchange On-Premises',
                    tasks: [
                        'Install Exchange Server 2016',
                        'Configure Exchange Organization',
                        'Create Mailboxes',
                        'Setup Distribution Groups',
                        'Configure Public Folders',
                        'Setup OWA',
                        'Configure SMTP Connectors',
                        'Setup Message Routing',
                        'Configure Anti-Spam',
                        'Test Internal Mail Flow'
                    ]
                },
                {
                    title: 'Microsoft 365 Setup',
                    tasks: [
                        'Create M365 Tenant',
                        'Configure Domain',
                        'Setup Exchange Online',
                        'Create Cloud Users',
                        'Configure Licensing',
                        'Setup Teams',
                        'Configure SharePoint',
                        'Setup OneDrive',
                        'Configure Compliance',
                        'Test Cloud Services'
                    ]
                },
                {
                    title: 'Hybrid Configuration',
                    tasks: [
                        'Install Azure AD Connect',
                        'Configure Directory Sync',
                        'Setup Hybrid Exchange',
                        'Configure Mail Flow',
                        'Test Hybrid Connectivity',
                        'Migrate Test Mailbox',
                        'Configure Hybrid Features',
                        'Setup Single Sign-On',
                        'Test User Experience',
                        'Document Configuration'
                    ]
                }
            ];

            const tasks = [];
            weeks.forEach((week, weekIndex) => {
                week.tasks.forEach((task, taskIndex) => {
                    tasks.push({
                        id: `week${weekIndex + 1}-task${taskIndex + 1}`,
                        week: weekIndex + 1,
                        title: task,
                        description: `Complete ${task} as part of Week ${weekIndex + 1}`,
                        category: week.title
                    });
                });
            });

            return tasks;
        }

        // Progress management with KV backend only
        async function loadUserProgress() {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token available');
                    appState.progress = {};
                    updateProgressDisplay();
                    return;
                }

                console.log('ðŸ”„ Loading progress from Cloudflare KV...');
                const response = await api.call(`${API_BASE}/user/progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                if (response.success) {
                    appState.progress = response.data || {};
                    console.log('âœ… Progress loaded from Cloudflare KV');
                } else {
                    console.warn('API returned error:', response.message);
                    appState.progress = {};
                }
            } catch (error) {
                console.warn('Progress API unavailable:', error);
                appState.progress = {};
            }
            
            updateProgressDisplay();
            checkLabCompletion();
        }

        async function saveUserProgress(taskId, taskProgress) {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token, cannot save progress');
                    return;
                }

                console.log(`ðŸ”„ Saving progress for task ${taskId} to Cloudflare KV...`);
                const response = await api.call(`${API_BASE}/user/progress`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        taskId: taskId,
                        progress: taskProgress
                    })
                });
                
                if (response.success) {
                    console.log('âœ… Progress saved to Cloudflare KV');
                } else {
                    console.warn('Failed to save progress:', response.message);
                }
            } catch (error) {
                console.warn('Progress save failed:', error);
            }
        }

        // Lab history management with KV backend only
        async function loadLabHistory() {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token available');
                    appState.labHistory = [];
                    return;
                }

                console.log('ðŸ”„ Loading lab history from Cloudflare KV...');
                const response = await api.call(`${API_BASE}/user/lab-history`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                if (response.success) {
                    appState.labHistory = response.data || [];
                    console.log('âœ… Lab history loaded from Cloudflare KV');
                } else {
                    console.warn('API returned error:', response.message);
                    appState.labHistory = [];
                }
            } catch (error) {
                console.warn('Lab history API unavailable:', error);
                appState.labHistory = [];
            }
        }

        async function saveLabHistory(newSession) {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token, cannot save lab history');
                    return;
                }

                console.log('ðŸ”„ Saving lab history to Cloudflare KV...');
                const response = await api.call(`${API_BASE}/user/lab-history`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newSession)
                });
                
                if (response.success) {
                    console.log('âœ… Lab history saved to Cloudflare KV');
                } else {
                    console.warn('Failed to save lab history:', response.message);
                }
            } catch (error) {
                console.warn('Lab history save failed:', error);
            }
        }

        function checkLabCompletion() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            
            // Check if lab is completed (all tasks done)
            if (completedTasks === totalTasks && totalTasks > 0) {
                const lastEntry = appState.labHistory[appState.labHistory.length - 1];
                const today = new Date().toISOString().split('T')[0];
                
                // Only add completion if not already completed today
                if (!lastEntry || lastEntry.date !== today || lastEntry.status !== 'completed') {
                    const completionEntry = {
                        session: appState.labHistory.length + 1,
                        date: today,
                        status: 'completed',
                        labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                        completedAt: new Date().toISOString(),
                        tasksCompleted: completedTasks,
                        totalTasks: totalTasks
                    };
                    
                    appState.labHistory.push(completionEntry);
                    saveLabHistory(completionEntry);
                    
                    notificationSystem.success('ðŸŽ‰ Lab completed successfully!');
                }
            }
        }

        // Check for existing session using cookies
        function checkExistingSession() {
            const userCookie = utils.cookies.get('user');
            const sessionCookie = utils.cookies.get('session');
            
            if (userCookie && sessionCookie) {
                try {
                    appState.user = JSON.parse(userCookie);
                    appState.sessionToken = sessionCookie;
                    appState.authenticated = true;
                    
                    // Mark welcome as shown for existing sessions to prevent duplicates
                    appState.isWelcomeShown = true;
                    
                    console.log('Found existing session for:', appState.user.name);
                    showDashboard();
                    loadUserProgress();
                    loadLabHistory();
                    themeSystem.loadTheme();
                } catch (error) {
                    console.error('Session validation failed:', error);
                    utils.cookies.delete('user');
                    utils.cookies.delete('session');
                    notificationSystem.clearShownNotifications();
                    showWelcomeScreen();
                    themeSystem.loadTheme();
                }
            } else {
                console.log('No existing session found');
                notificationSystem.clearShownNotifications();
                showWelcomeScreen();
                themeSystem.loadTheme();
            }
        }

        // Form handlers with progressive disclosure
        function setupFormHandlers() {
            const loginForm = utils.getId('signInForm');
            if (loginForm) {
                const emailInput = document.getElementById('signInEmail');
                const passwordGroup = document.getElementById('passwordGroup');
                const rememberGroup = document.getElementById('rememberGroup');
                
                // Progressive disclosure for login - only on Enter key or blur with valid email
                if (emailInput) {
                    emailInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && this.value.length > 0) {
                            e.preventDefault();
                            showPasswordField();
                        }
                    });
                    
                    emailInput.addEventListener('blur', function() {
                        // Check if it looks like a valid email and is not empty
                        if (this.value.length > 0 && (this.value.includes('@') || this.value.length > 3)) {
                            setTimeout(() => showPasswordField(), 100);
                        }
                    });
                }
                
                function showPasswordField() {
                    if (passwordGroup.classList.contains('hidden')) {
                        const modalBody = document.querySelector('#signInModal .modal-body');
                        
                        // Add loading state
                        emailInput.classList.add('loading');
                        
                        setTimeout(() => {
                            emailInput.classList.remove('loading');
                            passwordGroup.classList.remove('hidden');
                            rememberGroup.classList.remove('hidden');
                            if (modalBody) modalBody.classList.remove('initial-state');
                            document.getElementById('signInPassword').focus();
                        }, 600);
                    }
                }

                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(loginForm);
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    console.log('ðŸ“§ Login attempt for:', email);
                    await authSystem.login(formData);
                });
            }

            const registerForm = utils.getId('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(registerForm);
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!name || !email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    if (password.length < 8) {
                        notificationSystem.error('Password must be at least 8 characters long.');
                        return;
                    }
                    
                    console.log('ðŸ“§ Registration attempt for:', email);
                    await authSystem.register(formData);
                });
            }
        }

        // Global functions for HTML event handlers
        window.togglePasswordVisibility = function(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = 'â†'; // left arrow when showing
            } else {
                input.type = 'password';
                button.innerHTML = 'â†’'; // right arrow when hidden
            }
        };

        window.setTheme = function(theme) {
            themeSystem.setTheme(theme);
        };

        window.logout = async function() {
            await authSystem.logout();
        };

        window.goHome = function() {
            if (appState.authenticated) {
                return;
            } else {
                showWelcomeScreen();
            }
        };

        window.toggleMobileMenu = function() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            
            updateMobileMenuItems();
        };

        window.startLabEnvironment = async function() {
            try {
                // Reset all progress when starting new lab
                appState.progress = {};
                updateProgressDisplay();
                
                // Add a new lab session entry
                const today = new Date().toISOString().split('T')[0];
                const newSession = {
                    session: appState.labHistory.length + 1,
                    date: today,
                    status: 'started',
                    labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                    startedAt: new Date().toISOString()
                };
                
                // Check if already started today
                const todaySession = appState.labHistory.find(session => 
                    session.date === today && session.status === 'started'
                );
                
                if (!todaySession) {
                    appState.labHistory.push(newSession);
                    await saveLabHistory(newSession);
                }
                
                notificationSystem.success('New lab started!');
                
            } catch (error) {
                console.error('Failed to start lab:', error);
                notificationSystem.error('Failed to start lab environment. Please try again.');
            }
        };

        window.showLabHistoryModal = function() {
            const content = document.getElementById('labHistoryModalContent');
            
            if (appState.labHistory.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸš€</div>
                        <p>No lab sessions yet!</p>
                        <p style="margin-top: 0.5rem;">Click "Start New Lab" to begin your first training session.</p>
                    </div>
                `;
            } else {
                // Filter buttons
                const filterButtons = `
                    <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button onclick="filterLabHistory('week')" class="lab-filter-btn" data-filter="week" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Week</button>
                        <button onclick="filterLabHistory('month')" class="lab-filter-btn" data-filter="month" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 30 Days</button>
                        <button onclick="filterLabHistory('quarter')" class="lab-filter-btn" data-filter="quarter" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 3 Months</button>
                        <button onclick="filterLabHistory('halfyear')" class="lab-filter-btn" data-filter="halfyear" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 6 Months</button>
                        <button onclick="filterLabHistory('year')" class="lab-filter-btn" data-filter="year" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Year</button>
                        <button onclick="filterLabHistory('lifetime')" class="lab-filter-btn active" data-filter="lifetime" style="padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 0.8rem;">Lifetime</button>
                    </div>
                `;
                
                content.innerHTML = filterButtons + `
                    <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                        <strong>Total Sessions: <span id="filteredCount">${appState.labHistory.length}</span></strong>
                    </div>
                    <div id="labHistoryContent">
                        ${generateLabHistoryHTML(appState.labHistory)}
                    </div>
                `;
            }
            
            showModal('labHistoryModal');
        };

        window.showAdminPanel = async function() {
            try {
                // Check if user is admin
                if (!appState.user || appState.user.role !== 'admin') {
                    notificationSystem.error('Admin access required');
                    return;
                }

                console.log('ðŸ”„ Loading admin data from Cloudflare KV...');
                const response = await api.call(`${API_BASE}/admin/users-progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.success) {
                    console.log('âœ… Admin data loaded from Cloudflare KV');
                    displayAdminPanel(response.data);
                } else {
                    notificationSystem.error(`Failed to load admin data: ${response.message}`);
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
                console.log('âš ï¸ Admin panel API unavailable, showing fallback');
                // Show fallback admin panel
                showAdminPanelFallback();
            }
        };

        window.filterLabHistory = function(period) {
            const now = new Date();
            let filteredHistory = appState.labHistory;
            
            if (period !== 'lifetime') {
                const cutoffDate = new Date();
                switch(period) {
                    case 'week':
                        cutoffDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        cutoffDate.setDate(now.getDate() - 30);
                        break;
                    case 'quarter':
                        cutoffDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'halfyear':
                        cutoffDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredHistory = appState.labHistory.filter(session => 
                    new Date(session.date) >= cutoffDate
                );
            }
            
            // Update active button
            document.querySelectorAll('.lab-filter-btn').forEach(btn => {
                btn.style.background = 'var(--surface)';
                btn.style.color = 'var(--text)';
                btn.style.border = '1px solid var(--border)';
            });
            
            const activeBtn = document.querySelector(`[data-filter="${period}"]`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary)';
                activeBtn.style.color = 'white';
                activeBtn.style.border = '1px solid var(--primary)';
            }
            
            // Update content
            document.getElementById('filteredCount').textContent = filteredHistory.length;
            document.getElementById('labHistoryContent').innerHTML = generateLabHistoryHTML(filteredHistory);
        };

        window.showTaskDetail = function(taskId) {
            const taskDefinition = window.TASK_DEFINITIONS && window.TASK_DEFINITIONS[taskId];
            
            if (taskDefinition) {
                document.getElementById('taskDetailTitle').textContent = taskDefinition.title;
                
                // Get or create task progress
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const taskProgress = appState.progress[taskId];
                
                // Create task detail content with notes section
                const notesSection = `
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: var(--text);">ðŸ“ Your Notes</h4>
                        <textarea 
                            id="taskNotes_${taskId}" 
                            placeholder="Add your notes, observations, or troubleshooting steps here..."
                            style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--background); color: var(--text); font-family: inherit; resize: vertical;"
                            onchange="saveTaskNotes('${taskId}')"
                        >${taskProgress.notes || ''}</textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                            ðŸ’¡ Tip: Document any issues, solutions, or key learnings for future reference
                        </div>
                    </div>
                `;
                
                document.getElementById('taskDetailContent').innerHTML = taskDefinition.description + notesSection;
                
                // Add event listeners for subtask checkboxes
                setTimeout(() => {
                    const subtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
                    subtaskCheckboxes.forEach(checkbox => {
                        const step = checkbox.getAttribute('data-step');
                        
                        // Set checkbox state from saved progress
                        if (taskProgress.subtasks && taskProgress.subtasks[step]) {
                            checkbox.checked = taskProgress.subtasks[step].completed;
                            const subtaskItem = checkbox.closest('.subtask-item');
                            if (checkbox.checked) {
                                subtaskItem.classList.add('completed');
                            }
                        }
                        
                        checkbox.addEventListener('change', function() {
                            handleSubtaskChange(taskId, step, this.checked);
                        });
                    });
                }, 100);
                
                showModal('taskDetailModal');
            } else {
                notificationSystem.error('Task details not available');
            }
        };

        window.saveTaskNotes = function(taskId) {
            const notesTextarea = document.getElementById(`taskNotes_${taskId}`);
            if (notesTextarea && appState.progress[taskId]) {
                appState.progress[taskId].notes = notesTextarea.value;
                appState.progress[taskId].lastUpdated = new Date().toISOString();
                saveUserProgress(taskId, appState.progress[taskId]);
                console.log('ðŸ“ Notes saved for task:', taskId);
            }
        };

        window.toggleTaskCompletion = async function(taskId) {
            try {
                // Initialize task progress if not exists
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const isCompleted = appState.progress[taskId].completed;
                
                // Update local state
                appState.progress[taskId].completed = !isCompleted;
                appState.progress[taskId].completedAt = !isCompleted ? new Date().toISOString() : null;
                appState.progress[taskId].lastUpdated = new Date().toISOString();
                
                // Save to KV backend
                await saveUserProgress(taskId, appState.progress[taskId]);
                
                // Update UI immediately
                updateProgressDisplay();
                
                // Check if lab is now completed
                checkLabCompletion();
                
            } catch (error) {
                console.error('Failed to toggle task completion:', error);
                notificationSystem.error('Failed to save progress. Please try again.');
            }
        };

        window.toggleWeekExpansion = function(weekNum) {
            const weekCards = document.querySelectorAll('.week-card');
            const targetCard = weekCards[weekNum - 1];
            
            if (targetCard) {
                targetCard.classList.toggle('expanded');
            }
        };

        window.toggleMobileThemeMenu = function(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const themeOptions = document.getElementById('mobileThemeOptions');
            const themeToggle = document.getElementById('mobileThemeToggle');
            
            if (themeOptions && themeToggle) {
                if (themeOptions.style.display === 'none') {
                    themeOptions.style.display = 'block';
                    themeToggle.innerHTML = 'ðŸŽ¨ Theme â–¼';
                } else {
                    themeOptions.style.display = 'none';
                    themeToggle.innerHTML = 'ðŸŽ¨ Theme â–¶';
                }
            }
        };

        window.showUserLabHistory = function(userName, userEmail) {
            // This would need KV backend implementation for cross-user access
            notificationSystem.info('User lab history requires backend implementation');
        };

        // Mobile menu functionality
        function setupMobileMenuHandlers() {
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const hamburger = document.getElementById('hamburger');
                
                if (mobileMenu && hamburger && !mobileMenu.contains(event.target) && !hamburger.contains(event.target)) {
                    closeMobileMenu();
                }
            });
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
            
            // Close theme submenu if open
            closeMobileThemeMenu();
        }

        function updateMobileMenuItems() {
            const mobileMenuItems = document.getElementById('mobileMenuItems');
            
            if (appState.authenticated && appState.user) {
                let adminItem = '';
                if (appState.user.role === 'admin') {
                    adminItem = '<button class="mobile-menu-item" onclick="showAdminPanel(); closeMobileMenu();">ðŸ‘‘ Admin Panel</button>';
                }
                
                mobileMenuItems.innerHTML = `
                    <div style="padding: 0.5rem 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
                        Welcome, ${appState.user.name}
                    </div>
                    <button class="mobile-menu-item" onclick="startLabEnvironment(); closeMobileMenu();">ðŸš€ Start New Lab</button>
                    <button class="mobile-menu-item" onclick="showLabHistoryModal(); closeMobileMenu();">ðŸ“Š Lab History</button>
                    ${adminItem}
                    <button class="mobile-menu-item" onclick="toggleMobileThemeMenu(event)" id="mobileThemeToggle">
                        ðŸŽ¨ Theme â–¶
                    </button>
                    <div id="mobileThemeOptions" style="display: none; padding-left: 1rem; background: var(--bg-secondary);">
                        <button class="mobile-menu-item" onclick="setTheme('light'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">
                            ðŸŒŸ Light Jedi
                        </button>
                        <button class="mobile-menu-item" onclick="setTheme('dark'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">
                            âš¡ Dark Sith
                        </button>
                    </div>
                    <button class="mobile-menu-item" onclick="logout(); closeMobileMenu();">ðŸšª Sign Out</button>
                `;
            } else {
                mobileMenuItems.innerHTML = `
                    <button class="mobile-menu-item secondary" onclick="showSignInModal(); closeMobileMenu();">ðŸ‘¤ Sign In</button>
                    <button class="mobile-menu-item primary" onclick="showRegisterModal(); closeMobileMenu();">ðŸš€ Get Started</button>
                `;
            }
        }

        function closeMobileThemeMenu() {
            const existingSubmenu = document.getElementById('mobileThemeSubmenu');
            if (existingSubmenu) {
                existingSubmenu.remove();
            }
        }

        function generateLabHistoryHTML(history) {
            if (history.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No sessions found for this period.</div>';
            }
            
            // Sort history with newest first, but in-progress labs at the very top
            const sortedHistory = [...history].sort((a, b) => {
                // In-progress labs go to top
                if (a.status === 'started' && b.status !== 'started') return -1;
                if (b.status === 'started' && a.status !== 'started') return 1;
                
                // Otherwise sort by date (newest first)
                return new Date(b.date) - new Date(a.date);
            });
            
            // Number completed labs sequentially (Lab 1, Lab 2, etc.)
            const completedLabs = history.filter(lab => lab.status === 'completed')
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first for numbering
            
            let labNumberMap = {};
            completedLabs.forEach((lab, index) => {
                labNumberMap[lab.labId] = index + 1;
            });
            
            return sortedHistory.map(session => {
                const isInProgress = session.status === 'started';
                const statusIcon = session.status === 'completed' ? 'âœ…' : 'ðŸš€';
                const statusText = session.status === 'completed' ? 'Completed' : 'In Progress';
                const statusColor = session.status === 'completed' ? 'var(--success)' : 'var(--primary)';
                
                // Get current progress for in-progress labs
                const currentProgress = getCurrentLabProgress();
                const completedTasks = currentProgress.completedTasks || 0;
                
                // Lab title
                let labTitle;
                if (isInProgress) {
                    labTitle = `${statusIcon} Current Lab`;
                } else {
                    const labNumber = labNumberMap[session.labId];
                    labTitle = `${statusIcon} Lab ${labNumber}`;
                }
                
                return `
                    <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">${labTitle}</span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Lab ID: ${session.labId} â€¢ ${new Date(session.date).toLocaleDateString()}
                        </div>
                        ${isInProgress ? 
                            `<div style="color: var(--primary); font-size: 0.8rem; font-weight: 600;">Tasks: ${completedTasks}/42</div>` : 
                            session.tasksCompleted ? 
                            `<div style="color: var(--success); font-size: 0.8rem;">Tasks: ${session.tasksCompleted}/${session.totalTasks}</div>` : 
                            '<div style="color: var(--success); font-size: 0.8rem;">Tasks: 42/42</div>'
                        }
                        ${session.completedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Completed: ${new Date(session.completedAt).toLocaleString()}</div>` : 
                            session.startedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Started: ${new Date(session.startedAt).toLocaleString()}</div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }

        function getCurrentLabProgress() {
            const totalTasks = 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            return { completedTasks, totalTasks };
        }

        function handleSubtaskChange(taskId, step, isCompleted) {
            // Initialize subtasks if not exists
            if (!appState.progress[taskId].subtasks) {
                appState.progress[taskId].subtasks = {};
            }
            
            // Update subtask status
            appState.progress[taskId].subtasks[step] = {
                completed: isCompleted,
                completedAt: isCompleted ? new Date().toISOString() : null
            };
            
            // Update UI
            const checkbox = document.querySelector(`[data-step="${step}"]`);
            const subtaskItem = checkbox.closest('.subtask-item');
            
            if (isCompleted) {
                subtaskItem.classList.add('completed');
            } else {
                subtaskItem.classList.remove('completed');
            }
            
            // Check if all subtasks are completed
            const allSubtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
            const completedSubtasks = Array.from(allSubtaskCheckboxes).filter(cb => cb.checked);
            
            if (completedSubtasks.length === allSubtaskCheckboxes.length && allSubtaskCheckboxes.length > 0) {
                // Auto-complete the main task
                appState.progress[taskId].completed = true;
                appState.progress[taskId].completedAt = new Date().toISOString();
                
                notificationSystem.success(`ðŸŽ‰ Task completed: ${window.TASK_DEFINITIONS[taskId].title}`);
                
                // Update main task checkbox in the week view
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = true;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.add('completed');
                    }
                }
                
                updateProgressDisplay();
            } else if (appState.progress[taskId].completed && completedSubtasks.length < allSubtaskCheckboxes.length) {
                // Uncheck main task if not all subtasks are complete
                appState.progress[taskId].completed = false;
                
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = false;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.remove('completed');
                    }
                }
                
                updateProgressDisplay();
            }
            
            // Save progress to KV backend
            saveUserProgress(taskId, appState.progress[taskId]);
        }

        // UI state management
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('headerButtons').classList.remove('hidden');
            document.getElementById('userMenu').classList.add('hidden');
            closeMobileMenu();
        }

        function showDashboard() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('headerButtons').classList.add('hidden'); // Hide Sign In/Get Started buttons
            document.getElementById('userMenu').classList.remove('hidden'); // Show user menu
            
            // Update user info
            const userNameEl = document.getElementById('userName');
            if (userNameEl && appState.user) {
                userNameEl.textContent = appState.user.name;
            }
            
            // Show admin button if user is admin
            if (appState.user && appState.user.role === 'admin') {
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.style.display = 'block';
            }
            
            generateWeekCards();
            updateProgressDisplay();
            closeMobileMenu();
        }

        function generateWeekCards() {
            const container = document.getElementById('weeksContainer');
            if (!container) return;

            const weekGroups = groupTasksByWeek();
            
            container.innerHTML = Object.keys(weekGroups).map(weekNum => {
                const week = weekGroups[weekNum];
                const completedTasks = week.tasks.filter(task => 
                    appState.progress[task.id] && appState.progress[task.id].completed
                ).length;
                const progressPercentage = Math.round((completedTasks / week.tasks.length) * 100);
                
                return `
                    <div class="week-card" onclick="toggleWeekExpansion(${weekNum})">
                        <div class="week-header">
                            <div>
                                <div class="week-title">${week.title}</div>
                                <div class="week-tasks">${completedTasks}/${week.tasks.length} tasks</div>
                            </div>
                            <div class="expand-icon">â–¼</div>
                        </div>
                        <div class="week-progress">
                            <div class="week-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="week-description">${week.description}</div>
                        
                        <div class="task-list">
                            ${week.tasks.map(task => {
                                const isCompleted = appState.progress[task.id] && appState.progress[task.id].completed;
                                return `
                                    <div class="task-item ${isCompleted ? 'completed' : ''}" onclick="event.stopPropagation()">
                                        <input type="checkbox" class="task-checkbox" 
                                               ${isCompleted ? 'checked' : ''} 
                                               onchange="toggleTaskCompletion('${task.id}')">
                                        <div class="task-content" onclick="showTaskDetail('${task.id}')">
                                            <div class="task-title">${task.title}</div>
                                            <div class="task-description">Click to view step-by-step instructions</div>
                                        </div>
                                        <button class="task-detail-btn" onclick="showTaskDetail('${task.id}')">
                                            View Details
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function groupTasksByWeek() {
            const weeks = {};
            
            appState.tasks.forEach(task => {
                const weekNum = task.week || 1;
                if (!weeks[weekNum]) {
                    weeks[weekNum] = {
                        title: `Week ${weekNum}: ${task.category || 'Training'}`,
                        description: `Complete ${appState.tasks.filter(t => t.week === weekNum).length} tasks in this week`,
                        tasks: []
                    };
                }
                weeks[weekNum].tasks.push(task);
            });
            
            return weeks;
        }

        function updateProgressDisplay() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);
            
            // Update progress ring
            const circumference = 2 * Math.PI * 54; // r = 54
            const offset = circumference - (percentage / 100) * circumference;
            const progressRing = document.getElementById('progressRing');
            if (progressRing) {
                progressRing.style.strokeDasharray = `${circumference - offset} ${circumference}`;
            }
            
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
            
            // Update week cards if they exist
            const mainContent = document.getElementById('mainContent');
            if (mainContent && !mainContent.classList.contains('hidden')) {
                generateWeekCards();
            }
            
            // Check for lab completion after updating display
            if (appState.authenticated) {
                checkLabCompletion();
            }
        }

        // Admin functions
        function showAdminPanelFallback() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ‘‘</div>
                    <h3>Admin Panel</h3>
                    <p>Backend API is being set up...</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">Admin features will be available once the backend is deployed.</p>
                </div>
            `;
            showModal('adminModal');
        }

        function displayAdminPanel(users) {
            const content = document.getElementById('adminContent');
            
            if (users.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No users found.</p>';
            } else {
                // Sort by completed tasks and progress percentage
                users.sort((a, b) => {
                    if (a.completedTasks !== b.completedTasks) {
                        return b.completedTasks - a.completedTasks; // More completed tasks first
                    }
                    return b.progressPercentage - a.progressPercentage; // Higher percentage first
                });
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Leaderboard - ${users.length} Users</strong>
                        <small style="color: var(--text-secondary);">ðŸ“Š Sorted by Progress</small>
                    </div>
                    ${users.map((user, index) => {
                        const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `#${index + 1}`;
                        return `
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${medal} ${user.name}</span>
                                    <span style="color: var(--success); font-weight: 600;">${user.progressPercentage}%</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    ${user.email} â€¢ ${user.role}
                                </div>
                                <div style="background: var(--surface); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div style="height: 100%; background: var(--success); width: ${user.progressPercentage}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--primary);">${user.completedTasks}/42</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Tasks Done</div>
                                    </div>
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--success);">${user.completedLabs || 0}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Labs Completed</div>
                                    </div>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem; display: flex; justify-content: space-between;">
                                    <span>${user.hasNotes ? 'ðŸ“ Has notes' : 'No notes'}</span>
                                    <span>Last: ${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never'}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }
            
            showModal('adminModal');
        }

        // Modal management functions - Ensure global scope
        window.showModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
            closeMobileMenu();
        };

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        };

        window.showSignInModal = function() {
            // Reset modal state for progressive disclosure
            const passwordGroup = document.getElementById('passwordGroup');
            const rememberGroup = document.getElementById('rememberGroup');
            const emailInput = document.getElementById('signInEmail');
            const passwordInput = document.getElementById('signInPassword');
            const submitBtn = document.querySelector('#signInForm .password-toggle');
            const modalBody = document.querySelector('#signInModal .modal-body');
            
            if (passwordGroup) passwordGroup.classList.add('hidden');
            if (rememberGroup) rememberGroup.classList.add('hidden');
            if (emailInput) {
                emailInput.value = '';
                emailInput.classList.remove('loading');
            }
            if (passwordInput) passwordInput.value = '';
            if (submitBtn) submitBtn.classList.remove('loading');
            if (modalBody) modalBody.classList.add('initial-state');
            
            showModal('signInModal');
        };

        window.showRegisterModal = function() {
            // Reset register modal state
            const registerForm = document.getElementById('registerForm');
            const submitBtn = document.querySelector('#registerForm .password-toggle');
            
            if (registerForm) registerForm.reset();
            if (submitBtn) submitBtn.classList.remove('loading');
            
            showModal('registerModal');
        };

        window.toggleUserMenu = function() {
            const dropdown = document.getElementById('userMenuDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking session...');
            loadTaskDefinitions();
            checkExistingSession();
            setupMobileMenuHandlers();
            setupFormHandlers();
        });

        // Close modals and menus when clicking outside
        document.addEventListener('click', function(event) {
            // Close modals when clicking outside
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
            
            // Close user menu when clicking outside
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userMenuDropdown');
            if (userMenu && dropdown && !userMenu.contains(event.target) && dropdown.classList.contains('active')) {
                dropdown.classList.remove('active');
            }
        });

        // Error logging for debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error, e.filename, e.lineno);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>