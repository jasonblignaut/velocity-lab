<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocity Lab - Exchange Hybrid Training</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    
    <style>
        /* Apple-inspired Color Scheme with Light/Dark Themes */
        :root {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #f8f9fa;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-hover: #e9ecef;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: #d2d2d7;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --jedi-glow: #00ff88;
            --sith-glow: #ff0066;
            --bg-secondary: #f0f0f5;
        }

        [data-theme="dark"] {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #1e1e1e;
            --background: #000000;
            --surface: #1e1e1e;
            --surface-hover: #2e2e2e;
            --text: #ffffff;
            --text-secondary: #a1a1a6;
            --border: #2e2e2e;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --shadow: rgba(255, 255, 255, 0.1);
            --shadow-heavy: rgba(255, 255, 255, 0.2);
            --bg-secondary: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* Background Image */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.08;
            z-index: -1;
        }

        [data-theme="dark"] body::before {
            opacity: 0.05;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.95);
        }

        /* Logo */
        .logo {
            width: 80px;
            height: 80px;
            background: url('/assets/Velocity.jpg') center/contain no-repeat;
            cursor: pointer;
        }

        [data-theme="dark"] .logo {
            filter: invert(1) brightness(1.2);
        }

        /* Desktop Navigation */
        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Mobile Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            width: 40px;
            height: 40px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .hamburger:hover {
            background: var(--surface-hover);
        }

        .hamburger span {
            width: 24px;
            height: 2px;
            background: var(--text);
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
            padding: 1rem;
        }

        [data-theme="dark"] .mobile-menu {
            background: rgba(0, 0, 0, 0.98);
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
        }

        .mobile-menu-item:hover, .mobile-menu-item.primary {
            background: var(--primary);
            color: white;
        }

        .mobile-menu-item.secondary {
            border: 1px solid var(--border);
        }

        /* Theme Menu */
        .theme-menu-item {
            position: relative;
        }

        .theme-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            color: var(--text);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .theme-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .theme-submenu {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 150px;
            z-index: 1001;
            display: none;
            position: static; /* For mobile */
        }

        .theme-menu-item:hover .theme-submenu {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .theme-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .theme-option:hover {
            background: var(--surface-hover);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
        }

        .theme-option.jedi:hover {
            background: linear-gradient(45deg, var(--jedi-glow), #00ff88);
            color: white;
        }

        .theme-option.sith:hover {
            background: linear-gradient(45deg, var(--sith-glow), #ff0066);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
        }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative;
        }

        .welcome-notification {
            position: absolute;
            top: 100px;
            left: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            max-width: 300px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--text), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            padding: 0.2rem 0;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        .welcome-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* Apple-style Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1c1a;
            border-radius: 20px;
            padding: 0;
            width: 100%;
            max-width: 400px;
            height: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
            position: relative;
            animation: modalSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .modal-content.large {
            max-width: 800px;
            background: var(--background);
            height: auto;
            min-height: unset;
            max-height: 90vh;
            overflow-y: auto;
        }

        .apple-modal {
            background: #1a1c1e;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.8) translateY(60px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-header-clean {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: #1a1c1e;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-logo {
            width: 120px;
            height: 35px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            filter: invert(1) brightness(1.2);
        }

        .modal-body {
            padding: 130px 35px 35px;
            text-align: center;
            height: calc(100% - 120px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .apple-modal .modal-body {
            color: white;
        }

        .modal-title {
            font-size: clamp(22px, 5vw, 28px);
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
            line-height: 1.2;
        }

        .modal-subtitle {
            color: #a1a1a6;
            margin-bottom: 32px;
            font-size: clamp(15px, 4vw, 17px);
            line-height: 1.3;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            z-index: 20;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .apple-form-group {
            margin-bottom: 16px;
            text-align: left;
            position: relative;
        }

        .apple-form-group.hidden {
            display: none;
        }

        .apple-form-input {
            width: 100%;
            padding: 16px;
            border: 1px solid #3a3a3c;
            border-radius: 12px;
            font-size: 17px;
            background: #2c2c2e;
            color: white;
            transition: all 0.3s ease;
        }

        .password-field .apple-form-input {
            padding-right: 56px;
        }

        .apple-form-input:focus {
            outline: none;
            border-color: #0a84ff;
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.1);
        }

        .apple-form-input::placeholder {
            color: #6d6d70;
        }

        .apple-form-input.loading {
            background: #2c2c2e url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAyMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgc3Ryb2tlPSIjNmQ2ZDcwIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWRhc2hhcnJheT0iNCAyIiBvcGFjaXR5PSIwLjUiPgo8YW5pbWF0ZVRyYW5zZm9ybSBhdHRyaWJ1dGVOYW1lPSJ0cmFuc2Zvcm0iIGF0dHJpYnV0ZVR5cGU9IlhNTCIgdHlwZT0icm90YXRlIiB2YWx1ZXM9IjAgMTAgMTA7MzYwIDEwIDEwIiBkdXI9IjFzIiByZXBlYXRDb3VudD0iaW5kZWZpbml0ZSIvPgo8L2NpcmNsZT4KPC9zdmc+Cg==') no-repeat right 16px center;
            pointer-events: none;
        }

        .password-field {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: #6d6d70;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .password-toggle:hover {
            background: #8e8e93;
            transform: translateY(-50%) scale(1.05);
        }

        .password-toggle:active {
            background: #34c759;
            transform: translateY(-50%) scale(0.95);
        }

        .password-toggle.loading {
            background: #6d6d70;
            color: transparent;
            pointer-events: none;
            font-size: 0;
        }

        .password-toggle.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .apple-checkbox-container {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }

        .apple-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: #0a84ff;
        }

        .apple-checkbox-label {
            color: #a1a1a6;
            font-size: 15px;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .task-detail-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .subtask-container {
            margin: 1rem 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .subtask-item:hover {
            background: var(--surface-hover);
        }

        .subtask-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }

        .subtask-item label {
            cursor: pointer;
            line-height: 1.4;
        }

        .subtask-item.completed {
            opacity: 0.7;
        }

        .subtask-item.completed label {
            text-decoration: line-through;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-submit {
            width: 100%;
            margin-top: 1rem;
        }

        .main-content {
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .progress-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .weeks-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .week-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .week-card.expanded {
            cursor: default;
        }

        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .week-tasks {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .week-progress {
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .week-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .week-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .week-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .task-list {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .week-card.expanded .task-list {
            display: block;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            background: var(--surface-hover);
        }

        .task-checkbox {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-detail-btn {
            margin-left: 1rem;
            padding: 4px 8px;
            font-size: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .task-item:hover .task-detail-btn {
            opacity: 1;
        }

        .user-menu {
            position: relative;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: background-color 0.2s ease;
        }

        .user-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-menu-dropdown.active {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .user-menu-item:hover {
            background: var(--surface-hover);
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                justify-content: center;
                position: relative;
            }

            .logo {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 60px;
            }

            .header-buttons {
                display: none;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 1rem;
            }

            .user-menu {
                display: none;
            }

            .welcome-screen {
                padding: 1rem;
            }

            .welcome-notification {
                position: static;
                margin-bottom: 2rem;
                max-width: none;
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }

            .btn-large {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
                margin-top: 70px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .progress-ring {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 1.5rem;
            }

            .weeks-container {
                gap: 1rem;
            }

            .week-card {
                padding: 1rem;
            }

            .week-title {
                font-size: 1.1rem;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                max-width: 90vw;
                height: 420px;
            }

            .modal-body {
                padding: 110px 20px 30px;
                height: calc(100% - 100px);
            }

            .modal-logo {
                width: 100px;
                height: 29px;
            }

            .modal-header-clean {
                height: 100px;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px 16px;
            }

            .theme-submenu {
                position: static;
                margin-left: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
                padding: 0 0.75rem;
            }

            .main-content {
                margin-top: 60px;
                padding: 0.75rem;
            }

            .mobile-menu {
                top: 60px;
            }

            .logo {
                width: 50px;
                height: 50px;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                border-radius: 16px;
                max-width: 95vw;
                height: 400px;
            }

            .modal-body {
                padding: 90px 18px 25px;
                height: calc(100% - 90px);
            }

            .modal-header-clean {
                height: 90px;
            }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .notification {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--primary);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Header -->
    <header class="header" id="header">
        <div class="logo" onclick="goHome()"></div>
        <div class="header-buttons" id="headerButtons">
            <button class="btn btn-secondary" onclick="showSignInModal()">Sign In</button>
            <button class="btn btn-primary" onclick="showRegisterModal()">Get Started</button>
        </div>
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="user-menu hidden" id="userMenu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()">
                <span id="userName">User</span>
                <span>▼</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <button class="user-menu-item" onclick="startLabEnvironment()">🚀 Start New Lab</button>
                <button class="user-menu-item" onclick="showLabHistoryModal()">📊 Lab History</button>
                <button class="user-menu-item" onclick="showAdminPanel()" id="adminButton" style="display: none;">👑 Admin Panel</button>
                <div class="theme-menu-item">
                    <button class="theme-menu-toggle">
                        <span>🎨 Theme</span>
                        <span>▶</span>
                    </button>
                    <div class="theme-submenu">
                        <button class="theme-option jedi" onclick="setTheme('light')">🌟 Light Jedi</button>
                        <button class="theme-option sith active" onclick="setTheme('dark')">⚡ Dark Sith</button>
                    </div>
                </div>
                <button class="user-menu-item" onclick="logout()">🚪 Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-items" id="mobileMenuItems"></div>
    </div>

    <!-- Main Content -->
    <main>
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="welcome-notification">
                👋 Welcome to Velocity Lab! Sign in to access your Exchange Hybrid training journey.
            </div>
            <h1 class="welcome-title">Master Exchange Hybrid</h1>
            <p class="welcome-subtitle">
                Embark on a comprehensive 4-week journey with 42 hands-on tasks to build
                a complete Exchange Hybrid lab environment, from Domain Controllers to
                Microsoft 365 integration.
            </p>
            <div class="welcome-buttons">
                <button class="btn btn-primary btn-large" onclick="showSignInModal()">👤 Sign In</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="main-content hidden" id="mainContent">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Your Exchange Hybrid Journey</h1>
                <p class="dashboard-subtitle">Track your progress through 42 hands-on tasks across 4 comprehensive weeks</p>
            </div>
            <div class="progress-section">
                <div class="progress-ring">
                    <svg viewBox="0 0 120 120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="54"/>
                        <circle class="progress-ring-fill" cx="60" cy="60" r="54" stroke-dasharray="0 339.292" id="progressRing"/>
                    </svg>
                    <div class="progress-text">
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                        <div class="progress-label">Complete</div>
                    </div>
                </div>
            </div>
            <div class="weeks-container" id="weeksContainer"></div>
        </div>
    </main>

    <!-- Modals -->
    <div class="modal" id="signInModal">
        <div class="modal-content apple-modal">
            <button class="modal-close" onclick="closeModal('signInModal')">×</button>
            <div class="modal-header-clean">
                <div class="modal-logo"></div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title">Sign in with Velocity Lab</h2>
                <p class="modal-subtitle">Welcome back to your training journey</p>
                <form id="signInForm">
                    <div class="apple-form-group">
                        <input type="email" class="apple-form-input" id="signInEmail" name="email" placeholder="Email" required>
                    </div>
                    <div class="apple-form-group hidden" id="passwordGroup">
                        <div class="password-field">
                            <input type="password" class="apple-form-input" id="signInPassword" name="password" placeholder="Password" required>
                            <button type="submit" class="password-toggle" title="Sign In">→</button>
                        </div>
                    </div>
                    <div class="apple-checkbox-container hidden" id="rememberGroup">
                        <input type="checkbox" class="apple-checkbox" name="remember" id="rememberMe">
                        <label class="apple-checkbox-label" for="rememberMe">Remember me for 30 days</label>
                    </div>
                    <div id="signInMessage" class="message hidden"></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content apple-modal">
            <button class="modal-close" onclick="closeModal('registerModal')">×</button>
            <div class="modal-header-clean">
                <div class="modal-logo"></div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title">Create Velocity Lab Account</h2>
                <p class="modal-subtitle">Start your Exchange Hybrid journey today</p>
                <form id="registerForm">
                    <div class="apple-form-group">
                        <input type="text" class="apple-form-input" id="registerName" name="name" placeholder="Full Name" required>
                    </div>
                    <div class="apple-form-group">
                        <input type="email" class="apple-form-input" id="registerEmail" name="email" placeholder="Email" required>
                    </div>
                    <div class="apple-form-group">
                        <div class="password-field">
                            <input type="password" class="apple-form-input" id="registerPassword" name="password" placeholder="Password" required>
                            <button type="submit" class="password-toggle" title="Create Account">→</button>
                        </div>
                    </div>
                    <div id="registerMessage" class="message hidden"></div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="taskDetailModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('taskDetailModal')">×</button>
            <div class="modal-header">
                <h2 id="taskDetailTitle">Task Details</h2>
            </div>
            <div class="task-detail-content" id="taskDetailContent"></div>
        </div>
    </div>

    <div class="modal" id="labHistoryModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('labHistoryModal')">×</button>
            <div class="modal-header">
                <h2>📊 Lab History</h2>
                <p style="color: var(--text-secondary);">Your training progress timeline</p>
            </div>
            <div id="labHistoryModalContent"></div>
        </div>
    </div>

    <div class="modal" id="adminModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('adminModal')">×</button>
            <div class="modal-header">
                <h2>👑 Admin Panel</h2>
                <p style="color: var(--text-secondary);">User progress leaderboard</p>
            </div>
            <div id="adminContent"></div>
        </div>
    </div>

    <!-- Load Task Definitions -->
    <script src="/assets/task-definitions.js"></script>

    <script>
        // Global application state
        const appState = {
            user: null,
            sessionToken: null,
            progress: {},
            authenticated: false,
            labHistory: [],
            tasks: [],
            isWelcomeShown: false,
            shownNotifications: new Set()
        };

        // API configuration
        const API_BASE = '/api';

        // Utility functions
        const utils = {
            cookies: {
                set(name, value, days = 30) {
                    const expires = new Date();
                    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
                    document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/; SameSite=Strict`;
                },
                get(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for (let c of ca) {
                        c = c.trim();
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
                    }
                    return null;
                },
                delete(name) {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict`;
                }
            },
            getId(id) {
                return document.getElementById(id);
            }
        };

        // API call function
        const api = {
            async call(url, options = {}) {
                try {
                    console.log('🌐 API Call:', options.method || 'GET', url);
                    if (options.body instanceof FormData) {
                        console.log('📋 FormData Contents:');
                        for (let [key, value] of options.body.entries()) {
                            console.log(`  ${key}: ${key === 'password' ? '[*hidden*]' : value}`);
                        }
                    }
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        body: options.body,
                        headers: {
                            'Content-Type': options.body instanceof FormData ? undefined : 'application/json',
                            ...options.headers
                        }
                    });
                    console.log(`📡 Response: ${response.status} ${response.statusText}`);
                    const responseText = await response.text();
                    console.log('📡 Raw response body:', responseText);
                    if (!response.headers.get('Content-Type')?.includes('application/json')) {
                        console.warn(`⚠️ Expected JSON but got '${response.headers.get('Content-Type')}' for ${url}`);
                        throw new Error('BACKEND_NOT_AVAILABLE');
                    }
                    const result = JSON.parse(responseText);
                    console.log('📡 Parsed JSON:', result);
                    if (!result.success) {
                        throw new Error(result.message || 'API call failed');
                    }
                    return result;
                } catch (error) {
                    console.error(`❌ API Error for ${url}:`, error.message);
                    throw error;
                }
            }
        };

        // Notification system
        const notificationSystem = {
            notifications: [],
            show(message, type) {
                const id = `${type}:${message}`;
                if (appState.shownNotifications.has(id) || (message.includes('Welcome') && appState.isWelcomeShown)) {
                    console.log('🔔 Skipped duplicate:', message);
                    return;
                }
                if (message.includes('Welcome')) appState.isWelcomeShown = true;
                appState.shownNotifications.add(id);
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.top = `${90 + (this.notifications.length * 80)}px`;
                document.body.appendChild(notification);
                this.notifications.push(notification);
                setTimeout(() => {
                    notification.remove();
                    const index = this.notifications.indexOf(notification);
                    if (index !== -1) {
                        this.notifications.splice(index, 1);
                        this.notifications.forEach((n, i) => {
                            n.style.top = `${90 + (i * 80)}px`;
                        });
                    }
                    appState.shownNotifications.delete(id);
                }, 5000);
            },
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            info(message) { this.show(message, 'info'); },
            clearSession() {
                appState.shownNotifications.clear();
                appState.isWelcomeShown = false;
            }
        };

        // Authentication system
        const authSystem = {
            async login(formData) {
                const submitBtn = utils.getId('signInForm')?.querySelector('.password-toggle');
                try {
                    if (submitBtn) submitBtn.classList.add('loading');
                    const email = formData.get('email');
                    if (!email || !formData.get('password')) throw new Error('Please fill in all fields');
                    console.log('🔐 Logging in...');
                    const { data } = await api.call(`${API_BASE}/users/login`, {
                        method: 'POST',
                        body: formData
                    });
                    console.log('✅ Login Success');
                    appState.user = { name: data.name, email: data.email, role: data.role };
                    appState.sessionToken = data.sessionToken;
                    appState.authenticated = true;
                    utils.cookies.set('user', JSON.stringify(appState.user));
                    utils.cookies.set('session', data.sessionToken);
                    if (data.role === 'admin') utils.getId('adminButton').style.display = 'block';
                    showDashboard();
                    await loadUserData();
                    closeModal('signInModal');
                    notificationSystem.success(`Welcome back, ${data.name}! 🎉`);
                } catch (error) {
                    if (error.message === 'BACKEND_NOT_AVAILABLE') {
                        console.warn('⚠️ Backend unavailable, using demo mode');
                        const email = formData.get('email');
                        const name = email.split('@')[0] || 'Demo User';
                        const role = email.includes('admin') ? 'admin' : 'user';
                        const sessionToken = `demo_${Math.random().toString(36).substr(2, 8)}`;
                        appState.user = { name, email, role };
                        appState.sessionToken = sessionToken;
                        appState.authenticated = true;
                        utils.cookies.set('user', JSON.stringify(appState.user));
                        utils.cookies.set('session', sessionToken);
                        if (role === 'admin') utils.getId('adminButton').style.display = 'block';
                        showDashboard();
                        await loadUserData();
                        closeModal('signInModal');
                        notificationSystem.success(`Welcome, ${name}! (Demo Mode) 🎉`);
                    } else {
                        throw error;
                    }
                } finally {
                    if (submitBtn) submitBtn.classList.remove('loading');
                }
            },
            async register(formData) {
                const submitBtn = utils.getId('registerForm')?.querySelector('.password-toggle');
                try {
                    if (submitBtn) submitBtn.classList.add('loading');
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const password = formData.get('password');
                    if (!name || !email || !password) throw new Error('Please fill all fields');
                    if (password.length < 8) throw new Error('Password must be at least 8 characters');
                    console.log('📝 Registering...');
                    const { data } = await api.call(`${API_BASE}/users/register`, {
                        method: 'POST',
                        body: formData
                    });
                    console.log('✅ Registration Success');
                    appState.user = { name: data.name, email: data.email, role: data.role };
                    appState.sessionToken = data.sessionToken;
                    appState.authenticated = true;
                    utils.cookies.set('user', JSON.stringify(appState.user));
                    utils.cookies.set('session', data.sessionToken);
                    showDashboard();
                    await loadUserData();
                    closeModal('registerModal');
                    notificationSystem.success(`Welcome, ${data.name}! 🚀`);
                } catch (error) {
                    if (error.message === 'BACKEND_NOT_AVAILABLE') {
                        console.warn('⚠️ Demo mode registration');
                        const name = formData.get('name');
                        const email = formData.get('email');
                        const role = 'user';
                        const sessionToken = `demo_${Math.random().toString(36).substr(2, 8)}`;
                        appState.user = { name, email, role };
                        appState.sessionToken = sessionToken;
                        appState.authenticated = true;
                        utils.cookies.set('user', JSON.stringify(appState.user));
                        utils.cookies.set('session', sessionToken);
                        showDashboard();
                        await loadUserData();
                        closeModal('registerModal');
                        notificationSystem.success(`Welcome, ${name}! (Demo Mode) 🚀`);
                    } else {
                        throw error;
                    }
                } finally {
                    if (submitBtn) submitBtn.classList.remove('loading');
                }
            },
            async logout() {
                try {
                    if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                        await api.call(`${API_BASE}/users/logout`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${appState.sessionToken}` }
                        });
                    }
                } catch (e) {
                    console.warn('Logout API failed:', e);
                }
                utils.cookies.delete('user');
                utils.cookies.delete('session');
                localStorage.removeItem('progress');
                localStorage.removeItem('labHistory');
                appState.user = null;
                appState.sessionToken = null;
                appState.progress = {};
                appState.authenticated = false;
                appState.labHistory = [];
                notificationSystem.clearSession();
                utils.getId('adminButton').style.display = 'none';
                showWelcomeScreen();
                notificationSystem.info('Logged out successfully');
            }
        };

        // Theme management
        const themeSystem = {
            async setTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                utils.cookies.set('theme', theme);
                try {
                    if (appState.sessionToken && !appState.sessionToken?.startsWith('demo_')) {
                        await api.call(`${API_BASE}/user/preferences`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ theme })
                        });
                    }
                } catch (error) {
                    console.warn('⚠️ Theme sync failed:', error);
                }
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.toggle('active', opt.classList.contains(theme === 'light' ? 'jedi' : 'sith'));
                });
                notificationSystem.success(theme === 'light' ? '🌟 Light Jedi Theme!' : '⚡ Dark Sith Theme!');
            },
            async loadTheme() {
                let theme = utils.cookies.get('theme') || 'dark';
                try {
                    if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                        const { data } = await api.call(`${API_BASE}/user/preferences`, {
                            headers: { 'Authorization': `Bearer ${appState.sessionToken}` }
                        });
                        theme = data.theme || theme;
                    }
                } catch (e) {
                    console.warn('Theme load failed:', e);
                }
                await this.setTheme(theme);
            }
        };

        // Task management
        function loadTaskDefinitions() {
            if (window.TASKS_DEFINITIONS) {
                appState.tasks = Object.entries(window.TASKS).map(([id, task]) => ({
                    id,
                    title: task.title || 'Unknown Task',
                    description: task.description || 'No description available.',
                    week: parseInt(id.split('-')[0].replace('week', '')) || 1,
                    category: task.category || 'General'
                }));
                console.log(`✅ Loaded ${appState.tasks.length} tasks`);
            } else {
                console.warn('⚠️ Task definitions missing, using fallback');
                appState.tasks = generateFallbackTasks();
            }
        }

        function generateFallbackTasks() {
            return Array.from({ length: 4 }, (_, wIdx) => {
                const week = wIdx + 1;
                const titles = [
                    ['Install Windows Server', 'Configure AD DS', 'Setup DNS'],
                    ['Install Exchange Server', 'Configure Mailboxes', 'Setup DAG'],
                    ['Create M365 Tenant', 'Configure Domain', 'Setup Security'],
                    ['Install Azure AD Connect', 'Configure Hybrid Sync', 'Test Mail Flow']
                ][wIdx];
                return titles.map((title, tIdx) => ({
                    id: `week${week}-task${tIdx + 1}`,
                    week,
                    title,
                    description: `Complete ${title} for Week ${week}`,
                    category: ['Foundation', 'Exchange', 'M365', 'Hybrid'][wIdx]
                }));
            }).flat();
        }

        // Progress management
        async function loadUserProgress() {
            try {
                if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                    console.log('🔄 Loading user progress...');
                    const { data } = await api.call(`${API_BASE}/user/progress`, {
                        headers: {'Authorization': `Bearer ${appState.sessionToken}` }
                    });
                    appState.progress = data || {};
                    console.log('✅ Progress loaded');
                } else {
                    throw new Error('No valid session');
                }
            } catch (error) {
                console.warn('📁 Progress fallback:', error);
                appState.progress = JSON.parse(localStorage.getItem('progress') || '{}');
            }
            updateProgressDisplay();
            checkLabCompletion();
        }

        async function saveUserProgress(taskId, progress) {
            appState.progress[taskId] = progress;
            try {
                if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                    console.log(`💾 Saving progress for ${taskId}...`);
                    await api.call(`${API_BASE}/user/progress`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ taskId, progress })
                    });
                    console.log('✅ Progress saved');
                } else {
                    throw new Error('No valid session');
                }
            } catch (error) {
                console.warn('📁 Saving progress locally:', error);
                localStorage.setItem('progress', JSON.stringify(appState.progress));
            }
            updateProgressDisplay();
        }

        // Lab history management
        async function loadLabHistory() {
            try {
                if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                    console.log('🔄 Loading lab history...');
                    const { data } = await api.call(`${API_BASE}/user/lab-history`, {
                        headers: {'Authorization': `Bearer ${appState.sessionToken}` }
                    });
                    appState.labHistory = data || [];
                    console.log(`✅ Loaded ${appState.labHistory.length} lab sessions`);
                } else {
                    throw new Error('No valid session');
                }
            } catch (error) {
                console.warn('📁 Lab history fallback:', error);
                appState.labHistory = JSON.parse(localStorage.getItem('labHistory') || '[]');
                if (!appState.labHistory.length) {
                    appState.labHistory = [{
                        session: 1,
                        date: new Date().toISOString().split('T')[0],
                        status: 'started',
                        labId: 'LAB001',
                        startedAt: new Date().toISOString(),
                        tasksCompleted: 0,
                        totalTasks: appState.tasks.length || 42
                    }];
                    localStorage.setItem('labHistory', JSON.stringify(appState.labHistory));
                }
            }
        }

        async function saveLabProgress(session) {
            try {
                if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                    console.log('💾 Saving lab progress...');
                    await api.call(`${API_BASE}/user/lab-progress`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(session)
                    });
                    console.log('✅ Lab progress saved');
                    await loadLabHistory();
                } else {
                    throw new Error('No valid session');
                }
            } catch (error) {
                console.warn('📁 Saving lab progress locally:', error);
                appState.labHistory = appState.labHistory.filter(s => s.session !== session.session);
                appState.labHistory.push(session);
                localStorage.setItem('labHistory', JSON.stringify(appState.labHistory));
            }
        }

        function checkLabCompletion() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(t => t.completed).length;
            if (completedTasks === totalTasks && appState.labHistory.length) {
                const currentLab = appState.labHistory.find(l => l.status === 'started');
                if (currentLab) {
                    currentLab.status = 'completed';
                    currentLab.completedAt = new Date().toISOString();
                    currentLab.tasksCompleted = completedTasks;
                    currentLab.totalTasks = totalTasks;
                    saveLabProgress(currentLab);
                    notificationSystem.success('🎉 Lab completed!');
                }
            }
        }

        async function loadUserData() {
            await Promise.all([loadUserProgress(), loadLabHistory()]);
            renderWeekCards();
        }

        function checkSession() {
            const user = utils.cookies.get('user');
            const session = utils.cookies.get('session');
            if (user && session) {
                try {
                    appState.user = JSON.parse(user);
                    appState.sessionToken = session;
                    appState.authenticated = true;
                    appState.isWelcomeShown = true;
                    if (appState.user.role === 'admin') utils.getId('adminButton').style.display = 'block';
                    showDashboard();
                    loadUserData();
                    themeSystem.loadTheme();
                } catch (e) {
                    console.error('Invalid session:', e);
                    authSystem.logout();
                }
            } else {
                showWelcomeScreen();
                themeSystem.loadTheme();
            }
        }

        function setupFormHandlers() {
            const signInForm = utils.getId('signInForm');
            if (signInForm) {
                const emailInput = utils.getId('signInEmail');
                const passwordGroup = utils.getId('passwordGroup');
                const rememberGroup = utils.getId('rememberGroup');
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && emailInput.value) {
                        e.preventDefault();
                        showPasswordField();
                    }
                });
                emailInput.addEventListener('blur', () => {
                    if (emailInput.value && emailInput.value.includes('@')) {
                        setTimeout(showPasswordField, 100);
                    }
                });
                function showPasswordField() {
                    if (passwordGroup.classList.contains('hidden')) {
                        emailInput.classList.add('loading');
                        setTimeout(() => {
                            emailInput.classList.remove('loading');
                            passwordGroup.classList.remove('hidden');
                            rememberGroup.classList.remove('hidden');
                            utils.getId('signInPassword').focus();
                        }, 500);
                    }
                }
                signInForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        await authSystem.login(new FormData(signInForm));
                    } catch (err) {
                        utils.getId('signInMessage').classList.remove('hidden');
                        utils.getId('signInMessage').classList.add('error');
                        utils.getId('signInMessage').textContent = err.message || 'Login failed';
                    }
                });
            }
            const registerForm = utils.getId('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        await authSystem.register(new FormData(registerForm));
                    } catch (err) {
                        utils.getId('registerMessage').classList.remove('hidden');
                        utils.getId('registerMessage').classList.add('error');
                        utils.getId('registerMessage').textContent = err.message || 'Registration failed';
                    }
                });
            }
        }

        window.setTheme = themeSystem.setTheme;
        window.logout = authSystem.logout;
        window.goHome = () => appState.authenticated ? showDashboard() : showWelcomeScreen();
        window.toggleMobileMenu = () => {
            const hamburger = utils.getId('hamburger');
            const mobileMenu = utils.getId('mobileMenu');
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            updateMobileMenu();
        };
        window.startLabEnvironment = async () => {
            try {
                let labId, previousLabCompleted = false;
                if (appState.sessionToken && !appState.sessionToken.startsWith('demo_')) {
                    console.log('🔄 Starting lab...');
                    const { data } = await api.call(`${API_BASE}/lab/start`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.sessionToken}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    labId = data.labId;
                    previousLabCompleted = data.previousLabCompleted;
                    appState.progress = {};
                    await loadLabHistory();
                } else {
                    console.log('📁 Starting demo lab...');
                    const totalTasks = appState.tasks.length || 42;
                    const completedTasks = Object.values(appState.progress).filter(t => t.completed).length;
                    const isCompleted = completedTasks === totalTasks;
                    const today = new Date().toISOString().split('T')[0];
                    if (appState.labHistory.find(l => l.date === today && l.status === 'started')) {
                        notificationSystem.info('Lab already started today');
                        return;
                    }
                    if (appState.labHistory.length && isCompleted) {
                        const currentLab = appState.labHistory[appState.labHistory.length - 1];
                        if (currentLab.status === 'started') {
                            currentLab.status = 'completed';
                            currentLab.completedAt = new Date().toISOString();
                            currentLab.tasksCompleted = completedTasks;
                            currentLab.totalTasks = totalTasks;
                            previousLabCompleted = true;
                            await saveLabProgress(currentLab);
                        }
                    }
                    const newSession = {
                        session: appState.labHistory.length + 1,
                        date: today,
                        status: 'started',
                        labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                        startedAt: new Date().toISOString(),
                        tasksCompleted: 0,
                        totalTasks
                    };
                    appState.progress = {};
                    await saveLabProgress(newSession);
                    labId = newSession.labId;
                }
                updateProgressDisplay();
                notificationSystem.success(previousLabCompleted ? `🎉 Previous lab completed! New ${labId} started!` : `🚀 New lab ${labId} started!`);
            } catch (error) {
                console.error('❌ Lab start error:', error);
                notificationSystem.error('Failed to start lab');
            }
        };
        window.showLabHistoryModal = async () => {
            try {
                await loadLabHistory();
                const content = utils.getId('labHistoryModalContent');
                if (!appState.labHistory.length) {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🚀</div>
                            <p>No lab sessions yet!</p>
                            <p style="margin-top: 0.5rem;">Click "Start New Lab" to begin.</p>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-secondary lab-filter-btn active" data-filter="all" onclick="filterLabHistory('all')">All</button>
                            <button class="btn btn-secondary lab-filter-btn" data-filter="week" onclick="filterLabHistory('week')">Week</button>
                            <button class="btn btn-secondary lab-filter-btn" data-filter="month" onclick="filterLabHistory('month')">Month</button>
                        </div>
                        <div id="labHistoryContent">
                            ${generateLabHistoryHTML(appState.labHistory)}
                        </div>
                    `;
                }
                showModal('labHistoryModal');
            } catch (error) {
                console.error('❌ Lab history load error:', error);
                utils.getId('labHistoryModalContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <p>Lab history unavailable.</p>
                        <p style="margin-top: 1rem;">
                            ${error.message === 'BACKEND_NOT_AVAILABLE' ? 
                                'Backend unavailable. Deploy: /api/user/lab-history.js' : 
                                'Try again later.'}
                        </p>
                    </div>
                `;
                showModal('labHistoryModal');
            }
        };
        window.showTaskDetail = (taskId) => {
            const task = window.TASKS_DEFINITIONS?.[taskId];
            if (!task) {
                notificationSystem.error('Task details not found');
                return;
            }
            utils.getId('taskDetailTitle').value = task.title;
            if (!appState.progress[taskId]) {
                appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
            }
            const progress = appState.progress[taskId];
            utils.getId('contentDetailContent').innerHTML = `
                <p>${task.description}</p>
                <div class="subtask-container">
                    ${task.subtasks?.map((step, i) => `
                        <div class="subtask-item ${progress.subtasks[i]?.completed ? 'completed' : ''}" data-step="${i}">
                            <input type="checkbox" class="subtask-checkbox" data-step="${i}" ${progress.subtasks[i]?.completed ? 'checked' : ''}>
                            <label>${step}</label>
                        </div>
                    `).join('') || '<p>No subtasks available.</p>'}
                </div>
                <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <h4>Notes</h4>
                    <textarea id="taskNotes_${taskId}" style="width: 100%; height: 100px; padding: 8px; border-radius: 8px;" onchange="saveTaskNotes('${taskId}')">${progress.notes || ''}</textarea>
                </div>
            `;
            setTimeout(() => {
                document.querySelectorAll('.subtask-checkbox').forEach(cb => {
                    const step = cb.dataset.step;
                    cb.addEventListener('change', () => handleSubtaskChange(taskId, step, cb.checked));
                });
            }, 100);
            showModal('taskDetailModal');
        };
        window.saveTaskNotes = (taskId) => {
            const notes = document.getElementById(`taskNotes_${taskId}`).value;
            appState.progress[taskId].notes = notes;
            appState.progress[taskId].lastUpdated = new Date().toISOString();
            saveUserProgress(taskId, appState.progress[taskId]);
            console.log(`📝 Saved notes for ${taskId}`);
        };
        window.toggleTaskCompletion = async (taskId) => {
            try {
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
                }
                const progress = appState.progress[taskId];
                progress.completed = !progress.completed;
                progress.completedAt = progress.completed ? new Date().toISOString() : null;
                progress.lastUpdated = new Date().toISOString();
                await saveUserProgress(taskId, progress);
                updateProgressDisplay();
                checkLabCompletion();
                const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskItem) {
                    taskItem.classList.toggle('completed', progress.completed);
                    const checkbox = taskItem.querySelector('.checkbox-task');
                    if (checkbox) checkbox.checked = progress.completed;
                }
                notificationSystem.success(progress.completed ? `✅ Task ${taskId} completed!` : `↩️ Task ${taskId} marked incomplete`);
            } catch (error) {
                console.error(`❌ Task completion error for ${taskId}:`, error);
                alertSystem.error('Failed to update task status');
            }
        };
        window.filterLabHistory = (period) => {
            let filtered = appState.labHistory;
            const now = new Date();
            if (period !== 'all') {
                const cutoff = new Date();
                if (period === 'week') cutoff.setDate(now.getDate() - 7);
                else if (period === 'month') cutoff.setDate(now.getDate() - 30);
                filtered = filtered.filter(l => new Date(l.date) >= cutoff);
            }
            document.querySelectorAll('lab-filter-btn').forEach(btn => {
                button.classList.toggle('active', btn.dataset.filter === period);
            });
            utils.getId('labHistoryContent').innerHTML = generateLabHistoryContentHTML(filtered);
        };
        window.showAdminPanel = async () => {
            try {
                if (!appState.user || appState.user.role !== 'admin') throw new Error('Admin access required');
                console.log('🔄 Loading admin panel...');
                const { data } = await api.call(`${API_BASE}/admin/users-progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                console.log('✅ Admin data loaded');
                displayAdminPanel(data);
            } catch (error) {
                console.error('❌ Admin panel error:', error);
                const message = error.message === 'BACKEND_NOT_AVAILABLE' ?
                    'Backend unavailable. Deploy: /api/admin/users-progress.js' :
                    'Admin panel unavailable';
                showAdminPanelFallback(message);
            }
        };
        window.toggleUserMenu = () => {
            const dropdown = utils.getId('userMenuDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        };

        function handleSubtaskChange(taskId, stepIndex, isChecked) {
            if (!appState.progress[taskId]) {
                appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
            }
            appState.progress[taskId].subtasks[stepIndex] = {
                completed: isChecked,
                updatedAt: new Date().toISOString()
            };
            const allSubtasks = window.TASKS_DEFINITIONS?.[taskId]?.subtasks || [];
            const completedSubtasks = Object.values(appState.progress[taskId].subtasks).filter(s => s.completed).length;
            appState.progress[taskId].completed = completedSubtasks === allSubtasks.length;
            appState.progress[taskId].lastUpdated = new Date().toISOString();
            saveUserProgress(taskId, appState.progress[taskId]);
            console.log(`✅ Subtask ${stepIndex} for ${taskId} updated`);
            const subtaskItem = document.querySelector(`.subtask-item[data-step="${stepIndex}"]`);
            if (subtaskItem) {
                subtaskItem.classList.toggle('completed', isChecked);
            }
            checkLabCompletion();
        }

        function generateLabHistoryHTML(history) {
            return history.map(l => `
                <div style="padding: 1rem; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${l.labId}</strong> - ${new Date(l.date).toLocaleDateString()}
                        </div>
                        <span style="color: ${l.status === 'completed' ? 'var(--success)' : 'var(--warning)'}; font-weight: 500;">
                            ${l.status.charAt(0).toUpperCase() + l.status.slice(1)}
                        </span>
                    </div>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                        Tasks: ${l.tasksCompleted}/${l.totalTasks} • Started: ${new Date(l.startedAt).toLocaleString()}
                        ${l.completedAt ? ` • Completed: ${new Date(l.completedAt).toLocaleString()}` : ''}
                    </p>
                </div>
            `).join('');
        }

        function displayAdminPanel(data) {
            const content = utils.getId('adminContent');
            if (!data || !data.length) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📊</div>
                        <p>No user progress data available.</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">User</th>
                                <th style="padding: 1rem; text-align: left;">Email</th>
                                <th style="padding: 1rem; text-align: left;">Progress</th>
                                <th style="padding: 1rem; text-align: left;">Last Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(user => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 1rem;">${user.name}</td>
                                    <td style="padding: 1rem;">${user.email}</td>
                                    <td style="padding: 1rem;">
                                        ${Math.round((user.completedTasks / user.totalTasks) * 100)}%
                                    </td>
                                    <td style="padding: 1rem;">
                                        ${user.lastLab ? new Date(user.lastLab).toLocaleDateString() : 'N/A'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            showModal('adminModal');
        }

        function showAdminPanelFallback(message) {
            const content = utils.getId('adminContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <p>${message}</p>
                    <p style="margin-top: 1rem;">
                        ${appState.sessionToken?.startsWith('demo_') ? 'Demo mode: Admin data unavailable.' : 'Ensure admin role and try again.'}
                    </p>
                </div>
            `;
            showModal('adminModal');
        }

        function updateProgressDisplay() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(t => t.completed).length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);
            const circumference = 339.292; // 2 * π * 54
            const dashArray = (percentage / 100) * circumference;
            const ring = utils.getId('progressRing');
            if (ring) {
                ring.setAttribute('stroke-dasharray', `${dashArray} ${circumference}`);
            }
            const percentageText = utils.getId('progressPercentage');
            if (percentageText) {
                percentageText.textContent = `${percentage}%`;
            }
            renderWeekCards();
        }

        function renderWeekCards() {
            const container = utils.getId('weeksContainer');
            if (!container) return;
            const weeks = Array.from({ length: 4 }, (_, i) => i + 1);
            container.innerHTML = weeks.map(week => {
                const weekTasks = appState.tasks.filter(t => t.week === week);
                const completed = weekTasks.filter(t => appState.progress[t.id]?.completed).length;
                const progress = weekTasks.length ? (completed / weekTasks.length) * 100 : 0;
                return `
                    <div class="week-card" onclick="toggleWeekCard(${week})" data-week="${week}">
                        <div class="week-header">
                            <div>
                                <h3 class="week-title">Week ${week}: ${['Foundation', 'Exchange Setup', 'M365 Integration', 'Hybrid Deployment'][week - 1]}</h3>
                                <p class="week-tasks">${completed}/${weekTasks.length} tasks completed</p>
                            </div>
                            <span class="expand-icon">▼</span>
                        </div>
                        <div class="week-progress">
                            <div class="week-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p class="week-description">
                            ${['Set up core infrastructure including AD and DNS.',
                               'Deploy and configure Exchange Server.',
                               'Integrate with Microsoft 365 services.',
                               'Establish and test hybrid connectivity.'][week - 1]}
                        </p>
                        <div class="task-list">
                            ${weekTasks.map(task => `
                                <div class="task-item ${appState.progress[task.id]?.completed ? 'completed' : ''}" data-task-id="${task.id}">
                                    <input type="checkbox" class="task-checkbox" ${appState.progress[task.id]?.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleTaskCompletion('${task.id}')">
                                    <div class="task-content">
                                        <div class="task-title">${task.title}</div>
                                        <div class="task-description">${task.description}</div>
                                    </div>
                                    <button class="task-detail-btn" onclick="event.stopPropagation(); showTaskDetail('${task.id}')">Details</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleWeekCard = (week) => {
            const card = document.querySelector(`.week-card[data-week="${week}"]`);
            if (card) {
                const isExpanded = card.classList.contains('expanded');
                document.querySelectorAll('.week-card').forEach(c => c.classList.remove('expanded'));
                if (!isExpanded) {
                    card.classList.add('expanded');
                }
            }
        };

        function showModal(modalId) {
            const modal = utils.getId(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = utils.getId(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
                const message = modal.querySelector('.message');
                if (message) {
                    message.classList.add('hidden');
                    message.textContent = '';
                }
            }
        }

        function showWelcomeScreen() {
            utils.getId('welcomeScreen').classList.remove('hidden');
            utils.getId('mainContent').classList.add('hidden');
            utils.getId('headerButtons').classList.remove('hidden');
            utils.getId('userMenu').classList.add('hidden');
            updateMobileMenu();
        }

        function showDashboard() {
            utils.getId('welcomeScreen').classList.add('hidden');
            utils.getId('mainContent').classList.remove('hidden');
            utils.getId('headerButtons').classList.add('hidden');
            utils.getId('userMenu').classList.remove('hidden');
            utils.getId('userName').textContent = appState.user?.name || 'User';
            updateMobileMenu();
        }

        function updateMobileMenu() {
            const items = utils.getId('mobileMenuItems');
            if (!items) return;
            const isAuthenticated = appState.authenticated;
            items.innerHTML = `
                ${isAuthenticated ? `
                    <button class="mobile-menu-item" onclick="startLabEnvironment()">🚀 Start New Lab</button>
                    <button class="mobile-menu-item" onclick="showLabHistoryModal()">📊 Lab History</button>
                    ${appState.user?.role === 'admin' ? `<button class="mobile-menu-item" onclick="showAdminPanel()">👑 Admin Panel</button>` : ''}
                    <div class="mobile-menu-item theme-menu-item">
                        <button class="theme-menu-toggle" onclick="this.nextElementSibling.classList.toggle('active')">
                            <span>🎨 Theme</span>
                            <span>▶</span>
                        </button>
                        <div class="theme-submenu">
                            <button class="theme-option jedi ${document.body.getAttribute('data-theme') === 'light' ? 'active' : ''}" onclick="setTheme('light')">🌟 Light Jedi</button>
                            <button class="theme-option sith ${document.body.getAttribute('data-theme') === 'dark' ? 'active' : ''}" onclick="setTheme('dark')">⚡ Dark Sith</button>
                        </div>
                    </div>
                    <button class="mobile-menu-item" onclick="logout()">🚪 Sign Out</button>
                ` : `
                    <button class="mobile-menu-item primary" onclick="showSignInModal()">Sign In</button>
                    <button class="mobile-menu-item secondary" onclick="showRegisterModal()">Get Started</button>
                    <div class="mobile-menu-item theme-menu-item">
                        <button class="theme-menu-toggle" onclick="this.nextElementSibling.classList.toggle('active')">
                            <span>🎨 Theme</span>
                            <span>▶</span>
                        </button>
                        <div class="theme-submenu">
                            <button class="theme-option jedi ${document.body.getAttribute('data-theme') === 'light' ? 'active' : ''}" onclick="setTheme('light')">🌟 Light Jedi</button>
                            <button class="theme-option sith ${document.body.getAttribute('data-theme') === 'dark' ? 'active' : ''}" onclick="setTheme('dark')">⚡ Dark Sith</button>
                        </div>
                    </div>
                `}
            `;
            const hamburger = utils.getId('hamburger');
            const mobileMenu = utils.getId('mobileMenu');
            if (hamburger?.classList.contains('active')) {
                hamburger.classList.remove('active');
                mobileMenu.classList.remove('active');
            }
        }

        function initializeApp() {
            console.log('🚀 Initializing Velocity Lab...');
            loadTaskDefinitions();
            checkSession();
            setupFormHandlers();
            updateMobileMenu();
            document.addEventListener('click', (e) => {
                const userMenu = utils.getId('userMenuDropdown');
                const userToggle = document.querySelector('.user-menu-toggle');
                if (userMenu && userToggle && !userToggle.contains(e.target) && !userMenu.contains(e.target)) {
                    userMenu.classList.remove('active');
                }
            });
        }

        // Start the application
        initializeApp();
    </script>
</body>
</html>