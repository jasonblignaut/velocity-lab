<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Velocity Lab</title>
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --p: #0078d4; /* Azure Blue */
      --s: #34c759; /* Unifi Green */
      --e: #d13438; /* Apple Red */
      --g1: #f5f6f5; /* Light Gray (Azure) */
      --g5: #605e5c; /* Gray Text */
      --g9: #1c2526; /* Dark Text */
      --d1: #1a252f; /* Dark Azure */
      --d5: #c7d1d8; /* Dark Gray Text */
      --r: 14px; /* Border Radius */
      --t: 0.4s cubic-bezier(0.4, 0,0,0.2, 1); /* Apple-like easing */
      --shadow: 0 4px 8px rgba(0,0,0,0.1);
      --glass: rgba(255,255,255,0.85);
    }
    body {
      font-family: -apple-system, 'Segoe UI', system-ui, sans-serif';
      background: linear-gradient(180deg, var(--g1), #e6e7e8);
      color: var(--g9);
      line-height: 1.6;
      overflow-x: hidden;
      transition: background var(--t), color var(--t);
    }
    body.dark {
      background: var(--d1);
      color: var(--d5);
    }
    .c { max-width: 1280px; margin: 0 auto; padding: 0 16px; }
    header {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--glass);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      z-index: 100;
      transition: background var(--t);
    }
    body.dark header {
      background: rgba(26,37,47,0.9);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    nav {
      height: 60px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo img {
      height: 36px;
      transition: transform var(--t);
    }
    .logo img:hover { transform: scale(1.05); }
    .btn {
      padding: 10px 20px;
      border-radius: 24px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--t);
      background: transparent;
      border: 1px solid rgba(0,0,0,0.08);
    }
    body.dark .btn { border: 1px solid rgba(255,255,255,0.1); }
    .btn-p {
      background: var(--p);
      color: #fff;
      border: none;
    }
    .btn-p:hover {
      background: #005ba1;
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .btn-s:hover {
      background: rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }
    .btn-a {
      background: linear-gradient(135deg, #00b7eb, #0078d4);
      color: #fff;
      border: none;
    }
    .btn-a:hover {
      background: linear-gradient(135deg, #0078d4, #00b7eb);
      transform: translateY(-2px);
    }
    .h { display: none !important; }
    #land {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 60px;
    }
    #land h1 {
      font-size: clamp(48px, 8vw, 72px);
      font-weight: 900;
      margin-bottom: 20px;
      background: linear-gradient(180deg, var(--g9), #005ba1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    #land p {
      font-size: 20px;
      color: var(--g5);
      max-width: 600px;
      margin: 0 auto 40px;
    }
    #dash {
      padding: 80px 0 40px;
      min-height: 100vh;
    }
    .card {
      background: #fff;
      border-radius: var(--r);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      transition: box-shadow var(--t);
    }
    body.dark .card { background: rgba(40,50,60,0.9); }
    .card:hover { box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
    .ring {
      width: 160px;
      height: 160px;
      margin: 0 auto 24px;
    }
    .ring svg { transform: rotate(-90deg); }
    .ring circle {
      fill: none;
      stroke-width: 12;
      stroke-linecap: round;
    }
    .ring .bg { stroke: #e8ecef; }
    body.dark .ring .bg { stroke: #374151; }
    .ring .fg {
      stroke: var(--p);
      stroke-dasharray: 472;
      stroke-dashoffset: 472;
      transition: stroke-dashoffset 1.2s var(--t);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }
    .stat { text-align: center; }
    .stat-v {
      font-size: 32px;
      font-weight: 700;
      color: var(--p);
    }
    .stat-l {
      font-size: 13px;
      color: var(--g5);
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    body.dark .stat-l { color: var(--d5); }
    .week {
      background: #fff;
      border-radius: var(--r);
      margin-bottom: 20px;
      overflow: hidden;
      transition: all var(--t);
      cursor: pointer;
    }
    body.dark .week { background: rgba(40,50,60,0.9); }
    .week:hover { box-shadow: var(--shadow); }
    .wh {
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .wh h3 {
      font-size: 20px;
      font-weight: 600;
    }
    .wh p {
      color: var(--g5);
      font-size: 14px;
    }
    body.dark .wh p { color: var(--d5); }
    .wp { text-align: right; }
    .bar {
      width: 100px;
      height: 6px;
      background: #e8ecef;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }
    body.dark .bar { background: #374151; }
    .fill {
      height: 100%;
      background: var(--p);
      transition: width var(--t);
    }
    .tasks {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 16px;
      padding: 0 24px 24px;
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--t);
    }
    .tasks.show { max-height: 3000px; }
    .task {
      background: var(--g1);
      border-radius: var(--r);
      padding: 16px;
      cursor: pointer;
      transition: all var(--t);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    body.dark .task { background: rgba(31,41,55,0.5); }
    .task:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    .task.done {
      background: rgba(52,199,89,0.08);
      border: 1px solid var(--s);
    }
    .task input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    .task-t {
      font-weight: 500;
      font-size: 15px;
    }
    .task-d {
      font-size: 13px;
      color: var(--g5);
    }
    body.dark .task-d { color: var(--d5); }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(10px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 16px;
    }
    .modal-c {
      background: var(--glass);
      border-radius: 20px;
      padding: 32px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 12px 48px rgba(0,0,0,0.2);
    }
    body.dark .modal-c { background: rgba(40,50,60,0.9); }
    .modal-h {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-h h2 {
      font-size: 24px;
      font-weight: 700;
    }
    .close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--g1);
      cursor: pointer;
      font-size: 18px;
      transition: all var(--t);
    }
    body.dark .close { background: var(--d1); }
    .close:hover { background: var(--g5); color: #fff; }
    body.dark .close:hover { background: var(--d5); }
    .modal input, .modal select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 10px;
      margin-bottom: 16px;
      font-size: 15px;
      transition: border-color var(--t);
    }
    body.dark .modal input, body.dark .modal select { border: 1px solid rgba(255,255,255,0.1); }
    .modal input:focus, .modal select:focus {
      outline: none;
      border-color: var(--p);
    }
    .subtask { margin: 16px 0; }
    .sub-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
    }
    .sub-item input {
      width: 18px;
      height: 18px;
    }
    .sub-item label {
      font-size: 14px;
    }
    .notif {
      position: fixed;
      top: 80px;
      right: 20px;
      padding: 14px 24px;
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      transform: translateX(320px);
      transition: all var(--t);
      box-shadow: var(--shadow);
    }
    .notif.show { transform: translateX(0); }
    .notif.s { background: var(--s); }
    .notif.e { background: var(--e); }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    body.dark th, body.dark td { border-bottom: 1px solid rgba(255,255,255,0.06); }
    th {
      font-size: 13px;
      color: var(--g5);
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
    }
    body.dark th { color: var(--d5); }
    .admin-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
    }
    body.dark .admin-tabs { border-bottom: 1px solid rgba(255,255,255,0.08); }
    .admin-tab {
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--t);
    }
    .admin-tab.active {
      color: var(--p);
      border-bottom-color: var(--p);
    }
    .admin-tab:hover { color: var(--p); }
    .admin-section { display: none; }
    .admin-section.active { display: block; }
    .user-card {
      background: #fff;
      border-radius: var(--r);
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      transition: all var(--t);
    }
    body.dark .user-card { background: rgba(40,50,60,0.9); }
    .user-card:hover { transform: translateY(-2px); }
    .user-info h4 { font-size: 16px; font-weight: 600; }
    .user-info p { font-size: 14px; color: var(--g5); }
    body.dark .user-info p { color: var(--d5); }
    .user-actions { display: flex; gap: 12px; }
    .progress-bar {
      height: 8px;
      background: #e8ecef;
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    body.dark .progress-bar { background: #374151; }
    .progress-fill {
      height: 100%;
      background: var(--p);
      transition: width var(--t);
    }
    .data-tools {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .data-tools input[type="file"] {
      padding: 10px;
      border: 1px dashed var(--g5);
      border-radius: 10px;
    }
    body.dark .data-tools input[type="file"] { border: 1px dashed var(--d5); }
    .theme-toggle {
      padding: 8px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    @media (max-width: 768px) {
      .stats { grid-template-columns: repeat(2, 1fr); }
      .tasks { grid-template-columns: 1fr; }
      #land h1 { font-size: clamp(36px, 7vw, 56px); }
      #land p { font-size: 18px; }
      .modal-c { padding: 20px; }
      .admin-tabs { flex-wrap: wrap; }
      .user-card { flex-direction: column; align-items: flex-start; gap: 16px; }
      .user-actions { width: 100%; justify-content: flex-end; }
    }
  </style>
</head>
<body>
  <header>
    <nav class="c">
      <div class="logo">
        <img src="/assets/Velocity-Logo.png" alt="Velocity Lab">
      </div>
      <div>
        <span id="auth">
          <button onclick="showLogin()" class="btn btn-s">Sign In</button>
          <button onclick="showRegister()" class="btn btn-p">Register</button>
        </span>
        <span id="user" class="h">
          <span id="userName"></span>
          <button id="adminBtn" class="btn btn-a h" onclick="showAdmin()">Admin</button>
          <button onclick="logout()" class="btn btn-s">Sign Out</button>
          <button class="theme-toggle" onclick="toggleTheme()">🌙</button>
        </span>
      </div>
    </nav>
  </header>

  <main>
    <section id="land">
      <div class="c">
        <h1>Master Exchange Hybrid</h1>
        <p>42 hands-on tasks over 4 weeks. Build a lab with DC, Exchange, and workstation VMs.</p>
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
          <button class="btn btn-p" onclick="showRegister()">Register</button>
          <button class="btn btn-s" onclick="showLogin()">Sign In</button>
        </div>
      </div>
    </section>

    <section id="dash" class="h">
      <div class="c">
        <div class="card" style="text-align: center;">
          <h2 style="margin-bottom: 24px;">Training Progress</h2>
          <div class="ring">
            <svg viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="75" class="bg"/>
              <circle cx="80" cy="80" r="75" class="fg" id="ring"/>
            </svg>
            <div style="margin-top: -100px; font-size: 36px; font-weight: 700;" id="pct">0%</div>
          </div>
          <div class="stats">
            <div class="stat"><div class="stat-v" id="done">0</div><div class="stat-l">Tasks Done</div></div>
            <div class="stat"><div class="stat-v">42</div><div class="stat-l">Total Tasks</div></div>
            <div class="stat"><div class="stat-v" id="curWeek">Week 1</div><div class="stat-l">Current</div></div>
            <div class="stat"><div class="stat-v">3</div><div class="stat-l">VMs</div></div>
          </div>
          <button class="btn btn-p" onclick="newLab()">Start New Lab</button>
        </div>

        <div id="weeks">
          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 1: Foundation</h3>
                <p>DC setup, domain join, shares</p>
              </div>
              <div class="wp">
                <div><span id="week1-done">0</span>/12 tasks</div>
                <div class="bar"><div class="fill" id="week1-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week1-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 2: Infrastructure</h3>
                <p>Second DC, WSUS, time</p>
              </div>
              <div class="wp">
                <div><span id="week2-done">0</span>/8 tasks</div>
                <div class="bar"><div class="fill" id="week2-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week2-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 3: Exchange</h3>
                <p>DC upgrade, Exchange setup</p>
              </div>
              <div class="wp">
                <div><span id="week3-done">0</span>/12 tasks</div>
                <div class="bar"><div class="fill" id="week3-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week3-tasks"></div>
          </div>

          <div class="week">
            <div class="wh" onclick="toggleWeek(this)">
              <div>
                <h3>Week 4: Hybrid</h3>
                <p>M365 integration, hybrid</p>
              </div>
              <div class="wp">
                <div><span id="week4-done">0</span>/10 tasks</div>
                <div class="bar"><div class="fill" id="week4-bar" style="width: 0%;"></div></div>
              </div>
            </div>
            <div class="tasks" id="week4-tasks"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="loginModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Sign In</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <form id="loginForm">
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password" required>
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
          <input type="checkbox" name="remember" style="width: auto; margin: 0;"> Remember me
        </label>
        <button type="submit" class="btn btn-p" style="width: 100%;">Sign In</button>
        <p style="text-align: center; margin-top: 16px; font-size: 13px;">
          New? <a href="#" onclick="showRegister()">Register</a>
        </p>
      </form>
    </div>
  </div>

  <div id="registerModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Register</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <form id="registerForm">
        <input type="text" name="name" placeholder="Full Name" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="password" name="password" placeholder="Password (8+ chars)" required minlength="8">
        <button type="submit" class="btn btn-p" style="width: 100%;">Register</button>
        <p style="text-align: center; margin-top: 16px; font-size: 13px;">
          Have account? <a href="#" onclick="showLogin()">Sign In</a>
        </p>
      </form>
    </div>
  </div>

  <div id="taskModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2 id="taskTitle"></h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <div id="taskBody"></div>
    </div>
  </div>

  <div id="adminModal" class="modal">
    <div class="modal-c">
      <div class="modal-h">
        <h2>Admin Portal</h2>
        <button class="close" onclick="closeModal()">×</button>
      </div>
      <div class="admin-tabs">
        <div class="admin-tab active" onclick="switchAdminTab('leaderboard')">Leaderboard</div>
        <div class="admin-tab" onclick="switchAdminTab('users')">Users</div>
        <div class="admin-tab" onclick="switchAdminTab('data')">Data Tools</div>
      </div>
      <div id="admin-leaderboard" class="admin-section active">
        <table id="leaderboard-table">
          <thead>
            <tr>
              <th onclick="sortTable(0)">Rank</th>
              <th onclick="sortTable(1)">Name</th>
              <th onclick="sortTable(2)">Progress</th>
              <th onclick="sortTable(3)">Tasks</th>
              <th onclick="sortTable(4)">Last Login</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body"></tbody>
        </table>
        <button class="btn btn-s" onclick="refreshLeaderboard()" style="margin-top: 16px;">Refresh</button>
      </div>
      <div id="admin-users" class="admin-section">
        <div id="users-list"></div>
      </div>
      <div id="admin-data" class="admin-section">
        <div class="data-tools">
          <button class="btn btn-p" onclick="exportProgress()">Export Progress (CSV)</button>
          <input type="file" accept=".csv" id="importProgress" onchange="importProgress(this.files)">
        </div>
      </div>
    </div>
  </div>

  <div id="notif" class="notif"></div>

  <script src="/task-definitions.js"></script>
  <script>
    const TASKS = {
      week1: { t: ['install-server2012', 'promote-dc', 'join-vm-domain', 'create-hidden-share', 'map-drive-gpo', 'map-drive-script', 'map-drive-powershell', 'create-security-group', 'restrict-share-access', 'configure-static-ip', 'setup-vm-dns', 'create-domain-users'] },
      week2: { t: ['install-second-server', 'promote-additional-dc', 'install-wsus-role', 'configure-wsus-settings', 'setup-wsus-gpo', 'configure-primary-time', 'configure-secondary-time', 'test-infrastructure'] },
      week3: { t: ['backup-servers', 'upgrade-dc1-2016', 'upgrade-dc2-2016', 'raise-functional-levels', 'install-exchange-server', 'install-exchange-prereqs', 'extend-ad-schema', 'install-exchange-2019', 'configure-exchange-basic', 'create-mailboxes', 'test-mailbox-access', 'configure-internal-mailflow'] },
      week4: { t: ['configure-external-dns', 'setup-firewall-rules', 'install-ssl-certificates', 'configure-external-mailflow', 'setup-modern-auth', 'prepare-m365-tenant', 'install-aad-connect', 'run-hybrid-wizard', 'configure-hybrid-mailflow', 'verify-hybrid-functionality'] }
    };
    let A = { u: null, p: {}, auth: false, sessionToken: null };
    const $ = id => document.getElementById(id);
    const show = e => e?.classList.remove('h');
    const hide = e => e?.classList.add('h');

    const ck = {
      get: n => document.cookie.match(`${n}=([^;]+)`)?.[1],
      set: (n, v) => {
        document.cookie = `${n}=${v};path=/;max-age=604800;SameSite=Strict;Secure`;
      },
      del: n => { document.cookie = `${n}=;path=/;max-age=0;SameSite=Strict;Secure`; }
    };

    const msg = (m, t = 's') => {
      const n = $('notif');
      n.textContent = m;
      n.className = `notif ${t} show`;
      setTimeout(() => n.classList.remove('show'), 3000);
    };

    const api = async (ep, opt = {}) => {
      try {
        const headers = new Headers(opt.headers || {});
        if (A.sessionToken) headers.set('Authorization', `Bearer ${A.sessionToken}`);
        const isGet = !opt.method || opt.method.toUpperCase() === 'GET';
        
        let body;
        if (!isGet) {
          const r = await fetch('/api/csrf', { credentials: 'same-origin' });
          if (!r.ok) throw new Error(`CSRF fetch failed: ${r.status}`);
          const { token } = await r.json();
          
          let fd;
          if (opt.body instanceof FormData) {
            fd = opt.body;
            fd.append('csrf_token', token);
          } else {
            fd = new FormData();
            if (opt.body) {
              for (const [key, value] of Object.entries(opt.body)) {
                fd.append(key, value);
              }
            }
            fd.append('csrf_token', token);
          }
          body = fd;
        }
        
        const res = await fetch(ep, {
          credentials: 'same-origin',
          headers,
          method: opt.method || 'GET',
          body
        });
        
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const d = await res.json();
        if (!d.success) throw new Error(d.error || 'Request failed');
        return d;
      } catch (e) {
        console.error(`API error for ${ep}:`, e);
        throw e;
      }
    };

    const auth = {
      async check() {
        const u = ck.get('user');
        A.sessionToken = ck.get('session');
        if (u && A.sessionToken) {
          try {
            A.u = JSON.parse(decodeURIComponent(u));
            A.auth = true;
            if (A.u.role === 'admin') show($('adminBtn'));
            ui.dash();
            dash.load();
          } catch (e) {
            console.error('Auth check error:', e);
            auth.logout();
          }
        } else {
          ui.land();
        }
      },
      async login(fd) {
        try {
          const r = await api('/api/login', { method: 'POST', body: fd });
          ck.set('user', encodeURIComponent(JSON.stringify({ name: r.name, role: r.role, email: r.email })));
          ck.set('session', r.sessionToken);
          A.u = { name: r.name, role: r.role, email: r.email };
          A.auth = true;
          A.sessionToken = r.sessionToken;
          if (A.u.role === 'admin') show($('adminBtn'));
          ui.dash();
          dash.load();
          closeModal();
          msg(`Welcome, ${r.name}!`);
        } catch (e) {
          console.error('Login error:', e);
          msg(e.message || 'Login failed', 'e');
        }
      },
      async register(fd) {
        try {
          const r = await api('/api/register', { method: 'POST', body: fd });
          ck.set('user', encodeURIComponent(JSON.stringify({ name: r.name, role: r.role, email: r.email })));
          ck.set('session', r.sessionToken);
          A.u = { name: r.name, role: r.role, email: r.email };
          A.auth = true;
          A.sessionToken = r.sessionToken;
          ui.dash();
          dash.load();
          closeModal();
          msg(`Welcome, ${r.name}!`);
        } catch (e) {
          console.error('Register error:', e);
          msg(e.message || 'Registration failed', 'e');
        }
      },
      logout() {
        api('/api/logout', { method: 'POST' }).catch(e => console.error('Logout error:', e));
        ck.del('user');
        ck.del('session');
        A = { u: null, p: {}, auth: false, sessionToken: null };
        hide($('adminBtn'));
        ui.land();
        msg('Signed out');
      }
    };

    const ui = {
      land() {
        hide($('dash'));
        show($('land'));
        hide($('user'));
        show($('auth'));
      },
      dash() {
        hide($('land'));
        show($('dash'));
        show($('user'));
        hide($('auth'));
        $('userName').textContent = A.u?.name || '';
      }
    };

    const dash = {
      async load() {
        if (!A.auth) return;
        try {
          const r = await api('/api/progress');
          A.p = r.data || {};
          dash.update();
        } catch (e) {
          console.error('Progress load error:', e);
          msg('Failed to load progress', 'e');
        }
      },
      update() {
        let done = 0;
        Object.entries(TASKS).forEach(([w, d]) => {
          const wp = A.p[w] || {};
          const wd = d.t.filter(t => wp[t]?.completed).length;
          done += wd;
          const doneEl = $(`${w}-done`);
          const barEl = $(`${w}-bar`);
          const tasksEl = $(`${w}-tasks`);
          if (doneEl) doneEl.textContent = `${wd}`;
          if (barEl) barEl.style.width = `${(wd / d.t.length) * 100}%`;
          if (tasksEl) {
            tasksEl.innerHTML = d.t.map(t => `
              <div class="task ${wp[t]?.completed ? 'done' : ''}" onclick="openTask('${w}', '${t}')">
                <input type="checkbox" ${wp[t]?.completed ? 'checked' : ''} onchange="toggleTask('${w}', '${t}', this.checked)" onclick="event.stopPropagation()">
                <div>
                  <div class="task-t">${t.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                  <div class="task-d">Click for details</div>
                </div>
              </div>
            `).join('');
          }
        });
        const pct = Math.round((done / 42) * 100);
        const pctEl = $('pct');
        const doneEl = $('done');
        const curWeekEl = $('curWeek');
        const ringEl = $('ring');
        if (pctEl) pctEl.textContent = `${pct}%`;
        if (doneEl) doneEl.textContent = `${done}`;
        if (curWeekEl) curWeekEl.textContent = done >= 32 ? 'Week 4' : done >= 20 ? 'Week 3' : done >= 12 ? 'Week 2' : 'Week 1';
        if (ringEl) ringEl.style.strokeDashoffset = `${472 - (pct / 100) * 472}`;
      }
    };

    const toggleWeek = h => h.nextElementSibling.classList.toggle('show');

    const toggleTask = async (w, t, c) => {
      try {
        const fd = new FormData();
        fd.append('week', w);
        fd.append('task', t);
        fd.append('checked', c.toString());
        await api('/api/progress', { method: 'POST', body: fd });
        if (!A.p[w]) A.p[w] = {};
        if (!A.p[w][t]) A.p[w][t] = {};
        A.p[w][t].completed = c;
        dash.update();
        msg(c ? '✅ Task completed!' : 'Task unmarked');
      } catch (e) {
        console.error('Toggle task error:', e);
        msg('Failed to update task', 'e');
        event.target.checked = !c;
      }
    };

    const toggleSub = async (w, t, s, c) => {
      try {
        const fd = new FormData();
        fd.append('week', w);
        fd.append('task', t);
        fd.append('subtask', `step${s}`);
        fd.append('subtask_checked', c.toString());
        await api('/api/progress', { method: 'POST', body: fd });
        if (!A.p[w]) A.p[w] = {};
        if (!A.p[w][t]) A.p[w][t] = { subtasks: {} };
        if (!A.p[w][t].subtasks) A.p[w][t].subtasks = {};
        A.p[w][t].subtasks[`step${s}`] = c;
        msg(c ? '✅ Step completed!' : 'Step unmarked');
      } catch (e) {
        console.error('Toggle subtask error:', e);
        msg('Failed to update step', 'e');
      }
    };

    const openTask = (w, t) => {
      const k = `${w}-${t}`;
      const td = window.TASK_DEFINITIONS?.[k] || {
        title: t.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
        description: '<p>Details coming soon...</p>'
      };
      $('taskTitle').textContent = td.title;
      $('taskBody').innerHTML = td.description;
      setTimeout(() => {
        document.querySelectorAll('.subtask input').forEach(cb => {
          const s = cb.dataset.step;
          cb.checked = A.p[w]?.[t]?.subtasks?.[`step${s}`] || false;
          cb.onchange = () => toggleSub(w, t, s, cb.checked);
        });
      }, 100);
      $('taskModal').style.display = 'flex';
    };

    const newLab = async () => {
      if (!confirm('Start a new lab? This will reset your progress.')) return;
      try {
        await api('/api/lab/start-new', { method: 'POST' });
        A.p = {};
        dash.update();
        msg('🚀 New lab started!');
      } catch (e) {
        console.error('New lab error:', e);
        msg('Failed to start new lab', 'e');
      }
    };

    const switchAdminTab = tab => {
      document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
      document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
      $(`admin-${tab}`).classList.add('active');
      if (tab === 'leaderboard') refreshLeaderboard();
      if (tab === 'users') loadUsers();
    };

    const refreshLeaderboard = async () => {
      try {
        const r = await api('/api/admin/users-progress');
        const tbody = $('leaderboard-body');
        tbody.innerHTML = r.data.map((u, i) => `
          <tr>
            <td>${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : i + 1}</td>
            <td>${u.name}</td>
            <td>${u.progress}%</td>
            <td>${u.completedTasks}/42</td>
            <td>${u.lastLogin ? new Date(u.lastLogin).toLocaleString() : 'Never'}</td>
          </tr>
        `).join('');
        msg('Leaderboard refreshed', 's');
      } catch (e) {
        console.error('Leaderboard refresh error:', e);
        msg('Failed to load leaderboard', 'e');
      }
    };

    const loadUsers = async () => {
      try {
        const r = await api('/api/admin/users-progress');
        const list = $('users-list');
        list.innerHTML = r.data.map(u => `
          <div class="user-card">
            <div class="user-info">
              <h4>${u.name}</h4>
              <p>Email: ${u.email} | Role: ${u.role} | Progress: ${u.progress}%</p>
              <div class="progress-bar"><div class="progress-fill" style="width: ${u.progress}%"></div></div>
            </div>
            <div class="user-actions">
              <button class="btn btn-s" onclick="toggleRole('${u.email}', '${u.role === 'admin' ? 'user' : 'admin'}')">${u.role === 'admin' ? 'Demote' : 'Promote'}</button>
              <button class="btn btn-e" onclick="resetProgress('${u.email}')">Reset Progress</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Users load error:', e);
        msg('Failed to load users', 'e');
      }
    };

    const toggleRole = async (email, role) => {
      if (!confirm(`Change ${email} to ${role}?`)) return;
      try {
        const fd = new FormData();
        fd.append('email', email);
        fd.append('role', role);
        await api('/api/admin/update-role', { method: 'POST', body: fd });
        loadUsers();
        msg(`Role updated for ${email}`, 's');
      } catch (e) {
        console.error('Toggle role error:', e);
        msg('Failed to update role', 'e');
      }
    };

    const resetProgress = async (email) => {
      if (!confirm(`Reset progress for ${email}?`)) return;
      try {
        const fd = new FormData();
        fd.append('email', email);
        await api('/api/admin/reset-progress', { method: 'POST', body: fd });
        loadUsers();
        msg(`Progress reset for ${email}`, 's');
      } catch (e) {
        console.error('Reset progress error:', e);
        msg('Failed to reset progress', 'e');
      }
    };

    const exportProgress = async () => {
      try {
        const r = await api('/api/admin/export-progress');
        const blob = new Blob([r.csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'velocitylab-progress.csv';
        a.click();
        URL.revokeObjectURL(url);
        msg('Progress exported', 's');
      } catch (e) {
        console.error('Export error:', e);
        msg('Failed to export progress', 'e');
      }
    };

    const importProgress = async (files) => {
      if (!files[0]) return;
      try {
        const text = await files[0].text();
        const fd = new FormData();
        fd.append('csv', text);
        await api('/api/admin/import-progress', { method: 'POST', body: fd });
        refreshLeaderboard();
        loadUsers();
        msg('Progress imported', 's');
      } catch (e) {
        console.error('Import error:', e);
        msg('Failed to import progress', 'e');
      }
    };

    const sortTable = (col) => {
      const table = $('leaderboard-table');
      const tbody = $('leaderboard-body');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const isAsc = table.dataset.sortCol === col.toString() ? !table.dataset.sortAsc : true;
      table.dataset.sortCol = col;
      table.dataset.sortAsc = isAsc;
      rows.sort((a, b) => {
        let va = a.children[col].textContent;
        let vb = b.children[col].textContent;
        if (col === 2 || col === 3) {
          va = parseFloat(va.replace('%', '')) || parseInt(va.split('/')[0]);
          vb = parseFloat(vb.replace('%', '')) || parseInt(vb.split('/')[0]);
          return isAsc ? va - vb : vb - va;
        }
        return isAsc ? va.localeCompare(vb) : vb.localeCompare(va);
      });
      tbody.innerHTML = '';
      rows.forEach(row => tbody.appendChild(row));
    };

    const toggleTheme = () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    };

    const showAdmin = async () => {
      if (A.u?.role !== 'admin') {
        msg('Admin access required', 'e');
        return;
      }
      try {
        await refreshLeaderboard();
        $('adminModal').style.display = 'flex';
      } catch (e) {
        console.error('Admin load error:', e);
        msg('Failed to load admin portal', 'e');
      }
    };

    window.showLogin = () => {
      hide($('registerModal'));
      $('loginModal').style.display = 'flex';
    };
    window.showRegister = () => {
      hide($('loginModal'));
      $('registerModal').style.display = 'flex';
    };
    window.closeModal = () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    window.logout = auth.logout;
    window.newLab = newLab;
    window.showAdmin = showAdmin;
    window.openTask = openTask;
    window.toggleTask = toggleTask;
    window.toggleWeek = toggleWeek;
    window.switchAdminTab = switchAdminTab;
    window.refreshLeaderboard = refreshLeaderboard;
    window.toggleRole = toggleRole;
    window.resetProgress = resetProgress;
    window.exportProgress = exportProgress;
    window.importProgress = importProgress;
    window.sortTable = sortTable;
    window.toggleTheme = toggleTheme;

    document.addEventListener('DOMContentLoaded', () => {
      $('loginForm').onsubmit = e => {
        e.preventDefault();
        auth.login(new FormData(e.target));
      };
      $('registerForm').onsubmit = e => {
        e.preventDefault();
        auth.register(new FormData(e.target));
      };
      document.onclick = e => {
        if (e.target.classList.contains('modal')) closeModal();
      };
      console.log('Loaded scripts:', Array.from(document.scripts).map(s => s.src));
      if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
      auth.check();
    });

    window.addEventListener('message', e => {
      if (e.data?.type === 'hide-notification') {
        console.error('Caught hide-notification message:', e);
      }
    }, true);
  </script>
</body>
</html>