<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocity Lab - Exchange Hybrid Training</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    
    <style>
        /* Apple White + Unifi Cloud Color Scheme with Dark Mode */
        :root {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #f8f9fa;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-hover: #e9ecef;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: #d2d2d7;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --jedi-glow: #00ff88;
            --sith-glow: #ff0066;
            --bg-secondary: #f0f0f5;
        }

        [data-theme="dark"] {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #1e1e1e;
            --background: #000000;
            --surface: #1e1e1e;
            --surface-hover: #2e2e2e;
            --text: #ffffff;
            --text-secondary: #a1a1a6;
            --border: #2e2e2e;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --shadow: rgba(255, 255, 255, 0.1);
            --shadow-heavy: rgba(255, 255, 255, 0.2);
            --bg-secondary: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: all 0.3s ease;
        }

        /* Background Image - Fixed to show in both themes */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/assets/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.08;
            z-index: -1;
        }

        [data-theme="dark"] body::before {
            opacity: 0.05;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.95);
        }

        /* Logo */
        .logo {
            width: 80px;
            height: 80px;
            background: url('/assets/Velocity-Logo.png') center/contain no-repeat;
            cursor: pointer;
        }

        [data-theme="dark"] .logo {
            filter: invert(1) brightness(1.2);
        }

        /* Desktop Navigation */
        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Mobile Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .hamburger:hover {
            background: var(--surface-hover);
        }

        .hamburger span {
            width: 24px;
            height: 2px;
            background: var(--text);
            margin: 3px 0;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
            padding: 1rem;
        }

        [data-theme="dark"] .mobile-menu {
            background: rgba(0, 0, 0, 0.98);
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
        }

        .mobile-menu-item:hover, .mobile-menu-item.primary {
            background: var(--primary);
            color: white;
        }

        .mobile-menu-item.secondary {
            border: 1px solid var(--border);
        }

        /* Theme Menu */
        .theme-menu-item {
            position: relative;
        }

        .theme-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            color: var(--text);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .theme-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .theme-submenu {
            position: absolute;
            right: 100%;
            top: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 150px;
            z-index: 1001;
            display: none;
        }

        .theme-menu-item:hover .theme-submenu {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .theme-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .theme-option:hover {
            background: var(--surface-hover);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
        }

        .theme-option.jedi:hover {
            background: linear-gradient(45deg, var(--jedi-glow), #00ff88);
            color: white;
        }

        .theme-option.sith:hover {
            background: linear-gradient(45deg, var(--sith-glow), #ff0066);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--surface-hover);
        }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative;
        }

        .welcome-notification {
            position: absolute;
            top: 100px;
            left: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            max-width: 300px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--text), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
            padding: 0.2rem 0;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        .welcome-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--background);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px var(--shadow-heavy);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 800px;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 6px;
        }

        .modal-close:hover {
            background: var(--surface-hover);
        }

        /* Task Detail Modal */
        .task-detail-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .subtask-container {
            margin: 1rem 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .subtask-item:hover {
            background: var(--surface-hover);
        }

        .subtask-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }

        .subtask-item label {
            cursor: pointer;
            line-height: 1.4;
        }

        .subtask-item.completed {
            opacity: 0.7;
        }

        .subtask-item.completed label {
            text-decoration: line-through;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-submit {
            width: 100%;
            margin-top: 1rem;
        }

        /* Main Dashboard */
        .main-content {
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Progress Ring */
        .progress-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Week Cards */
        .weeks-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .week-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .week-card.expanded {
            cursor: default;
        }

        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .week-tasks {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .week-progress {
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .week-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .week-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .week-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Task List */
        .task-list {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .week-card.expanded .task-list {
            display: block;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            background: var(--surface-hover);
        }

        .task-checkbox {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-detail-btn {
            margin-left: 1rem;
            padding: 4px 8px;
            font-size: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .task-item:hover .task-detail-btn {
            opacity: 1;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: background-color 0.2s ease;
        }

        .user-menu-toggle:hover {
            background: var(--surface-hover);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-menu-dropdown.active {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .user-menu-item:hover {
            background: var(--surface-hover);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                justify-content: center;
                position: relative;
            }

            .logo {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 60px;
            }

            .header-buttons {
                display: none;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 1rem;
            }

            .user-menu {
                display: none;
            }

            .welcome-screen {
                padding: 1rem;
            }

            .welcome-notification {
                position: static;
                margin-bottom: 2rem;
                max-width: none;
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }

            .btn-large {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
                margin-top: 70px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .progress-ring {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 1.5rem;
            }

            .weeks-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .week-card {
                padding: 1rem;
            }

            .week-title {
                font-size: 1.1rem;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
                margin: auto;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px 16px;
                justify-content: center;
            }

            .form-input {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
                padding: 0 0.75rem;
            }

            .main-content {
                margin-top: 60px;
                padding: 0.75rem;
            }

            .mobile-menu {
                top: 60px;
            }

            .logo {
                width: 50px;
                height: 50px;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                padding: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading {
            position: relative;
            color: transparent;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success/Error Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Hide elements by default */
        .hidden {
            display: none !important;
        }

        /* Notification System */
        .notification {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Header -->
    <div class="header" id="header">
        <!-- Logo only (no text) -->
        <div class="logo" onclick="goHome()"></div>
        
        <!-- Desktop Navigation -->
        <div class="header-buttons" id="headerButtons">
            <button class="btn btn-secondary" onclick="showSignInModal()">Sign In</button>
            <button class="btn btn-primary" onclick="showRegisterModal()">Get Started</button>
        </div>
        
        <!-- Mobile Hamburger Menu -->
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <!-- Desktop User Menu -->
        <div class="user-menu hidden" id="userMenu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()">
                <span id="userName">User</span>
                <span>â–¼</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <button class="user-menu-item" onclick="startLabEnvironment()">ðŸš€ Start New Lab</button>
                <button class="user-menu-item" onclick="showLabHistoryModal()" id="labHistoryButton">ðŸ“Š Lab History</button>
                <button class="user-menu-item" onclick="showAdminPanel()" id="adminButton" style="display: none;">ðŸ‘‘ Admin Panel</button>
                <div class="theme-menu-item">
                    <button class="theme-menu-toggle">
                        <span>ðŸŽ¨ Theme</span>
                        <span>â–¶</span>
                    </button>
                    <div class="theme-submenu">
                        <button class="theme-option jedi ${document.body.getAttribute('data-theme') === 'light' ? 'active' : ''}" onclick="setTheme('light')">
                            ðŸŒŸ Light Jedi
                        </button>
                        <button class="theme-option sith ${document.body.getAttribute('data-theme') === 'dark' ? 'active' : ''}" onclick="setTheme('dark')">
                            âš¡ Dark Sith
                        </button>
                    </div>
                </div>
                <button class="user-menu-item" onclick="logout()">ðŸšª Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-items" id="mobileMenuItems">
            <!-- Items populated by JavaScript based on auth state -->
        </div>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-notification">
            ðŸ‘‹ Welcome to Velocity Lab! Sign in to access your Exchange Hybrid training journey.
        </div>
        
        <h1 class="welcome-title">Master Exchange Hybrid</h1>
        <p class="welcome-subtitle">
            Embark on a comprehensive 4-week journey with 42 hands-on tasks to build
            a complete Exchange Hybrid lab environment, from Domain Controllers to
            Microsoft 365 integration.
        </p>
        
        <div class="welcome-buttons">
            <button class="btn btn-primary btn-large" onclick="showRegisterModal()">
                Start Your Journey
            </button>
            <button class="btn btn-secondary btn-large" onclick="showSignInModal()">
                ðŸ‘¤ Sign In
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="main-content hidden" id="mainContent">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Exchange Hybrid Journey</h1>
            <p class="dashboard-subtitle">Track your progress through 42 hands-on tasks across 4 comprehensive weeks</p>
        </div>

        <!-- Progress Ring -->
        <div class="progress-section">
            <div class="progress-ring">
                <svg viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="54"/>
                    <circle class="progress-ring-fill" cx="60" cy="60" r="54" 
                            stroke-dasharray="0 339.292" id="progressRing"/>
                </svg>
                <div class="progress-text">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
        </div>

        <!-- Week Cards -->
        <div class="weeks-container" id="weeksContainer">
            <!-- Week cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="signInModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('signInModal')">&times;</button>
            <div class="modal-header">
                <h2>Sign In</h2>
                <p style="color: var(--text-secondary);">Welcome back to your training journey</p>
            </div>
            <form id="signInForm" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label class="form-label" for="signInEmail">Email</label>
                    <input type="email" class="form-input" id="signInEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signInPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="signInPassword" name="password" required>
                        <button type="button" onclick="togglePasswordVisibility('signInPassword')" 
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-family: Arial, sans-serif;">
                            &#128065;
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" class="form-checkbox" name="remember">
                        <span>Remember me for 30 days</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary form-submit">Sign In</button>
                <div id="signInMessage"></div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
            <div class="modal-header">
                <h2>Create Account</h2>
                <p style="color: var(--text-secondary);">Start your Exchange Hybrid journey today</p>
            </div>
            <form id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label" for="registerName">Full Name</label>
                    <input type="text" class="form-input" id="registerName" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerEmail">Email</label>
                    <input type="email" class="form-input" id="registerEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="registerPassword" name="password" required>
                        <button type="button" onclick="togglePasswordVisibility('registerPassword')" 
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-family: Arial, sans-serif;">
                            &#128065;
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary form-submit">Create Account</button>
                <div id="registerMessage"></div>
            </form>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('taskDetailModal')">&times;</button>
            <div class="modal-header">
                <h2 id="taskDetailTitle">Task Details</h2>
            </div>
            <div class="task-detail-content" id="taskDetailContent">
                <!-- Task details will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Lab History Modal -->
    <div class="modal" id="labHistoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('labHistoryModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸ“Š Lab History</h2>
                <p style="color: var(--text-secondary);">Your training progress timeline</p>
            </div>
            <div id="labHistoryModalContent">
                <!-- Lab history content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('adminModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸ‘‘ Admin Panel</h2>
                <p style="color: var(--text-secondary);">User progress leaderboard</p>
            </div>
            <div id="adminContent">
                <!-- Admin content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load Task Definitions -->
    <script src="/assets/task-definitions.js"></script>

    <script>
        // Global application state
        const appState = {
            user: null,
            sessionToken: null,
            progress: {},
            authenticated: false,
            labHistory: [],
            tasks: [], // Will be populated from task-definitions.js
            isWelcomeShown: false // Flag to prevent duplicate welcome messages
        };

        // Password visibility toggle
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '&#128064;'; // closed eye
            } else {
                input.type = 'password';
                button.innerHTML = '&#128065;'; // open eye
            }
        }

        // API configuration
        const API_BASE = '/api';

        // Utility functions for cookies (matching old working code)
        const utils = {
            cookies: {
                set(name, value) {
                    const expires = new Date();
                    expires.setTime(expires.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
                    document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/`;
                },
                get(name) {
                    const nameEQ = name + "=";
                    const ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                },
                delete(name) {
                    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                }
            },
            getId(id) {
                return document.getElementById(id);
            }
        };

        // API call function (matching old working code)
        const api = {
            async call(url, options = {}) {
                try {
                    const response = await fetch(url, {
                        method: options.method || 'GET',
                        body: options.body,
                        headers: {
                            ...options.headers
                        }
                    });

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`API returned ${response.status}: Expected JSON response but got ${contentType}`);
                    }

                    const result = await response.json();
                    
                    if (!result.success) {
                        throw new Error(result.message || 'API call failed');
                    }
                    
                    return result;
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
        };

        // Notification system
        const notificationSystem = {
            notifications: [],
            success(message) {
                console.log('âœ… Success:', message);
                this.show(message, 'success');
            },
            error(message) {
                console.log('âŒ Error:', message);
                this.show(message, 'error');
            },
            info(message) {
                console.log('â„¹ï¸ Info:', message);
                this.show(message, 'info');
            },
            show(message, type) {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                // Calculate position based on existing notifications
                const offset = this.notifications.length * 80;
                notification.style.top = `${90 + offset}px`;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.remove();
                    const index = this.notifications.indexOf(notification);
                    if (index > -1) {
                        this.notifications.splice(index, 1);
                        // Reposition remaining notifications
                        this.notifications.forEach((notif, i) => {
                            notif.style.top = `${90 + (i * 80)}px`;
                        });
                    }
                }, 5000);
            }
        };

        // Theme management
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            // Update active states in desktop menu
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.classList.remove('active');
                if ((theme === 'light' && option.classList.contains('jedi')) || 
                    (theme === 'dark' && option.classList.contains('sith'))) {
                    option.classList.add('active');
                }
            });
            
            // Show notification
            if (theme === 'light') {
                notificationSystem.success('ðŸŒŸ Light Jedi theme activated!');
            } else {
                notificationSystem.success('âš¡ Dark Sith theme activated!');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // Authentication system (matching old working code exactly)
        const authSystem = {
            async login(formData) {
                try {
                    const { data } = await api.call('/api/users/login', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const { name, role, email, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, role, email }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, role, email };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        const adminBtn = document.getElementById('adminButton');
                        if (adminBtn) adminBtn.style.display = 'block';
                    }
                    
                    showDashboard();
                    await loadUserProgress();
                    await loadLabHistory();
                    closeModal('signInModal');
                    notificationSystem.success(`Welcome back, ${name}! ðŸŽ‰`);
                } catch (err) {
                    notificationSystem.error(err.message || 'Login failed. Please check your credentials.');
                }
            },
            
            async register(formData) {
                try {
                    const { data } = await api.call('/api/users/register', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const { name, email, role, sessionToken } = data;
                    
                    utils.cookies.set('user', JSON.stringify({ name, email, role }));
                    utils.cookies.set('session', sessionToken);
                    
                    appState.user = { name, email, role };
                    appState.sessionToken = sessionToken;
                    appState.authenticated = true;
                    
                    if (role === 'admin') {
                        const adminBtn = document.getElementById('adminButton');
                        if (adminBtn) adminBtn.style.display = 'block';
                    }
                    
                    showDashboard();
                    await loadUserProgress();
                    await loadLabHistory();
                    closeModal('registerModal');
                    notificationSystem.success(`Welcome to Velocity Lab, ${name}! ðŸš€`);
                } catch (err) {
                    notificationSystem.error(err.message || 'Registration failed. Please try again.');
                }
            },
            
            async logout() {
                try {
                    if (appState.sessionToken) {
                        await api.call('/api/users/logout', { 
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${appState.sessionToken}`
                            }
                        });
                    }
                } catch (err) {
                    console.error('Logout API call failed:', err);
                }
                
                utils.cookies.delete('user');
                utils.cookies.delete('session');
                
                appState.user = null;
                appState.progress = {};
                appState.authenticated = false;
                appState.sessionToken = null;
                appState.labHistory = [];
                
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.style.display = 'none';
                showWelcomeScreen();
                notificationSystem.info('Signed out successfully');
            }
        };

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking session...');
            loadTheme();
            loadTaskDefinitions();
            checkExistingSession();
            setupMobileMenuHandlers();
            setupFormHandlers();
        });

        // Load task definitions from task-definitions.js (Fixed to use window.TASK_DEFINITIONS)
        function loadTaskDefinitions() {
            if (typeof window !== 'undefined' && window.TASK_DEFINITIONS) {
                // Convert object to array format
                appState.tasks = [];
                Object.keys(window.TASK_DEFINITIONS).forEach(taskId => {
                    const task = window.TASK_DEFINITIONS[taskId];
                    appState.tasks.push({
                        id: taskId,
                        title: task.title,
                        description: task.description || 'No description available',
                        week: parseInt(taskId.split('-')[0].replace('week', '')) || 1,
                        category: task.category || 'General'
                    });
                });
                console.log('Task definitions loaded:', appState.tasks.length, 'tasks');
            } else {
                console.warn('Task definitions not loaded from task-definitions.js');
                // Fallback task structure
                appState.tasks = generateFallbackTasks();
            }
        }

        function generateFallbackTasks() {
            const weeks = [
                {
                    title: 'Foundation Setup',
                    tasks: [
                        'Install Windows Server 2012 R2',
                        'Configure Domain Controller',
                        'Create Organizational Units',
                        'Add Domain Users',
                        'Configure DNS',
                        'Setup DHCP',
                        'Join Client Machine',
                        'Test Domain Authentication',
                        'Configure Group Policy',
                        'Create Security Groups',
                        'Configure File Shares',
                        'Verify Network Services'
                    ]
                },
                {
                    title: 'Exchange On-Premises',
                    tasks: [
                        'Install Exchange Server 2016',
                        'Configure Exchange Organization',
                        'Create Mailboxes',
                        'Setup Distribution Groups',
                        'Configure Public Folders',
                        'Setup OWA',
                        'Configure SMTP Connectors',
                        'Setup Message Routing',
                        'Configure Anti-Spam',
                        'Test Internal Mail Flow'
                    ]
                },
                {
                    title: 'Microsoft 365 Setup',
                    tasks: [
                        'Create M365 Tenant',
                        'Configure Domain',
                        'Setup Exchange Online',
                        'Create Cloud Users',
                        'Configure Licensing',
                        'Setup Teams',
                        'Configure SharePoint',
                        'Setup OneDrive',
                        'Configure Compliance',
                        'Test Cloud Services'
                    ]
                },
                {
                    title: 'Hybrid Configuration',
                    tasks: [
                        'Install Azure AD Connect',
                        'Configure Directory Sync',
                        'Setup Hybrid Exchange',
                        'Configure Mail Flow',
                        'Test Hybrid Connectivity',
                        'Migrate Test Mailbox',
                        'Configure Hybrid Features',
                        'Setup Single Sign-On',
                        'Test User Experience',
                        'Document Configuration'
                    ]
                }
            ];

            const tasks = [];
            weeks.forEach((week, weekIndex) => {
                week.tasks.forEach((task, taskIndex) => {
                    tasks.push({
                        id: `week${weekIndex + 1}-task${taskIndex + 1}`,
                        week: weekIndex + 1,
                        title: task,
                        description: `Complete ${task} as part of Week ${weekIndex + 1}`,
                        category: week.title
                    });
                });
            });

            return tasks;
        }

        // Check for existing session using cookies (matching old code)
        function checkExistingSession() {
            const userCookie = utils.cookies.get('user');
            const sessionCookie = utils.cookies.get('session');
            
            if (userCookie && sessionCookie) {
                try {
                    appState.user = JSON.parse(userCookie);
                    appState.sessionToken = sessionCookie;
                    appState.authenticated = true;
                    
                    console.log('Found existing session for:', appState.user.name);
                    showDashboard();
                    loadUserProgress();
                    loadLabHistory();
                } catch (error) {
                    console.error('Session validation failed:', error);
                    utils.cookies.delete('user');
                    utils.cookies.delete('session');
                    showWelcomeScreen();
                }
            } else {
                console.log('No existing session found');
                showWelcomeScreen();
            }
        }

        // Form handlers (matching old working code)
        function setupFormHandlers() {
            const loginForm = utils.getId('signInForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(loginForm);
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    await authSystem.login(formData);
                });
            }

            const registerForm = utils.getId('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const formData = new FormData(registerForm);
                    const name = formData.get('name');
                    const email = formData.get('email');
                    const password = formData.get('password');
                    
                    if (!name || !email || !password) {
                        notificationSystem.error('Please fill in all required fields.');
                        return;
                    }
                    
                    if (password.length < 8) {
                        notificationSystem.error('Password must be at least 8 characters long.');
                        return;
                    }
                    
                    await authSystem.register(formData);
                });
            }
        }

        // Legacy form submission handlers (for compatibility)
        async function handleSignIn(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            await authSystem.login(formData);
        }

        async function handleRegister(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            await authSystem.register(formData);
        }

        // Logout function
        async function logout() {
            await authSystem.logout();
        }

        // Progress management with fallback
        async function loadUserProgress() {
            try {
                if (!appState.sessionToken) {
                    console.warn('No session token available');
                    loadProgressFromLocal();
                    return;
                }

                const response = await fetch(`${API_BASE}/user/progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                // Check if response is actually JSON before parsing
                const contentType = response.headers.get('content-type');
                if (!response.ok || !contentType || !contentType.includes('application/json')) {
                    console.warn(`Progress API unavailable (${response.status}), using local storage`);
                    loadProgressFromLocal();
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    appState.progress = result.data || {};
                    saveProgressToLocal();
                } else {
                    console.warn('API returned error, using local storage:', result.message);
                    loadProgressFromLocal();
                }
            } catch (error) {
                console.warn('API unavailable, using local storage for progress');
                loadProgressFromLocal();
            }
            
            updateProgressDisplay();
            checkLabCompletion();
        }

        function loadProgressFromLocal() {
            const localProgress = localStorage.getItem(`progress_${appState.user?.email}`);
            if (localProgress) {
                appState.progress = JSON.parse(localProgress);
                console.log('âœ… Progress loaded from local storage');
            } else {
                appState.progress = {};
                console.log('ðŸ†• Starting with empty progress');
            }
        }

        function saveProgressToLocal() {
            if (appState.user?.email) {
                localStorage.setItem(`progress_${appState.user.email}`, JSON.stringify(appState.progress));
                console.log('ðŸ’¾ Progress saved to local storage');
            }
        }

        // Lab history management
        async function loadLabHistory() {
            try {
                // Try to load from API first
                if (appState.sessionToken) {
                    const response = await fetch(`${API_BASE}/user/lab-history`, {
                        headers: {
                            'Authorization': `Bearer ${appState.sessionToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const result = await response.json();
                            if (result.success) {
                                appState.labHistory = result.data || [];
                                console.log('âœ… Lab history loaded from API');
                                return;
                            }
                        }
                    }
                }
                
                // Try global storage first (cross-device persistence)
                if (loadLabHistoryFromGlobal()) {
                    console.log('âœ… Lab history loaded from global storage');
                    return;
                }
                
                // Fallback to local storage
                const localHistory = localStorage.getItem(`labHistory_${appState.user?.email}`);
                if (localHistory) {
                    appState.labHistory = JSON.parse(localHistory);
                    console.log('âœ… Lab history loaded from local storage');
                } else {
                    appState.labHistory = [];
                }
                
            } catch (error) {
                console.warn('Lab history API unavailable, using local storage');
                // Try global first, then local
                if (!loadLabHistoryFromGlobal()) {
                    const localHistory = localStorage.getItem(`labHistory_${appState.user?.email}`);
                    appState.labHistory = localHistory ? JSON.parse(localHistory) : [];
                }
                console.log('âœ… Lab history loaded from local storage');
            }
        }

        function saveLabHistoryToLocal() {
            if (appState.user?.email) {
                localStorage.setItem(`labHistory_${appState.user.email}`, JSON.stringify(appState.labHistory));
            }
        }

        function saveLabHistoryToGlobal() {
            // Save to global storage for cross-device persistence
            if (appState.user?.email) {
                const globalHistory = JSON.parse(localStorage.getItem('globalLabHistory') || '{}');
                globalHistory[appState.user.email] = appState.labHistory;
                localStorage.setItem('globalLabHistory', JSON.stringify(globalHistory));
            }
        }

        function loadLabHistoryFromGlobal() {
            // Load from global storage for cross-device access
            if (appState.user?.email) {
                const globalHistory = JSON.parse(localStorage.getItem('globalLabHistory') || '{}');
                if (globalHistory[appState.user.email]) {
                    appState.labHistory = globalHistory[appState.user.email];
                    // Also save to user-specific storage
                    saveLabHistoryToLocal();
                    return true;
                }
            }
            return false;
        }

        function checkLabCompletion() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            
            // Check if lab is completed (all tasks done)
            if (completedTasks === totalTasks && totalTasks > 0) {
                const lastEntry = appState.labHistory[appState.labHistory.length - 1];
                const today = new Date().toISOString().split('T')[0];
                
                // Only add completion if not already completed today
                if (!lastEntry || lastEntry.date !== today || lastEntry.status !== 'completed') {
                    const completionEntry = {
                        session: appState.labHistory.length + 1,
                        date: today,
                        status: 'completed',
                        labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                        completedAt: new Date().toISOString(),
                        tasksCompleted: completedTasks,
                        totalTasks: totalTasks
                    };
                    
                    appState.labHistory.push(completionEntry);
                    saveLabHistoryToLocal();
                    saveLabHistoryToGlobal(); // Save to global storage
                    
                    notificationSystem.success('ðŸŽ‰ Lab completed successfully!');
                }
            }
        }

        // Mobile menu functionality
        function setupMobileMenuHandlers() {
            document.addEventListener('click', function(event) {
                const mobileMenu = document.getElementById('mobileMenu');
                const hamburger = document.getElementById('hamburger');
                
                if (mobileMenu && hamburger && !mobileMenu.contains(event.target) && !hamburger.contains(event.target)) {
                    closeMobileMenu();
                }
            });
        }

        function toggleMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            hamburger.classList.toggle('active');
            mobileMenu.classList.toggle('active');
            
            updateMobileMenuItems();
        }

        function closeMobileMenu() {
            const hamburger = document.getElementById('hamburger');
            const mobileMenu = document.getElementById('mobileMenu');
            
            hamburger.classList.remove('active');
            mobileMenu.classList.remove('active');
            
            // Close theme submenu if open
            closeMobileThemeMenu();
        }

        function updateMobileMenuItems() {
            const mobileMenuItems = document.getElementById('mobileMenuItems');
            
            if (appState.authenticated && appState.user) {
                let adminItem = '';
                if (appState.user.role === 'admin') {
                    adminItem = '<button class="mobile-menu-item" onclick="showAdminPanel(); closeMobileMenu();">ðŸ‘‘ Admin Panel</button>';
                }
                
                mobileMenuItems.innerHTML = `
                    <div style="padding: 0.5rem 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
                        Welcome, ${appState.user.name}
                    </div>
                    <button class="mobile-menu-item" onclick="startLabEnvironment(); closeMobileMenu();">ðŸš€ Start New Lab</button>
                    <button class="mobile-menu-item" onclick="showLabHistoryModal(); closeMobileMenu();">ðŸ“Š Lab History</button>
                    ${adminItem}
                    <button class="mobile-menu-item" onclick="toggleMobileThemeMenu(event)" id="mobileThemeToggle">
                        ðŸŽ¨ Theme â–¶
                    </button>
                    <div id="mobileThemeOptions" style="display: none; padding-left: 1rem; background: var(--bg-secondary);">
                        <button class="mobile-menu-item" onclick="setTheme('light'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">
                            ðŸŒŸ Light Jedi
                        </button>
                        <button class="mobile-menu-item" onclick="setTheme('dark'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">
                            âš¡ Dark Sith
                        </button>
                    </div>
                    <button class="mobile-menu-item" onclick="logout(); closeMobileMenu();">ðŸšª Sign Out</button>
                `;
            } else {
                mobileMenuItems.innerHTML = `
                    <button class="mobile-menu-item secondary" onclick="showSignInModal(); closeMobileMenu();">ðŸ‘¤ Sign In</button>
                    <button class="mobile-menu-item primary" onclick="showRegisterModal(); closeMobileMenu();">ðŸš€ Get Started</button>
                `;
            }
        }

        function toggleMobileThemeMenu(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const themeOptions = document.getElementById('mobileThemeOptions');
            const themeToggle = document.getElementById('mobileThemeToggle');
            
            if (themeOptions && themeToggle) {
                if (themeOptions.style.display === 'none') {
                    themeOptions.style.display = 'block';
                    themeToggle.innerHTML = 'ðŸŽ¨ Theme â–¼';
                } else {
                    themeOptions.style.display = 'none';
                    themeToggle.innerHTML = 'ðŸŽ¨ Theme â–¶';
                }
            }
        }

        function closeMobileThemeMenu() {
            const existingSubmenu = document.getElementById('mobileThemeSubmenu');
            if (existingSubmenu) {
                existingSubmenu.remove();
            }
        }

        function goHome() {
            if (appState.authenticated) {
                return;
            } else {
                showWelcomeScreen();
            }
        }

        // Lab environment functions
        async function startLabEnvironment() {
            try {
                // Reset all progress when starting new lab
                appState.progress = {};
                saveProgressToLocal();
                updateProgressDisplay();
                
                // Add a new lab session entry
                const today = new Date().toISOString().split('T')[0];
                const newSession = {
                    session: appState.labHistory.length + 1,
                    date: today,
                    status: 'started',
                    labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                    startedAt: new Date().toISOString()
                };
                
                // Check if already started today
                const todaySession = appState.labHistory.find(session => 
                    session.date === today && session.status === 'started'
                );
                
                if (!todaySession) {
                    appState.labHistory.push(newSession);
                    saveLabHistoryToLocal();
                    saveLabHistoryToGlobal(); // For cross-device persistence
                }
                
                // Try to call the API if available
                try {
                    const response = await fetch(`${API_BASE}/lab/start`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${appState.sessionToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newSession)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            notificationSystem.success('New lab started!');
                            return;
                        }
                    }
                } catch (apiError) {
                    console.warn('Lab start API failed, continuing with local tracking:', apiError);
                }
                
                // Fallback success message
                notificationSystem.success('New lab started!');
                
            } catch (error) {
                console.error('Failed to start lab:', error);
                notificationSystem.error('Failed to start lab environment. Please try again.');
            }
        }

        function showLabHistoryModal() {
            const content = document.getElementById('labHistoryModalContent');
            
            if (appState.labHistory.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸš€</div>
                        <p>No lab sessions yet!</p>
                        <p style="margin-top: 0.5rem;">Click "Start New Lab" to begin your first training session.</p>
                    </div>
                `;
            } else {
                // Filter buttons
                const filterButtons = `
                    <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <button onclick="filterLabHistory('week')" class="lab-filter-btn" data-filter="week" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Week</button>
                        <button onclick="filterLabHistory('month')" class="lab-filter-btn" data-filter="month" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 30 Days</button>
                        <button onclick="filterLabHistory('quarter')" class="lab-filter-btn" data-filter="quarter" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 3 Months</button>
                        <button onclick="filterLabHistory('halfyear')" class="lab-filter-btn" data-filter="halfyear" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last 6 Months</button>
                        <button onclick="filterLabHistory('year')" class="lab-filter-btn" data-filter="year" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem;">Last Year</button>
                        <button onclick="filterLabHistory('lifetime')" class="lab-filter-btn active" data-filter="lifetime" style="padding: 0.5rem 1rem; border: 1px solid var(--primary); border-radius: 6px; background: var(--primary); color: white; cursor: pointer; font-size: 0.8rem;">Lifetime</button>
                    </div>
                `;
                
                content.innerHTML = filterButtons + `
                    <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                        <strong>Total Sessions: <span id="filteredCount">${appState.labHistory.length}</span></strong>
                    </div>
                    <div id="labHistoryContent">
                        ${generateLabHistoryHTML(appState.labHistory)}
                    </div>
                `;
            }
            
            showModal('labHistoryModal');
        }

        function filterLabHistory(period) {
            const now = new Date();
            let filteredHistory = appState.labHistory;
            
            if (period !== 'lifetime') {
                const cutoffDate = new Date();
                switch(period) {
                    case 'week':
                        cutoffDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        cutoffDate.setDate(now.getDate() - 30);
                        break;
                    case 'quarter':
                        cutoffDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'halfyear':
                        cutoffDate.setMonth(now.getMonth() - 6);
                        break;
                    case 'year':
                        cutoffDate.setFullYear(now.getFullYear() - 1);
                        break;
                }
                
                filteredHistory = appState.labHistory.filter(session => 
                    new Date(session.date) >= cutoffDate
                );
            }
            
            // Update active button
            document.querySelectorAll('.lab-filter-btn').forEach(btn => {
                btn.style.background = 'var(--surface)';
                btn.style.color = 'var(--text)';
                btn.style.border = '1px solid var(--border)';
            });
            
            const activeBtn = document.querySelector(`[data-filter="${period}"]`);
            if (activeBtn) {
                activeBtn.style.background = 'var(--primary)';
                activeBtn.style.color = 'white';
                activeBtn.style.border = '1px solid var(--primary)';
            }
            
            // Update content
            document.getElementById('filteredCount').textContent = filteredHistory.length;
            document.getElementById('labHistoryContent').innerHTML = generateLabHistoryHTML(filteredHistory);
        }

        function generateLabHistoryHTML(history) {
            if (history.length === 0) {
                return '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No sessions found for this period.</div>';
            }
            
            // Sort history with newest first, but in-progress labs at the very top
            const sortedHistory = [...history].sort((a, b) => {
                // In-progress labs go to top
                if (a.status === 'started' && b.status !== 'started') return -1;
                if (b.status === 'started' && a.status !== 'started') return 1;
                
                // Otherwise sort by date (newest first)
                return new Date(b.date) - new Date(a.date);
            });
            
            // Number completed labs sequentially (Lab 1, Lab 2, etc.)
            const completedLabs = history.filter(lab => lab.status === 'completed')
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first for numbering
            
            let labNumberMap = {};
            completedLabs.forEach((lab, index) => {
                labNumberMap[lab.labId] = index + 1;
            });
            
            return sortedHistory.map(session => {
                const isInProgress = session.status === 'started';
                const statusIcon = session.status === 'completed' ? 'âœ…' : 'ðŸš€';
                const statusText = session.status === 'completed' ? 'Completed' : 'In Progress';
                const statusColor = session.status === 'completed' ? 'var(--success)' : 'var(--primary)';
                
                // Get current progress for in-progress labs
                const currentProgress = getCurrentLabProgress();
                const completedTasks = currentProgress.completedTasks || 0;
                
                // Lab title
                let labTitle;
                if (isInProgress) {
                    labTitle = `${statusIcon} Current Lab`;
                } else {
                    const labNumber = labNumberMap[session.labId];
                    labTitle = `${statusIcon} Lab ${labNumber}`;
                }
                
                return `
                    <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">${labTitle}</span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Lab ID: ${session.labId} â€¢ ${new Date(session.date).toLocaleDateString()}
                        </div>
                        ${isInProgress ? 
                            `<div style="color: var(--primary); font-size: 0.8rem; font-weight: 600;">Tasks: ${completedTasks}/42</div>` : 
                            session.tasksCompleted ? 
                            `<div style="color: var(--success); font-size: 0.8rem;">Tasks: ${session.tasksCompleted}/${session.totalTasks}</div>` : 
                            '<div style="color: var(--success); font-size: 0.8rem;">Tasks: 42/42</div>'
                        }
                        ${session.completedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Completed: ${new Date(session.completedAt).toLocaleString()}</div>` : 
                            session.startedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Started: ${new Date(session.startedAt).toLocaleString()}</div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }

        function getCurrentLabProgress() {
            const totalTasks = 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            return { completedTasks, totalTasks };
        }

        // Admin functions
        async function showAdminPanel() {
            try {
                const response = await fetch(`${API_BASE}/admin/users-progress`, {
                    headers: {
                        'Authorization': `Bearer ${appState.sessionToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAdminPanel(result.data);
                } else {
                    notificationSystem.error(`Failed to load admin data: ${result.message}`);
                }
            } catch (error) {
                console.error('Failed to load admin data:', error);
                notificationSystem.error('Failed to load admin panel. Please try again.');
            }
        }

        function displayAdminPanel(users) {
            const content = document.getElementById('adminContent');
            
            if (users.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No users found.</p>';
            } else {
                // Calculate lab counts for each user using global storage
                const globalHistory = JSON.parse(localStorage.getItem('globalLabHistory') || '{}');
                const usersWithLabData = users.map(user => {
                    const labHistory = globalHistory[user.email] || JSON.parse(localStorage.getItem(`labHistory_${user.email}`)) || [];
                    const completedLabs = labHistory.filter(lab => lab.status === 'completed').length;
                    const totalSessions = labHistory.length;
                    
                    return {
                        ...user,
                        completedLabs,
                        totalSessions,
                        labHistory,
                        lastLabDate: labHistory.length > 0 ? labHistory[labHistory.length - 1].date : null
                    };
                });
                
                // Sort by completed labs first, then by progress percentage
                usersWithLabData.sort((a, b) => {
                    if (a.completedLabs !== b.completedLabs) {
                        return b.completedLabs - a.completedLabs; // More completed labs first
                    }
                    return b.progressPercentage - a.progressPercentage; // Higher percentage first
                });
                
                content.innerHTML = `
                    <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Leaderboard - ${users.length} Users</strong>
                        <small style="color: var(--text-secondary);">ðŸ“Š Sorted by Labs Completed & Progress</small>
                    </div>
                    ${usersWithLabData.map((user, index) => {
                        const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : `#${index + 1}`;
                        return `
                            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600; cursor: pointer; color: var(--primary); text-decoration: underline;" 
                                          onclick="showUserLabHistory('${user.name}', '${user.email}')">${medal} ${user.name}</span>
                                    <span style="color: var(--success); font-weight: 600;">${user.progressPercentage}%</span>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                                    ${user.email} â€¢ ${user.role}
                                </div>
                                <div style="background: var(--surface); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 0.5rem;">
                                    <div style="height: 100%; background: var(--success); width: ${user.progressPercentage}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--primary);">${user.completedTasks}/42</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Tasks Done</div>
                                    </div>
                                    <div style="text-align: center; background: var(--bg-secondary); padding: 0.5rem; border-radius: 6px;">
                                        <div style="font-weight: 600; color: var(--success);">${user.completedLabs}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Labs Completed</div>
                                    </div>
                                </div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem; display: flex; justify-content: space-between;">
                                    <span>${user.hasNotes ? 'ðŸ“ Has notes' : 'No notes'}</span>
                                    <span>Sessions: ${user.totalSessions}</span>
                                    <span>Last: ${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : 'Never'}</span>
                                </div>
                                ${user.lastLabDate ? `
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.25rem;">
                                        ðŸ”¬ Last lab: ${new Date(user.lastLabDate).toLocaleDateString()}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                `;
            }
            
            showModal('adminModal');
        }

        function showUserLabHistory(userName, userEmail) {
            const globalHistory = JSON.parse(localStorage.getItem('globalLabHistory') || '{}');
            const userLabHistory = globalHistory[userEmail] || JSON.parse(localStorage.getItem(`labHistory_${userEmail}`)) || [];
            
            const content = document.getElementById('adminContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button onclick="showAdminPanel()" style="background: var(--surface); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; color: var(--text); margin-bottom: 1rem;">
                        â† Back to User List
                    </button>
                    <h3 style="margin: 0;">${userName}'s Lab History</h3>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">ðŸ“§ ${userEmail}</p>
                </div>
                
                ${userLabHistory.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸš€</div>
                        <p>No lab sessions found for this user.</p>
                    </div>
                ` : `
                    <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                        <strong>Total Sessions: ${userLabHistory.length}</strong>
                    </div>
                    ${generateUserLabHistoryHTML(userLabHistory)}
                `}
            `;
        }

        function generateUserLabHistoryHTML(history) {
            // Sort history with newest first, but in-progress labs at the very top
            const sortedHistory = [...history].sort((a, b) => {
                // In-progress labs go to top
                if (a.status === 'started' && b.status !== 'started') return -1;
                if (b.status === 'started' && a.status !== 'started') return 1;
                
                // Otherwise sort by date (newest first)
                return new Date(b.date) - new Date(a.date);
            });
            
            // Number completed labs sequentially (Lab 1, Lab 2, etc.)
            const completedLabs = history.filter(lab => lab.status === 'completed')
                .sort((a, b) => new Date(a.date) - new Date(b.date)); // Oldest first for numbering
            
            let labNumberMap = {};
            completedLabs.forEach((lab, index) => {
                labNumberMap[lab.labId] = index + 1;
            });
            
            return sortedHistory.map(session => {
                const isInProgress = session.status === 'started';
                const statusIcon = session.status === 'completed' ? 'âœ…' : 'ðŸš€';
                const statusText = session.status === 'completed' ? 'Completed' : 'In Progress';
                const statusColor = session.status === 'completed' ? 'var(--success)' : 'var(--primary)';
                
                // Lab title
                let labTitle;
                if (isInProgress) {
                    labTitle = `${statusIcon} Current Lab`;
                } else {
                    const labNumber = labNumberMap[session.labId];
                    labTitle = `${statusIcon} Lab ${labNumber}`;
                }
                
                return `
                    <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">${labTitle}</span>
                            <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                            Lab ID: ${session.labId} â€¢ ${new Date(session.date).toLocaleDateString()}
                        </div>
                        ${session.tasksCompleted ? 
                            `<div style="color: var(--success); font-size: 0.8rem;">Tasks: ${session.tasksCompleted}/${session.totalTasks}</div>` : 
                            isInProgress ?
                            '<div style="color: var(--primary); font-size: 0.8rem;">Tasks: In Progress</div>' :
                            '<div style="color: var(--success); font-size: 0.8rem;">Tasks: 42/42</div>'
                        }
                        ${session.completedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Completed: ${new Date(session.completedAt).toLocaleString()}</div>` : 
                            session.startedAt ? 
                            `<div style="color: var(--text-secondary); font-size: 0.75rem;">Started: ${new Date(session.startedAt).toLocaleString()}</div>` : ''
                        }
                    </div>
                `;
            }).join('');
        }

        // Task detail functionality
        function showTaskDetail(taskId) {
            const taskDefinition = window.TASK_DEFINITIONS && window.TASK_DEFINITIONS[taskId];
            
            if (taskDefinition) {
                document.getElementById('taskDetailTitle').textContent = taskDefinition.title;
                
                // Get or create task progress
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const taskProgress = appState.progress[taskId];
                
                // Create task detail content with notes section
                const notesSection = `
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 1rem; color: var(--text);">ðŸ“ Your Notes</h4>
                        <textarea 
                            id="taskNotes_${taskId}" 
                            placeholder="Add your notes, observations, or troubleshooting steps here..."
                            style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--background); color: var(--text); font-family: inherit; resize: vertical;"
                            onchange="saveTaskNotes('${taskId}')"
                        >${taskProgress.notes || ''}</textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                            ðŸ’¡ Tip: Document any issues, solutions, or key learnings for future reference
                        </div>
                    </div>
                `;
                
                document.getElementById('taskDetailContent').innerHTML = taskDefinition.description + notesSection;
                
                // Add event listeners for subtask checkboxes
                setTimeout(() => {
                    const subtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
                    subtaskCheckboxes.forEach(checkbox => {
                        const step = checkbox.getAttribute('data-step');
                        
                        // Set checkbox state from saved progress
                        if (taskProgress.subtasks && taskProgress.subtasks[step]) {
                            checkbox.checked = taskProgress.subtasks[step].completed;
                            const subtaskItem = checkbox.closest('.subtask-item');
                            if (checkbox.checked) {
                                subtaskItem.classList.add('completed');
                            }
                        }
                        
                        checkbox.addEventListener('change', function() {
                            handleSubtaskChange(taskId, step, this.checked);
                        });
                    });
                }, 100);
                
                showModal('taskDetailModal');
            } else {
                notificationSystem.error('Task details not available');
            }
        }

        function handleSubtaskChange(taskId, step, isCompleted) {
            // Initialize subtasks if not exists
            if (!appState.progress[taskId].subtasks) {
                appState.progress[taskId].subtasks = {};
            }
            
            // Update subtask status
            appState.progress[taskId].subtasks[step] = {
                completed: isCompleted,
                completedAt: isCompleted ? new Date().toISOString() : null
            };
            
            // Update UI
            const checkbox = document.querySelector(`[data-step="${step}"]`);
            const subtaskItem = checkbox.closest('.subtask-item');
            
            if (isCompleted) {
                subtaskItem.classList.add('completed');
            } else {
                subtaskItem.classList.remove('completed');
            }
            
            // Check if all subtasks are completed
            const allSubtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
            const completedSubtasks = Array.from(allSubtaskCheckboxes).filter(cb => cb.checked);
            
            if (completedSubtasks.length === allSubtaskCheckboxes.length && allSubtaskCheckboxes.length > 0) {
                // Auto-complete the main task
                appState.progress[taskId].completed = true;
                appState.progress[taskId].completedAt = new Date().toISOString();
                
                notificationSystem.success(`ðŸŽ‰ Task completed: ${window.TASK_DEFINITIONS[taskId].title}`);
                
                // Update main task checkbox in the week view
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = true;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.add('completed');
                    }
                }
                
                updateProgressDisplay();
            } else if (appState.progress[taskId].completed && completedSubtasks.length < allSubtaskCheckboxes.length) {
                // Uncheck main task if not all subtasks are complete
                appState.progress[taskId].completed = false;
                
                const mainTaskCheckbox = document.querySelector(`input[onchange="toggleTaskCompletion('${taskId}')"]`);
                if (mainTaskCheckbox) {
                    mainTaskCheckbox.checked = false;
                    const taskItem = mainTaskCheckbox.closest('.task-item');
                    if (taskItem) {
                        taskItem.classList.remove('completed');
                    }
                }
                
                updateProgressDisplay();
            }
            
            // Save progress
            saveProgressToLocal();
        }

        function saveTaskNotes(taskId) {
            const notesTextarea = document.getElementById(`taskNotes_${taskId}`);
            if (notesTextarea && appState.progress[taskId]) {
                appState.progress[taskId].notes = notesTextarea.value;
                saveProgressToLocal();
                console.log('ðŸ“ Notes saved for task:', taskId);
            }
        }

        // UI state management
        function showWelcomeScreen() {
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('headerButtons').classList.remove('hidden');
            document.getElementById('userMenu').classList.add('hidden');
            closeMobileMenu();
        }

        function showDashboard() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('headerButtons').classList.add('hidden');
            document.getElementById('userMenu').classList.remove('hidden');
            
            // Update user info
            const userNameEl = document.getElementById('userName');
            if (userNameEl && appState.user) {
                userNameEl.textContent = appState.user.name;
            }
            
            // Show admin button if user is admin
            if (appState.user && appState.user.role === 'admin') {
                const adminBtn = document.getElementById('adminButton');
                if (adminBtn) adminBtn.style.display = 'block';
            }
            
            generateWeekCards();
            updateProgressDisplay();
            closeMobileMenu();
        }

        function generateWeekCards() {
            const container = document.getElementById('weeksContainer');
            if (!container) return;

            const weekGroups = groupTasksByWeek();
            
            container.innerHTML = Object.keys(weekGroups).map(weekNum => {
                const week = weekGroups[weekNum];
                const completedTasks = week.tasks.filter(task => 
                    appState.progress[task.id] && appState.progress[task.id].completed
                ).length;
                const progressPercentage = Math.round((completedTasks / week.tasks.length) * 100);
                
                return `
                    <div class="week-card" onclick="toggleWeekExpansion(${weekNum})">
                        <div class="week-header">
                            <div>
                                <div class="week-title">${week.title}</div>
                                <div class="week-tasks">${completedTasks}/${week.tasks.length} tasks</div>
                            </div>
                            <div class="expand-icon">â–¼</div>
                        </div>
                        <div class="week-progress">
                            <div class="week-progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="week-description">${week.description}</div>
                        
                        <div class="task-list">
                            ${week.tasks.map(task => {
                                const isCompleted = appState.progress[task.id] && appState.progress[task.id].completed;
                                return `
                                    <div class="task-item ${isCompleted ? 'completed' : ''}" onclick="event.stopPropagation()">
                                        <input type="checkbox" class="task-checkbox" 
                                               ${isCompleted ? 'checked' : ''} 
                                               onchange="toggleTaskCompletion('${task.id}')">
                                        <div class="task-content" onclick="showTaskDetail('${task.id}')">
                                            <div class="task-title">${task.title}</div>
                                            <div class="task-description">Click to view step-by-step instructions</div>
                                        </div>
                                        <button class="task-detail-btn" onclick="showTaskDetail('${task.id}')">
                                            View Details
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function groupTasksByWeek() {
            const weeks = {};
            
            appState.tasks.forEach(task => {
                const weekNum = task.week || 1;
                if (!weeks[weekNum]) {
                    weeks[weekNum] = {
                        title: `Week ${weekNum}: ${task.category || 'Training'}`,
                        description: `Complete ${appState.tasks.filter(t => t.week === weekNum).length} tasks in this week`,
                        tasks: []
                    };
                }
                weeks[weekNum].tasks.push(task);
            });
            
            return weeks;
        }

        function toggleWeekExpansion(weekNum) {
            const weekCards = document.querySelectorAll('.week-card');
            const targetCard = weekCards[weekNum - 1];
            
            if (targetCard) {
                targetCard.classList.toggle('expanded');
            }
        }

        async function toggleTaskCompletion(taskId) {
            try {
                // Initialize task progress if not exists
                if (!appState.progress[taskId]) {
                    appState.progress[taskId] = {
                        completed: false,
                        subtasks: {},
                        notes: ''
                    };
                }
                
                const isCompleted = appState.progress[taskId].completed;
                
                // Update local state
                appState.progress[taskId].completed = !isCompleted;
                appState.progress[taskId].completedAt = !isCompleted ? new Date().toISOString() : null;
                
                // Save to local storage
                saveProgressToLocal();
                
                // Update UI immediately
                updateProgressDisplay();
                
                // Check if lab is now completed
                checkLabCompletion();
                
                // TODO: Save to backend
                // await saveTaskProgress(taskId, appState.progress[taskId]);
                
            } catch (error) {
                console.error('Failed to toggle task completion:', error);
                notificationSystem.error('Failed to save progress. Please try again.');
            }
        }

        function getWeekProgress(weekNum) {
            return appState.tasks.filter(task => 
                task.week === weekNum && appState.progress[task.id] && appState.progress[task.id].completed
            ).length;
        }

        function updateProgressDisplay() {
            const totalTasks = appState.tasks.length || 42;
            const completedTasks = Object.values(appState.progress).filter(task => task.completed).length;
            const percentage = Math.round((completedTasks / totalTasks) * 100);
            
            // Update progress ring
            const circumference = 2 * Math.PI * 54; // r = 54
            const offset = circumference - (percentage / 100) * circumference;
            const progressRing = document.getElementById('progressRing');
            if (progressRing) {
                progressRing.style.strokeDasharray = `${circumference - offset} ${circumference}`;
            }
            
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${percentage}%`;
            }
            
            // Update week cards if they exist
            const mainContent = document.getElementById('mainContent');
            if (mainContent && !mainContent.classList.contains('hidden')) {
                generateWeekCards();
            }
            
            // Check for lab completion after updating display
            if (appState.authenticated) {
                checkLabCompletion();
            }
        }

        // Modal management
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
            closeMobileMenu();
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showSignInModal() {
            showModal('signInModal');
        }

        function showRegisterModal() {
            showModal('registerModal');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userMenuDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
            }
        }

        // Close modals and menus when clicking outside
        document.addEventListener('click', function(event) {
            // Close modals when clicking outside
            const modals = document.querySelectorAll('.modal.active');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
            
            // Close user menu when clicking outside
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userMenuDropdown');
            if (userMenu && dropdown && !userMenu.contains(event.target) && dropdown.classList.contains('active')) {
                dropdown.classList.remove('active');
            }
        });

        // Error logging for debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error, e.filename, e.lineno);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>