<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velocity Lab - Exchange Hybrid Training</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    
    <style>
        /* Apple White + Unifi Cloud Color Scheme with Dark Mode */
        :root {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #f8f9fa;
            --background: #ffffff;
            --surface: #f8f9fa;
            --surface-hover: #e9ecef;
            --text: #1d1d1f;
            --text-secondary: #6e6e73;
            --border: #d2d2d7;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --shadow: rgba(0, 0, 0, 0.08);
            --shadow-heavy: rgba(0, 0, 0, 0.15);
            --jedi-glow: #00ff88;
            --sith-glow: #ff0066;
            --bg-secondary: #f0f0f5;
        }

        [data-theme="dark"] {
            --primary: #00a8ff;
            --primary-hover: #0093e6;
            --secondary: #1e1e1e;
            --background: #000000;
            --surface: #1e1e1e;
            --surface-hover: #2e2e2e;
            --text: #ffffff;
            --text-secondary: #a1a1a6;
            --border: #2e3e3e;
            --success: #30d158;
            --warning: #ff9f0a;
            --danger: #ff453a;
            --shadow: rgba(255, 255, 0.1);
            --shadow-heavy: rgba(255, 255, 255, 0.2);
            --bg-secondary: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Background Image */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/assets/images/VelocityBackground.jpg') center/cover no-repeat;
            opacity: 0.08;
            z-index: -1;
        }

        [data-theme="dark"] body::before {
            opacity: 0.05;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            transition: background-color 0.3s ease, border-bottom 0.3s ease;
        }

        [data-theme="dark"] .header {
            background: rgba(0, 0, 0, 0.95);
        }

        /* Logo */
        .logo {
            width: 80px;
            height: 80px;
            background: url('/assets/images/Velocity-Logo.png') center/contain no-repeat;
            cursor: pointer;
        }

        [data-theme="dark"] .logo {
            filter: brightness(1.2);
        }

        /* Desktop Navigation */
        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Hamburger Menu */
        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .hamburger:hover {
            background-color: var(--surface-hover-bg);
        }

        .hamburger span {
            width: 24px;
            height: 2px;
            background: var(--text);
            margin: 3px 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-radius: 1px;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(2) {
            transform: none;
            opacity: 1;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        /* Mobile Menu Overlay */
        .mobile-menu {
            position: fixed;
            top: 70px;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
            padding: 1rem;
        }

        [data-theme="dark"] .mobile-menu {
            background: rgba(0, 0, 0, 0.98);
        }

        .mobile-menu.active {
            transform: translateY(0);
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
        }

        .mobile-menu-item:hover, .mobile-menu-item.primary {
            background-color: var(--primary);
            color: white;
        }

        .mobile-menu-item.secondary {
            border: 1px solid var(--border);
        }

        /* Theme Menu */
        .theme-menu-item {
            position: relative;
        }

        .theme-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            color: var(--text);
            border: none;
            background: none;
            width: 100%;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .theme-menu-toggle:hover {
            background-color: var(--surface-hover-bg);
        }

        .theme-submenu {
            position: absolute;
            right: 100%;
            top: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 150px;
            z-index: 1001;
            display: none;
        }

        .theme-menu-item:hover .theme-submenu {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        .theme-option {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            text-decoration: none;
            font-size: 14px;
        }

        .theme-option:hover {
            background-color: var(--surface-hover-bg);
        }

        .theme-option.active {
            background: var(--primary);
            color: white;
        }

        .theme-option.jedi:hover {
            background: linear-gradient(45deg, var(--jedi-glow), #00ff88);
            color: white;
        }

        .theme-option.sith:hover {
            background: linear-gradient(45deg, var(--sith-glow), #ff0066);
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: var(--surface-hover-bg);
        }

        /* Welcome Screen */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            position: relative;
        }

        .welcome-notification {
            position: absolute;
            top: 100px;
            left: 2rem;
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            max-width: 300px;
            animation: slideInLeft 0.5s ease;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .welcome-title {
            font-size: clamp(3rem, 8vw, 5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--text), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        .welcome-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-large {
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 12px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--background);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px var(--shadow-heavy);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content.large {
            max-width: 800px;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px;
            border-radius: 6px;
        }

        .modal-close:hover {
            background-color: var(--surface-hover-bg);
        }

        /* Task Detail Modal */
        .task-detail-content {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem 0;
        }

        .subtask-container {
            margin: 1rem 0;
        }

        .subtask-item {
            display: flex;
            align-items: flex-start;
            margin: 0.75rem 0;
            padding: 0.5rem;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }

        .subtask-item:hover {
            background-color: var(--surface-hover-bg);
        }

        .subtask-checkbox {
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            cursor: pointer;
        }

        .subtask-item label {
            cursor: pointer;
            line-height: 1.4;
        }

        .subtask-item.completed {
            opacity: 0.7;
        }

        .subtask-item.completed label {
            text-decoration: line-through;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--background);
            color: var(--text);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 255, 0.1);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .form-submit {
            width: 100%;
            margin-top: 1rem;
        }

        /* Main Dashboard */
        .main-content {
            margin-top: 70px;
            padding: 2rem;
            min-height: calc(100vh - 70px);
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .dashboard-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Progress Ring */
        .progress-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .progress-ring {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: var(--surface);
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Week Cards */
        .weeks-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .week-card {
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-heavy);
        }

        .week-card.expanded {
            cursor: default;
        }

        .week-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .week-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text);
        }

        .week-tasks {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .week-progress {
            height: 6px;
            background: var(--surface);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .week-progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.5s ease;
        }

        .week-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .week-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Task List */
        .task-list {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
        }

        .week-card.expanded .task-list {
            display: block;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .task-item:hover {
            background-color: var(--surface-hover-bg);
        }

        .task-checkbox {
            margin-right: 1rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-weight: 500;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .task-item.completed {
            opacity: 0.7;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-detail-btn {
            margin-left: 1rem;
            padding: 4px 8px;
            font-size: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .task-item:hover .task-detail-btn {
            opacity: 1;
        }

        /* User Menu */
        .user-menu {
            position: relative;
        }

        .user-menu-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text);
            transition: background-color 0.2s ease;
        }

        .user-menu-toggle:hover {
            background-color: var(--surface-hover-bg);
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-heavy);
            min-width: 200px;
            z-index: 1000;
            display: none;
        }

        .user-menu-dropdown.active {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }

        @keyframes dropdownSlide {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-menu-item {
            display: block;
            width: 100%;
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            transition: background-color 0.2s ease;
            text-decoration: none;
        }

        .user-menu-item:hover {
            background-color: var(--surface-hover-bg);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
                justify-content: center;
                position: relative;
            }

            .logo {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                width: 100px;
                height: 100px;
            }

            .header-buttons {
                display: none;
            }

            .hamburger {
                display: flex;
                position: absolute;
                right: 1rem;
            }

            .user-menu {
                display: none;
            }

            .welcome-screen {
                padding: 1rem;
            }

            .welcome-notification {
                position: static;
                margin-bottom: 2rem;
                max-width: none;
            }

            .welcome-title {
                font-size: 2.5rem;
            }

            .welcome-buttons {
                flex-direction: column;
                width: 100%;
                max-width: 300px;
            }

            .btn-large {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 1rem;
                margin-top: 70px;
            }

            .dashboard-title {
                font-size: 2rem;
            }

            .dashboard-subtitle {
                font-size: 1rem;
            }

            .progress-ring {
                width: 150px;
                height: 150px;
            }

            .progress-percentage {
                font-size: 1.5rem;
            }

            .weeks-container {
                gap: 1rem;
            }

            .week-card {
                padding: 1rem;
            }

            .week-title {
                font-size: 1.1rem;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .btn {
                font-size: 0.9rem;
                padding: 10px 16px;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
                padding: 0 0.75rem;
            }

            .main-content {
                margin-top: 60px;
                padding: 0.75rem;
            }

            .mobile-menu {
                top: 60px;
            }

            .logo {
                width: 90px;
                height: 90px;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .modal {
                padding: 0.5rem;
            }

            .modal-content {
                padding: 1rem;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .message.error {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        /* Hidden Elements */
        .hidden {
            display: none !important;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 90px;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--danger);
            color: white;
        }

        .notification.info {
            background: var(--primary);
            color: white;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Header -->
    <div class="header" id="header">
        <div class="logo" onclick="goHome()"></div>
        <div class="header-buttons" id="headerButtons">
            <button class="btn btn-secondary" onclick="showSignInModal()">Sign In</button>
            <button class="btn btn-primary" onclick="showRegisterModal()">Get Started</button>
        </div>
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <div class="user-menu hidden" id="userMenu">
            <button class="user-menu-toggle" onclick="toggleUserMenu()">
                <span id="userName">User</span>
                <span>▼</span>
            </button>
            <div class="user-menu-dropdown" id="userMenuDropdown">
                <button class="user-menu-item" onclick="startLabEnvironment()">🚀 Start New Lab</button>
                <button class="user-menu-item" onclick="showLabHistoryModal()">📊 Lab History</button>
                <button class="user-menu-item" onclick="showAdminPanel()" id="adminButton" style="display: none;">👑 Admin Panel</button>
                <div class="theme-menu-item">
                    <button class="theme-menu-toggle">
                        <span>🎨 Theme</span>
                        <span>▶</span>
                    </button>
                    <div class="theme-submenu">
                        <button class="theme-option jedi" onclick="setTheme('light')">🌟 Light Jedi</button>
                        <button class="theme-option sith active" onclick="setTheme('dark')">⚡ Dark Sith</button>
                    </div>
                </div>
                <button class="user-menu-item" onclick="logout()">🚪 Sign Out</button>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-items" id="mobileMenuItems"></div>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-notification">
            👋 Welcome to Velocity Lab! Sign in to access your Exchange Hybrid training journey.
        </div>
        <h1 class="welcome-title">Master Exchange Hybrid</h1>
        <p class="welcome-subtitle">
            Embark on a comprehensive 4-week journey with 42 hands-on tasks to build
            a complete Exchange Hybrid lab environment, from Domain Controllers to
            Microsoft 365 integration.
        </p>
        <div class="welcome-buttons">
            <button class="btn btn-secondary btn-large" onclick="showSignInModal()">👤 Sign In</button>
            <button class="btn btn-primary btn-large" onclick="showRegisterModal()">🚗 Get Started</button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="main-content hidden" id="mainContent">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Exchange Hybrid Journey</h1>
            <p class="dashboard-subtitle">Track your progress through 42 hands-on tasks across 4 comprehensive weeks</p>
        </div>
        <div class="progress-section">
            <div class="progress-ring">
                <svg viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="54"/>
                    <circle class="progress-ring-fill" cx="60" cy="60" r="54" stroke-dasharray="0 339.292" id="progressRing"/>
                </svg>
                <div class="progress-text">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-label">Complete</div>
                </div>
            </div>
        </div>
        <div class="weeks-container" id="weeksContainer"></div>
    </div>

    <!-- Sign In Modal -->
    <div class="modal" id="signInModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('signInModal')">×</button>
            <div class="modal-header">
                <h2>Sign In</h2>
                <p style="color: var(--text-secondary);">Welcome back to your training journey</p>
            </div>
            <form id="signInForm">
                <div class="form-group">
                    <label class="form-label" for="signInEmail">Email</label>
                    <input type="email" class="form-input" id="signInEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="signInPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="signInPassword" name="password" required>
                        <button type="button" onclick="togglePasswordVisibility('signInPassword')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-family: Arial, sans-serif;">👁</button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" class="form-checkbox" name="remember">
                        <span>Remember me for 30 days</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary form-submit">Sign In</button>
                <div id="signInMessage" class="message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('registerModal')">×</button>
            <div class="modal-header">
                <h2>Create Account</h2>
                <p style="color: var(--text-secondary);">Start your Exchange Hybrid journey today</p>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="registerName">Full Name</label>
                    <input type="text" class="form-input" id="registerName" name="name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerEmail">Email</label>
                    <input type="email" class="form-input" id="registerEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="registerPassword">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="registerPassword" name="password" required>
                        <button type="button" onclick="togglePasswordVisibility('registerPassword')" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-secondary); font-family: Arial, sans-serif;">👁</button>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center;">
                        <input type="checkbox" class="form-checkbox" name="remember">
                        <span>Remember me for 30 days</span>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary form-submit">Create Account</button>
                <div id="registerMessage" class="message hidden"></div>
            </form>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('taskDetailModal')">×</button>
            <div class="modal-header">
                <h2 id="taskDetailTitle">Task Details</h2>
            </div>
            <div class="task-detail-content" id="taskDetailContent"></div>
        </div>
    </div>

    <!-- Lab History Modal -->
    <div class="modal" id="labHistoryModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('labHistoryModal')">×</button>
            <div class="modal-header">
                <h2>📊 Lab History</h2>
                <p style="color: var(--text-secondary);">Your training progress timeline</p>
            </div>
            <div id="labHistoryModalContent"></div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeModal('adminModal')">×</button>
            <div class="modal-header">
                <h2>👑 Admin Panel</h2>
                <p style="color: var(--text-secondary);">User progress leaderboard</p>
            </div>
            <div id="adminContent"></div>
        </div>
    </div>

    <!-- Load Task Definitions -->
    <script src="/assets/task-definitions.js"></script>

<script>
// Global application state
const appState = {
    user: null,
    sessionToken: null,
    progress: {},
    preferences: { theme: 'dark' },
    authenticated: false,
    labHistory: [],
    tasks: [],
    isWelcomeShown: false
};

// Utility functions
const utils = {
    getId(id) { return document.getElementById(id); },
    setText(id, text) { const el = this.getId(id); if (el) el.textContent = text; },
    showElement(id) { const el = this.getId(id); if (el) el.classList.remove('hidden'); },
    hideElement(id) { const el = this.getId(id); if (el) el.classList.add('hidden'); },
    cookies: {
        set(name, value, days = 30) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value}; expires=${expires.toUTCString()}; path=/; SameSite=Strict`;
        },
        get(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let c of ca) {
                c = c.trim();
                if (c.startsWith(nameEQ)) return c.substring(nameEQ.length);
            }
            return null;
        },
        delete(name) {
            document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Strict`;
        }
    }
};

// API configuration
const API_BASE = '/api';
const api = {
    async call(endpoint, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            ...(appState.sessionToken && { 'Authorization': `Bearer ${appState.sessionToken}` }),
            ...options.headers
        };
        try {
            const response = await fetch(`${API_BASE}/${endpoint}`, {
                method: options.method || 'GET',
                headers,
                body: options.body ? JSON.stringify(options.body) : options.formData
            });
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error(`Expected JSON, got ${contentType}`);
            }
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.message || 'API call failed');
            }
            return result.data;
        } catch (error) {
            console.error(`API call failed: ${endpoint}`, error);
            throw error;
        }
    }
};

// Notification system
const notificationSystem = {
    notifications: [],
    show(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        const offset = this.notifications.length * 80;
        notification.style.top = `${90 + offset}px`;
        document.body.appendChild(notification);
        this.notifications.push(notification);
        setTimeout(() => {
            notification.remove();
            const index = this.notifications.indexOf(notification);
            if (index > -1) {
                this.notifications.splice(index, 1);
                this.notifications.forEach((notif, i) => {
                    notif.style.top = `${90 + (i * 80)}px`;
                });
            }
        }, 5000);
    },
    success(message) { this.show(message, 'success'); },
    error(message) { this.show(message, 'error'); },
    info(message) { this.show(message, 'info'); }
};

// Theme management
function setTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    appState.preferences.theme = theme;
    const themeOptions = document.querySelectorAll('.theme-option');
    themeOptions.forEach(opt => {
        opt.classList.toggle('active', opt.classList.contains(theme === 'light' ? 'jedi' : 'sith'));
    });
    saveUserPreferences();
    notificationSystem.success(theme === 'light' ? '🌟 Light Jedi theme activated!' : '⚡ Dark Sith theme activated!');
}

async function loadTheme() {
    try {
        const prefs = await api.call('users/preferences');
        setTheme(prefs.theme || 'dark');
    } catch {
        setTheme(appState.preferences.theme);
    }
}

// Authentication system
const authSystem = {
    async login(formData) {
        try {
            const { id, email, name, role, sessionToken } = await api.call('users/login', {
                method: 'POST',
                formData
            });
            appState.user = { id, email, name, role };
            appState.sessionToken = sessionToken;
            appState.authenticated = true;
            if (role === 'admin') utils.getId('adminButton').style.display = 'block';
            await Promise.all([loadUserProgress(), loadLabHistory(), loadTheme()]);
            showDashboard('success', `Welcome back, ${name}! 🎉`);
            closeModal('signInModal');
        } catch (error) {
            notificationSystem.error(error.message || 'Login failed. Please check your credentials.');
        }
    },
    async register(formData) {
        try {
            const { id, email, name, role, sessionToken } = await api.call('users/register', {
                method: 'POST',
                formData
            });
            appState.user = { id, email, name, role };
            appState.sessionToken = sessionToken;
            appState.authenticated = true;
            if (role === 'admin') utils.getId('adminButton').style.display = 'block';
            await Promise.all([loadUserProgress(), loadLabHistory(), loadTheme()]);
            showDashboard('success', `Welcome to Velocity Lab, ${name}! 🚀`);
            closeModal('registerModal');
        } catch (error) {
            notificationSystem.error(error.message || 'Registration failed. Please try again.');
        }
    },
    async logout() {
        try {
            if (appState.sessionToken) {
                await api.call('users/logout', { method: 'POST' });
            }
        } catch {}
        appState.user = null;
        appState.sessionToken = null;
        appState.authenticated = false;
        appState.progress = {};
        appState.labHistory = [];
        appState.preferences = { theme: 'dark' };
        utils.getId('adminButton').style.display = 'none';
        showWelcomeScreen();
        notificationSystem.info('Signed out successfully');
    },
    async checkSession() {
        try {
            const user = await api.call('users/login');
            appState.user = user;
            appState.sessionToken = user.sessionToken;
            appState.authenticated = true;
            if (user.role === 'admin') utils.getId('adminButton').style.display = 'block';
            await Promise.all([loadUserProgress(), loadLabHistory(), loadTheme()]);
            return true;
        } catch {
            return false;
        }
    }
};

// Task definitions
function loadTaskDefinitions() {
    if (window.TASK_DEFINITIONS) {
        appState.tasks = Object.entries(window.TASK_DEFINITIONS).map(([id, task]) => ({
            id,
            title: task.title,
            description: task.description || 'No description available.',
            week: parseInt(id.split('-')[0].replace('week', '')) || 1,
            category: task.category || 'General',
            subtasks: task.subtasks || [
                { id: 'st1', description: `Prepare environment for ${task.title.toLowerCase()}` },
                { id: 'st2', description: `Execute ${task.title.toLowerCase()}` },
                { id: 'st3', description: `Verify ${task.title.toLowerCase()} functionality` }
            ]
        }));
        console.log(`Loaded ${appState.tasks.length} tasks from task-definitions.js`);
    } else {
        console.warn('task-definitions.js not loaded, using fallback tasks');
        appState.tasks = generateFallbackTasks();
    }
}

function generateFallbackTasks() {
    const weeks = [
        { title: 'Foundation Setup', tasks: [
            'Install Windows Server 2012 R2', 'Configure Domain Controller', 'Create Organizational Units',
            'Add Domain Users', 'Configure DNS', 'Setup DHCP', 'Join Client Machine',
            'Test Domain Authentication', 'Configure Group Policy', 'Create Security Groups',
            'Configure File Shares', 'Verify Network Services'
        ]},
        { title: 'Exchange On-Premises', tasks: [
            'Install Exchange Server 2016', 'Configure Exchange Organization', 'Create Mailboxes',
            'Setup Distribution Groups', 'Configure Public Folders', 'Setup OWA',
            'Configure SMTP Connectors', 'Setup Message Routing', 'Configure Anti-Spam',
            'Test Internal Mail Flow'
        ]},
        { title: 'Microsoft 365 Setup', tasks: [
            'Create M365 Tenant', 'Configure Domain', 'Setup Exchange Online',
            'Create Cloud Users', 'Configure Licensing', 'Setup Teams',
            'Configure SharePoint', 'Setup OneDrive', 'Configure Compliance',
            'Test Cloud Services'
        ]},
        { title: 'Hybrid Configuration', tasks: [
            'Install Azure AD Connect', 'Configure Directory Sync', 'Setup Hybrid Exchange',
            'Configure Mail Flow', 'Test Hybrid Connectivity', 'Migrate Test Mailbox',
            'Configure Hybrid Features', 'Setup Single Sign-On', 'Test User Experience',
            'Document Configuration', 'Verify Hybrid Setup', 'Finalize Migration'
        ]}
    ];

    return weeks.flatMap((week, weekIndex) => 
        week.tasks.map((task, taskIndex) => ({
            id: `week-${weekIndex + 1}-task-${taskIndex + 1}`,
            title: task,
            description: `Complete the ${task.toLowerCase()} task for ${week.title.toLowerCase()}.`,
            week: weekIndex + 1,
            category: week.title,
            subtasks: [
                { id: `st1`, description: `Prepare environment for ${task.toLowerCase()}` },
                { id: `st2`, description: `Execute ${task.toLowerCase()}` },
                { id: `st3`, description: `Verify ${task.toLowerCase()} functionality` }
            ]
        }))
    );
}

// Task detail functionality
window.showTaskDetail = function(taskId) {
    const task = appState.tasks.find(t => t.id === taskId);
    if (!task) {
        notificationSystem.error('Task details not found.');
        return;
    }
    utils.setText('taskDetailTitle', task.title);
    if (!appState.progress[taskId]) {
        appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
    }
    const progress = appState.progress[taskId];
    const notesSection = `
        <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
            <h4 style="margin-bottom: 1rem; color: var(--text);">📝 Notes</h4>
            <textarea id="taskNotes_${taskId}" placeholder="Add notes..." style="width: 100%; min-height: 100px; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--background); color: var(--text); resize: vertical;" onchange="saveTaskNotes('${taskId}')">${progress.notes || ''}</textarea>
        </div>
    `;
    const subtaskContent = task.subtasks.length ? `
        <div class="subtask-container">
            <h4 style="margin-bottom: 1rem; color: var(--text);">✅ Subtasks</h4>
            ${task.subtasks.map(subtask => `
                <div class="subtask-item ${progress.subtasks[subtask.id]?.completed ? 'completed' : ''}">
                    <input type="checkbox" class="subtask-checkbox" id="subtask_${taskId}_${subtask.id}" ${progressSubtask[subtask.id]?.completed ? 'checked' : ''} onchange="updateSubtask('${taskId}', '${subtask.id}')">
                    <label for="subtask_${taskId}_${subtask.id}">${subtask.description}</label>
                </div>
            `).join('')}
        </div>
    ` : '';
    utils.getId('taskDetailContent').innerHTML = `
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">${task.description}</p>
        ${subtaskContent}
        ${notesSection}
    `;
    showModal('taskDetailModal');
};

window.saveTaskNotes = async function(taskId) {
    const notes = utils.getId(`taskNotes_${taskId}`)?.value || '';
    appState.progress[taskId].notes = notes;
    await saveUserProgress();
};

window.updateSubtask = async function(taskId, subtaskId) {
    if (!appState.progress[taskId]) {
        appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
    }
    const completed = utils.getId(`subtask_${taskId}_${subtaskId}`).checked;
    appState.progress[taskId].subtasks[subtaskId] = { completed, completedAt: completed ? new Date().toISOString() : null };
    const task = appState.tasks.find(t => t.id === taskId);
    const allSubtasksCompleted = task.subtasks.every(st => appState.progress[taskId].subtasks[st.id]?.completed);
    appState.progress[taskId].completed = allSubtasksCompleted;
    if (allSubtasksCompleted) {
        notificationSystem.success(`🎉 Task completed: ${task.title}`);
    }
    await saveUserProgress();
    updateProgressDisplay();
    generateWeekCards();
};

// Progress management
async function loadUserProgress() {
    try {
        const progress = await api.call('users/progress');
        appState.progress = progress || {};
        updateProgressDisplay();
        generateWeekCards();
    } catch (error) {
        notificationSystem.error('Failed to load progress from server.');
        appState.progress = {};
    }
}

async function saveUserProgress() {
    if (!appState.authenticated) return;
    try {
        await api.call('users/progress', {
            method: 'POST',
            body: appState.progress
        });
    } catch (error) {
        notificationSystem.error('Failed to sync progress with server.');
    }
}

function updateProgressDisplay() {
    const totalTasks = appState.tasks.length || 42;
    const completedTasks = Object.values(appState.progress).filter(p => p.completed).length;
    const percentage = totalTasks ? Math.round((completedTasks / totalTasks) * 100) : 0;
    const circumference = 339.292; // 2 * π * 54
    const dashArray = (percentage / 100) * circumference;
    const progressRing = utils.getId('progressRing');
    if (progressRing) {
        progressRing.setAttribute('stroke-dasharray', `${dashArray} ${circumference}`);
    }
    utils.setText('progressPercentage', `${percentage}%`);
    checkLabCompletion();
}

// Lab history management
async function loadLabHistory() {
    try {
        const history = await api.call('users/history');
        appState.labHistory = Array.isArray(history) ? history : [];
    } catch (error) {
        notificationSystem.error('Failed to load lab history from server.');
        appState.labHistory = [];
    }
}

async function saveLabHistory() {
    if (!appState.authenticated) return;
    try {
        await api.call('users/history', {
            method: 'POST',
            body: appState.labHistory
        });
    } catch (error) {
        notificationSystem.error('Failed to sync lab history with server.');
    }
}

window.startLabEnvironment = async function() {
    try {
        appState.progress = {};
        await saveUserProgress();
        const today = new Date().toISOString().split('T')[0];
        const existingSession = appState.labHistory.find(s => s.date === today && s.status === 'started');
        if (!existingSession) {
            const newSession = {
                session: appState.labHistory.length + 1,
                date: today,
                status: 'started',
                labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                startedAt: new Date().toISOString()
            };
            appState.labHistory.push(newSession);
            await saveLabHistory();
        }
        notificationSystem.success('New lab started!');
        updateProgressDisplay();
        generateWeekCards();
    } catch (error) {
        notificationSystem.error('Failed to start lab environment.');
    }
};

window.showLabHistoryModal = function() {
    const content = utils.getId('labHistoryModalContent');
    if (!appState.labHistory.length) {
        content.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🚀</div>
                <p>No lab sessions yet!</p>
                <p style="margin-top: 0.5rem;">Click "Start New Lab" to begin your first training session.</p>
            </div>
        `;
    } else {
        content.innerHTML = `
            <div style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                ${['week', 'month', 'quarter', 'halfyear', 'year', 'lifetime'].map(period => `
                    <button onclick="filterLabHistory('${period}')" class="lab-filter-btn ${period === 'lifetime' ? 'active' : ''}" data-filter="${period}" style="padding: 0.5rem 1rem; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); cursor: pointer; font-size: 0.8rem; ${period === 'lifetime' ? 'background: var(--primary); color: white; border-color: var(--primary);' : ''}">
                        ${period === 'week' ? 'Last Week' : period === 'month' ? 'Last 30 Days' : period === 'quarter' ? 'Last 3 Months' : period === 'halfyear' ? 'Last 6 Months' : period === 'year' ? 'Last Year' : 'Lifetime'}
                    </button>
                `).join('')}
            </div>
            <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                <strong>Total Sessions: <span id="filteredCount">${appState.labHistory.length}</span></strong>
            </div>
            <div id="labHistoryContent">
                ${generateLabHistoryHTML(appState.labHistory)}
            </div>
        `;
    }
    showModal('labHistoryModal');
};

window.filterLabHistory = function(period) {
    const now = new Date();
    let filteredHistory = appState.labHistory;
    if (period !== 'lifetime') {
        const cutoff = new Date();
        switch (period) {
            case 'week': cutoff.setDate(now.getDate() - 7); break;
            case 'month': cutoff.setDate(now.getDate() - 30); break;
            case 'quarter': cutoff.setMonth(now.getMonth() - 3); break;
            case 'halfyear': cutoff.setMonth(now.getMonth() - 6); break;
            case 'year': cutoff.setFullYear(now.getFullYear() - 1); break;
        }
        filteredHistory = appState.labHistory.filter(s => new Date(s.date) >= cutoff);
    }
    document.querySelectorAll('.lab-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--surface)';
        btn.style.color = 'var(--text)';
        btn.style.border = '1px solid var(--border)';
    });
    const activeBtn = document.querySelector(`[data-filter="${period}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.background = 'var(--primary)';
        activeBtn.style.color = 'white';
        activeBtn.style.border = '1px solid var(--primary)';
    }
    utils.getId('filteredCount').textContent = filteredHistory.length;
    utils.getId('labHistoryContent').innerHTML = generateLabHistoryHTML(filteredHistory);
};

function generateLabHistoryHTML(history) {
    if (!history.length) {
        return '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No sessions found for this period.</div>';
    }
    const sortedHistory = [...history].sort((a, b) => {
        if (a.status === 'started' && b.status !== 'started') return -1;
        if (b.status === 'started' && a.status !== 'started') return 1;
        return new Date(b.date) - new Date(a.date);
    });
    const completedLabs = history.filter(l => l.status === 'completed').sort((a, b) => new Date(a.date) - new Date(b.date));
    const labNumberMap = Object.fromEntries(completedLabs.map((l, i) => [l.labId, i + 1]));
    return sortedHistory.map(session => {
        const isInProgress = session.status === 'started';
        const statusIcon = session.status === 'completed' ? '✅' : '🚀';
        const statusText = session.status === 'completed' ? 'Completed' : 'In Progress';
        const statusColor = session.status === 'completed' ? 'var(--success)' : 'var(--primary)';
        const labTitle = isInProgress ? `${statusIcon} Current Lab` : `${statusIcon} Lab ${labNumberMap[session.labId]}`;
        const completedTasks = isInProgress ? Object.values(appState.progress).filter(p => p.completed).length : session.tasksCompleted || 42;
        return `
            <div style="padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600;">${labTitle}</span>
                    <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span>
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem;">
                    Lab ID: ${session.labId} • ${new Date(session.date).toLocaleDateString()}
                </div>
                <div style="color: ${isInProgress ? 'var(--primary)' : 'var(--success)'}; font-size: 0.8rem;">
                    Tasks: ${completedTasks}/42
                </div>
                ${session.completedAt ? `
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">
                        Completed: ${new Date(session.completedAt).toLocaleString()}
                    </div>` : `
                    <div style="color: var(--text-secondary); font-size: 0.75rem;">
                        Started: ${new Date(session.startedAt).toLocaleString()}
                    </div>`}
            </div>
        `;
    }).join('');
}

// Admin panel
window.showAdminPanel = async function() {
    if (appState.user?.role !== 'admin') {
        notificationSystem.error('Access denied. Admin privileges required.');
        return;
    }
    const content = utils.getId('adminContent');
    content.innerHTML = '<p style="text-align: center;">Loading user progress...</p>';
    showModal('adminModal');
    try {
        const data = await api.call('admin/users-progress');
        if (!Array.isArray(data.users) || !data.users.length) {
            content.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No user progress data available.</p>';
            return;
        }
        content.innerHTML = `
            <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border); border-radius: 8px;">
                <h3 style="margin-bottom: 0.5rem;">📊 Summary</h3>
                <p>Total Users: ${data.summary.totalUsers}</p>
                <p>Active Users (Last 7 Days): ${data.summary.activeUsers}</p>
                <p>Total Completed Tasks: ${data.summary.totalCompletedTasks}</p>
                <p>Total Completed Labs: ${data.summary.totalCompletedLabs}</p>
                <p>Average Progress: ${data.summary.averageProgress}%</p>
                ${data.summary.topPerformer ? `
                    <p>Top Performer: ${data.summary.topPerformer.name} (${data.summary.topPerformer.progressPercentage}%)</p>
                ` : ''}
            </div>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                        <th style="padding: 1rem; text-align: left;">Rank</th>
                        <th style="padding: 1rem; text-align: left;">User</th>
                        <th style="padding: 1rem; text-align: left;">Progress</th>
                        <th style="padding: 1rem; text-align: left;">Labs</th>
                        <th style="padding: 1rem; text-align: left;">Last Active</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.users.map(user => `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem;">${user.leaderboardPosition} ${user.medal || ''}</td>
                            <td style="padding: 1rem;">
                                <span style="cursor: pointer; color: var(--primary); text-decoration: underline;" onclick="showUserLabHistory('${user.name}', '${user.email}')">${user.name}</span> (${user.email})
                            </td>
                            <td style="padding: 1rem;">${user.completedTasks}/42 tasks (${user.completionRate}%)</td>
                            <td style="padding: 1rem;">${user.completedLabs}/${user.totalSessions} labs</td>
                            <td style="padding: 1rem;">${user.lastActive ? new Date(user.lastActive).toLocaleString() : 'N/A'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (error) {
        content.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Unable to load user progress from server.</p>';
        notificationSystem.error('Admin panel temporarily unavailable.');
    }
};

window.showUserLabHistory = async function(userName, userEmail) {
    const content = utils.getId('adminContent');
    try {
        const history = await api.call(`users/history?email=${encodeURIComponent(userEmail)}`);
        content.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <button onclick="showAdminPanel()" style="background: var(--surface); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; color: var(--text); margin-bottom: 1rem;">
                    ← Back to User List
                </button>
                <h3 style="margin: 0;">${userName}'s Lab History</h3>
                <p style="color: var(--text-secondary); margin: 0.5rem 0;">📧 ${userEmail}</p>
            </div>
            ${!history.length ? `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🚀</div>
                    <p>No lab sessions found for this user.</p>
                </div>
            ` : `
                <div style="margin-bottom: 1rem; color: var(--text-secondary);">
                    <strong>Total Sessions: ${history.length}</strong>
                </div>
                ${generateLabHistoryHTML(history)}
            `}
        `;
    } catch (error) {
        content.innerHTML = `
            <div style="margin-bottom: 1rem;">
                <button onclick="showAdminPanel()" style="background: var(--surface); border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; color: var(--text); margin-bottom: 1rem;">
                    ← Back to User List
                </button>
                <p style="color: var(--text-secondary); text-align: center;">Unable to load lab history for ${userName}.</p>
            </div>
        `;
        notificationSystem.error('Failed to load user lab history.');
    }
};

// Preferences management
async function saveUserPreferences() {
    if (!appState.authenticated) return;
    try {
        await api.call('users/preferences', {
            method: 'POST',
            body: appState.preferences
        });
    } catch (error) {
        notificationSystem.error('Failed to save theme preference.');
    }
}

// UI state management
function showDashboard(type, message) {
    if (message && !appState.isWelcomeShown) {
        notificationSystem[type || 'info'](message);
        appState.isWelcomeShown = true;
    }
    utils.hideElement('welcomeScreen');
    utils.showElement('mainContent');
    utils.hideElement('headerButtons');
    utils.showElement('userMenu');
    if (appState.user?.name) utils.setText('userName', appState.user.name);
    updateMobileMenuItems();
    generateWeekCards();
}

function showWelcomeScreen() {
    utils.showElement('welcomeScreen');
    utils.hideElement('mainContent');
    utils.showElement('headerButtons');
    utils.hideElement('userMenu');
    appState.isWelcomeShown = false;
    updateMobileMenuItems();
}

function generateWeekCards() {
    const container = utils.getId('weeksContainer');
    if (!container) return;
    const weekGroups = groupTasksByWeek();
    container.innerHTML = Object.keys(weekGroups).map(weekNum => {
        const week = weekGroups[weekNum];
        const completedTasks = week.tasks.filter(t => appState.progress[t.id]?.completed).length;
        const progress = week.tasks.length ? (completedTasks / week.tasks.length) * 100 : 0;
        return `
            <div class="week-card" id="week${weekNum}" onclick="toggleWeekExpansion(${weekNum}, event)">
                <div class="week-header">
                    <div>
                        <div class="week-title">${week.title}</div>
                        <div class="week-tasks">${completedTasks}/${week.tasks.length} tasks</div>
                    </div>
                    <span class="expand-icon">▼</span>
                </div>
                <div class="week-progress">
                    <div class="week-progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="week-description">${week.description}</div>
                <div class="task-list" id="taskList${weekNum}">
                    ${week.tasks.map(task => `
                        <div class="task-item ${appState.progress[task.id]?.completed ? 'completed' : ''}">
                            <input type="checkbox" class="task-checkbox" id="task_${task.id}" ${appState.progress[task.id]?.completed ? 'checked' : ''} onchange="toggleTaskCompletion('${task.id}')">
                            <div class="task-content" onclick="showTaskDetail('${task.id}')">
                                <div class="task-title">${task.title}</div>
                                <div class="task-description">${task.description}</div>
                            </div>
                            <button class="task-detail-btn" onclick="showTaskDetail('${task.id}'); event.stopPropagation();">Details</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function groupTasksByWeek() {
    const weeks = {};
    appState.tasks.forEach(task => {
        const weekNum = task.week;
        if (!weeks[weekNum]) {
            weeks[weekNum] = {
                title: `Week ${weekNum}: ${task.category}`,
                description: getWeekDescription(weekNum),
                tasks: []
            };
        }
        weeks[weekNum].tasks.push(task);
    });
    return weeks;
}

function getWeekDescription(week) {
    const descriptions = {
        1: 'Set up the core infrastructure, including Domain Controllers and network services.',
        2: 'Deploy and configure Exchange Server on-premises.',
        3: 'Configure Microsoft 365 and integrate cloud services.',
        4: 'Establish a hybrid Exchange environment with Azure AD Connect.'
    };
    return descriptions[week] || `Week ${week} of your Exchange Hybrid journey.`;
}

window.toggleWeekExpansion = function(weekNum, event) {
    if (event.target.closest('.task-item') || event.target.closest('.task-detail-btn')) return;
    const card = utils.getId(`week${weekNum}`);
    if (card) card.classList.toggle('expanded');
};

window.toggleTaskCompletion = async function(taskId) {
    if (!appState.progress[taskId]) {
        appState.progress[taskId] = { completed: false, subtasks: {}, notes: '' };
    }
    appState.progress[taskId].completed = !appState.progress[taskId].completed;
    appState.progress[taskId].completedAt = appState.progress[taskId].completed ? new Date().toISOString() : null;
    await saveUserProgress();
    updateProgressDisplay();
    generateWeekCards();
};

function checkLabCompletion() {
    const totalTasks = appState.tasks.length || 42;
    const completedTasks = Object.values(appState.progress).filter(p => p.completed).length;
    if (completedTasks === totalTasks && totalTasks > 0) {
        const today = new Date().toISOString().split('T')[0];
        const lastEntry = appState.labHistory[appState.labHistory.length - 1];
        if (!lastEntry || lastEntry.date !== today || lastEntry.status !== 'completed') {
            appState.labHistory.push({
                session: appState.labHistory.length + 1,
                date: today,
                status: 'completed',
                labId: `LAB${String(appState.labHistory.length + 1).padStart(3, '0')}`,
                completedAt: new Date().toISOString(),
                tasksCompleted: completedTasks,
                totalTasks
            });
            saveLabHistory();
            notificationSystem.success('🎉 Lab completed successfully!');
        }
    }
}

// Mobile menu functionality
function updateMobileMenuItems() {
    const mobileMenuItems = utils.getId('mobileMenuItems');
    if (!mobileMenuItems) return;
    if (appState.authenticated && appState.user) {
        const adminItem = appState.user.role === 'admin' ? `
            <button class="mobile-menu-item" onclick="showAdminPanel(); closeMobileMenu();">👑 Admin Panel</button>
        ` : '';
        mobileMenuItems.innerHTML = `
            <div style="padding: 0.5rem 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem; border-bottom: 1px solid var(--border); margin-bottom: 0.5rem;">
                Welcome, ${appState.user.name}
            </div>
            <button class="mobile-menu-item" onclick="startLabEnvironment(); closeMobileMenu();">🚀 Start New Lab</button>
            <button class="mobile-menu-item" onclick="showLabHistoryModal(); closeMobileMenu();">📊 Lab History</button>
            ${adminItem}
            <button class="mobile-menu-item" onclick="toggleMobileThemeMenu(event)" id="mobileThemeToggle">🎨 Theme ▶</button>
            <div id="mobileThemeOptions" style="display: none; padding-left: 1rem; background: var(--bg-secondary);">
                <button class="mobile-menu-item" onclick="setTheme('light'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">🌟 Light Jedi</button>
                <button class="mobile-menu-item" onclick="setTheme('dark'); closeMobileMenu();" style="background: var(--bg-secondary); font-size: 0.9rem;">⚡ Dark Sith</button>
            </div>
            <button class="mobile-menu-item" onclick="logout(); closeMobileMenu();">🚪 Sign Out</button>
        `;
    } else {
        mobileMenuItems.innerHTML = `
            <button class="mobile-menu-item secondary" onclick="showSignInModal(); closeMobileMenu();">👤 Sign In</button>
            <button class="mobile-menu-item primary" onclick="showRegisterModal(); closeMobileMenu();">🚀 Get Started</button>
        `;
    }
}

window.toggleMobileMenu = function() {
    const hamburger = utils.getId('hamburger');
    const mobileMenu = utils.getId('mobileMenu');
    hamburger.classList.toggle('active');
    mobileMenu.classList.toggle('active');
    updateMobileMenuItems();
};

function closeMobileMenu() {
    const hamburger = utils.getId('hamburger');
    const mobileMenu = utils.getId('mobileMenu');
    if (hamburger && mobileMenu) {
        hamburger.classList.remove('active');
        mobileMenu.classList.remove('active');
        const themeOptions = utils.getId('mobileThemeOptions');
        const themeToggle = utils.getId('mobileThemeToggle');
        if (themeOptions && themeToggle) {
            themeOptions.style.display = 'none';
            themeToggle.innerHTML = '🎨 Theme ▶';
        }
    }
}

window.toggleMobileThemeMenu = function(event) {
    event.stopPropagation();
    event.preventDefault();
    const themeOptions = utils.getId('mobileThemeOptions');
    const themeToggle = utils.getId('mobileThemeToggle');
    if (themeOptions && themeToggle) {
        themeOptions.style.display = themeOptions.style.display === 'none' ? 'block' : 'none';
        themeToggle.innerHTML = themeOptions.style.display === 'block' ? '🎨 Theme ▼' : '🎨 Theme ▶';
    }
};

// Modal management
function showModal(modalId) {
    const modal = utils.getId(modalId);
    if (modal) modal.classList.add('active');
    closeMobileMenu();
}

function closeModal(modalId) {
    const modal = utils.getId(modalId);
    if (modal) modal.classList.remove('active');
}

window.showSignInModal = function() { showModal('signInModal'); };
window.showRegisterModal = function() { showModal('registerModal'); };
window.toggleUserMenu = function() {
    const dropdown = utils.getId('userMenuDropdown');
    if (dropdown) dropdown.classList.toggle('active');
};

// Form handlers
function setupFormHandlers() {
    const signInForm = utils.getId('signInForm');
    if (signInForm) {
        signInForm.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(signInForm);
            if (!formData.get('email') || !formData.get('password')) {
                notificationSystem.error('Please fill in all required fields.');
                return;
            }
            await authSystem.login(formData);
        });
    }
    const registerForm = utils.getId('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const formData = new FormData(registerForm);
            if (!formData.get('name') || !formData.get('email') || !formData.get('password')) {
                notificationSystem.error('Please fill in all required fields.');
                return;
            }
            if (formData.get('password').length < 8) {
                notificationSystem.error('Password must be at least 8 characters long.');
                return;
            }
            await authSystem.register(formData);
        });
    }
}

window.handleSignIn = async function(e) {
    e.preventDefault();
    await authSystem.login(new FormData(e.target));
};

window.handleRegister = async function(e) {
    e.preventDefault();
    await authSystem.register(new FormData(e.target));
};

// Password visibility toggle
window.togglePasswordVisibility = function(inputId) {
    const input = utils.getId(inputId);
    const button = input.nextElementSibling;
    if (input.type === 'password') {
        input.type = 'text';
        button.innerHTML = '👀';
    } else {
        input.type = 'password';
        button.innerHTML = '👁';
    }
};

// Navigation
window.goHome = function() {
    if (appState.authenticated) {
        showDashboard();
    } else {
        showWelcomeScreen();
    }
};

window.logout = function() {
    authSystem.logout();
};

// Event listeners
document.addEventListener('click', e => {
    const modals = document.querySelectorAll('.modal.active');
    modals.forEach(modal => {
        if (e.target === modal) modal.classList.remove('active');
    });
    const userMenu = utils.getId('userMenu');
    const dropdown = utils.getId('userMenuDropdown');
    if (userMenu && dropdown && !userMenu.contains(e.target) && dropdown.classList.contains('active')) {
        dropdown.classList.remove('active');
    }
    const mobileMenu = utils.getId('mobileMenu');
    const hamburger = utils.getId('hamburger');
    if (mobileMenu && hamburger && !mobileMenu.contains(e.target) && !hamburger.contains(e.target)) {
        closeMobileMenu();
    }
});

window.addEventListener('error', e => console.error('Global error:', e));
window.addEventListener('unhandledrejection', e => console.error('Unhandled promise rejection:', e.reason));

// Initialize application
async function init() {
    loadTaskDefinitions();
    setupFormHandlers();
    updateMobileMenuItems();
    const isAuthenticated = await authSystem.checkSession();
    if (isAuthenticated) {
        showDashboard('info', `Welcome back, ${appState.user.name}! 🎉`);
    } else {
        showWelcomeScreen();
    }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>